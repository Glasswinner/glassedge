<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roleplay Scenario | GlassEDGE</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- capture URL params immediately -->
  <script>
    window.urlParams = new URLSearchParams(window.location.search);
    window.eventCode = urlParams.get("event") || "PFN";
    window.isTDM = urlParams.get("tdm") === "true";
  </script>

  <!-- MAIN MODULE: now deferred until after the <body> is parsed -->
  <script type="module" defer>
    // --- Markdown Table to HTML Conversion Function ---
    function markdownTableToHTML(text) {
      const tableRegex = /((?:\|.+\|[\r\n]+)+)/g;
      return text.replace(tableRegex, (table) => {
        const rows = table.trim().split('\n').filter(r => r.trim());
        const filteredRows = rows.filter(r => !/^(\|\s*:?-+:?\s*)+\|?$/.test(r.trim()));
        if (filteredRows.length === 0) return table;
        const htmlRows = filteredRows.map((row, i) => {
          const cells = row.split('|').slice(1, -1).map(c => c.trim());
          if (i === 0) {
            return '<tr>' + cells.map(cell => `<th class="px-3 py-2 border">${cell}</th>`).join('') + '</tr>';
          }
          return '<tr>' + cells.map(cell => `<td class="px-3 py-2 border">${cell}</td>`).join('') + '</tr>';
        });
        return `<table class="my-4 border border-gray-300 rounded-lg text-sm w-auto bg-white shadow">${htmlRows.join('')}</table>`;
      });
    }

    // relative imports from your published /roleplaybanks folder
    import PFNBank from './roleplaybanks/PFNroleplaybank.js';
    import PBMBank from './roleplaybanks/PBMroleplaybank.js';
    import BFSBank from './roleplaybanks/BFSroleplaybank.js';

    // populate the Event code in the UI
    document.getElementById("event-code").textContent = window.eventCode;

    async function fetchWithTimeout(url, options = {}, timeout = 120000) {
      return Promise.race([
        fetch(url, options),
        new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), timeout))
      ]);
    }

    async function fetchPromptWithFallback() {
      const promptElement = document.getElementById("generated-prompt");
      const preludeElement = document.getElementById("prelude-block");
      const noticeElement = document.getElementById("loading-notice");
      const skills = [
        "- Critical Thinking ‚Äì Reason effectively and use systems thinking.",
        "- Communication ‚Äì Communicate clearly.",
        "- Creativity and Innovation ‚Äì Show evidence of creativity."
      ];

      const showBtn = document.getElementById("show-indicators-btn");
      const indicatorsDiv = document.getElementById("indicators-list");

      const handlePrompt = ({ prompt, indicators }) => {
        promptElement.innerHTML = markdownTableToHTML(prompt);
        window.currentIndicators = indicators;
        localStorage.setItem("glassedge_prompt", prompt);
        preludeElement.innerHTML = `
          <div class="font-semibold text-purple-600 mb-1">21st CENTURY SKILLS</div>
          <ul class="mb-4 list-disc list-inside text-gray-700">
            ${skills.map(s => `<li>${s}</li>`).join('')}
          </ul>
        `;
        noticeElement.classList.add("hidden");
        startPrepTimer();
        showBtn.classList.remove("hidden");
        indicatorsDiv.classList.add("hidden");
        showBtn.classList.add("animate-fadeIn");

        // keep fullscreen content in sync if user opens right away
        const fsContent = document.getElementById("fullscreen-content");
        if (fsContent) fsContent.innerHTML = promptElement.innerHTML;
      };

      try {
        const res = await fetchWithTimeout('/api/generatePrompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eventCode: window.eventCode })
        });
        const data = await res.json();
        if (res.ok && data.prompt) return handlePrompt(data);
      } catch {}

      // fallback bank
      const fallback = { PFN: PFNBank, PBM: PBMBank, BFS: BFSBank }[window.eventCode];
      if (fallback?.length) {
        const fallbackPrompt = fallback[Math.floor(Math.random() * fallback.length)];
        promptElement.innerHTML = markdownTableToHTML(fallbackPrompt);
        window.currentIndicators = ["No AI indicators found."];
        localStorage.setItem("glassedge_prompt", fallbackPrompt);
        preludeElement.innerHTML = `
          <div class="font-semibold text-purple-600 mb-1">21st CENTURY SKILLS</div>
          <ul class="mb-4 list-disc list-inside text-gray-700">
            ${skills.map(s => `<li>${s}</li>`).join('')}
          </ul>
        `;
        noticeElement.classList.add("hidden");
        startPrepTimer();
        showBtn.classList.remove("hidden");
        indicatorsDiv.classList.add("hidden");
        showBtn.classList.add("animate-fadeIn");

        const fsContent = document.getElementById("fullscreen-content");
        if (fsContent) fsContent.innerHTML = promptElement.innerHTML;
      } else {
        promptElement.textContent = "‚ùå Failed to generate a prompt and no fallback available.";
      }
    }

    // start things off
    fetchPromptWithFallback();
  </script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: none; }
    }
    .animate-fadeIn { animation: fadeIn 0.6s cubic-bezier(.4,0,.2,1) 1; }

    /* Prevent background scroll when fullscreen is open */
    .no-scroll { overflow: hidden; }
  </style>
</head>

<body class="bg-white text-gray-800 font-inter">
  <!-- Header -->
  <header class="bg-gradient-to-r from-purple-600 to-pink-400 text-white sticky top-0 z-50 shadow-md">
    <div class="max-w-screen-xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <span class="text-lg font-semibold flex items-center">
          GlassEDGE
          <img src="glassedgenewlogo.png" alt="GlassEDGE Logo" class="h-6 ml-2" />
        </span>
      </div>
      <nav class="hidden md:flex space-x-6 text-sm font-medium">
        <a href="roleplay.html" class="hover:underline">Roleplays</a>
        <a href="walkthrough.html" class="hover:underline">Walkthrough Videos</a>
        <a href="written.html" class="hover:underline">Written Event Gallery</a>
        <a href="#" class="hover:underline">About Us</a>
      </nav>
      <div>
        <a href="start.html">
          <button class="bg-white text-purple-600 font-semibold text-sm px-4 py-2 rounded-full shadow-md hover:opacity-90">
            Get Started ‚Üí
          </button>
        </a>
      </div>
    </div>
  </header>

  <div class="flex h-[calc(100vh-64px)] overflow-hidden">
    <!-- Left Column -->
    <div class="w-full md:w-2/3 p-4 md:p-8 overflow-y-auto bg-white">
      <h2 class="text-2xl font-bold text-purple-600 mb-4 uppercase tracking-wider">
        Event: <span id="event-code">--</span>
      </h2>
      <div id="prelude-block" class="mb-4"></div>
      <p id="loading-notice" class="text-sm text-gray-500 italic mb-2">
        ‚ö†Ô∏è Response may take up to 2 minutes to generate, please be patient.
      </p>

      <!-- Prompt Card (with expand control) -->
      <div class="relative">
        <!-- Expand button (top-right) -->
        <button
          id="expand-prompt"
          aria-label="Expand prompt to full screen"
          class="absolute right-2 top-2 z-10 rounded-md px-2 py-1 text-xs md:text-sm bg-white/90 border border-gray-300 shadow hover:bg-white"
          title="Expand to full screen"
        >
          ‚§¢
        </button>

        <div class="bg-[#f2f2f2] p-4 md:p-6 rounded-xl border border-gray-200 shadow-inner max-h-[80vh] overflow-y-auto">
          <p id="generated-prompt" class="whitespace-pre-wrap leading-relaxed text-base md:text-lg">
            üß† Generating your DECA prompt...
          </p>
        </div>
      </div>

      <!-- PERFORMANCE INDICATOR REVEAL BUTTON + BOX -->
      <div id="show-indicators-section" class="mt-24 text-center">
        <button id="show-indicators-btn"
          class="hidden bg-gradient-to-r from-purple-600 to-pink-400 text-white px-6 py-3 rounded-2xl shadow-xl font-semibold text-base transition-all hover:scale-105"
        >
          Can't see your performance indicators? Click here to view them.
        </button>
        <div id="indicators-list" class="hidden mt-6 bg-[#f2f2f2] p-6 rounded-xl shadow-xl text-left max-w-xl mx-auto text-gray-900"></div>
      </div>

      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const showBtn = document.getElementById("show-indicators-btn");
          const listDiv = document.getElementById("indicators-list");
          showBtn.onclick = () => {
            const indicators = window.currentIndicators || [];
            if (indicators.length && indicators[0] !== "No AI indicators found.") {
              listDiv.innerHTML = `
                <strong class="block mb-2 text-lg">Performance Indicators for this scenario:</strong>
                <ul class="list-disc pl-5 mt-2">
                  ${indicators.map(i => `<li>${i}</li>`).join('')}
                </ul>
              `;
            } else {
              listDiv.innerHTML = `<em>Sorry, no indicators are available for this scenario.</em>`;
            }
            listDiv.classList.remove("hidden");
            showBtn.classList.add("hidden");
          };
        });
      </script>
    </div>

    <!-- Right Column -->
    <div class="hidden md:flex md:w-1/3 flex-col justify-between p-6 border-l border-gray-200 bg-gray-50">
      <div class="mb-4 text-right">
        <h3 id="timer-label" class="text-xl font-semibold text-purple-600 mb-2">‚è±Ô∏è Prep Timer</h3>
        <div id="timer" class="text-3xl font-bold text-gray-900">10:00</div>
      </div>
      <div class="flex-grow flex flex-col">
        <h3 class="text-xl font-semibold text-purple-600 mb-2">üó£Ô∏è Your Response</h3>
        <video id="camera" autoplay playsinline muted class="w-full rounded-lg mb-2 border border-gray-300"></video>
        <div class="flex gap-3 mt-2">
          <button id="start" class="bg-green-600 text-white px-4 py-2 rounded-md">Start</button>
          <button id="stop" class="bg-red-600 text-white px-4 py-2 rounded-md" disabled>Stop</button>
        </div>
        <p id="status" class="text-sm text-green-600 mt-2 hidden">Processing...</p>
      </div>
      <div class="text-center mt-6">
        <a href="index.html" class="text-purple-600 hover:underline">‚Üê Return to Home</a>
      </div>
    </div>
  </div>

  <!-- Mobile Timer/Recorder (shows on small screens only) -->
  <div class="md:hidden sticky bottom-0 w-full bg-gray-50 border-t border-gray-200 px-4 py-3 z-40">
    <div class="flex items-center justify-between">
      <div>
        <div id="timer-label" class="text-sm font-semibold text-purple-600">‚è±Ô∏è Prep Timer</div>
        <div id="timer" class="text-xl font-bold text-gray-900">10:00</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="start-mobile" class="bg-green-600 text-white px-3 py-2 rounded-md text-sm">Start</button>
        <button id="stop-mobile" class="bg-red-600 text-white px-3 py-2 rounded-md text-sm" disabled>Stop</button>
      </div>
    </div>
    <video id="camera-mobile" autoplay playsinline muted class="w-full mt-2 rounded-md border border-gray-300"></video>
    <p id="status-mobile" class="text-xs text-green-600 mt-1 hidden">Processing...</p>
  </div>

  <!-- FULLSCREEN PROMPT OVERLAY -->
  <div
    id="fullscreen-overlay"
    class="fixed inset-0 hidden bg-white z-[100]"
    role="dialog"
    aria-modal="true"
    aria-labelledby="fs-title"
  >
    <div class="flex flex-col h-full">
      <!-- Top bar with collapse button -->
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-gradient-to-r from-purple-600 to-pink-400">
        <h2 id="fs-title" class="text-white font-semibold text-base sm:text-lg">Prompt (Full Screen)</h2>
        <div class="flex items-center gap-2">
          <button
            id="increase-text"
            class="rounded-md bg-white/90 text-gray-800 text-xs sm:text-sm px-2 py-1 border border-white/50 hover:bg-white"
            title="Increase text size"
            aria-label="Increase text size"
          >A+</button>
          <button
            id="decrease-text"
            class="rounded-md bg-white/90 text-gray-800 text-xs sm:text-sm px-2 py-1 border border-white/50 hover:bg-white"
            title="Decrease text size"
            aria-label="Decrease text size"
          >A-</button>
          <button
            id="collapse-prompt"
            class="rounded-md bg-white/90 text-gray-800 text-xs sm:text-sm px-2 py-1 border border-white/50 hover:bg-white"
            aria-label="Return prompt to page"
            title="Return to page"
          >
            ‚§°
          </button>
        </div>
      </div>

      <!-- Scrollable content -->
      <div id="fullscreen-scroll" class="flex-1 overflow-y-auto p-4 sm:p-6">
        <div
          id="fullscreen-content"
          class="prose max-w-none text-base sm:text-lg leading-relaxed"
        ></div>
      </div>
    </div>
  </div>

  <!-- Timer & Recording Logic -->
  <script>
    // Elements for desktop column
    const timerDisplays = document.querySelectorAll("#timer");
    const timerLabels = document.querySelectorAll("#timer-label");
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const status = document.getElementById("status");
    const camera = document.getElementById("camera");

    // Elements for mobile footer
    const startBtnMobile = document.getElementById("start-mobile");
    const stopBtnMobile = document.getElementById("stop-mobile");
    const statusMobile = document.getElementById("status-mobile");
    const cameraMobile = document.getElementById("camera-mobile");

    let prepDuration = window.isTDM ? 1800 : 600;
    let roleplayDuration = window.isTDM ? 900 : 600;
    let seconds = prepDuration;
    let timerInterval;
    let prepPhase = true;
    let mediaRecorder;
    let chunks = [];

    function renderTime(s) {
      const min = String(Math.floor(s / 60)).padStart(2, '0');
      const sec = String(s % 60).padStart(2, '0');
      return `${min}:${sec}`;
    }

    function updateTimer() {
      const isDanger = seconds <= 60;
      timerDisplays.forEach(el => {
        el.textContent = renderTime(seconds);
        if (isDanger) el.classList.add("text-red-500");
      });
      if (seconds > 0) {
        seconds--;
        return;
      }
      clearInterval(timerInterval);
      if (prepPhase) {
        // auto-start recording when prep ends
        (startBtn || startBtnMobile)?.click();
        startRoleplayTimer();
      } else {
        if (mediaRecorder?.state === "recording") handleStopRecording();
      }
    }

    function startPrepTimer() {
      seconds = prepDuration;
      prepPhase = true;
      timerLabels.forEach(el => el.textContent = "‚è±Ô∏è Prep Timer");
      timerDisplays.forEach(el => el.classList.remove("text-red-500"));
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
    }

    function startRoleplayTimer() {
      seconds = roleplayDuration;
      prepPhase = false;
      timerLabels.forEach(el => el.textContent = "‚è±Ô∏è Roleplay Timer");
      timerDisplays.forEach(el => el.classList.remove("text-red-500"));
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
    }

    function handleStopRecording() {
      mediaRecorder.stop();
      // Enable start buttons, disable stop buttons
      [startBtn, startBtnMobile].forEach(b => {
        if (!b) return;
        b.disabled = false;
        b.classList.remove("opacity-50", "cursor-not-allowed");
      });
      [stopBtn, stopBtnMobile].forEach(b => { if (b) b.disabled = true; });
    }

    // Camera init for both desktop and mobile video elements
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      if (camera) camera.srcObject = stream;
      if (cameraMobile) cameraMobile.srcObject = stream;

      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'video/mp4' });
        [status, statusMobile].forEach(s => { if (s) { s.textContent = "‚òÅÔ∏è Uploading to Cloudinary..."; s.classList.remove("hidden"); } });

        const formData = new FormData();
        formData.append("file", blob);
        formData.append("upload_preset", "glassuploadbetter");

        let cloudUrl = "";
        try {
          const res = await fetch("https://api.cloudinary.com/v1_1/drgawbn5b/video/upload", {
            method: "POST",
            body: formData
          });
          const data = await res.json();
          cloudUrl = data.secure_url;
        } catch {
          [status, statusMobile].forEach(s => { if (s) s.textContent = "‚ùå Cloud upload failed."; });
          return;
        }

        [status, statusMobile].forEach(s => { if (s) s.textContent = "üîä Transcribing with Deepgram..."; });
        try {
          const transcriptRes = await fetch('/api/transcriptbackend', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url: cloudUrl })
          });
          const { transcript = "No transcript available." } = await transcriptRes.json();
          [status, statusMobile].forEach(s => { if (s) s.textContent = "üß† Grading..."; });
          const prompt = localStorage.getItem("glassedge_prompt");
          const gradeRes = await fetch('/api/grade', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ transcript, eventCode: window.eventCode, prompt })
          });
          const grade = await gradeRes.json();
          window.location.href = `/feedback.html?event=${eventCode}`
            + `&feedback=${encodeURIComponent(grade.full)}`
            + `&transcript=${encodeURIComponent(transcript)}`;
        } catch {
          [status, statusMobile].forEach(s => { if (s) s.textContent = "‚ùå Transcription or grading failed."; });
        }
      };

      function startRecording() {
        chunks = [];
        mediaRecorder.start();
        [startBtn, startBtnMobile].forEach(b => {
          if (!b) return;
          b.disabled = true;
          b.classList.add("opacity-50", "cursor-not-allowed");
        });
        [stopBtn, stopBtnMobile].forEach(b => { if (b) b.disabled = false; });
      }

      if (startBtn) startBtn.onclick = startRecording;
      if (stopBtn) stopBtn.onclick = handleStopRecording;
      if (startBtnMobile) startBtnMobile.onclick = startRecording;
      if (stopBtnMobile) stopBtnMobile.onclick = handleStopRecording;
    }).catch(err => {
      alert("Camera access denied or not available: " + err.message);
    });

    // -------- Fullscreen prompt logic --------
    const expandBtn = document.getElementById("expand-prompt");
    const fsOverlay = document.getElementById("fullscreen-overlay");
    const fsContent = document.getElementById("fullscreen-content");
    const collapseBtn = document.getElementById("collapse-prompt");
    const generatedPrompt = document.getElementById("generated-prompt");
    const increaseText = document.getElementById("increase-text");
    const decreaseText = document.getElementById("decrease-text");

    let fsBaseSize = 18; // base text size in px for fullscreen content
    function applyFsFontSize() {
      fsContent.style.fontSize = fsBaseSize + "px";
      fsContent.style.lineHeight = "1.6";
    }
    applyFsFontSize();

    function openFullscreen() {
      // Copy current prompt HTML so tables/formatting match
      fsContent.innerHTML = generatedPrompt.innerHTML;
      fsOverlay.classList.remove("hidden");
      document.documentElement.classList.add("no-scroll");
      // Focus collapse for accessibility
      collapseBtn?.focus();
    }

    function closeFullscreen() {
      fsOverlay.classList.add("hidden");
      document.documentElement.classList.remove("no-scroll");
      // Return focus to expand button
      expandBtn?.focus();
    }

    if (expandBtn) expandBtn.addEventListener("click", openFullscreen);
    if (collapseBtn) collapseBtn.addEventListener("click", closeFullscreen);

    // Keyboard: ESC to close
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !fsOverlay.classList.contains("hidden")) {
        closeFullscreen();
      }
    });

    // Tap outside to close (optional quality-of-life)
    fsOverlay.addEventListener("click", (e) => {
      // Only if user clicks the backdrop (not the inner content area)
      const scrollArea = document.getElementById("fullscreen-scroll");
      if (!scrollArea.contains(e.target) && e.target !== collapseBtn && e.target !== increaseText && e.target !== decreaseText) {
        closeFullscreen();
      }
    });

    // Text size controls (for readability on small screens)
    if (increaseText) increaseText.addEventListener("click", () => {
      fsBaseSize = Math.min(fsBaseSize + 2, 28);
      applyFsFontSize();
    });
    if (decreaseText) decreaseText.addEventListener("click", () => {
      fsBaseSize = Math.max(fsBaseSize - 2, 14);
      applyFsFontSize();
    });
  </script>
</body>
</html>
