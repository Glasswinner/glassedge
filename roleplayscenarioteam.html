<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Decision Making Scenario | GlassEDGE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@daily-co/daily-js"></script>
  <script>
    window.urlParams = new URLSearchParams(window.location.search);
    window.eventCode = urlParams.get("event") || "PFN";
    window.roomCode = urlParams.get("room") || "";
    window.mode = urlParams.get("mode") || "guest";
  </script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px);}
      to   { opacity: 1; transform: none;}
    }
    .animate-fadeIn { animation: fadeIn 0.6s ease 1; }
  </style>
</head>
<body class="bg-white text-gray-800 font-inter">
  <!-- Header -->
  <header class="bg-gradient-to-r from-purple-600 to-pink-400 text-white sticky top-0 z-50 shadow-md">
    <div class="max-w-screen-xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <span class="text-lg font-semibold flex items-center">
          GlassEDGE
          <img src="glassedgenewlogo.png" alt="GlassEDGE Logo" class="h-6 ml-2" />
        </span>
      </div>
      <div class="text-sm font-medium">
        <span class="bg-white text-purple-600 px-3 py-1 rounded-full font-semibold">
          Room Code: <span id="room-display">---</span>
        </span>
      </div>
    </div>
  </header>

  <div class="flex h-[calc(100vh-64px)] overflow-hidden">
    <!-- Left Column -->
    <div class="w-2/3 p-8 overflow-y-auto bg-white">
      <h2 class="text-2xl font-bold text-purple-600 mb-4 uppercase tracking-wider">
        Event: <span id="event-code">--</span>
      </h2>

      <!-- Timer -->
      <div class="mb-4">
        <h3 id="timer-label" class="text-lg font-semibold text-purple-600 mb-1">‚è±Ô∏è Prep Timer</h3>
        <div id="timer" class="text-3xl font-bold text-gray-900">30:00</div>
      </div>

      <p id="loading-notice" class="text-sm text-gray-500 italic mb-2">‚ö†Ô∏è Waiting for host to reveal the prompt...</p>

      <div class="bg-[#f2f2f2] p-6 rounded-xl border border-gray-200 shadow-inner max-h-[60vh] overflow-y-auto">
        <p class="whitespace-pre-wrap leading-relaxed text-lg" id="generated-prompt">üß† Your DECA prompt will appear here...</p>
      </div>

      <div id="show-indicators" class="mt-8 hidden">
        <h3 class="text-lg font-semibold mb-2 text-purple-600">Performance Indicators</h3>
        <ul id="indicators-list" class="list-disc pl-6 text-gray-800"></ul>
      </div>
    </div>

    <!-- Right Column -->
    <div class="w-1/3 flex flex-col p-6 border-l border-gray-200 bg-gray-50">
      <div class="flex-grow flex flex-col">
        <h3 class="text-xl font-semibold text-purple-600 mb-2">üó£Ô∏è Live Video</h3>
        <div id="video-section" class="w-full bg-black rounded-lg flex items-center justify-center h-64 text-white">
          <span id="waiting-label" class="text-center text-lg">Waiting for second participant...</span>
        </div>
      </div>

      <div class="mt-6 space-y-3">
        <button id="reveal-prompt-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md w-full hidden">Reveal Prompt</button>
        <button id="start-roleplay-btn" class="bg-green-600 text-white px-4 py-2 rounded-md w-full hidden">Start Roleplay Early</button>
        <button id="stop-recording-btn" class="bg-red-600 text-white px-4 py-2 rounded-md w-full hidden">Stop & Submit</button>
        <p id="status" class="text-sm text-green-600 hidden mt-2">Processing...</p>
      </div>
    </div>
  </div>

  <script type="module">
    document.getElementById("event-code").textContent = window.eventCode;
    document.getElementById("room-display").textContent = window.roomCode;

    const timerDisplay = document.getElementById("timer");
    const timerLabel = document.getElementById("timer-label");
    const revealBtn = document.getElementById("reveal-prompt-btn");
    const startRoleplayBtn = document.getElementById("start-roleplay-btn");
    const stopBtn = document.getElementById("stop-recording-btn");
    const status = document.getElementById("status");

    let seconds = 1800;
    let prepPhase = true;
    let timerInterval;
    let mediaRecorder;
    let chunks = [];

    function updateTimer() {
      const min = String(Math.floor(seconds / 60)).padStart(2, '0');
      const sec = String(seconds % 60).padStart(2, '0');
      timerDisplay.textContent = `${min}:${sec}`;
      if (seconds > 0) {
        seconds--;
      } else {
        clearInterval(timerInterval);
        if (prepPhase) beginRoleplayPhase();
        else finishRecording();
      }
    }

    function syncStartPrep() {
      clearInterval(timerInterval);
      seconds = 1800;
      prepPhase = true;
      timerLabel.textContent = "‚è±Ô∏è Prep Timer";
      timerDisplay.classList.remove("text-red-500");
      timerInterval = setInterval(updateTimer, 1000);
    }

    function beginRoleplayPhase() {
      prepPhase = false;
      seconds = 900;
      timerLabel.textContent = "‚è±Ô∏è Roleplay Timer";
      timerDisplay.classList.add("text-red-500");
      startRecording();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function startRecording() {
      mediaRecorder.start();
      startRoleplayBtn.classList.add("hidden");
      stopBtn.classList.remove("hidden");
    }

    function finishRecording() {
      mediaRecorder.stop();
      stopBtn.disabled = true;
      status.textContent = "‚òÅÔ∏è Uploading...";
      status.classList.remove("hidden");
    }

    // ‚úÖ Daily Video Setup
    const videoSection = document.getElementById("video-section");
    const waitingLabel = document.getElementById("waiting-label");

    const callFrame = window.DailyIframe.createFrame(videoSection, {
      url: `https://glassedgetdm.daily.co/${window.roomCode}`,
      showLeaveButton: true,
      iframeStyle: {
        position: 'relative',
        width: '100%',
        height: '100%',
        border: '0',
        borderRadius: '8px'
      }
    });

    callFrame.join();

    callFrame.on('participant-joined', () => {
      if (waitingLabel) waitingLabel.style.display = "none";
    });

    // ‚úÖ Recording setup
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'video/mp4' });

        const formData = new FormData();
        formData.append("file", blob);
        formData.append("upload_preset", "glassuploadbetter");

        let cloudUrl = "";
        try {
          const res = await fetch("https://api.cloudinary.com/v1_1/drgawbn5b/video/upload", {
            method: "POST",
            body: formData
          });
          const data = await res.json();
          cloudUrl = data.secure_url;
        } catch {
          status.textContent = "‚ùå Upload failed.";
          return;
        }

        status.textContent = "üîä Transcribing...";
        const transcriptRes = await fetch('/api/transcriptbackend', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url: cloudUrl })
        });

        const { transcript = "No transcript." } = await transcriptRes.json();
        status.textContent = "üß† Grading...";

        const gradeRes = await fetch('/api/grade', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ transcript, eventCode: window.eventCode })
        });

        const grade = await gradeRes.json();
        await fetch(`/api/delete-room?roomName=${window.roomCode}`, { method: 'DELETE' });

        window.location.href = `/feedback.html?event=${window.eventCode}&feedback=${encodeURIComponent(grade.full)}&transcript=${encodeURIComponent(transcript)}`;
      };
    });

    // ‚úÖ Host controls
    if (window.mode === "host") {
      revealBtn.classList.remove("hidden");
      revealBtn.onclick = async () => {
        const res = await fetch('/api/generatePrompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eventCode: window.eventCode })
        });
        const data = await res.json();

        callFrame.sendAppMessage({ type: "prompt", prompt: data.prompt, indicators: data.indicators });
        callFrame.sendAppMessage({ type: "start-prep" });

        document.getElementById("generated-prompt").textContent = data.prompt;
        document.getElementById("show-indicators").classList.remove("hidden");
        document.getElementById("indicators-list").innerHTML = data.indicators.map(i => `<li>${i}</li>`).join('');
        revealBtn.classList.add("hidden");
        startRoleplayBtn.classList.remove("hidden");

        syncStartPrep();
      };
    }

    // ‚úÖ Guest receives prompt + timer sync
    callFrame.on('app-message', e => {
      const { type, prompt, indicators } = e.data;

      if (type === "prompt") {
        document.getElementById("generated-prompt").textContent = prompt;
        document.getElementById("show-indicators").classList.remove("hidden");
        document.getElementById("indicators-list").innerHTML = indicators.map(i => `<li>${i}</li>`).join('');
      }

      if (type === "start-prep") {
        syncStartPrep();
      }
    });

    startRoleplayBtn.onclick = () => {
      clearInterval(timerInterval);
      beginRoleplayPhase();
      callFrame.sendAppMessage({ type: "start-roleplay" });
    };

    // ‚úÖ Guest auto-start roleplay on sync
    callFrame.on('app-message', e => {
      if (e.data.type === "start-roleplay") {
        clearInterval(timerInterval);
        beginRoleplayPhase();
      }
    });

    stopBtn.onclick = finishRecording;
  </script>
</body>
</html>
