let e,t,i,s,r,n,a,o,l,d,c,u,h,p,v,g,m,f,y,k,b,T,S,w,P,C,E,I;var A=globalThis;function R(e,t,i,s){Object.defineProperty(e,t,{get:i,set:s,enumerable:!0,configurable:!0})}function _(e){return e&&e.__esModule?e.default:e}var L={},M={},D=A.parcelRequire86a0;null==D&&((D=function(e){if(e in L)return L[e].exports;if(e in M){var t=M[e];delete M[e];var i={id:e,exports:{}};return L[e]=i,t.call(i.exports,i,i.exports),i.exports}var s=Error("Cannot find module '"+e+"'");throw s.code="MODULE_NOT_FOUND",s}).register=function(e,t){M[e]=t},A.parcelRequire86a0=D);var O=D.register;function N(e,t){return e===t}O("86Wyx",function(e,t){!function(i,s){var r="function",n="undefined",a="object",o="string",l="major",d="model",c="name",u="type",h="vendor",p="version",v="architecture",g="console",m="mobile",f="tablet",y="smarttv",k="wearable",b="embedded",T="Amazon",S="Apple",w="ASUS",P="BlackBerry",C="Browser",E="Chrome",I="Firefox",A="Google",R="Huawei",_="Microsoft",L="Motorola",M="Opera",D="Samsung",O="Sharp",N="Sony",x="Xiaomi",U="Zebra",B="Facebook",F="Chromium OS",j="Mac OS",$=" Browser",G=function(e,t){var i={};for(var s in e)t[s]&&t[s].length%2==0?i[s]=t[s].concat(e[s]):i[s]=e[s];return i},V=function(e){for(var t={},i=0;i<e.length;i++)t[e[i].toUpperCase()]=e[i];return t},q=function(e,t){return typeof e===o&&-1!==H(t).indexOf(H(e))},H=function(e){return e.toLowerCase()},W=function(e,t){if(typeof e===o)return e=e.replace(/^\s\s*/,""),typeof t===n?e:e.substring(0,500)},z=function(e,t){for(var i,n,o,l,d,c,u=0;u<t.length&&!d;){var h=t[u],p=t[u+1];for(i=n=0;i<h.length&&!d&&h[i];)if(d=h[i++].exec(e))for(o=0;o<p.length;o++)c=d[++n],typeof(l=p[o])===a&&l.length>0?2===l.length?typeof l[1]==r?this[l[0]]=l[1].call(this,c):this[l[0]]=l[1]:3===l.length?typeof l[1]!==r||l[1].exec&&l[1].test?this[l[0]]=c?c.replace(l[1],l[2]):void 0:this[l[0]]=c?l[1].call(this,c,l[2]):void 0:4===l.length&&(this[l[0]]=c?l[3].call(this,c.replace(l[1],l[2])):s):this[l]=c||s;u+=2}},K=function(e,t){for(var i in t)if(typeof t[i]===a&&t[i].length>0){for(var r=0;r<t[i].length;r++)if(q(t[i][r],e))return"?"===i?s:i}else if(q(t[i],e))return"?"===i?s:i;return t.hasOwnProperty("*")?t["*"]:e},J={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Q={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[c,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[c,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[c,p],[/opios[\/ ]+([\w\.]+)/i],[p,[c,M+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[p,[c,M+" GX"]],[/\bopr\/([\w\.]+)/i],[p,[c,M]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[p,[c,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[p,[c,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[c,p],[/quark(?:pc)?\/([-\w\.]+)/i],[p,[c,"Quark"]],[/\bddg\/([\w\.]+)/i],[p,[c,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[c,"UC"+C]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[p,[c,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[c,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[c,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[p,[c,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[p,[c,"Smart Lenovo "+C]],[/(avast|avg)\/([\w\.]+)/i],[[c,/(.+)/,"$1 Secure "+C],p],[/\bfocus\/([\w\.]+)/i],[p,[c,I+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[c,M+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[c,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[c,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[c,M+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[c,"MIUI"+$]],[/fxios\/([\w\.-]+)/i],[p,[c,I]],[/\bqihoobrowser\/?([\w\.]*)/i],[p,[c,"360"]],[/\b(qq)\/([\w\.]+)/i],[[c,/(.+)/,"$1Browser"],p],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[c,/(.+)/,"$1"+$],p],[/samsungbrowser\/([\w\.]+)/i],[p,[c,D+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[p,[c,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[c,"Sogou Mobile"],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[c,p],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[c],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[p,c],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[c,B],p],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[c,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[c,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[p,[c,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[c,E+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[c,E+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[c,"Android "+C]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[c,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[c,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,c],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[c,[p,K,{"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[c,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[c,"Netscape"],p],[/(wolvic|librewolf)\/([\w\.]+)/i],[c,p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[c,I+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[c,[p,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[c,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[v,"amd64"]],[/(ia32(?=;))/i],[[v,H]],[/((?:i[346]|x)86)[;\)]/i],[[v,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[v,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[v,"armhf"]],[/windows (ce|mobile); ppc;/i],[[v,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[v,/ower/,"",H]],[/(sun4\w)[;\)]/i],[[v,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[v,H]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[h,D],[u,f]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[d,[h,D],[u,m]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[d,[h,S],[u,m]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[h,S],[u,f]],[/(macintosh);/i],[d,[h,S]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[h,O],[u,m]],[/(?:honor)([-\w ]+)[;\)]/i],[d,[h,"Honor"],[u,m]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[h,R],[u,f]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[h,R],[u,m]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i],[[d,/_/g," "],[h,x],[u,m]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[h,x],[u,f]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[h,"OPPO"],[u,m]],[/\b(opd2\d{3}a?) bui/i],[d,[h,"OPPO"],[u,f]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[h,"Vivo"],[u,m]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[d,[h,"Realme"],[u,m]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[h,L],[u,m]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[h,L],[u,f]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[h,"LG"],[u,f]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[h,"LG"],[u,m]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[h,"Lenovo"],[u,f]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[h,"Nokia"],[u,m]],[/(pixel c)\b/i],[d,[h,A],[u,f]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[h,A],[u,m]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[h,N],[u,m]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[h,N],[u,f]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[h,"OnePlus"],[u,m]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[h,T],[u,f]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[h,T],[u,m]],[/(playbook);[-\w\),; ]+(rim)/i],[d,h,[u,f]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[h,P],[u,m]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[h,w],[u,f]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[h,w],[u,m]],[/(nexus 9)/i],[d,[h,"HTC"],[u,f]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[h,[d,/_/g," "],[u,m]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[d,[h,"TCL"],[u,f]],[/(itel) ((\w+))/i],[[h,H],d,[u,K,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[h,"Acer"],[u,f]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[h,"Meizu"],[u,m]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[d,[h,"Ulefone"],[u,m]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[d,[h,"Energizer"],[u,m]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[d,[h,"Cat"],[u,m]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[d,[h,"Smartfren"],[u,m]],[/droid.+; (a(?:015|06[35]|142p?))/i],[d,[h,"Nothing"],[u,m]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (imo) ((?!tab)[\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[h,d,[u,m]],[/(imo) (tab \w+)/i,/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[h,d,[u,f]],[/(surface duo)/i],[d,[h,_],[u,f]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[h,"Fairphone"],[u,m]],[/(u304aa)/i],[d,[h,"AT&T"],[u,m]],[/\bsie-(\w*)/i],[d,[h,"Siemens"],[u,m]],[/\b(rct\w+) b/i],[d,[h,"RCA"],[u,f]],[/\b(venue[\d ]{2,7}) b/i],[d,[h,"Dell"],[u,f]],[/\b(q(?:mv|ta)\w+) b/i],[d,[h,"Verizon"],[u,f]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[h,"Barnes & Noble"],[u,f]],[/\b(tm\d{3}\w+) b/i],[d,[h,"NuVision"],[u,f]],[/\b(k88) b/i],[d,[h,"ZTE"],[u,f]],[/\b(nx\d{3}j) b/i],[d,[h,"ZTE"],[u,m]],[/\b(gen\d{3}) b.+49h/i],[d,[h,"Swiss"],[u,m]],[/\b(zur\d{3}) b/i],[d,[h,"Swiss"],[u,f]],[/\b((zeki)?tb.*\b) b/i],[d,[h,"Zeki"],[u,f]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[h,"Dragon Touch"],d,[u,f]],[/\b(ns-?\w{0,9}) b/i],[d,[h,"Insignia"],[u,f]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[h,"NextBook"],[u,f]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[h,"Voice"],d,[u,m]],[/\b(lvtel\-)?(v1[12]) b/i],[[h,"LvTel"],d,[u,m]],[/\b(ph-1) /i],[d,[h,"Essential"],[u,m]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[h,"Envizen"],[u,f]],[/\b(trio[-\w\. ]+) b/i],[d,[h,"MachSpeed"],[u,f]],[/\btu_(1491) b/i],[d,[h,"Rotor"],[u,f]],[/(shield[\w ]+) b/i],[d,[h,"Nvidia"],[u,f]],[/(sprint) (\w+)/i],[h,d,[u,m]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[h,_],[u,m]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[h,U],[u,f]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[h,U],[u,m]],[/smart-tv.+(samsung)/i],[h,[u,y]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[h,D],[u,y]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[h,"LG"],[u,y]],[/(apple) ?tv/i],[h,[d,S+" TV"],[u,y]],[/crkey/i],[[d,E+"cast"],[h,A],[u,y]],[/droid.+aft(\w+)( bui|\))/i],[d,[h,T],[u,y]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[h,O],[u,y]],[/(bravia[\w ]+)( bui|\))/i],[d,[h,N],[u,y]],[/(mitv-\w{5}) bui/i],[d,[h,x],[u,y]],[/Hbbtv.*(technisat) (.*);/i],[h,d,[u,y]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[h,W],[d,W],[u,y]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,y]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[h,d,[u,g]],[/droid.+; (shield) bui/i],[d,[h,"Nvidia"],[u,g]],[/(playstation [345portablevi]+)/i],[d,[h,N],[u,g]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[h,_],[u,g]],[/\b(sm-[lr]\d\d[05][fnuw]?s?)\b/i],[d,[h,D],[u,k]],[/((pebble))app/i],[h,d,[u,k]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[h,S],[u,k]],[/droid.+; (glass) \d/i],[d,[h,A],[u,k]],[/droid.+; (wt63?0{2,3})\)/i],[d,[h,U],[u,k]],[/droid.+; (glass) \d/i],[d,[h,A],[u,k]],[/(pico) (4|neo3(?: link|pro)?)/i],[h,d,[u,k]],[/; (quest( \d| pro)?)/i],[d,[h,B],[u,k]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[h,[u,b]],[/(aeobc)\b/i],[d,[h,T],[u,b]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[d,[u,m]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[u,f]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,f]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[u,m]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[h,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[c,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[c,p],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[c,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[c,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,c]],os:[[/microsoft (windows) (vista|xp)/i],[c,p],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[c,[p,K,J]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[p,K,J],[c,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[c,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[c,j],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,c],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish|openharmony)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[c,p],[/\(bb(10);/i],[p,[c,P]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[c,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[c,I+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[c,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[c,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[c,E+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[c,F],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[c,p],[/(sunos) ?([\w\.\d]*)/i],[[c,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[c,p]]},Y=function(e,t){if(typeof e===a&&(t=e,e=s),!(this instanceof Y))return new Y(e,t).getResult();var g=typeof i!==n&&i.navigator?i.navigator:s,y=e||(g&&g.userAgent?g.userAgent:""),k=g&&g.userAgentData?g.userAgentData:s,b=t?G(Q,t):Q,T=g&&g.userAgent==y;return this.getBrowser=function(){var e,t={};return t[c]=s,t[p]=s,z.call(t,y,b.browser),t[l]=typeof(e=t[p])===o?e.replace(/[^\d\.]/g,"").split(".")[0]:s,T&&g&&g.brave&&typeof g.brave.isBrave==r&&(t[c]="Brave"),t},this.getCPU=function(){var e={};return e[v]=s,z.call(e,y,b.cpu),e},this.getDevice=function(){var e={};return e[h]=s,e[d]=s,e[u]=s,z.call(e,y,b.device),T&&!e[u]&&k&&k.mobile&&(e[u]=m),T&&"Macintosh"==e[d]&&g&&typeof g.standalone!==n&&g.maxTouchPoints&&g.maxTouchPoints>2&&(e[d]="iPad",e[u]=f),e},this.getEngine=function(){var e={};return e[c]=s,e[p]=s,z.call(e,y,b.engine),e},this.getOS=function(){var e={};return e[c]=s,e[p]=s,z.call(e,y,b.os),T&&!e[c]&&k&&k.platform&&"Unknown"!=k.platform&&(e[c]=k.platform.replace(/chrome os/i,F).replace(/macos/i,j)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return y},this.setUA=function(e){return y=typeof e===o&&e.length>500?W(e,500):e,this},this.setUA(y),this};Y.VERSION="1.0.40",Y.BROWSER=V([c,p,l]),Y.CPU=V([v]),Y.DEVICE=V([d,h,u,g,m,y,f,k,b]),Y.ENGINE=Y.OS=V([c,p]),typeof t!==n?(e.exports&&(t=e.exports=Y),t.UAParser=Y):typeof define===r&&define.amd?define(function(){return Y}):typeof i!==n&&(i.UAParser=Y);var X=typeof i!==n&&(i.jQuery||i.Zepto);if(X&&!X.ua){var Z=new Y;X.ua=Z.getResult(),X.ua.get=function(){return Z.getUA()},X.ua.set=function(e){Z.setUA(e);var t=Z.getResult();for(var i in t)X.ua[i]=t[i]}}}("object"==typeof window?window:this)}),O("6cqMT",function(e,t){var i,s,r,n="__lodash_hash_undefined__",a="[object Arguments]",o="[object Array]",l="[object Boolean]",d="[object Date]",c="[object Error]",u="[object Function]",h="[object Map]",p="[object Number]",v="[object Object]",g="[object Promise]",m="[object RegExp]",f="[object Set]",y="[object String]",k="[object WeakMap]",b="[object ArrayBuffer]",T="[object DataView]",S=/^\[object .+?Constructor\]$/,w=/^(?:0|[1-9]\d*)$/,P={};P["[object Float32Array]"]=P["[object Float64Array]"]=P["[object Int8Array]"]=P["[object Int16Array]"]=P["[object Int32Array]"]=P["[object Uint8Array]"]=P["[object Uint8ClampedArray]"]=P["[object Uint16Array]"]=P["[object Uint32Array]"]=!0,P[a]=P[o]=P[b]=P[l]=P[T]=P[d]=P[c]=P[u]=P[h]=P[p]=P[v]=P[m]=P[f]=P[y]=P[k]=!1;var C="object"==typeof A&&A&&A.Object===Object&&A,E="object"==typeof self&&self&&self.Object===Object&&self,I=C||E||Function("return this")(),R=t&&!t.nodeType&&t,_=R&&e&&!e.nodeType&&e,L=_&&_.exports===R,M=L&&C.process,D=function(){try{return M&&M.binding&&M.binding("util")}catch(e){}}(),O=D&&D.isTypedArray;function N(e){var t=-1,i=Array(e.size);return e.forEach(function(e,s){i[++t]=[s,e]}),i}function x(e){var t=-1,i=Array(e.size);return e.forEach(function(e){i[++t]=e}),i}var U=Array.prototype,B=Function.prototype,F=Object.prototype,j=I["__core-js_shared__"],$=B.toString,G=F.hasOwnProperty,V=(i=/[^.]+$/.exec(j&&j.keys&&j.keys.IE_PROTO||""))?"Symbol(src)_1."+i:"",q=F.toString,H=RegExp("^"+$.call(G).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),W=L?I.Buffer:void 0,z=I.Symbol,K=I.Uint8Array,J=F.propertyIsEnumerable,Q=U.splice,Y=z?z.toStringTag:void 0,X=Object.getOwnPropertySymbols,Z=W?W.isBuffer:void 0,ee=(s=Object.keys,r=Object,function(e){return s(r(e))}),et=eC(I,"DataView"),ei=eC(I,"Map"),es=eC(I,"Promise"),er=eC(I,"Set"),en=eC(I,"WeakMap"),ea=eC(Object,"create"),eo=eA(et),el=eA(ei),ed=eA(es),ec=eA(er),eu=eA(en),eh=z?z.prototype:void 0,ep=eh?eh.valueOf:void 0;function ev(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var s=e[t];this.set(s[0],s[1])}}function eg(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var s=e[t];this.set(s[0],s[1])}}function em(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var s=e[t];this.set(s[0],s[1])}}function ef(e){var t=-1,i=null==e?0:e.length;for(this.__data__=new em;++t<i;)this.add(e[t])}function ey(e){var t=this.__data__=new eg(e);this.size=t.size}function ek(e,t){for(var i=e.length;i--;)if(eR(e[i][0],t))return i;return -1}function eb(e){var t;return null==e?void 0===e?"[object Undefined]":"[object Null]":Y&&Y in Object(e)?function(e){var t=G.call(e,Y),i=e[Y];try{e[Y]=void 0;var s=!0}catch(e){}var r=q.call(e);return s&&(t?e[Y]=i:delete e[Y]),r}(e):(t=e,q.call(t))}function eT(e){return ex(e)&&eb(e)==a}function eS(e,t,i,s,r,n){var a=1&i,o=e.length,l=t.length;if(o!=l&&!(a&&l>o))return!1;var d=n.get(e);if(d&&n.get(t))return d==t;var c=-1,u=!0,h=2&i?new ef:void 0;for(n.set(e,t),n.set(t,e);++c<o;){var p=e[c],v=t[c];if(s)var g=a?s(v,p,c,t,e,n):s(p,v,c,e,t,n);if(void 0!==g){if(g)continue;u=!1;break}if(h){if(!function(e,t){for(var i=-1,s=null==e?0:e.length;++i<s;)if(t(e[i],i,e))return!0;return!1}(t,function(e,t){if(!h.has(t)&&(p===e||r(p,e,i,s,n)))return h.push(t)})){u=!1;break}}else if(!(p===v||r(p,v,i,s,n))){u=!1;break}}return n.delete(e),n.delete(t),u}function ew(e){var t;return t=eB(e),eL(e)?t:function(e,t){for(var i=-1,s=t.length,r=e.length;++i<s;)e[r+i]=t[i];return e}(t,eE(e))}function eP(e,t){var i,s,r=e.__data__;return("string"==(s=typeof(i=t))||"number"==s||"symbol"==s||"boolean"==s?"__proto__"!==i:null===i)?r["string"==typeof t?"string":"hash"]:r.map}function eC(e,t){var i,s=null==e?void 0:e[t];return!(!eN(s)||(i=s,V&&V in i))&&(eD(s)?H:S).test(eA(s))?s:void 0}ev.prototype.clear=function(){this.__data__=ea?ea(null):{},this.size=0},ev.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=!!t,t},ev.prototype.get=function(e){var t=this.__data__;if(ea){var i=t[e];return i===n?void 0:i}return G.call(t,e)?t[e]:void 0},ev.prototype.has=function(e){var t=this.__data__;return ea?void 0!==t[e]:G.call(t,e)},ev.prototype.set=function(e,t){var i=this.__data__;return this.size+=+!this.has(e),i[e]=ea&&void 0===t?n:t,this},eg.prototype.clear=function(){this.__data__=[],this.size=0},eg.prototype.delete=function(e){var t=this.__data__,i=ek(t,e);return!(i<0)&&(i==t.length-1?t.pop():Q.call(t,i,1),--this.size,!0)},eg.prototype.get=function(e){var t=this.__data__,i=ek(t,e);return i<0?void 0:t[i][1]},eg.prototype.has=function(e){return ek(this.__data__,e)>-1},eg.prototype.set=function(e,t){var i=this.__data__,s=ek(i,e);return s<0?(++this.size,i.push([e,t])):i[s][1]=t,this},em.prototype.clear=function(){this.size=0,this.__data__={hash:new ev,map:new(ei||eg),string:new ev}},em.prototype.delete=function(e){var t=eP(this,e).delete(e);return this.size-=!!t,t},em.prototype.get=function(e){return eP(this,e).get(e)},em.prototype.has=function(e){return eP(this,e).has(e)},em.prototype.set=function(e,t){var i=eP(this,e),s=i.size;return i.set(e,t),this.size+=+(i.size!=s),this},ef.prototype.add=ef.prototype.push=function(e){return this.__data__.set(e,n),this},ef.prototype.has=function(e){return this.__data__.has(e)},ey.prototype.clear=function(){this.__data__=new eg,this.size=0},ey.prototype.delete=function(e){var t=this.__data__,i=t.delete(e);return this.size=t.size,i},ey.prototype.get=function(e){return this.__data__.get(e)},ey.prototype.has=function(e){return this.__data__.has(e)},ey.prototype.set=function(e,t){var i=this.__data__;if(i instanceof eg){var s=i.__data__;if(!ei||s.length<199)return s.push([e,t]),this.size=++i.size,this;i=this.__data__=new em(s)}return i.set(e,t),this.size=i.size,this};var eE=X?function(e){return null==e?[]:function(e,t){for(var i=-1,s=null==e?0:e.length,r=0,n=[];++i<s;){var a=e[i];t(a,i,e)&&(n[r++]=a)}return n}(X(e=Object(e)),function(t){return J.call(e,t)})}:function(){return[]},eI=eb;function eA(e){if(null!=e){try{return $.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function eR(e,t){return e===t||e!=e&&t!=t}(et&&eI(new et(new ArrayBuffer(1)))!=T||ei&&eI(new ei)!=h||es&&eI(es.resolve())!=g||er&&eI(new er)!=f||en&&eI(new en)!=k)&&(eI=function(e){var t=eb(e),i=t==v?e.constructor:void 0,s=i?eA(i):"";if(s)switch(s){case eo:return T;case el:return h;case ed:return g;case ec:return f;case eu:return k}return t});var e_=eT(function(){return arguments}())?eT:function(e){return ex(e)&&G.call(e,"callee")&&!J.call(e,"callee")},eL=Array.isArray,eM=Z||function(){return!1};function eD(e){if(!eN(e))return!1;var t=eb(e);return t==u||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}function eO(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=0x1fffffffffffff}function eN(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function ex(e){return null!=e&&"object"==typeof e}var eU=O?function(e){return O(e)}:function(e){return ex(e)&&eO(e.length)&&!!P[eb(e)]};function eB(e){return null!=e&&eO(e.length)&&!eD(e)?function(e,t){var i,s,r=eL(e),n=!r&&e_(e),a=!r&&!n&&eM(e),o=!r&&!n&&!a&&eU(e),l=r||n||a||o,d=l?function(e,t){for(var i=-1,s=Array(e);++i<e;)s[i]=t(i);return s}(e.length,String):[],c=d.length;for(var u in e){G.call(e,u)&&!(l&&("length"==u||a&&("offset"==u||"parent"==u)||o&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||(i=u,(s=null==(s=c)?0x1fffffffffffff:s)&&("number"==typeof i||w.test(i))&&i>-1&&i%1==0&&i<s)))&&d.push(u)}return d}(e):function(e){if(i=(t=e)&&t.constructor,t!==("function"==typeof i&&i.prototype||F))return ee(e);var t,i,s=[];for(var r in Object(e))G.call(e,r)&&"constructor"!=r&&s.push(r);return s}(e)}e.exports=function(e,t){return function e(t,i,s,r,n){return t===i||(null!=t&&null!=i&&(ex(t)||ex(i))?function(e,t,i,s,r,n){var u=eL(e),g=eL(t),k=u?o:eI(e),S=g?o:eI(t);k=k==a?v:k,S=S==a?v:S;var w=k==v,P=S==v,C=k==S;if(C&&eM(e)){if(!eM(t))return!1;u=!0,w=!1}if(C&&!w)return n||(n=new ey),u||eU(e)?eS(e,t,i,s,r,n):function(e,t,i,s,r,n,a){switch(i){case T:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)break;e=e.buffer,t=t.buffer;case b:if(e.byteLength!=t.byteLength||!n(new K(e),new K(t)))break;return!0;case l:case d:case p:return eR(+e,+t);case c:return e.name==t.name&&e.message==t.message;case m:case y:return e==t+"";case h:var o=N;case f:var u=1&s;if(o||(o=x),e.size!=t.size&&!u)break;var v=a.get(e);if(v)return v==t;s|=2,a.set(e,t);var g=eS(o(e),o(t),s,r,n,a);return a.delete(e),g;case"[object Symbol]":if(ep)return ep.call(e)==ep.call(t)}return!1}(e,t,k,i,s,r,n);if(!(1&i)){var E=w&&G.call(e,"__wrapped__"),I=P&&G.call(t,"__wrapped__");if(E||I){var A=E?e.value():e,R=I?t.value():t;return n||(n=new ey),r(A,R,i,s,n)}}return!!C&&(n||(n=new ey),function(e,t,i,s,r,n){var a=1&i,o=ew(e),l=o.length;if(l!=ew(t).length&&!a)return!1;for(var d=l;d--;){var c=o[d];if(!(a?c in t:G.call(t,c)))return!1}var u=n.get(e);if(u&&n.get(t))return u==t;var h=!0;n.set(e,t),n.set(t,e);for(var p=a;++d<l;){var v=e[c=o[d]],g=t[c];if(s)var m=a?s(g,v,c,t,e,n):s(v,g,c,e,t,n);if(!(void 0===m?v===g||r(v,g,i,s,n):m)){h=!1;break}p||(p="constructor"==c)}if(h&&!p){var f=e.constructor,y=t.constructor;f!=y&&"constructor"in e&&"constructor"in t&&!("function"==typeof f&&f instanceof f&&"function"==typeof y&&y instanceof y)&&(h=!1)}return n.delete(e),n.delete(t),h}(e,t,i,s,r,n))}(t,i,s,r,e,n):t!=t&&i!=i)}(e,t)}}),O("i4CZ2",function(e,t){function i(e){for(var t=arguments.length,i=Array(t>1?t-1:0),s=1;s<t;s++)i[s-1]=arguments[s];throw Error("[Immer] minified error nr: "+e+(i.length?" "+i.map(function(e){return"'"+e+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function s(e){return!!e&&!!e[$]}function r(e){var t;return!!e&&(function(e){if(!e||"object"!=typeof e)return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var i=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return i===Object||"function"==typeof i&&Function.toString.call(i)===G}(e)||Array.isArray(e)||!!e[j]||!!(null==(t=e.constructor)?void 0:t[j])||d(e)||c(e))}function n(e,t,i){void 0===i&&(i=!1),0===a(e)?(i?Object.keys:V)(e).forEach(function(s){i&&"symbol"==typeof s||t(s,e[s],e)}):e.forEach(function(i,s){return t(s,i,e)})}function a(e){var t=e[$];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:d(e)?2:3*!!c(e)}function o(e,t){return 2===a(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function l(e,t,i){var s=a(e);2===s?e.set(t,i):3===s?e.add(i):e[t]=i}function d(e){return x&&e instanceof Map}function c(e){return U&&e instanceof Set}function u(e){return e.o||e.t}function h(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=q(e);delete t[$];for(var i=V(t),s=0;s<i.length;s++){var r=i[s],n=t[r];!1===n.writable&&(n.writable=!0,n.configurable=!0),(n.get||n.set)&&(t[r]={configurable:!0,writable:!0,enumerable:n.enumerable,value:e[r]})}return Object.create(Object.getPrototypeOf(e),t)}function p(e,t){return void 0===t&&(t=!1),g(e)||s(e)||!r(e)||(a(e)>1&&(e.set=e.add=e.clear=e.delete=v),Object.freeze(e),t&&n(e,function(e,t){return p(t,!0)},!0)),e}function v(){i(2)}function g(e){return null==e||"object"!=typeof e||Object.isFrozen(e)}function m(e){var t=H[e];return t||i(18,e),t}R(e.exports,"produce",()=>J);function f(e,t){t&&(m("Patches"),e.u=[],e.s=[],e.v=t)}function y(e){k(e),e.p.forEach(T),e.p=null}function k(e){e===O&&(O=e.l)}function b(e){return O={p:[],l:O,h:e,m:!0,_:0}}function T(e){var t=e[$];0===t.i||1===t.i?t.j():t.g=!0}function S(e,t){t._=t.p.length;var s=t.p[0],n=void 0!==e&&e!==s;return t.h.O||m("ES5").S(t,e,n),n?(s[$].P&&(y(t),i(4)),r(e)&&(e=w(t,e),t.l||C(t,e)),t.u&&m("Patches").M(s[$].t,e,t.u,t.s)):e=w(t,s,[]),y(t),t.u&&t.v(t.u,t.s),e!==F?e:void 0}function w(e,t,i){if(g(t))return t;var s=t[$];if(!s)return n(t,function(r,n){return P(e,s,t,r,n,i)},!0),t;if(s.A!==e)return t;if(!s.P)return C(e,s.t,!0),s.t;if(!s.I){s.I=!0,s.A._--;var r=4===s.i||5===s.i?s.o=h(s.k):s.o,a=r,o=!1;3===s.i&&(a=new Set(r),r.clear(),o=!0),n(a,function(t,n){return P(e,s,r,t,n,i,o)}),C(e,r,!1),i&&e.u&&m("Patches").N(s,i,e.u,e.s)}return s.o}function P(e,t,i,n,a,d,c){if(s(a)){var u=w(e,a,d&&t&&3!==t.i&&!o(t.R,n)?d.concat(n):void 0);if(l(i,n,u),!s(u))return;e.m=!1}else c&&i.add(a);if(r(a)&&!g(a)){if(!e.h.D&&e._<1)return;w(e,a),t&&t.A.l||C(e,a)}}function C(e,t,i){void 0===i&&(i=!1),!e.l&&e.h.D&&e.m&&p(t,i)}function E(e,t){var i=e[$];return(i?u(i):e)[t]}function I(e,t){if(t in e)for(var i=Object.getPrototypeOf(e);i;){var s=Object.getOwnPropertyDescriptor(i,t);if(s)return s;i=Object.getPrototypeOf(i)}}function A(e){e.P||(e.P=!0,e.l&&A(e.l))}function _(e){e.o||(e.o=h(e.t))}function L(e,t,i){var s,r,n,a,o,l,u,h=d(t)?m("MapSet").F(t,i):c(t)?m("MapSet").T(t,i):e.O?(n=r={i:+!!(s=Array.isArray(t)),A:i?i.A:O,P:!1,I:!1,R:{},l:i,t:t,k:null,o:null,j:null,C:!1},a=W,s&&(n=[r],a=z),l=(o=Proxy.revocable(n,a)).revoke,r.k=u=o.proxy,r.j=l,u):m("ES5").J(t,i);return(i?i.A:O).p.push(h),h}function M(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return h(e)}var D,O,N="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),x="undefined"!=typeof Map,U="undefined"!=typeof Set,B="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,F=N?Symbol.for("immer-nothing"):((D={})["immer-nothing"]=!0,D),j=N?Symbol.for("immer-draftable"):"__$immer_draftable",$=N?Symbol.for("immer-state"):"__$immer_state",G=""+Object.prototype.constructor,V="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,q=Object.getOwnPropertyDescriptors||function(e){var t={};return V(e).forEach(function(i){t[i]=Object.getOwnPropertyDescriptor(e,i)}),t},H={},W={get:function(e,t){if(t===$)return e;var i,s,n=u(e);if(!o(n,t))return(s=I(n,t))?"value"in s?s.value:null==(i=s.get)?void 0:i.call(e.k):void 0;var a=n[t];return e.I||!r(a)?a:a===E(e.t,t)?(_(e),e.o[t]=L(e.A.h,a,e)):a},has:function(e,t){return t in u(e)},ownKeys:function(e){return Reflect.ownKeys(u(e))},set:function(e,t,i){var s=I(u(e),t);if(null==s?void 0:s.set)return s.set.call(e.k,i),!0;if(!e.P){var r=E(u(e),t),n=null==r?void 0:r[$];if(n&&n.t===i)return e.o[t]=i,e.R[t]=!1,!0;if((i===r?0!==i||1/i==1/r:i!=i&&r!=r)&&(void 0!==i||o(e.t,t)))return!0;_(e),A(e)}return e.o[t]===i&&(void 0!==i||t in e.o)||Number.isNaN(i)&&Number.isNaN(e.o[t])||(e.o[t]=i,e.R[t]=!0),!0},deleteProperty:function(e,t){return void 0!==E(e.t,t)||t in e.t?(e.R[t]=!1,_(e),A(e)):delete e.R[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var i=u(e),s=Reflect.getOwnPropertyDescriptor(i,t);return s?{writable:!0,configurable:1!==e.i||"length"!==t,enumerable:s.enumerable,value:i[t]}:s},defineProperty:function(){i(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){i(12)}},z={};n(W,function(e,t){z[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),z.deleteProperty=function(e,t){return z.set.call(this,e,t,void 0)},z.set=function(e,t,i){return W.set.call(this,e[0],t,i,e[0])};var K=new(function(){function e(e){var t=this;this.O=B,this.D=!0,this.produce=function(e,s,n){if("function"==typeof e&&"function"!=typeof s){var a,o=s;return s=e,function(e){var i=this;void 0===e&&(e=o);for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return t.produce(e,function(e){var t;return(t=s).call.apply(t,[i,e].concat(n))})}}if("function"!=typeof s&&i(6),void 0!==n&&"function"!=typeof n&&i(7),r(e)){var l=b(t),d=L(t,e,void 0),c=!0;try{a=s(d),c=!1}finally{c?y(l):k(l)}return"undefined"!=typeof Promise&&a instanceof Promise?a.then(function(e){return f(l,n),S(e,l)},function(e){throw y(l),e}):(f(l,n),S(a,l))}if(!e||"object"!=typeof e){if(void 0===(a=s(e))&&(a=e),a===F&&(a=void 0),t.D&&p(a,!0),n){var u=[],h=[];m("Patches").M(e,a,u,h),n(u,h)}return a}i(21,e)},this.produceWithPatches=function(e,i){if("function"==typeof e)return function(i){for(var s=arguments.length,r=Array(s>1?s-1:0),n=1;n<s;n++)r[n-1]=arguments[n];return t.produceWithPatches(i,function(t){return e.apply(void 0,[t].concat(r))})};var s,r,n=t.produce(e,i,function(e,t){s=e,r=t});return"undefined"!=typeof Promise&&n instanceof Promise?n.then(function(e){return[e,s,r]}):[n,s,r]},"boolean"==typeof(null==e?void 0:e.useProxies)&&this.setUseProxies(e.useProxies),"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze)}var t=e.prototype;return t.createDraft=function(e){r(e)||i(8),s(e)&&(s(t=e)||i(22,t),e=function e(t){if(!r(t))return t;var i,s=t[$],o=a(t);if(s){if(!s.P&&(s.i<4||!m("ES5").K(s)))return s.t;s.I=!0,i=M(t,o),s.I=!1}else i=M(t,o);return n(i,function(t,r){var n;s&&(n=s.t,(2===a(n)?n.get(t):n[t])===r)||l(i,t,e(r))}),3===o?new Set(i):i}(t));var t,o=b(this),d=L(this,e,void 0);return d[$].C=!0,k(o),d},t.finishDraft=function(e,t){var i=(e&&e[$]).A;return f(i,t),S(void 0,i)},t.setAutoFreeze=function(e){this.D=e},t.setUseProxies=function(e){e&&!B&&i(20),this.O=e},t.applyPatches=function(e,t){for(i=t.length-1;i>=0;i--){var i,r=t[i];if(0===r.path.length&&"replace"===r.op){e=r.value;break}}i>-1&&(t=t.slice(i+1));var n=m("Patches").$;return s(e)?n(e,t):this.produce(e,function(e){return n(e,t)})},e}()),J=K.produce;K.produceWithPatches.bind(K),K.setAutoFreeze.bind(K),K.setUseProxies.bind(K),K.applyPatches.bind(K),K.createDraft.bind(K),K.finishDraft.bind(K)});for(var x=function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),s=1;s<t;s++)i[s-1]=arguments[s];return function(){for(var t=arguments.length,s=Array(t),r=0;r<t;r++)s[r]=arguments[r];var n=0,a=s.pop(),o=function(e){var t=Array.isArray(e[0])?e[0]:e;if(!t.every(function(e){return"function"==typeof e}))throw Error("Selector creators expect all input-selectors to be functions, instead received the following types: ["+t.map(function(e){return typeof e}).join(", ")+"]");return t}(s),l=e.apply(void 0,[function(){return n++,a.apply(null,arguments)}].concat(i)),d=e(function(){for(var e=[],t=o.length,i=0;i<t;i++)e.push(o[i].apply(null,arguments));return l.apply(null,e)});return d.resultFunc=a,d.dependencies=o,d.recomputations=function(){return n},d.resetRecomputations=function(){return n=0},d}}(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:N,i=null,s=null;return function(){return!function(e,t,i){if(null===t||null===i||t.length!==i.length)return!1;for(var s=t.length,r=0;r<s;r++)if(!e(t[r],i[r]))return!1;return!0}(t,i,arguments)&&(s=e.apply(null,arguments)),i=arguments,s}}),U=D("86Wyx"),B=new Uint8Array(16),F=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,j=[],$=0;$<256;++$)j.push(($+256).toString(16).substr(1));var G=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(j[e[t+0]]+j[e[t+1]]+j[e[t+2]]+j[e[t+3]]+"-"+j[e[t+4]]+j[e[t+5]]+"-"+j[e[t+6]]+j[e[t+7]]+"-"+j[e[t+8]]+j[e[t+9]]+"-"+j[e[t+10]]+j[e[t+11]]+j[e[t+12]]+j[e[t+13]]+j[e[t+14]]+j[e[t+15]]).toLowerCase();if(!("string"==typeof i&&F.test(i)))throw TypeError("Stringified UUID is invalid");return i},V=function(e,t,i){var s=(e=e||{}).random||(e.rng||function(){if(!tq&&!(tq="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return tq(B)})();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){i=i||0;for(var r=0;r<16;++r)t[i+r]=s[r];return t}return G(s)},q=D("6cqMT");let H=!0,W=!0;function z(e,t,i){let s=e.match(t);return s&&s.length>=i&&parseFloat(s[i],10)}function K(e,t,i){if(!e.RTCPeerConnection)return;let s=e.RTCPeerConnection.prototype,r=s.addEventListener;s.addEventListener=function(e,s){if(e!==t)return r.apply(this,arguments);let n=e=>{let t=i(e);t&&(s.handleEvent?s.handleEvent(t):s(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(s,n),r.apply(this,[e,n])};let n=s.removeEventListener;s.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t]||!this._eventMap[t].has(i))return n.apply(this,arguments);let s=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,n.apply(this,[e,s])},Object.defineProperty(s,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function J(e){return"boolean"!=typeof e?Error("Argument type: "+typeof e+". Please use a boolean."):(H=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function Q(e){return"boolean"!=typeof e?Error("Argument type: "+typeof e+". Please use a boolean."):(W=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function Y(){"object"==typeof window&&(H||"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments))}function X(e,t){W&&console.warn(e+" is deprecated, please use "+t+" instead.")}function Z(e){return"[object Object]"===Object.prototype.toString.call(e)}function ee(e,t,i){let s=i?"outbound-rtp":"inbound-rtp",r=new Map;if(null===t)return r;let n=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&n.push(e)}),n.forEach(t=>{e.forEach(i=>{i.type===s&&i.trackId===t.id&&function e(t,i,s){!i||s.has(i.id)||(s.set(i.id,i),Object.keys(i).forEach(r=>{r.endsWith("Id")?e(t,t.get(i[r]),s):r.endsWith("Ids")&&i[r].forEach(i=>{e(t,t.get(i),s)})}))}(e,i,r)})}),r}var et={};function ei(e,t){let i=e&&e.navigator;if(!i.mediaDevices)return;let s=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;let t={};return Object.keys(e).forEach(i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;let s="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==s.exact&&"number"==typeof s.exact&&(s.min=s.max=s.exact);let r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==s.ideal){t.optional=t.optional||[];let e={};"number"==typeof s.ideal?(e[r("min",i)]=s.ideal,t.optional.push(e),(e={})[r("max",i)]=s.ideal):e[r("",i)]=s.ideal,t.optional.push(e)}void 0!==s.exact&&"number"!=typeof s.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",i)]=s.exact):["min","max"].forEach(e=>{void 0!==s[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,i)]=s[e])})}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},r=function(e,r){if(t.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){let t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=s(e.audio)}if(e&&"object"==typeof e.video){let n=e.video.facingMode;n=n&&("object"==typeof n?n:{ideal:n});let a=t.version<66;if(n&&("user"===n.exact||"environment"===n.exact||"user"===n.ideal||"environment"===n.ideal)&&!(i.mediaDevices.getSupportedConstraints&&i.mediaDevices.getSupportedConstraints().facingMode&&!a)){let t;if(delete e.video.facingMode,"environment"===n.exact||"environment"===n.ideal?t=["back","rear"]:("user"===n.exact||"user"===n.ideal)&&(t=["front"]),t)return i.mediaDevices.enumerateDevices().then(i=>{let a=(i=i.filter(e=>"videoinput"===e.kind)).find(e=>t.some(t=>e.label.toLowerCase().includes(t)));return!a&&i.length&&t.includes("back")&&(a=i[i.length-1]),a&&(e.video.deviceId=n.exact?{exact:a.deviceId}:{ideal:a.deviceId}),e.video=s(e.video),Y("chrome: "+JSON.stringify(e)),r(e)})}e.video=s(e.video)}return Y("chrome: "+JSON.stringify(e)),r(e)},n=function(e){return t.version>=64?e:{name:({PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"})[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=(function(e,t,s){r(e,e=>{i.webkitGetUserMedia(e,t,e=>{s&&s(n(e))})})}).bind(i),i.mediaDevices.getUserMedia){let e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return r(t,t=>e(t).then(e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(e=>{e.stop()}),new DOMException("","NotFoundError");return e},e=>Promise.reject(n(e))))}}}function es(e,t){if((!e.navigator.mediaDevices||!("getDisplayMedia"in e.navigator.mediaDevices))&&e.navigator.mediaDevices){if("function"!=typeof t)return void console.error("shimGetDisplayMedia: getSourceId argument is not a function");e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(t=>{let s=i.video&&i.video.width,r=i.video&&i.video.height,n=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:n||3}},s&&(i.video.mandatory.maxWidth=s),r&&(i.video.mandatory.maxHeight=r),e.navigator.mediaDevices.getUserMedia(i)})}}}function er(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function en(e){if("object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)K(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e));else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});let t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",i=>{let s;s=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===i.track.id):{track:i.track};let r=new Event("track");r.track=i.track,r.receiver=s,r.transceiver={receiver:s},r.streams=[t.stream],this.dispatchEvent(r)}),t.stream.getTracks().forEach(i=>{let s;s=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===i.id):{track:i};let r=new Event("track");r.track=i,r.receiver=s,r.transceiver={receiver:s},r.streams=[t.stream],this.dispatchEvent(r)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}}function ea(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){let t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,s){let r=i.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};let s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){s.apply(this,arguments);let t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}let i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e))})};let s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],s.apply(this,[e]),e.getTracks().forEach(e=>{let t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){let t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){let e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function eo(e){if(!e.RTCPeerConnection)return;let t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){let[e,i,s]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0==arguments.length||"function"!=typeof e))return t.apply(this,[]);let r=function(e){let t={};return e.result().forEach(e=>{let i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(t=>{i[t]=e.stat(t)}),t[i.id]=i}),t},n=function(e){return new Map(Object.keys(e).map(t=>[t,e[t]]))};return arguments.length>=2?t.apply(this,[function(e){i(n(r(e)))},e]):new Promise((e,i)=>{t.apply(this,[function(t){e(n(r(t)))},i])}).then(i,s)}}function el(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){let t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){let e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});let i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){let e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){let e=this;return this._pc.getStats().then(t=>ee(t,e.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){let t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){let e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),K(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){let e=this;return this._pc.getStats().then(t=>ee(t,e.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype))return;let t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){let e,t,i,s=arguments[0];return(this.getSenders().forEach(t=>{t.track===s&&(e?i=!0:e=t)}),this.getReceivers().forEach(e=>(e.track===s&&(t?i=!0:t=e),e.track===s)),i||e&&t)?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):e?e.getStats():t?t.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function ed(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};let t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let s=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(s)&&this._shimmedLocalStreams[i.id].push(s):this._shimmedLocalStreams[i.id]=[i,s],s};let i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});let t=this.getSenders();i.apply(this,arguments);let s=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(s)};let s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],s.apply(this,arguments)};let r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{let i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]}),r.apply(this,arguments)}}function ec(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return ed(e);let i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){let e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};let s=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){let i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}s.apply(this,[t])};let r=e.RTCPeerConnection.prototype.removeStream;function n(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{let s=e._reverseStreams[t],r=e._streams[s.id];i=i.replace(RegExp(r.id,"g"),s.id)}),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let s=[].slice.call(arguments,1);if(1!==s.length||!s[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(e=>e.track===t))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let r=this._streams[i.id];if(r)r.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let s=new e.MediaStream([t]);this._streams[i.id]=s,this._reverseStreams[s.id]=i,this.addStream(s)}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach(function(t){let i=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=({[t](){let e=arguments,t=arguments.length&&"function"==typeof arguments[0];return t?i.apply(this,[t=>{let i=n(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then(e=>n(this,e))}})[t]});let a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){var e,t;let i;return arguments.length&&arguments[0].type?(arguments[0]=(e=this,t=arguments[0],i=t.sdp,Object.keys(e._reverseStreams||[]).forEach(t=>{let s=e._reverseStreams[t],r=e._streams[s.id];i=i.replace(RegExp(s.id,"g"),r.id)}),new RTCSessionDescription({type:t.type,sdp:i})),a.apply(this,arguments)):a.apply(this,arguments)};let o=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){let e=o.get.apply(this);return""===e.type?e:n(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){let t;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{},Object.keys(this._streams).forEach(i=>{this._streams[i].getTracks().find(t=>e.track===t)&&(t=this._streams[i])}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function eu(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){let i=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=({[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}})[t]})}function eh(e,t){K(e,"negotiationneeded",e=>{let i=e.target;if(!(t.version<72)&&(!i.getConfiguration||"plan-b"!==i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e})}R(et,"shimMediaStream",()=>er),R(et,"shimOnTrack",()=>en),R(et,"shimGetSendersWithDtmf",()=>ea),R(et,"shimGetStats",()=>eo),R(et,"shimSenderReceiverGetStats",()=>el),R(et,"shimAddTrackRemoveTrackWithNative",()=>ed),R(et,"shimAddTrackRemoveTrack",()=>ec),R(et,"shimPeerConnection",()=>eu),R(et,"fixNegotiationNeeded",()=>eh),R(et,"shimGetUserMedia",()=>ei),R(et,"shimGetDisplayMedia",()=>es);var ep={};function ev(e,t){let i=e&&e.navigator,s=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,s){X("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,s)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){let e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(e((i=JSON.parse(JSON.stringify(i))).audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},s&&s.prototype.getSettings){let t=s.prototype.getSettings;s.prototype.getSettings=function(){let i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(s&&s.prototype.applyConstraints){let t=s.prototype.applyConstraints;s.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(e(i=JSON.parse(JSON.stringify(i)),"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function eg(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){let e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}function em(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ef(e,t){if("object"!=typeof e||!(e.RTCPeerConnection||e.mozRTCPeerConnection))return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){let i=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=({[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}})[t]});let i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){let[e,r,n]=arguments;return s.apply(this,[e||null]).then(e=>{if(t.version<53&&!r)try{e.forEach(e=>{e.type=i[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach((t,s)=>{e.set(s,Object.assign({},t,{type:i[t.type]||t.type}))})}return e}).then(r,n)}}function ey(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender)||e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;let t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){let e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});let i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){let e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function ek(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender)||e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;let t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){let e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),K(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function eb(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){X("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function eT(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function eS(e){if(!("object"==typeof e&&e.RTCPeerConnection))return;let t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]);let i=(e=[...e]).length>0;i&&e.forEach(e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw RangeError("max_framerate must be >= 0.0")});let s=t.apply(this,arguments);if(i){let{sender:t}=s,i=t.getParameters();"encodings"in i&&(1!==i.encodings.length||0!==Object.keys(i.encodings[0]).length)||(i.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(i).then(()=>{delete t.sendEncodings}).catch(()=>{delete t.sendEncodings})))}return s})}function ew(e){if(!("object"==typeof e&&e.RTCRtpSender))return;let t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){let e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function eP(e){if(!("object"==typeof e&&e.RTCPeerConnection))return;let t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function eC(e){if(!("object"==typeof e&&e.RTCPeerConnection))return;let t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}R(ep,"shimOnTrack",()=>em),R(ep,"shimPeerConnection",()=>ef),R(ep,"shimSenderGetStats",()=>ey),R(ep,"shimReceiverGetStats",()=>ek),R(ep,"shimRemoveStream",()=>eb),R(ep,"shimRTCDataChannel",()=>eT),R(ep,"shimAddTransceiver",()=>eS),R(ep,"shimGetParameters",()=>ew),R(ep,"shimCreateOffer",()=>eP),R(ep,"shimCreateAnswer",()=>eC),R(ep,"shimGetUserMedia",()=>ev),R(ep,"shimGetDisplayMedia",()=>eg);var eE={};function eI(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){let t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(i=>t.call(this,i,e)),e.getVideoTracks().forEach(i=>t.call(this,i,e))},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach(e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);let t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);let i=e.getTracks();this.getSenders().forEach(e=>{i.includes(e.track)&&this.removeTrack(e)})})}}function eA(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);let t=new Event("addstream");t.stream=e,this.dispatchEvent(t)})})}});let t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){let e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);let i=new Event("addstream");i.stream=t,e.dispatchEvent(i)})}),t.apply(e,arguments)}}}function eR(e){if("object"!=typeof e||!e.RTCPeerConnection)return;let t=e.RTCPeerConnection.prototype,i=t.createOffer,s=t.createAnswer,r=t.setLocalDescription,n=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){let s=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[s]);return t?(r.then(e,t),Promise.resolve()):r},t.createAnswer=function(e,t){let i=arguments.length>=2?arguments[2]:arguments[0],r=s.apply(this,[i]);return t?(r.then(e,t),Promise.resolve()):r};let o=function(e,t,i){let s=r.apply(this,[e]);return i?(s.then(t,i),Promise.resolve()):s};t.setLocalDescription=o,t.setRemoteDescription=o=function(e,t,i){let s=n.apply(this,[e]);return i?(s.then(t,i),Promise.resolve()):s},t.addIceCandidate=function(e,t,i){let s=a.apply(this,[e]);return i?(s.then(t,i),Promise.resolve()):s}}function e_(e){let t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){let e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(eL(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(e,i,s){t.mediaDevices.getUserMedia(e).then(i,s)}).bind(t))}function eL(e){return e&&void 0!==e.video?Object.assign({},e,{video:function e(t){return Z(t)?Object.keys(t).reduce(function(i,s){let r=Z(t[s]),n=r?e(t[s]):t[s],a=r&&!Object.keys(n).length;return void 0===n||a?i:Object.assign(i,{[s]:n})},{}):t}(e.video)}):e}function eM(e){if(!e.RTCPeerConnection)return;let t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){let t=[];for(let i=0;i<e.iceServers.length;i++){let s=e.iceServers[i];void 0===s.urls&&s.url?(X("RTCIceServer.url","RTCIceServer.urls"),(s=JSON.parse(JSON.stringify(s))).urls=s.url,delete s.url,t.push(s)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function eD(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function eO(e){let t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);let t=this.getTransceivers().find(e=>"audio"===e.receiver.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);let i=this.getTransceivers().find(e=>"video"===e.receiver.track.kind);!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function eN(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}R(eE,"shimLocalStreamsAPI",()=>eI),R(eE,"shimRemoteStreamsAPI",()=>eA),R(eE,"shimCallbacksAPI",()=>eR),R(eE,"shimGetUserMedia",()=>e_),R(eE,"shimConstraints",()=>eL),R(eE,"shimRTCIceServerUrls",()=>eM),R(eE,"shimTrackEventTransceiver",()=>eD),R(eE,"shimCreateOfferLegacy",()=>eO),R(eE,"shimAudioContext",()=>eN);var ex={};R(ex,"shimRTCIceCandidate",()=>eF),R(ex,"shimRTCIceCandidateRelayProtocol",()=>ej),R(ex,"shimMaxMessageSize",()=>e$),R(ex,"shimSendThrowTypeError",()=>eG),R(ex,"shimConnectionState",()=>eV),R(ex,"removeExtmapAllowMixed",()=>eq),R(ex,"shimAddIceCandidateNullOrEmpty",()=>eH),R(ex,"shimParameterlessSetLocalDescription",()=>eW);var eU={};const eB={};function eF(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;let t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){let i=new t(e),s=_(eU).parseCandidate(e.candidate);for(let e in s)e in i||Object.defineProperty(i,e,{value:s[e]});return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,K(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t))}function ej(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||K(e,"icecandidate",e=>{if(e.candidate){let t=_(eU).parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol=({0:"tls",1:"tcp",2:"udp"})[t.priority>>24])}return e})}function e$(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});let i=function(e){if(!e||!e.sdp)return!1;let t=_(eU).splitSections(e.sdp);return t.shift(),t.some(e=>{let t=_(eU).parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},s=function(e){let t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return -1;let i=parseInt(t[1],10);return i!=i?-1:i},r=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:0x7ffffff5:t.version<60?57===t.version?65535:65536:0x7ffffff5),i},n=function(e,i){let s=65536;"firefox"===t.browser&&57===t.version&&(s=65535);let r=_(eU).matchPrefix(e.sdp,"a=max-message-size:");return r.length>0?s=parseInt(r[0].substring(19),10):"firefox"===t.browser&&-1!==i&&(s=0x7ffffff5),s},a=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){let{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){let e,t=s(arguments[0]),i=r(t),a=n(arguments[0],t);e=0===i&&0===a?1/0:0===i||0===a?Math.max(i,a):Math.min(i,a);let o={};Object.defineProperty(o,"maxMessageSize",{get:()=>e}),this._sctp=o}return a.apply(this,arguments)}}function eG(e){if(!(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){let i=e.send;e.send=function(){let s=arguments[0],r=s.length||s.size||s.byteLength;if("open"===e.readyState&&t.sctp&&r>t.sctp.maxMessageSize)throw TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}let i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){let e=i.apply(this,arguments);return t(e,this),e},K(e,"datachannel",e=>(t(e.channel,e.target),e))}function eV(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;let t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return({completed:"connected",checking:"connecting"})[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{let i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{let t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;let i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function eq(e,t){if(!e.RTCPeerConnection||"chrome"===t.browser&&t.version>=71||"safari"===t.browser&&t._safariVersion>=13.1)return;let i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){let i=t.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function eH(e,t){if(!(e.RTCPeerConnection&&e.RTCPeerConnection.prototype))return;let i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function eW(e,t){if(!(e.RTCPeerConnection&&e.RTCPeerConnection.prototype))return;let i=e.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return i.apply(this,arguments);if(!(e={type:e.type,sdp:e.sdp}).type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}return e.sdp||"offer"!==e.type&&"answer"!==e.type?i.apply(this,[e]):("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then(e=>i.apply(this,[e]))})}eB.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},eB.localCName=eB.generateIdentifier(),eB.splitLines=function(e){return e.trim().split("\n").map(e=>e.trim())},eB.splitSections=function(e){return e.split("\nm=").map((e,t)=>(t>0?"m="+e:e).trim()+"\r\n")},eB.getDescription=function(e){let t=eB.splitSections(e);return t&&t[0]},eB.getMediaSections=function(e){let t=eB.splitSections(e);return t.shift(),t},eB.matchPrefix=function(e,t){return eB.splitLines(e).filter(e=>0===e.indexOf(t))},eB.parseCandidate=function(e){let t,i={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let e=8;e<t.length;e+=2)switch(t[e]){case"raddr":i.relatedAddress=t[e+1];break;case"rport":i.relatedPort=parseInt(t[e+1],10);break;case"tcptype":i.tcpType=t[e+1];break;case"ufrag":i.ufrag=t[e+1],i.usernameFragment=t[e+1];break;default:void 0===i[t[e]]&&(i[t[e]]=t[e+1])}return i},eB.writeCandidate=function(e){let t=[];t.push(e.foundation);let i=e.component;"rtp"===i?t.push(1):"rtcp"===i?t.push(2):t.push(i),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);let s=e.type;return t.push("typ"),t.push(s),"host"!==s&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},eB.parseIceOptions=function(e){return e.substring(14).split(" ")},eB.parseRtpMap=function(e){let t=e.substring(9).split(" "),i={payloadType:parseInt(t.shift(),10)};return i.name=(t=t[0].split("/"))[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},eB.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);let i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},eB.parseExtmap=function(e){let t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},eB.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},eB.parseFmtp=function(e){let t,i={},s=e.substring(e.indexOf(" ")+1).split(";");for(let e=0;e<s.length;e++)i[(t=s[e].trim().split("="))[0].trim()]=t[1];return i},eB.writeFmtp=function(e){let t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){let s=[];Object.keys(e.parameters).forEach(t=>{void 0!==e.parameters[t]?s.push(t+"="+e.parameters[t]):s.push(t)}),t+="a=fmtp:"+i+" "+s.join(";")+"\r\n"}return t},eB.parseRtcpFb=function(e){let t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},eB.writeRtcpFb=function(e){let t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(e=>{t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},eB.parseSsrcMedia=function(e){let t=e.indexOf(" "),i={ssrc:parseInt(e.substring(7,t),10)},s=e.indexOf(":",t);return s>-1?(i.attribute=e.substring(t+1,s),i.value=e.substring(s+1)):i.attribute=e.substring(t+1),i},eB.parseSsrcGroup=function(e){let t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(e=>parseInt(e,10))}},eB.getMid=function(e){let t=eB.matchPrefix(e,"a=mid:")[0];if(t)return t.substring(6)},eB.parseFingerprint=function(e){let t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},eB.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:eB.matchPrefix(e+t,"a=fingerprint:").map(eB.parseFingerprint)}},eB.writeDtlsParameters=function(e,t){let i="a=setup:"+t+"\r\n";return e.fingerprints.forEach(e=>{i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),i},eB.parseCryptoLine=function(e){let t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},eB.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?eB.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},eB.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;let t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},eB.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},eB.getCryptoParameters=function(e,t){return eB.matchPrefix(e+t,"a=crypto:").map(eB.parseCryptoLine)},eB.getIceParameters=function(e,t){let i=eB.matchPrefix(e+t,"a=ice-ufrag:")[0],s=eB.matchPrefix(e+t,"a=ice-pwd:")[0];return i&&s?{usernameFragment:i.substring(12),password:s.substring(10)}:null},eB.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},eB.parseRtpParameters=function(e){let t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=eB.splitLines(e)[0].split(" ");t.profile=i[2];for(let s=3;s<i.length;s++){let r=i[s],n=eB.matchPrefix(e,"a=rtpmap:"+r+" ")[0];if(n){let i=eB.parseRtpMap(n),s=eB.matchPrefix(e,"a=fmtp:"+r+" ");switch(i.parameters=s.length?eB.parseFmtp(s[0]):{},i.rtcpFeedback=eB.matchPrefix(e,"a=rtcp-fb:"+r+" ").map(eB.parseRtcpFb),t.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(i.name.toUpperCase())}}}eB.matchPrefix(e,"a=extmap:").forEach(e=>{t.headerExtensions.push(eB.parseExtmap(e))});let s=eB.matchPrefix(e,"a=rtcp-fb:* ").map(eB.parseRtcpFb);return t.codecs.forEach(e=>{s.forEach(t=>{e.rtcpFeedback.find(e=>e.type===t.type&&e.parameter===t.parameter)||e.rtcpFeedback.push(t)})}),t},eB.writeRtpDescription=function(e,t){let i="";i+="m="+e+" ",i+=t.codecs.length>0?"9":"0",i+=" "+(t.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=t.codecs.map(e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(e=>{i+=eB.writeRtpMap(e),i+=eB.writeFmtp(e),i+=eB.writeRtcpFb(e)});let s=0;return t.codecs.forEach(e=>{e.maxptime>s&&(s=e.maxptime)}),s>0&&(i+="a=maxptime:"+s+"\r\n"),t.headerExtensions&&t.headerExtensions.forEach(e=>{i+=eB.writeExtmap(e)}),i},eB.parseRtpEncodingParameters=function(e){let t,i=[],s=eB.parseRtpParameters(e),r=-1!==s.fecMechanisms.indexOf("RED"),n=-1!==s.fecMechanisms.indexOf("ULPFEC"),a=eB.matchPrefix(e,"a=ssrc:").map(e=>eB.parseSsrcMedia(e)).filter(e=>"cname"===e.attribute),o=a.length>0&&a[0].ssrc,l=eB.matchPrefix(e,"a=ssrc-group:FID").map(e=>e.substring(17).split(" ").map(e=>parseInt(e,10)));l.length>0&&l[0].length>1&&l[0][0]===o&&(t=l[0][1]),s.codecs.forEach(e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let s={ssrc:o,codecPayloadType:parseInt(e.parameters.apt,10)};o&&t&&(s.rtx={ssrc:t}),i.push(s),r&&((s=JSON.parse(JSON.stringify(s))).fec={ssrc:o,mechanism:n?"red+ulpfec":"red"},i.push(s))}}),0===i.length&&o&&i.push({ssrc:o});let d=eB.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substring(7),10):0===d[0].indexOf("b=AS:")?950*parseInt(d[0].substring(5),10)-16e3:void 0,i.forEach(e=>{e.maxBitrate=d})),i},eB.parseRtcpParameters=function(e){let t={},i=eB.matchPrefix(e,"a=ssrc:").map(e=>eB.parseSsrcMedia(e)).filter(e=>"cname"===e.attribute)[0];i&&(t.cname=i.value,t.ssrc=i.ssrc);let s=eB.matchPrefix(e,"a=rtcp-rsize");return t.reducedSize=s.length>0,t.compound=0===s.length,t.mux=eB.matchPrefix(e,"a=rtcp-mux").length>0,t},eB.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},eB.parseMsid=function(e){let t,i=eB.matchPrefix(e,"a=msid:");if(1===i.length)return{stream:(t=i[0].substring(7).split(" "))[0],track:t[1]};let s=eB.matchPrefix(e,"a=ssrc:").map(e=>eB.parseSsrcMedia(e)).filter(e=>"msid"===e.attribute);if(s.length>0)return{stream:(t=s[0].value.split(" "))[0],track:t[1]}},eB.parseSctpDescription=function(e){let t,i=eB.parseMLine(e),s=eB.matchPrefix(e,"a=max-message-size:");s.length>0&&(t=parseInt(s[0].substring(19),10)),isNaN(t)&&(t=65536);let r=eB.matchPrefix(e,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substring(12),10),protocol:i.fmt,maxMessageSize:t};let n=eB.matchPrefix(e,"a=sctpmap:");if(n.length>0){let e=n[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:t}}},eB.writeSctpDescription=function(e,t){let i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},eB.generateSessionId=function(){return Math.random().toString().substr(2,22)},eB.writeSessionBoilerplate=function(e,t,i){return"v=0\r\no="+(i||"thisisadapterortc")+" "+(e||eB.generateSessionId())+" "+(void 0!==t?t:2)+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},eB.getDirection=function(e,t){let i=eB.splitLines(e);for(let e=0;e<i.length;e++)switch(i[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[e].substring(2)}return t?eB.getDirection(t):"sendrecv"},eB.getKind=function(e){return eB.splitLines(e)[0].split(" ")[0].substring(2)},eB.isRejected=function(e){return"0"===e.split(" ",2)[1]},eB.parseMLine=function(e){let t=eB.splitLines(e)[0].substring(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},eB.parseOLine=function(e){let t=eB.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},eB.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;let t=eB.splitLines(e);for(let e=0;e<t.length;e++)if(t[e].length<2||"="!==t[e].charAt(1))return!1;return!0},eU=eB;const ez=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){let i=function(e){let t={browser:null,version:null};if(void 0===e||!e.navigator||!e.navigator.userAgent)return t.browser="Not a browser.",t;let{navigator:i}=e;return i.mozGetUserMedia?(t.browser="firefox",t.version=parseInt(z(i.userAgent,/Firefox\/(\d+)\./,1))):i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection?(t.browser="chrome",t.version=parseInt(z(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2))):e.RTCPeerConnection&&i.userAgent.match(/AppleWebKit\/(\d+)\./)?(t.browser="safari",t.version=parseInt(z(i.userAgent,/AppleWebKit\/(\d+)\./,1)),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype,t._safariVersion=z(i.userAgent,/Version\/(\d+(\.?\d+))/,1)):t.browser="Not a supported browser.",t}(e),s={browserDetails:i,commonShim:ex,extractVersion:z,disableLog:J,disableWarnings:Q,sdp:eU};switch(i.browser){case"chrome":if(!et||!et.shimPeerConnection||!t.shimChrome){Y("Chrome shim is not included in this adapter release.");break}if(null===i.version){Y("Chrome shim can not determine version, not shimming.");break}Y("adapter.js shimming chrome."),s.browserShim=et,eH(e,i),eW(e,i),et.shimGetUserMedia(e,i),et.shimMediaStream(e,i),et.shimPeerConnection(e,i),et.shimOnTrack(e,i),et.shimAddTrackRemoveTrack(e,i),et.shimGetSendersWithDtmf(e,i),et.shimGetStats(e,i),et.shimSenderReceiverGetStats(e,i),et.fixNegotiationNeeded(e,i),eF(e,i),ej(e,i),eV(e,i),e$(e,i),eG(e,i),eq(e,i);break;case"firefox":if(!ep||!ep.shimPeerConnection||!t.shimFirefox){Y("Firefox shim is not included in this adapter release.");break}Y("adapter.js shimming firefox."),s.browserShim=ep,eH(e,i),eW(e,i),ep.shimGetUserMedia(e,i),ep.shimPeerConnection(e,i),ep.shimOnTrack(e,i),ep.shimRemoveStream(e,i),ep.shimSenderGetStats(e,i),ep.shimReceiverGetStats(e,i),ep.shimRTCDataChannel(e,i),ep.shimAddTransceiver(e,i),ep.shimGetParameters(e,i),ep.shimCreateOffer(e,i),ep.shimCreateAnswer(e,i),eF(e,i),eV(e,i),e$(e,i),eG(e,i);break;case"safari":if(!eE||!t.shimSafari){Y("Safari shim is not included in this adapter release.");break}Y("adapter.js shimming safari."),s.browserShim=eE,eH(e,i),eW(e,i),eE.shimRTCIceServerUrls(e,i),eE.shimCreateOfferLegacy(e,i),eE.shimCallbacksAPI(e,i),eE.shimLocalStreamsAPI(e,i),eE.shimRemoteStreamsAPI(e,i),eE.shimTrackEventTransceiver(e,i),eE.shimGetUserMedia(e,i),eE.shimAudioContext(e,i),eF(e,i),ej(e,i),e$(e,i),eG(e,i),eq(e,i);break;default:Y("Unsupported browser!")}return s}({window:"undefined"==typeof window?void 0:window});var eK={},eJ={},eQ=eJ={};function eY(){throw Error("setTimeout has not been defined")}function eX(){throw Error("clearTimeout has not been defined")}try{tH="function"==typeof setTimeout?setTimeout:eY}catch(e){tH=eY}try{tW="function"==typeof clearTimeout?clearTimeout:eX}catch(e){tW=eX}function eZ(e){if(tH===setTimeout)return setTimeout(e,0);if((tH===eY||!tH)&&setTimeout)return tH=setTimeout,setTimeout(e,0);try{return tH(e,0)}catch(t){try{return tH.call(null,e,0)}catch(t){return tH.call(this,e,0)}}}var e0=[],e1=!1,e2=-1;function e3(){e1&&tz&&(e1=!1,tz.length?e0=tz.concat(e0):e2=-1,e0.length&&e5())}function e5(){if(!e1){var e=eZ(e3);e1=!0;for(var t=e0.length;t;){for(tz=e0,e0=[];++e2<t;)tz&&tz[e2].run();e2=-1,t=e0.length}tz=null,e1=!1,function(e){if(tW===clearTimeout)return clearTimeout(e);if((tW===eX||!tW)&&clearTimeout)return tW=clearTimeout,clearTimeout(e);try{tW(e)}catch(t){try{return tW.call(null,e)}catch(t){return tW.call(this,e)}}}(e)}}function e4(e,t){this.fun=e,this.array=t}function e6(){}eQ.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];e0.push(new e4(e,t)),1!==e0.length||e1||eZ(e5)},e4.prototype.run=function(){this.fun.apply(null,this.array)},eQ.title="browser",eQ.browser=!0,eQ.env={},eQ.argv=[],eQ.version="",eQ.versions={},eQ.on=e6,eQ.addListener=e6,eQ.once=e6,eQ.off=e6,eQ.removeListener=e6,eQ.removeAllListeners=e6,eQ.emit=e6,eQ.prependListener=e6,eQ.prependOnceListener=e6,eQ.listeners=function(e){return[]},eQ.binding=function(e){throw Error("process.binding is not supported")},eQ.cwd=function(){return"/"},eQ.chdir=function(e){throw Error("process.chdir is not supported")},eQ.umask=function(){return 0},function(e){var t=Object.hasOwnProperty,i=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},s="function"==typeof Symbol,r="object"==typeof Reflect,n="function"==typeof setImmediate?setImmediate:setTimeout,a=s?r&&"function"==typeof Reflect.ownKeys?Reflect.ownKeys:function(e){var t=Object.getOwnPropertyNames(e);return t.push.apply(t,Object.getOwnPropertySymbols(e)),t}:Object.keys;function o(){this._events={},this._conf&&l.call(this,this._conf)}function l(t){t&&(this._conf=t,t.delimiter&&(this.delimiter=t.delimiter),t.maxListeners!==e&&(this._maxListeners=t.maxListeners),t.wildcard&&(this.wildcard=t.wildcard),t.newListener&&(this._newListener=t.newListener),t.removeListener&&(this._removeListener=t.removeListener),t.verboseMemoryLeak&&(this.verboseMemoryLeak=t.verboseMemoryLeak),t.ignoreErrors&&(this.ignoreErrors=t.ignoreErrors),this.wildcard&&(this.listenerTree={}))}function d(e,t){var i="(node) warning: possible EventEmitter memory leak detected. "+e+" listeners added. Use emitter.setMaxListeners() to increase limit.";this.verboseMemoryLeak&&(i+=" Event name: "+t+"."),console.error(i),console.trace&&console.trace()}var c=function(e,t,i){var s=arguments.length;switch(s){case 0:return[];case 1:return[e];case 2:return[e,t];case 3:return[e,t,i];default:for(var r=Array(s);s--;)r[s]=arguments[s];return r}};function u(t,i){for(var s={},r=t.length,n=i?i.length:0,a=0;a<r;a++)s[t[a]]=a<n?i[a]:e;return s}function h(e,t,i){if(this._emitter=e,this._target=t,this._listeners={},this._listenersCount=0,(i.on||i.off)&&(s=i.on,r=i.off),t.addEventListener?(s=t.addEventListener,r=t.removeEventListener):t.addListener?(s=t.addListener,r=t.removeListener):t.on&&(s=t.on,r=t.off),!s&&!r)throw Error("target does not implement any known event API");if("function"!=typeof s)throw TypeError("on method must be a function");if("function"!=typeof r)throw TypeError("off method must be a function");this._on=s,this._off=r;var s,r,n=e._observers;n?n.push(this):e._observers=[this]}function p(i,s,r,n){var a,o,l,d=Object.assign({},s);if(!i)return d;if("object"!=typeof i)throw TypeError("options must be an object");var c=Object.keys(i),u=c.length;function h(e){throw Error('Invalid "'+a+'" option value'+(e?". Reason: "+e:""))}for(var p=0;p<u;p++){if(a=c[p],!n&&!t.call(s,a))throw Error('Unknown "'+a+'" option');(o=i[a])!==e&&(l=r[a],d[a]=l?l(o,h):o)}return d}function v(e,t){return"function"==typeof e&&e.hasOwnProperty("prototype")||t("value must be a constructor"),e}function g(e){var t="value must be type of "+e.join("|"),i=e.length,s=e[0],r=e[1];return 1===i?function(e,i){if(typeof e===s)return e;i(t)}:2===i?function(e,i){var n=typeof e;if(n===s||n===r)return e;i(t)}:function(s,r){for(var n=typeof s,a=i;a-- >0;)if(n===e[a])return s;r(t)}}Object.assign(h.prototype,{subscribe:function(e,t,i){var s=this,r=this._target,n=this._emitter,a=this._listeners,o=function(){var s=c.apply(null,arguments),a={data:s,name:t,original:e};if(i){!1!==i.call(r,a)&&n.emit.apply(n,[a.name].concat(s));return}n.emit.apply(n,[t].concat(s))};if(a[e])throw Error("Event '"+e+"' is already listening");this._listenersCount++,n._newListener&&n._removeListener&&!s._onNewListener?(this._onNewListener=function(i){i===t&&null===a[e]&&(a[e]=o,s._on.call(r,e,o))},n.on("newListener",this._onNewListener),this._onRemoveListener=function(i){i===t&&!n.hasListeners(i)&&a[e]&&(a[e]=null,s._off.call(r,e,o))},a[e]=null,n.on("removeListener",this._onRemoveListener)):(a[e]=o,s._on.call(r,e,o))},unsubscribe:function(e){var t,i,s,r=this,n=this._listeners,o=this._emitter,l=this._off,d=this._target;if(e&&"string"!=typeof e)throw TypeError("event must be a string");function c(){r._onNewListener&&(o.off("newListener",r._onNewListener),o.off("removeListener",r._onRemoveListener),r._onNewListener=null,r._onRemoveListener=null);var e=k.call(o,r);o._observers.splice(e,1)}if(e){if(!(t=n[e]))return;l.call(d,e,t),delete n[e],--this._listenersCount||c()}else{for(s=(i=a(n)).length;s-- >0;)e=i[s],l.call(d,e,n[e]);this._listeners={},this._listenersCount=0,c()}}});var m=g(["function"]),f=g(["object","function"]);function y(e,t,i){var s,r,n,a=0,o=new e(function(l,d,c){function u(){r&&(r=null),a&&(clearTimeout(a),a=0)}s=!(i=p(i,{timeout:0,overload:!1},{timeout:function(e,t){return("number"!=typeof(e*=1)||e<0||!Number.isFinite(e))&&t("timeout must be a positive number"),e}})).overload&&"function"==typeof e.prototype.cancel&&"function"==typeof c;var h=function(e){u(),l(e)},v=function(e){u(),d(e)};s?t(h,v,c):(r=[function(e){v(e||Error("canceled"))}],t(h,v,function(e){if(n)throw Error("Unable to subscribe on cancel event asynchronously");if("function"!=typeof e)throw TypeError("onCancel callback must be a function");r.push(e)}),n=!0),i.timeout>0&&(a=setTimeout(function(){var e=Error("timeout");e.code="ETIMEDOUT",a=0,o.cancel(e),d(e)},i.timeout))});return s||(o.cancel=function(e){if(r){for(var t=r.length,i=1;i<t;i++)r[i](e);r[0](e),r=null}}),o}function k(e){var t=this._observers;if(!t)return -1;for(var i=t.length,s=0;s<i;s++)if(t[s]._target===e)return s;return -1}function b(e,t,i,s,r){if(!i)return null;if(0===s){var n=typeof t;if("string"===n){var o,l,d=0,c=0,u=this.delimiter,h=u.length;if(-1!==(l=t.indexOf(u))){o=[,,,,,];do o[d++]=t.slice(c,l),c=l+h;while(-1!==(l=t.indexOf(u,c)))o[d++]=t.slice(c),t=o,r=d}else t=[t],r=1}else"object"===n?r=t.length:(t=[t],r=1)}var p,v,g,m,f,y,k,T=null,S=t[s],w=t[s+1];if(s===r)i._listeners&&("function"==typeof i._listeners?e&&e.push(i._listeners):e&&e.push.apply(e,i._listeners),T=[i]);else if("*"===S){for(l=(y=a(i)).length;l-- >0;)"_listeners"!==(p=y[l])&&(k=b(e,t,i[p],s+1,r))&&(T?T.push.apply(T,k):T=k);return T}else if("**"===S){for((f=s+1===r||s+2===r&&"*"===w)&&i._listeners&&(T=b(e,t,i,r,r)),l=(y=a(i)).length;l-- >0;)"_listeners"!==(p=y[l])&&("*"===p||"**"===p?(i[p]._listeners&&!f&&(k=b(e,t,i[p],r,r))&&(T?T.push.apply(T,k):T=k),k=b(e,t,i[p],s,r)):k=p===w?b(e,t,i[p],s+2,r):b(e,t,i[p],s,r),k&&(T?T.push.apply(T,k):T=k));return T}else i[S]&&(T=b(e,t,i[S],s+1,r));if((v=i["*"])&&b(e,t,v,s+1,r),g=i["**"])if(s<r)for(g._listeners&&b(e,t,g,r,r),l=(y=a(g)).length;l-- >0;)"_listeners"!==(p=y[l])&&(p===w?b(e,t,g[p],s+2,r):p===S?b(e,t,g[p],s+1,r):((m={})[p]=g[p],b(e,t,{"**":m},s+1,r)));else g._listeners?b(e,t,g,r,r):g["*"]&&g["*"]._listeners&&b(e,t,g["*"],r,r);return T}function T(e,t,i){var s,r,n=0,a=0,o=this.delimiter,l=o.length;if("string"==typeof e)if(-1!==(s=e.indexOf(o))){r=[,,,,,];do r[n++]=e.slice(a,s),a=s+l;while(-1!==(s=e.indexOf(o,a)))r[n++]=e.slice(a)}else r=[e],n=1;else r=e,n=e.length;if(n>1){for(s=0;s+1<n;s++)if("**"===r[s]&&"**"===r[s+1])return}var c,u=this.listenerTree;for(s=0;s<n;s++)if(u=u[c=r[s]]||(u[c]={}),s===n-1){u._listeners?("function"==typeof u._listeners&&(u._listeners=[u._listeners]),i?u._listeners.unshift(t):u._listeners.push(t),!u._listeners.warned&&this._maxListeners>0&&u._listeners.length>this._maxListeners&&(u._listeners.warned=!0,d.call(this,u._listeners.length,c))):u._listeners=t;break}return!0}function S(e,t,i,s){for(var r,n,o,l,d=a(e),c=d.length,u=e._listeners;c-- >0;)r=e[n=d[c]],o="_listeners"===n?i:i?i.concat(n):[n],l=s||"symbol"==typeof n,u&&t.push(l?o:o.join(this.delimiter)),"object"==typeof r&&S.call(this,r,t,o,l);return t}function w(e){for(var t,i,s,r=a(e),n=r.length;n-- >0;)(t=e[i=r[n]])&&(s=!0,"_listeners"===i||w(t)||delete e[i]);return s}function P(e,t,i){this.emitter=e,this.event=t,this.listener=i}function C(t,i,s){if(!0===s)a=!0;else if(!1===s)r=!0;else{if(!s||"object"!=typeof s)throw TypeError("options should be an object or true");var r=s.async,a=s.promisify,o=s.nextTick,l=s.objectify}if(r||o||a){var d=i,c=i._origin||i;if(o&&1)throw Error("process.nextTick is not supported");a===e&&(a="AsyncFunction"===i.constructor.name),(i=function(){var e=arguments,t=this,i=this.event;return a?o?Promise.resolve():new Promise(function(e){n(e)}).then(function(){return t.event=i,d.apply(t,e)}):(o?eJ.nextTick:n)(function(){t.event=i,d.apply(t,e)})})._async=!0,i._origin=c}return[i,l?new P(this,t,i):this]}function E(e){this._events={},this._newListener=!1,this._removeListener=!1,this.verboseMemoryLeak=!1,l.call(this,e)}P.prototype.off=function(){return this.emitter.off(this.event,this.listener),this},E.EventEmitter2=E,E.prototype.listenTo=function(t,s,r){if("object"!=typeof t)throw TypeError("target musts be an object");var n=this;return r=p(r,{on:e,off:e,reducers:e},{on:m,off:m,reducers:f}),function(e){if("object"!=typeof e)throw TypeError("events must be an object");var i,s,o=r.reducers,l=k.call(n,t);i=-1===l?new h(n,t,r):n._observers[l];for(var d=a(e),c=d.length,u="function"==typeof o,p=0;p<c;p++)s=d[p],i.subscribe(s,e[s]||s,u?o:o&&o[s])}(i(s)?u(s):"string"==typeof s?u(s.split(/\s+/)):s),this},E.prototype.stopListeningTo=function(e,t){var i,s=this._observers;if(!s)return!1;var r=s.length,n=!1;if(e&&"object"!=typeof e)throw TypeError("target should be an object");for(;r-- >0;)i=s[r],e&&i._target!==e||(i.unsubscribe(t),n=!0);return n},E.prototype.delimiter=".",E.prototype.setMaxListeners=function(t){t!==e&&(this._maxListeners=t,this._conf||(this._conf={}),this._conf.maxListeners=t)},E.prototype.getMaxListeners=function(){return this._maxListeners},E.prototype.event="",E.prototype.once=function(e,t,i){return this._once(e,t,!1,i)},E.prototype.prependOnceListener=function(e,t,i){return this._once(e,t,!0,i)},E.prototype._once=function(e,t,i,s){return this._many(e,1,t,i,s)},E.prototype.many=function(e,t,i,s){return this._many(e,t,i,!1,s)},E.prototype.prependMany=function(e,t,i,s){return this._many(e,t,i,!0,s)},E.prototype._many=function(e,t,i,s,r){var n=this;if("function"!=typeof i)throw Error("many only accepts instances of Function");function a(){return 0==--t&&n.off(e,a),i.apply(this,arguments)}return a._origin=i,this._on(e,a,s,r)},E.prototype.emit=function(){if(!this._events&&!this._all)return!1;this._events||o.call(this);var e,t,i,r,n,a,l,d=arguments[0],c=this.wildcard;if("newListener"===d&&!this._newListener&&!this._events.newListener)return!1;if(c&&(l=d,"newListener"!==d&&"removeListener"!==d&&"object"==typeof d)){if(t=d.length,s){for(i=0;i<t;i++)if("symbol"==typeof d[i]){n=!0;break}}n||(d=d.join(this.delimiter))}var u=arguments.length;if(this._all&&this._all.length)for(i=0,t=(a=this._all.slice()).length;i<t;i++)switch(this.event=d,u){case 1:a[i].call(this,d);break;case 2:a[i].call(this,d,arguments[1]);break;case 3:a[i].call(this,d,arguments[1],arguments[2]);break;default:a[i].apply(this,arguments)}if(c)a=[],b.call(this,a,l,this.listenerTree,0,t);else{if("function"==typeof(a=this._events[d])){switch(this.event=d,u){case 1:a.call(this);break;case 2:a.call(this,arguments[1]);break;case 3:a.call(this,arguments[1],arguments[2]);break;default:for(r=1,e=Array(u-1);r<u;r++)e[r-1]=arguments[r];a.apply(this,e)}return!0}a&&(a=a.slice())}if(a&&a.length){if(u>3)for(r=1,e=Array(u-1);r<u;r++)e[r-1]=arguments[r];for(i=0,t=a.length;i<t;i++)switch(this.event=d,u){case 1:a[i].call(this);break;case 2:a[i].call(this,arguments[1]);break;case 3:a[i].call(this,arguments[1],arguments[2]);break;default:a[i].apply(this,e)}return!0}if(!this.ignoreErrors&&!this._all&&"error"===d)if(arguments[1]instanceof Error)throw arguments[1];else throw Error("Uncaught, unspecified 'error' event.");return!!this._all},E.prototype.emitAsync=function(){if(!this._events&&!this._all)return!1;this._events||o.call(this);var e,t,i,r,n,a,l,d=arguments[0],c=this.wildcard;if("newListener"===d&&!this._newListener&&!this._events.newListener)return Promise.resolve([!1]);if(c&&(a=d,"newListener"!==d&&"removeListener"!==d&&"object"==typeof d)){if(t=d.length,s){for(i=0;i<t;i++)if("symbol"==typeof d[i]){l=!0;break}}l||(d=d.join(this.delimiter))}var u=[],h=arguments.length;if(this._all)for(i=0,t=this._all.length;i<t;i++)switch(this.event=d,h){case 1:u.push(this._all[i].call(this,d));break;case 2:u.push(this._all[i].call(this,d,arguments[1]));break;case 3:u.push(this._all[i].call(this,d,arguments[1],arguments[2]));break;default:u.push(this._all[i].apply(this,arguments))}if(c?(n=[],b.call(this,n,a,this.listenerTree,0)):n=this._events[d],"function"==typeof n)switch(this.event=d,h){case 1:u.push(n.call(this));break;case 2:u.push(n.call(this,arguments[1]));break;case 3:u.push(n.call(this,arguments[1],arguments[2]));break;default:for(r=1,e=Array(h-1);r<h;r++)e[r-1]=arguments[r];u.push(n.apply(this,e))}else if(n&&n.length){if(n=n.slice(),h>3)for(r=1,e=Array(h-1);r<h;r++)e[r-1]=arguments[r];for(i=0,t=n.length;i<t;i++)switch(this.event=d,h){case 1:u.push(n[i].call(this));break;case 2:u.push(n[i].call(this,arguments[1]));break;case 3:u.push(n[i].call(this,arguments[1],arguments[2]));break;default:u.push(n[i].apply(this,e))}}else if(!this.ignoreErrors&&!this._all&&"error"===d)if(arguments[1]instanceof Error)return Promise.reject(arguments[1]);else return Promise.reject("Uncaught, unspecified 'error' event.");return Promise.all(u)},E.prototype.on=function(e,t,i){return this._on(e,t,!1,i)},E.prototype.prependListener=function(e,t,i){return this._on(e,t,!0,i)},E.prototype.onAny=function(e){return this._onAny(e,!1)},E.prototype.prependAny=function(e){return this._onAny(e,!0)},E.prototype.addListener=E.prototype.on,E.prototype._onAny=function(e,t){if("function"!=typeof e)throw Error("onAny only accepts instances of Function");return this._all||(this._all=[]),t?this._all.unshift(e):this._all.push(e),this},E.prototype._on=function(t,i,s,r){if("function"==typeof t)return this._onAny(t,i),this;if("function"!=typeof i)throw Error("on only accepts instances of Function");this._events||o.call(this);var n,a=this;return(r!==e&&(i=(n=C.call(this,t,i,r))[0],a=n[1]),this._newListener&&this.emit("newListener",t,i),this.wildcard)?T.call(this,t,i,s):this._events[t]?("function"==typeof this._events[t]&&(this._events[t]=[this._events[t]]),s?this._events[t].unshift(i):this._events[t].push(i),!this._events[t].warned&&this._maxListeners>0&&this._events[t].length>this._maxListeners&&(this._events[t].warned=!0,d.call(this,this._events[t].length,t))):this._events[t]=i,a},E.prototype.off=function(e,t){if("function"!=typeof t)throw Error("removeListener only takes instances of Function");var s,r=[];if(this.wildcard){var n="string"==typeof e?e.split(this.delimiter):e.slice();if(!(r=b.call(this,null,n,this.listenerTree,0)))return this}else{if(!this._events[e])return this;s=this._events[e],r.push({_listeners:s})}for(var a=0;a<r.length;a++){var o=r[a];if(i(s=o._listeners)){for(var l=-1,d=0,c=s.length;d<c;d++)if(s[d]===t||s[d].listener&&s[d].listener===t||s[d]._origin&&s[d]._origin===t){l=d;break}if(l<0)continue;return this.wildcard?o._listeners.splice(l,1):this._events[e].splice(l,1),0===s.length&&(this.wildcard?delete o._listeners:delete this._events[e]),this._removeListener&&this.emit("removeListener",e,t),this}(s===t||s.listener&&s.listener===t||s._origin&&s._origin===t)&&(this.wildcard?delete o._listeners:delete this._events[e],this._removeListener&&this.emit("removeListener",e,t))}return this.listenerTree&&w(this.listenerTree),this},E.prototype.offAny=function(e){var t,i=0,s=0;if(e&&this._all&&this._all.length>0){for(i=0,s=(t=this._all).length;i<s;i++)if(e===t[i]){t.splice(i,1),this._removeListener&&this.emit("removeListenerAny",e);break}}else{if(t=this._all,this._removeListener)for(i=0,s=t.length;i<s;i++)this.emit("removeListenerAny",t[i]);this._all=[]}return this},E.prototype.removeListener=E.prototype.off,E.prototype.removeAllListeners=function(t){if(t===e)return this._events&&o.call(this),this;if(this.wildcard){var i,s=b.call(this,null,t,this.listenerTree,0);if(!s)return this;for(i=0;i<s.length;i++)s[i]._listeners=null;this.listenerTree&&w(this.listenerTree)}else this._events&&(this._events[t]=null);return this},E.prototype.listeners=function(t){var i,s,r,n,o,l=this._events;if(t===e){if(this.wildcard)throw Error("event name required for wildcard emitter");if(!l)return[];for(n=(i=a(l)).length,r=[];n-- >0;)"function"==typeof(s=l[i[n]])?r.push(s):r.push.apply(r,s);return r}if(this.wildcard){if(!(o=this.listenerTree))return[];var d=[],c="string"==typeof t?t.split(this.delimiter):t.slice();return b.call(this,d,c,o,0),d}return l&&(s=l[t])?"function"==typeof s?[s]:s:[]},E.prototype.eventNames=function(e){var t=this._events;return this.wildcard?S.call(this,this.listenerTree,[],null,e):t?a(t):[]},E.prototype.listenerCount=function(e){return this.listeners(e).length},E.prototype.hasListeners=function(t){if(this.wildcard){var i=[],s="string"==typeof t?t.split(this.delimiter):t.slice();return b.call(this,i,s,this.listenerTree,0),i.length>0}var r=this._events,n=this._all;return!!(n&&n.length||r&&(t===e?a(r).length:r[t]))},E.prototype.listenersAny=function(){return this._all?this._all:[]},E.prototype.waitFor=function(t,i){var s=this,r=typeof i;return"number"===r?i={timeout:i}:"function"===r&&(i={filter:i}),y((i=p(i,{timeout:0,filter:e,handleError:!1,Promise:Promise,overload:!1},{filter:m,Promise:v})).Promise,function(e,r,n){function a(){var n=i.filter;if(!n||n.apply(s,arguments))if(s.off(t,a),i.handleError){var o=arguments[0];o?r(o):e(c.apply(null,arguments).slice(1))}else e(c.apply(null,arguments))}n(function(){s.off(t,a)}),s._on(t,a,!1)},{timeout:i.timeout,overload:i.overload})};var I=E.prototype;Object.defineProperties(E,{defaultMaxListeners:{get:function(){return I._maxListeners},set:function(e){if("number"!=typeof e||e<0||Number.isNaN(e))throw TypeError("n must be a non-negative number");I._maxListeners=e},enumerable:!0},once:{value:function(e,t,i){return y((i=p(i,{Promise:Promise,timeout:0,overload:!1},{Promise:v})).Promise,function(i,s,r){if("function"==typeof e.addEventListener){n=function(){i(c.apply(null,arguments))},r(function(){e.removeEventListener(t,n)}),e.addEventListener(t,n,{once:!0});return}var n,a,o=function(){a&&e.removeListener("error",a),i(c.apply(null,arguments))};"error"!==t&&(a=function(i){e.removeListener(t,o),s(i)},e.once("error",a)),r(function(){a&&e.removeListener("error",a),e.removeListener(t,o)}),e.once(t,o)},{timeout:i.timeout,overload:i.overload})},writable:!0,configurable:!0}}),Object.defineProperties(I,{_maxListeners:{value:10,writable:!0,configurable:!0},_observers:{value:null,writable:!0,configurable:!0}}),"function"==typeof define&&define.amd?define(function(){return E}):eK=E}();var e9=D("i4CZ2"),e8={};Object.defineProperty(e8,"__esModule",{value:!0}),e8.default=function(e,t){if(Object.is(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var i=Object.keys(e);if(i.length!==Object.keys(t).length)return!1;for(var s=0;s<i.length;s++)if(!Object.prototype.hasOwnProperty.call(t,i[s])||!Object.is(e[i[s]],t[i[s]]))return!1;return!0};var e7={};Object.defineProperty(e7,"__esModule",{value:!0}),e7.default=function(e){var t,i=new Set,s=function(e,s){var r="function"==typeof e?e(t):e;if(r!==t){var n=t;t=s?r:Object.assign({},t,r),i.forEach(function(e){return e(t,n)})}},r=function(){return t},n=function(e,s,n){void 0===s&&(s=r),void 0===n&&(n=Object.is);var a=s(t);function o(){var i=s(t);if(!n(a,i)){var r=a;e(a=i,r)}}return i.add(o),function(){return i.delete(o)}},a={setState:s,getState:r,subscribe:function(e,t,s){return t||s?n(e,t,s):(i.add(e),function(){return i.delete(e)})},destroy:function(){return i.clear()}};return t=e(s,r,a),a};var te=function(e){return String(Number(e))===e?Number(e):e},tt=function(e,t,i,s){if(s&&!i)t[s]=te(e[1]);else for(var r=0;r<i.length;r+=1)null!=e[r+1]&&(t[i[r]]=te(e[r+1]))},ti=function(e,t,i){var s=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:s&&!t[e.name]&&(t[e.name]={});var r=e.push?{}:s?t[e.name]:t;tt(i.match(e.reg),r,e.names,e.name),e.push&&t[e.push].push(r)},ts={},tr=ts={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=(null!=e.raddr?" raddr %s rport %d":"%v%v")+(null!=e.tcptype?" tcptype %s":"%v"),null!=e.generation&&(t+=" generation %d"),t+=(null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+((null!=e.id?"id=%s %s":"%v%s")+(null!=e.mediaClockValue?"=%s":"")+(null!=e.rateNumerator?" rate=%s":"")+(null!=e.rateDenominator?"/%s":""))}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(tr).forEach(function(e){tr[e].forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})});var tn=RegExp.prototype.test.bind(/^([a-z])=(.*)/),ta=/%[sdv%]/g,to=function(e){var t=1,i=arguments,s=i.length;return e.replace(ta,function(e){if(t>=s)return e;var r=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(r);case"%d":return Number(r);case"%v":return""}})},tl=function(e,t,i){var s=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var r=0;r<t.names.length;r+=1){var n=t.names[r];t.name?s.push(i[t.name][n]):s.push(i[t.names[r]])}else s.push(i[t.name]);return to.apply(null,s)},td=["v","o","s","i","u","e","p","c","b","t","r","z","a"],tc=["i","c","b","a"];tK=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach(function(e){null==e.payloads&&(e.payloads="")});var i=t.outerOrder||td,s=t.innerOrder||tc,r=[];return i.forEach(function(t){ts[t].forEach(function(i){i.name in e&&null!=e[i.name]?r.push(tl(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach(function(e){r.push(tl(t,i,e))})})}),e.media.forEach(function(e){r.push(tl("m",ts.m[0],e)),s.forEach(function(t){ts[t].forEach(function(i){i.name in e&&null!=e[i.name]?r.push(tl(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach(function(e){r.push(tl(t,i,e))})})})}),r.join("\r\n")+"\r\n"},tJ=function(e){var t={},i=[],s=t;return e.split(/(\r\n|\r|\n)/).filter(tn).forEach(function(e){var t=e[0],r=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),s=i[i.length-1]);for(var n=0;n<(ts[t]||[]).length;n+=1){var a=ts[t][n];if(a.reg.test(r))return ti(a,s,r)}}),t.media=i,t};var tu=Object.defineProperty,th=Object.defineProperties,tp=Object.getOwnPropertyDescriptors,tv=Object.getOwnPropertySymbols,tg=Object.getPrototypeOf,tm=Object.prototype.hasOwnProperty,tf=Object.prototype.propertyIsEnumerable,ty=Reflect.get,tk=(e,t,i)=>t in e?tu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,tb=(e,t)=>{for(var i in t||(t={}))tm.call(t,i)&&tk(e,i,t[i]);if(tv)for(var i of tv(t))tf.call(t,i)&&tk(e,i,t[i]);return e},tT=(e,t)=>th(e,tp(t)),tS=(e,t)=>{var i={};for(var s in e)tm.call(e,s)&&0>t.indexOf(s)&&(i[s]=e[s]);if(null!=e&&tv)for(var s of tv(e))0>t.indexOf(s)&&tf.call(e,s)&&(i[s]=e[s]);return i},tw=(e,t,i)=>ty(tg(e),i,t),tP=(e,t,i)=>new Promise((s,r)=>{var n=e=>{try{o(i.next(e))}catch(e){r(e)}},a=e=>{try{o(i.throw(e))}catch(e){r(e)}},o=e=>e.done?s(e.value):Promise.resolve(e.value).then(n,a);o((i=i.apply(e,t)).next())}),tC=(e=(e,t)=>{t.exports={version:"0.12.35",license:"MIT",repository:{type:"git",url:"https://github.com/100mslive/web-sdks.git",directory:"packages/hms-video-store"},main:"dist/index.cjs.js",module:"dist/index.js",typings:"dist/index.d.ts",files:["dist","src"],engines:{node:">=12"},exports:{".":{require:"./dist/index.cjs.js",import:"./dist/index.js",default:"./dist/index.js"}},sideEffects:!1,scripts:{prestart:"rm -rf dist && yarn types:build",start:'concurrently "yarn dev" "yarn types"',dev:"node ../../scripts/dev","build:only":"node ../../scripts/build",build:"yarn build:only && yarn types:build",types:"tsc -w","types:build":"tsc -p tsconfig.json",format:"prettier --write src/**/*.ts",test:"jest --maxWorkers=1","test:watch":"jest --watch","test:coverage":"jest --coverage",lint:"eslint -c ../../.eslintrc .","lint:fix":"yarn lint --fix",prepare:"yarn build",size:"size-limit",analyze:"size-limit --why",docs:"rm -rf ./docs && typedoc && rm -f ./docs/README.md && mkdir ./docs/home &&mv ./docs/modules.md ./docs/home/content.md && node ../../scripts/docs-store && npx prettier --write './docs/**/*'"},name:"@100mslive/hms-video-store",author:"100ms",dependencies:{eventemitter2:"^6.4.9",immer:"^9.0.6","lodash.isequal":"^4.5.0",reselect:"4.0.0","sdp-transform":"^2.14.1","ua-parser-js":"^1.0.1",uuid:"^8.3.2","webrtc-adapter":"^8.0.0",zustand:"3.5.7"},devDependencies:{"@types/dom-screen-wake-lock":"^1.0.1","@types/lodash.isequal":"^4.5.8","@types/sdp-transform":"^2.4.4","@types/ua-parser-js":"^0.7.36","@types/uuid":"^8.3.0","jest-canvas-mock":"^2.3.1","jsdom-worker":"^0.3.0",tslib:"^2.2.0"},description:"@100mslive Core SDK which abstracts the complexities of webRTC while providing a reactive store for data management with a unidirectional data flow",keywords:["video","webrtc","conferencing","100ms"],gitHead:"21175fa295899839b6bfd2a7fa5af06150de1df9"}},()=>(t||e((t={exports:{}}).exports,t),t.exports)),tE=((i=tE||{}).Disconnected="Disconnected",i.Preview="Preview",i.Connecting="Connecting",i.Connected="Connected",i.Reconnecting="Reconnecting",i.Disconnecting="Disconnecting",i.Failed="Failed",i),tI=()=>({room:{id:"",isConnected:!1,name:"",peers:[],localPeer:"",roomState:"Disconnected",recording:{browser:{running:!1},server:{running:!1},hls:{running:!1}},rtmp:{running:!1},hls:{running:!1,variants:[]},sessionId:""},peers:{},tracks:{},playlist:{audio:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1},video:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1}},messages:{byID:{},allIDs:[]},speakers:{},connectionQualities:{},settings:{audioInputDeviceId:"",audioOutputDeviceId:"",videoInputDeviceId:""},devices:{audioInput:[],audioOutput:[],videoInput:[]},roles:{},roleChangeRequests:[],errors:[],sessionStore:{},templateAppData:{},polls:{},whiteboards:{},hideLocalPeer:!1}),tA=()=>({peerStats:{},remoteTrackStats:{},localTrackStats:{},localPeer:{id:""}}),tR=((s=tR||{}).CHAT="chat",s),t_=((r=t_||{}).INFO="info",r.ERROR="error",r),tL=((n=tL||{}).PEER_JOINED="PEER_JOINED",n.PEER_LEFT="PEER_LEFT",n.PEER_LIST="PEER_LIST",n.NEW_MESSAGE="NEW_MESSAGE",n.ERROR="ERROR",n.RECONNECTING="RECONNECTING",n.RECONNECTED="RECONNECTED",n.TRACK_ADDED="TRACK_ADDED",n.TRACK_REMOVED="TRACK_REMOVED",n.TRACK_MUTED="TRACK_MUTED",n.TRACK_UNMUTED="TRACK_UNMUTED",n.TRACK_DEGRADED="TRACK_DEGRADED",n.TRACK_RESTORED="TRACK_RESTORED",n.TRACK_DESCRIPTION_CHANGED="TRACK_DESCRIPTION_CHANGED",n.ROLE_UPDATED="ROLE_UPDATED",n.CHANGE_TRACK_STATE_REQUEST="CHANGE_TRACK_STATE_REQUEST",n.CHANGE_MULTI_TRACK_STATE_REQUEST="CHANGE_MULTI_TRACK_STATE_REQUEST",n.ROOM_ENDED="ROOM_ENDED",n.REMOVED_FROM_ROOM="REMOVED_FROM_ROOM",n.DEVICE_CHANGE_UPDATE="DEVICE_CHANGE_UPDATE",n.PLAYLIST_TRACK_ENDED="PLAYLIST_TRACK_ENDED",n.NAME_UPDATED="NAME_UPDATED",n.METADATA_UPDATED="METADATA_UPDATED",n.POLL_CREATED="POLL_CREATED",n.POLL_STARTED="POLL_STARTED",n.POLL_STOPPED="POLL_STOPPED",n.POLL_VOTES_UPDATED="POLL_VOTES_UPDATED",n.POLLS_LIST="POLLS_LIST",n.HAND_RAISE_CHANGED="HAND_RAISE_CHANGED",n.TRANSCRIPTION_STATE_UPDATED="TRANSCRIPTION_STATE_UPDATED",n),tM=((a=tM||{}).audio="audio",a.video="video",a);function tD(e,t){let i,s;if(t)for(let n of t.auxiliaryTracks){var r;let t=e[n];(r=t)&&"screen"===r.source&&(s=tO(t)?t:s,i=tN(t)?t:i)}return{video:i,audio:s}}function tO(e){return e&&"audio"===e.type}function tN(e){return e&&"video"===e.type}function tx(e){return e&&"audioplaylist"===e.source}function tU(e){return e&&"videoplaylist"===e.source}function tB(e){return!!e&&!!(null!=e&&e.degraded)}function tF(e,t){return!!t&&!!e.tracks[t]&&e.tracks[t].enabled}function tj(e){var t;let i=!1,s=!1,r=!1;return null!=(t=null==e?void 0:e.publishParams)&&t.allowed&&(i=e.publishParams.allowed.includes("video"),s=e.publishParams.allowed.includes("audio"),r=e.publishParams.allowed.includes("screen")),{video:i,audio:s,screen:r}}var t$=((o=t$||{})[o.VERBOSE=0]="VERBOSE",o[o.DEBUG=1]="DEBUG",o[o.INFO=2]="INFO",o[o.WARN=3]="WARN",o[o.TIME=4]="TIME",o[o.TIMEEND=5]="TIMEEND",o[o.ERROR=6]="ERROR",o[o.NONE=7]="NONE",o),tG="undefined"!=typeof window&&void 0!==window.expect,tV=class{static v(e,...t){this.log(0,e,...t)}static d(e,...t){this.log(1,e,...t)}static i(e,...t){this.log(2,e,...t)}static w(e,...t){this.log(3,e,...t)}static e(e,...t){this.log(6,e,...t)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanup(){performance.clearMarks(),performance.clearMeasures()}static log(e,t,...i){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:console.log(t,...i);break;case 1:console.debug(t,...i);break;case 2:console.info(t,...i);break;case 3:console.warn(t,...i);break;case 6:console.error(t,...i);break;case 4:performance.mark(i[0]);break;case 5:{let e=i[0];try{let i=performance.measure(e,e);this.log(1,t,e,null==i?void 0:i.duration),performance.clearMarks(e),performance.clearMeasures(e)}catch(i){this.log(1,t,e,i)}}}}};tV.level=7*!!tG;var tq,tH,tW,tz,tK,tJ,tQ,tY,tX,tZ,t0,t1=class{constructor(e){this.tracks=[],this.nativeStream=e,this.id=e.id}updateId(e){this.id=e}},t2=new(0,U.UAParser),t3="undefined"!=typeof window,t5="undefined"==typeof window&&!(null!=(tQ=t2.getBrowser().name)&&tQ.toLowerCase().includes("electron")),t4=()=>"mobile"===t2.getDevice().type,t6=null==(tX=null==(tY=t2.getBrowser())?void 0:tY.name)?void 0:tX.toLowerCase().includes("safari"),t9=(null==(t0=null==(tZ=t2.getBrowser())?void 0:tZ.name)?void 0:t0.toLowerCase())==="firefox",t8=((l=t8||{}).CUSTOM="CUSTOM",l.LOCAL="LOCAL",l.HMS="HMS",l),t7=function(){if(t3&&window){let e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e?"LOCAL":e.includes("app.100ms.live")?"HMS":"CUSTOM"}return"CUSTOM"}(),ie=1e3,it=1003,ii=1006,is=2002,ir=2003,ia=2004,io=3e3,il=3001,id=3002,ic=3003,iu=3005,ih=3006,ip=3008,iv=3009,ig=3010,im=3011,iy=3012,ik=3013,ib=3014,iT=3015,iS=4001,iw=4002,iP=4003,iC=4004,iE=4005,iI=4006,iA=4007,iR=5001,i_=6e3,iL=6001,iM=6002,iD=6003,iO=6008,iN=6009,ix=6010,iU=6011,iB=6012,iF=6013,ij=8001,i$=class e extends Error{constructor(t,i,s,r,n,a=!1){super(r),this.code=t,this.name=i,this.message=r,this.description=n,this.isTerminal=a,Object.setPrototypeOf(this,e.prototype),this.action=s.toString()}toAnalyticsProperties(){return{error_name:this.name,error_code:this.code,error_message:this.message,error_description:this.description,action:this.action,is_terminal:this.isTerminal}}addNativeError(e){this.nativeError=e}toString(){var e;return`{
        code: ${this.code};
        name: ${this.name};
        action: ${this.action};
        message: ${this.message};
        description: ${this.description};
        isTerminal: ${this.isTerminal};
        nativeError: ${null==(e=this.nativeError)?void 0:e.message};
      }`}},iG=class extends i${constructor(e,t,i,s,r,n){super(e,t,i,s,r,!1),this.code=e,this.name=t,this.message=s,this.description=r,this.trackType=n}toAnalyticsProperties(){return tT(tb({},super.toAnalyticsProperties()),{track_type:this.trackType})}toString(){var e;return`{
        code: ${this.code};
        name: ${this.name};
        action: ${this.action};
        message: ${this.message};
        description: ${this.description};
        isTerminal: ${this.isTerminal};
        nativeError: ${null==(e=this.nativeError)?void 0:e.message};
        trackType: ${this.trackType};
      }`}},iV=((d=iV||{}).AUDIO="audio",d.VIDEO="video",d.AUDIO_VIDEO="audio, video",d.SCREEN="screen",d);function iq(e){switch(e){case"join":return"JOIN";case"offer":return"PUBLISH";case"answer":return"SUBSCRIBE";case"track-update":return"TRACK";default:return"NONE"}}var iH=["join","offer","answer","trickle","on-error","JOIN"],iW=(e,t="")=>new i$(ie,"WebsocketFailedToConnect",e,`[WS]: ${t}`,`[WS]: ${t}`),iz=(e,t="")=>new i$(it,"WebSocketConnectionLost",e,"Network connection lost",t),iK=(e,t="")=>new i$(ii,"WebSocketAbnormalClose",e,"Websocket closed abnormally",t),iJ=(e,t,i="",s=!0)=>new i$(e,"ServerErrors",t,`[${t}]: Server error ${i}`,i,s),iQ=(e,t="")=>new i$(ir,"EndpointUnreachable",e,`Endpoint is not reachable - ${t}`,t),iY=(e,t="")=>new i$(ia,"InvalidTokenFormat",e,`Token is not in proper JWT format - ${t}`,t,!0),iX=(e,t="")=>new i$(is,"InitError",e,`[INIT]: ${t}`,`[INIT]: ${t}`),iZ=(e,t="")=>new iG(io,"GenericTrack",e,`[TRACK]: ${t}`,`[TRACK]: ${t}`,"audio, video"),i0=(e,t,i="")=>new iG(il,"CantAccessCaptureDevice",e,`User denied permission to access capture device - ${t}`,i,t),i1=(e,t,i="")=>new iG(id,"DeviceNotAvailable",e,`[TRACK]: Capture device is no longer available - ${t}`,i,t),i2=(e,t,i="")=>new iG(ic,"DeviceInUse",e,`[TRACK]: Capture device is in use by another application - ${t}`,i,t),i3=(e,t="",i="There is no media to return. Please select either video or audio or both.")=>new iG(iu,"NothingToReturn",e,i,t,"audio, video"),i5=(e,t="")=>new iG(ih,"InvalidVideoSettings",e,"Cannot enable simulcast when no video settings are provided",t,"video"),i4=(e,t="")=>new iG(ip,"AutoplayBlocked",e,"Autoplay blocked because the user didn't interact with the document first",t,"audio"),i6=(e,t,i="")=>new iG(iv,"OverConstrained",e,`[TRACK]: Requested constraints cannot be satisfied with the device hardware - ${t}`,i,t),i9=(e,t="Please check the mic or use another audio input")=>new iG(ig,"NoAudioDetected",e,"No audio input detected from microphone",t,"audio"),i8=(e,t,i="")=>new iG(im,"SystemDeniedPermission",e,`Operating System denied permission to access capture device - ${t}`,i,t),i7=()=>new iG(iy,"CurrentTabNotShared","TRACK","The app requires you to share the current tab","You must screen share the current tab in order to proceed","screen"),se=e=>new iG(ik,"Audio playback error","TRACK",e,e,"audio"),st=e=>new iG(ib,"SelectedDeviceMissing","TRACK",`Could not detect selected ${e} device`,`Please check connection to the ${e} device`,e),si=e=>new iG(iT,"Track does not have any data","TRACK",e,"This could possibily due to another application taking priority over the access to camera or microphone or due to an incoming call","audio, video"),ss=(e,t="")=>new i$(iS,"CreateOfferFailed",e,`[${e.toString()}]: Failed to create offer. `,t),sr=(e,t="")=>new i$(iw,"CreateAnswerFailed",e,`[${e.toString()}]: Failed to create answer. `,t),sn=(e,t="")=>new i$(iP,"SetLocalDescriptionFailed",e,`[${e.toString()}]: Failed to set offer. `,t),sa=(e,t="")=>new i$(iC,"SetRemoteDescriptionFailed",e,`[${e.toString()}]: Failed to set answer. `,t,!0),so=(e,t="",i=!1)=>new i$(iE,"ICEFailure",e,`[${e.toString()}]: Ice connection state FAILED`,t,i),sl=(e,t="")=>new i$(iI,"ICEDisconnected",e,`[${e.toString()}]: Ice connection state DISCONNECTED`,t),sd=(e,t="")=>new i$(iA,"StatsFailed",e,`Failed to WebRTC get stats - ${t}`,t),sc=(e,t,i)=>new i$(e,"ServerErrors",t,i,i,iH.includes(t)),su=(e,t="")=>new i$(iR,"AlreadyJoined",e,"[JOIN]: You have already joined this room.",t),sh=(e,t="")=>new i$(i_,"NotConnected",e,"Client is not connected",t),sp=(e,t)=>new i$(iL,"Signalling",e,`Unknown signalling error: ${e.toString()} ${t} `,t),sv=(e,t)=>new i$(iM,"Unknown",e,`Unknown exception: ${t}`,t),sg=(e,t="")=>new i$(iD,"NotReady",e,t,t),sm=(e,t)=>new i$(iF,"ValidationFailed","VALIDATION",e,t?JSON.stringify(t):""),sf=(e,t)=>new i$(iO,"InvalidRole",e,"Invalid role. Join with valid role",t,!0),sy=(e,t="")=>new i$(iN,"PreviewAlreadyInProgress",e,"[Preview]: Cannot join if preview is in progress",t),sk=(e="Access to localStorage has been denied")=>new i$(iB,"LocalStorageAccessDenied","NONE","LocalStorageAccessDenied",e),sb=()=>new i$(ix,"MissingMediaDevices","JOIN","navigator.mediaDevices is undefined. 100ms SDK won't work on this website as WebRTC is not supported on HTTP endpoints(missing navigator.mediaDevices). Please ensure you're using the SDK either on localhost or a valid HTTPS endpoint.","",!0),sT=()=>new i$(iU,"MissingRTCPeerConnection","JOIN","RTCPeerConnection which is a core requirement for WebRTC call was not found, this could be due to an unsupported browser or browser extensions blocking WebRTC","",!0),sS=(e,t="")=>new i$(7001,"PlatformNotSupported",e,"Check HMS Docs to see the list of supported platforms",t),sw=(e,t="")=>new i$(7002,"InitFailed",e,"Plugin init failed",t),sP=(e,t="")=>new i$(7003,"ProcessingFailed",e,"Plugin processing failed",t),sC=(e,t="")=>new i$(7004,"AddAlreadyInProgress",e,"Plugin add already in progress",t),sE=(e,t="")=>new i$(7005,"DeviceNotSupported",e,"Check HMS Docs to see the list of supported devices",t),sI=(e,t)=>new i$(ij,"NoEntryToPlay",e,"Reached end of playlist",t),sA=class{constructor(){this.valuesMap=new Map}getItem(e){return this.valuesMap.has(e)?String(this.valuesMap.get(e)):null}setItem(e,t){this.valuesMap.set(e,t)}removeItem(e){this.valuesMap.delete(e)}clear(){this.valuesMap.clear()}key(e){if(0==arguments.length)throw TypeError("Failed to execute 'key' on 'Storage': 1 argument required, but only 0 present.");return Array.from(this.valuesMap.keys())[e]}get length(){return this.valuesMap.size}},sR=class{constructor(e){this.key=e,this.storage=null}getStorage(){try{return t3&&!this.storage&&((()=>{try{t3&&!localStorage&&(window.localStorage=new sA)}catch(e){tV.e("Error initialising localStorage",sk())}})(),this.storage=window.localStorage),this.storage}catch(e){return tV.e("Error initialising localStorage",sk()),null}}get(){var e;let t=null==(e=this.getStorage())?void 0:e.getItem(this.key);return t?JSON.parse(t):void 0}set(e){var t;let i=JSON.stringify(e);null==(t=this.getStorage())||t.setItem(this.key,i)}clear(){var e;null==(e=this.getStorage())||e.removeItem(this.key)}},s_=()=>{let e,t=new sR("hms-analytics-deviceId"),i=t.get();return i?e=i:(e=V(),t.set(e)),e},sL="[VALIDATIONS]";function sM(e){return null!=e}var sD=()=>{if(!sM(RTCPeerConnection)){let e=sT();throw tV.e(sL,e),e}},sO=()=>{if(!sM(navigator.mediaDevices)){let e=sb();throw tV.e(sL,e),e}},sN=tC().version;function sx(e="prod",t){let i="LOCAL"!==t7&&"prod"===e?"prod":"debug";if(t5)return sB({os:"web_nodejs",os_version:eJ.version,sdk:"web",sdk_version:sN,env:i,domain:t7,is_prebuilt:!!(null!=t&&t.isPrebuilt),framework:"node",framework_version:eJ.version,framework_sdk_version:null==t?void 0:t.sdkVersion});let s=t2.getOS(),r=t2.getDevice(),n=t2.getBrowser(),a=sU(`web_${s.name}`),o=s.version||"",l=sU(`${n.name}_${n.version}`),d=l;return r.type&&(d=`${sU(`${r.vendor}_${r.type}`)}/${l}`),sB({os:a,os_version:o,sdk:"web",sdk_version:sN,device_model:d,env:i,domain:t7,is_prebuilt:!!(null!=t&&t.isPrebuilt),framework:null==t?void 0:t.type,framework_version:null==t?void 0:t.version,framework_sdk_version:null==t?void 0:t.sdkVersion})}function sU(e){return e.replace(/ /g,"_")}var sB=(e,t=",")=>Object.keys(e).filter(t=>sM(e[t])).map(t=>`${t}:${e[t]}`).join(t),sF=class{constructor({name:e,level:t,properties:i,includesPII:s,timestamp:r}){this.metadata={peer:{},userAgent:sx()},this.name=e,this.level=t,this.includesPII=s||!1,this.properties=i||{},this.timestamp=r||new Date().getTime(),this.event_id=V(),this.device_id=s_()}toSignalParams(){return{name:this.name,info:tT(tb({},this.properties),{timestamp:this.timestamp,domain:t7}),timestamp:new Date().getTime()}}},sj=class{static connect(e,t,i=new Date,s=new Date,r){return new sF({name:this.eventNameFor("connect",void 0===e),level:e?2:1,properties:this.getPropertiesWithError(tT(tb({},t),{[this.KEY_REQUESTED_AT]:null==i?void 0:i.getTime(),[this.KEY_RESPONDED_AT]:null==s?void 0:s.getTime(),endpoint:r}),e)})}static disconnect(e,t){return new sF({name:"disconnected",level:e?2:1,properties:this.getPropertiesWithError(t,e)})}static preview(e){var{error:t}=e,i=tS(e,["error"]);return new sF({name:this.eventNameFor("preview",void 0===t),level:t?2:1,properties:this.getPropertiesWithError(i,t)})}static join(e){var{error:t}=e,i=tS(e,["error"]);return new sF({name:this.eventNameFor("join",void 0===t),level:t?2:1,properties:this.getPropertiesWithError(tT(tb({},i),{is_preview_called:!!i.is_preview_called}),t)})}static publish({devices:e,settings:t,error:i}){return new sF({name:this.eventNameFor("publish",void 0===i),level:i?2:1,properties:this.getPropertiesWithError({devices:e,audio:null==t?void 0:t.audio,video:null==t?void 0:t.video},i)})}static hlsPlayerError(e){return new sF({name:"hlsPlayerError",level:2,properties:this.getErrorProperties(e)})}static subscribeFail(e){return new sF({name:this.eventNameFor("subscribe",!1),level:2,properties:this.getErrorProperties(e)})}static leave(){return new sF({name:"leave",level:1})}static autoplayError(){return new sF({name:"autoplayError",level:2})}static audioPlaybackError(e){return new sF({name:"audioPlaybackError",level:2,properties:this.getErrorProperties(e)})}static audioRecovered(e){return new sF({name:"audioRecovered",level:1,properties:{message:e}})}static permissionChange(e,t){return new sF({name:"permissionChanged",level:1,properties:{message:`Perrmission for ${e} changed to ${t}`}})}static deviceChange({isUserSelection:e,selection:t,type:i,devices:s,error:r}){return new sF({name:this.eventNameFor(r?"publish":`device.${i}`,void 0===r),level:r?2:1,properties:this.getPropertiesWithError({selection:t,devices:s,isUserSelection:e},r)})}static performance(e){return new sF({name:"perf.stats",level:1,properties:e.toAnalyticsProperties()})}static rtcStats(e){return new sF({name:"rtc.stats",level:1,properties:e.toAnalyticsProperties()})}static rtcStatsFailed(e){return new sF({name:"rtc.stats.failed",level:2,properties:this.getErrorProperties(e)})}static degradationStats(e,t){let i={degradedAt:e.degradedAt,trackId:e.trackId};if(!t&&e.degradedAt instanceof Date){let t=new Date,s=t.valueOf()-e.degradedAt.valueOf();i=tT(tb({},i),{duration:s,restoredAt:t})}return new sF({name:"video.degradation.stats",level:1,properties:i})}static audioDetectionFail(e,t){return new sF({name:"audiopresence.failed",level:2,properties:this.getPropertiesWithError({device:t},e)})}static previewNetworkQuality(e){return new sF({name:"perf.networkquality.preview",level:e.error?2:1,properties:e})}static publishStats(e){return new sF({name:"publisher.stats",level:1,properties:e})}static subscribeStats(e){return new sF({name:"subscriber.stats",level:1,properties:e})}static getKrispUsage(e){return new sF({name:"krisp.usage",level:1,properties:{duration:e}})}static krispStart(){return new sF({name:"krisp.start",level:1})}static krispStop(){return new sF({name:"krisp.stop",level:1})}static interruption({started:e,type:t,reason:i,deviceInfo:s}){return new sF({name:`${e?"interruption.start":"interruption.stop"}`,level:1,properties:tb({reason:i,type:t},s)})}static eventNameFor(e,t){return`${e}.${t?"success":"failed"}`}static getPropertiesWithError(e,t){return e=tb(tb({},this.getErrorProperties(t)),e)}static getErrorProperties(e){return e?e instanceof i$?e.toAnalyticsProperties():{error_name:e.name,error_message:e.message,error_description:e.cause}:{}}};sj.KEY_REQUESTED_AT="requested_at",sj.KEY_RESPONDED_AT="responded_at";var s$=e=>e?`{
    trackId: ${e.id};
    kind: ${e.kind};
    enabled: ${e.enabled};
    muted: ${e.muted};
    readyState: ${e.readyState};
  }`:"",sG=class{constructor(e,t,i){this.logIdentifier="",this.isTrackNotPublishing=()=>"ended"===this.nativeTrack.readyState||this.nativeTrack.muted,this.stream=e,this.nativeTrack=t,this.source=i}get enabled(){return this.nativeTrack.enabled}get trackId(){return this.firstTrackId||this.sdpTrackId||this.nativeTrack.id}getMediaTrackSettings(){return this.nativeTrack.getSettings()}setEnabled(e){return tP(this,null,function*(){this.nativeTrack.enabled=e})}setSdpTrackId(e){this.sdpTrackId=e}setFirstTrackId(e){this.firstTrackId=e}sendInterruptionEvent({started:e,reason:t}){return sj.interruption({started:e,type:this.type,reason:t,deviceInfo:{deviceId:this.nativeTrack.getSettings().deviceId,groupId:this.nativeTrack.getSettings().groupId}})}cleanup(){var e;tV.d("[HMSTrack]","Stopping track",this.toString()),null==(e=this.nativeTrack)||e.stop()}toString(){var e;return`{
      streamId: ${this.stream.id};
      peerId: ${this.peerId};
      trackId: ${this.trackId};
      mid: ${(null==(e=this.transceiver)?void 0:e.mid)||"-"};
      logIdentifier: ${this.logIdentifier};
      source: ${this.source};
      enabled: ${this.enabled};
      nativeTrack: ${s$(this.nativeTrack)};
    }`}},sV=class extends sG{constructor(e,t,i){if(super(e,t,i),this.type="audio",this.audioElement=null,"audio"!==t.kind)throw Error("Expected 'track' kind = 'audio'")}getVolume(){return this.audioElement?Math.floor(100*this.audioElement.volume):null}setVolume(e){return tP(this,null,function*(){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");yield this.subscribeToAudio(0!==e&&this.enabled),this.audioElement&&(this.audioElement.volume=e/100)})}setAudioElement(e){tV.d("[HMSAudioTrack]",this.logIdentifier,"adding audio element",`${this}`,e),this.audioElement=e}getAudioElement(){return this.audioElement}getOutputDevice(){return this.outputDevice}cleanup(){super.cleanup(),this.audioElement&&(this.audioElement.srcObject=null,this.audioElement.remove(),this.audioElement=null)}setOutputDevice(e){return tP(this,null,function*(){var t;if(!e)return void tV.d("[HMSAudioTrack]",this.logIdentifier,"device is null",`${this}`);if(!this.audioElement){tV.d("[HMSAudioTrack]",this.logIdentifier,"no audio element to set output",`${this}`),this.outputDevice=e;return}try{"function"==typeof this.audioElement.setSinkId&&(t9||(yield null==(t=this.audioElement)?void 0:t.setSinkId(e.deviceId)),this.outputDevice=e)}catch(e){tV.d("[HMSAudioTrack]","error in setSinkId",e)}})}subscribeToAudio(e){return tP(this,null,function*(){this.stream instanceof rH&&(yield this.stream.setAudio(e,this.trackId,this.logIdentifier))})}},sq=new class{constructor(){this.storage=new sR("hms-device-selection"),this.remember=!1,this.TAG="[HMSDeviceStorage]"}setDevices(e){this.devices=e}rememberDevices(e){this.remember=e}updateSelection(e,{deviceId:t,groupId:i}){if(!this.devices||!this.remember)return;let s=this.devices[e].find(e=>this.isSame({deviceId:t,groupId:i},e));if(!s)return void tV.w(this.TAG,`Could not find device with deviceId: ${t}, groupId: ${i}`);let r=this.storage.get()||{};r[e]=s,this.storage.set(r)}getSelection(){if(this.remember)return this.storage.get()}cleanup(){this.remember=!1,this.devices=void 0}isSame(e,t){return e.deviceId===t.deviceId&&(e.groupId===t.groupId||!e.groupId)}},sH=((c=sH||{}).TRANSFORM="TRANSFORM",c.ANALYZE="ANALYZE",c),sW=((u=sW||{}).PLATFORM_NOT_SUPPORTED="PLATFORM_NOT_SUPPORTED",u.DEVICE_NOT_SUPPORTED="DEVICE_NOT_SUPPORTED",u),sz=class{static failure(e,t){return new sF({name:"mediaPlugin.failed",level:2,properties:tb({plugin_name:e},t.toAnalyticsProperties())})}static audioPluginFailure(e,t,i){return new sF({name:"mediaPlugin.failed",level:2,properties:tb({plugin_name:e,sampleRate:t},i.toAnalyticsProperties())})}static audioPluginStats({pluginName:e,duration:t,loadTime:i,sampleRate:s}){return new sF({name:"mediaPlugin.stats",level:1,properties:{plugin_name:e,duration:t,load_time:i,sampleRate:s}})}static added(e,t){return new sF({name:"mediaPlugin.added",level:1,properties:{plugin_name:e,added_at:t}})}static stats({pluginName:e,duration:t,loadTime:i,avgPreProcessingTime:s,avgProcessingTime:r,inputFrameRate:n,pluginFrameRate:a}){return new sF({name:"mediaPlugin.stats",level:1,properties:{plugin_name:e,duration:t,load_time:i,avg_preprocessing_time:s,avg_processing_time:r,input_frame_rate:n,plugin_frame_rate:a}})}},sK=class{constructor(e){this.eventBus=e,this.TAG="[AudioPluginsAnalytics]",this.initTime={},this.addedTimestamps={},this.pluginAdded={},this.pluginSampleRate={}}added(e,t){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.pluginSampleRate[e]=t,this.eventBus.analytics.publish(sz.added(e,this.addedTimestamps[e]))}removed(e){if(this.pluginAdded[e]){let t={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],sampleRate:this.pluginSampleRate[e]};this.eventBus.analytics.publish(sz.audioPluginStats(t)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(sz.audioPluginFailure(e,this.pluginSampleRate[e],t)),this.clean(e))}initWithTime(e,t){return tP(this,null,function*(){let i;if(this.initTime[e])return void tV.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);try{i=yield this.timeInMs(t),tV.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(i){let t=sw("AUDIO_PLUGINS",`failed during initialization of plugin${i.message||i}`);throw tV.e(this.TAG,t),this.failure(e,t),t}i&&(this.initTime[e]=i)})}timeInMs(e){return tP(this,null,function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)})}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.pluginAdded[e],delete this.pluginSampleRate[e]}},sJ=class{constructor(e,t,i){this.eventBus=t,this.TAG="[AudioPluginsManager]",this.pluginAddInProgress=!1,this.hmsTrack=e,this.pluginsMap=new Map,this.analytics=new sK(t),this.audioContext=s1.getAudioContext(),this.room=i}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e){return tP(this,null,function*(){var t,i;let s=null==(t=e.getName)?void 0:t.call(e);if(!s)return void tV.w("no name provided by the plugin");if(this.pluginAddInProgress){let e=sC("AUDIO_PLUGINS","Add Plugin is already in Progress");throw this.analytics.added(s,this.audioContext.sampleRate),this.analytics.failure(s,e),tV.w("can't add another plugin when previous add is in progress"),e}if("HMSKrispPlugin"===e.getName()){if(!(null!=(i=this.room)&&i.isNoiseCancellationEnabled)){let e="Krisp Noise Cancellation is not enabled for this room";if(0===this.pluginsMap.size)throw Error(e);tV.w(this.TAG,e);return}this.eventBus.analytics.publish(sj.krispStart())}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e)}finally{this.pluginAddInProgress=!1}})}addPluginInternal(e){return tP(this,null,function*(){var t,i;let s=null==(t=e.getName)?void 0:t.call(e);if(this.pluginsMap.get(s))return void tV.w(this.TAG,`plugin - ${s} already added.`);yield this.validateAndThrow(s,e),null==(i=e.setEventBus)||i.call(e,this.eventBus);try{0===this.pluginsMap.size?yield this.initAudioNodes():this.prevAudioNode&&this.prevAudioNode.disconnect(),this.analytics.added(s,this.audioContext.sampleRate),yield this.analytics.initWithTime(s,()=>tP(this,null,function*(){return e.init()})),this.pluginsMap.set(s,e),yield this.processPlugin(e),yield this.connectToDestination(),yield this.updateProcessedTrack()}catch(e){throw tV.e(this.TAG,"failed to add plugin",e),e}})}validatePlugin(e){return e.checkSupport(this.audioContext)}validateAndThrow(e,t){return tP(this,null,function*(){let i=this.validatePlugin(t);if(i.isSupported)tV.i(this.TAG,`plugin is supported,- ${t.getName()}`);else if(this.analytics.added(e,this.audioContext.sampleRate),"PLATFORM_NOT_SUPPORTED"===i.errType){let t=sS("AUDIO_PLUGINS","platform not supported, see docs");throw this.analytics.failure(e,t),yield this.cleanup(),t}else if("DEVICE_NOT_SUPPORTED"===i.errType){let t=sE("AUDIO_PLUGINS","audio device not supported, see docs");throw this.analytics.failure(e,t),yield this.cleanup(),t}})}removePlugin(e){return tP(this,null,function*(){"HMSKrispPlugin"===e.getName()&&this.eventBus.analytics.publish(sj.krispStop()),yield this.removePluginInternal(e),0===this.pluginsMap.size?(yield this.cleanup(),tV.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.hmsTrack.setProcessedTrack(void 0)):yield this.reprocessPlugins()})}cleanup(){return tP(this,null,function*(){var e,t,i;for(let e of this.pluginsMap.values())yield this.removePluginInternal(e);yield this.hmsTrack.setProcessedTrack(void 0),null==(e=this.sourceNode)||e.disconnect(),null==(t=this.prevAudioNode)||t.disconnect(),null==(i=this.outputTrack)||i.stop(),this.sourceNode=void 0,this.destinationNode=void 0,this.prevAudioNode=void 0,this.outputTrack=void 0})}closeContext(){return tP(this,null,function*(){this.audioContext=void 0})}reprocessPlugins(){return tP(this,null,function*(){if(0===this.pluginsMap.size||!this.sourceNode)return;let e=Array.from(this.pluginsMap.values());for(let t of(yield this.cleanup(),yield this.initAudioNodes(),e))yield this.addPlugin(t);yield this.updateProcessedTrack()})}initAudioNodes(){return tP(this,null,function*(){if(this.audioContext){let e=new MediaStream([this.hmsTrack.nativeTrack]);this.sourceNode=this.audioContext.createMediaStreamSource(e),this.destinationNode||(this.destinationNode=this.audioContext.createMediaStreamDestination(),this.outputTrack=this.destinationNode.stream.getAudioTracks()[0])}})}updateProcessedTrack(){return tP(this,null,function*(){try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw tV.e(this.TAG,"error in setting processed track",e),e}})}processPlugin(e){return tP(this,null,function*(){try{let t=yield e.processAudioTrack(this.audioContext,this.prevAudioNode||this.sourceNode);this.prevAudioNode&&this.prevAudioNode.connect(t),this.prevAudioNode=t}catch(i){let t=e.getName();tV.e(this.TAG,`error in processing plugin ${t}`,i),yield this.removePluginInternal(e)}})}connectToDestination(){return tP(this,null,function*(){try{this.prevAudioNode&&this.destinationNode&&this.prevAudioNode.context===this.destinationNode.context&&this.prevAudioNode.connect(this.destinationNode)}catch(e){tV.e(this.TAG,"error in connecting to destination node",e)}})}removePluginInternal(e){return tP(this,null,function*(){var t;let i=null==(t=e.getName)?void 0:t.call(e);if(!this.pluginsMap.get(i))return void tV.w(this.TAG,`plugin - ${i} not found to remove.`);tV.i(this.TAG,`removing plugin ${i}`),this.pluginsMap.delete(i),e.stop(),this.analytics.removed(i)})}};function sQ(e,t){let i=function(e,t=""){if("chrome"===ez.browserDetails.browser&&"NotAllowedError"===e.name&&e.message.includes("denied by system"))return i8("TRACK",t,e.message);if("firefox"===ez.browserDetails.browser&&"NotFoundError"===e.name){let i=i8("TRACK",t,e.message);return i.description=`Capture device is either blocked at Operating System level or not available - ${t}`,i}switch(e.name){case"OverconstrainedError":return i6("TRACK",t,e.constraint);case"NotAllowedError":return i0("TRACK",t,e.message);case"NotFoundError":return i1("TRACK",t,e.message);case"NotReadableError":return i2("TRACK",t,e.message);case"TypeError":return i3("TRACK",e.message);default:var i;let s,r;return i=e.message,s=i.toLowerCase(),r=iZ("TRACK",i),s.includes("device not found")?r=i1("TRACK",t,i):s.includes("permission denied")&&(r=i0("TRACK",t,i)),r}}(e,t);return i.addNativeError(e),i}function sY(e){return tP(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:!!e&&e.toConstraints()})).getAudioTracks()[0]}catch(e){throw sQ(e,"audio")}})}function sX(e){return tP(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({video:!!e&&e.toConstraints()})).getVideoTracks()[0]}catch(e){throw sQ(e,"video")}})}function sZ(e){return"canvas"in e||"MediaStreamAudioDestinationNode"===e.label||""===e.label}var s0=(e,t)=>{if(!navigator.permissions)return void tV.d("Permissions API not supported");navigator.permissions.query({name:e}).then(e=>{e.onchange=()=>{t(e.state)}}).catch(t=>{tV.e(`${e} not supported`,t.message)})},s1={audioContext:null,getAudioContext(){return this.audioContext||(this.audioContext=t9?new AudioContext:new AudioContext({sampleRate:32e3})),this.audioContext},resumeContext(){return tP(this,null,function*(){try{return yield this.getAudioContext().resume()}catch(e){tV.e("AudioContext",e)}})}},s2=((h=s2||{}).SPEAKERPHONE="SPEAKERPHONE",h.WIRED="WIRED",h.BLUETOOTH="BLUETOOTH",h.EARPIECE="EARPIECE",h),s3=e=>{if(!e)return tV.w("[DeviceManager]:","No device label provided"),"SPEAKERPHONE";let t=e.toLowerCase();return t.includes("speakerphone")?"SPEAKERPHONE":t.includes("wired")?"WIRED":/airpods|buds|wireless|bluetooth/gi.test(t)?"BLUETOOTH":t.includes("earpiece")?"EARPIECE":"SPEAKERPHONE"},s5=class{constructor(e=1/0){this.capacity=e,this.storage=[]}size(){return this.storage.length}toList(){return this.storage.slice(0)}enqueue(e){this.size()===this.capacity&&this.dequeue(),this.storage.push(e)}dequeue(){return this.storage.shift()}aggregate(e){return e(this.storage)}},s4=`(function workerSetup() {
  function ticker() {
    self.postMessage('tick');
  }
  self.onmessage = function (event) {
    const [data, time] = event.data;
    switch (data) {
      case 'start':
        setTimeout(ticker, time);
        break;
      default:
        break;
    }
  };
})()`;function s6(e){if(e<0)throw Error("`ms` should be a positive integer");return new Promise(t=>{setTimeout(t,e)})}function s9(e){if(e<0)throw Error("`ms` should be a positive integer");if("undefined"==typeof Worker)return s6(e);let t=new Worker(URL.createObjectURL(new Blob([s4],{type:"application/javascript"})));return t.postMessage(["start",e]),new Promise(e=>{t.onmessage=i=>{"tick"===i.data&&(e(),t.terminate())}})}function s8(e,t=300){let i;return function(...s){clearTimeout(i),i=void 0;let r=this;i=setTimeout(()=>{e.apply(r,s)},t)}}var s7=class{constructor(e,t,i){this.track=e,this.audioLevelEvent=t,this.silenceEvent=i,this.TAG="[TrackAudioLevelMonitor]",this.audioLevel=0,this.isMonitored=!1,this.interval=100,this.historyInterval=700,this.history=new s5(this.historyInterval/this.interval),this.detectSilence=()=>tP(this,null,function*(){let e=0;for(;this.isMonitored;){if(this.track.enabled)if(this.isSilentThisInstant()){if(++e>50){this.silenceEvent.publish({track:this.track});break}}else break;yield s6(20)}});try{let e=new MediaStream([this.track.nativeTrack]);this.analyserNode=this.createAnalyserNodeForStream(e);let t=this.analyserNode.frequencyBinCount;this.dataArray=new Uint8Array(t)}catch(e){tV.w(this.TAG,"Unable to initialize AudioContext",e)}}start(){this.stop(),this.isMonitored=!0,tV.d(this.TAG,"Starting track Monitor",`${this.track}`),this.loop().then(()=>tV.d(this.TAG,"Stopping track Monitor",`${this.track}`))}stop(){if(!this.analyserNode)return void tV.d(this.TAG,"AudioContext not initialized");this.sendAudioLevel(0),this.isMonitored=!1}loop(){return tP(this,null,function*(){for(;this.isMonitored;)this.sendAudioLevel(this.getMaxAudioLevelOverPeriod()),yield s6(this.interval)})}sendAudioLevel(e=0){if(e=e>35?e:0,Math.abs(this.audioLevel-e)>5){this.audioLevel=e;let t={track:this.track,audioLevel:this.audioLevel};this.audioLevelEvent.publish(t)}}getMaxAudioLevelOverPeriod(){if(!this.analyserNode)return void tV.d(this.TAG,"AudioContext not initialized");let e=this.calculateAudioLevel();return void 0!==e&&this.history.enqueue(e),this.history.aggregate(e=>Math.max(...e))}calculateAudioLevel(){if(!this.analyserNode||!this.dataArray)return void tV.d(this.TAG,"AudioContext not initialized");this.analyserNode.getByteTimeDomainData(this.dataArray);let e=.009;for(let t of this.dataArray)e=Math.max(e,(t-128)/128);return Math.ceil(Math.min(Math.max((Math.log(.009)-Math.log(e))/Math.log(.009)*100,0),100))}isSilentThisInstant(){return this.analyserNode&&this.dataArray?(this.analyserNode.getByteTimeDomainData(this.dataArray),this.dataArray.every(e=>128===e||0===e)):void tV.d(this.TAG,"AudioContext not initialized")}createAnalyserNodeForStream(e){let t=s1.getAudioContext(),i=t.createMediaStreamSource(e),s=t.createAnalyser();return s.fftSize=2048,i.connect(s),s}},re=((p=re||{}).SIP="sip",p.REGULAR="regular",p),rt=((v=rt||{}).NONE="none",v.INITIALISED="initialised",v.STARTED="started",v.PAUSED="paused",v.RESUMED="resumed",v.STOPPED="stopped",v.FAILED="failed",v),ri=((g=ri||{}).DVR="dvr",g.NO_DVR="no-dvr",g),rs=((m=rs||{}).REGULAR="regular",m.SCREEN="screen",m.COMPOSITE="composite",m),rr=((f=rr||{}).INITIALISED="initialised",f.STARTED="started",f.STOPPED="stopped",f.FAILED="failed",f),rn=((y=rn||{}).CAPTION="caption",y),ra={f:"high",h:"medium",q:"low"},ro=((k=ro||{}).VOICE="voice",k.MUSIC="music",k),rl=((b=rl||{}).videoInput="videoInput",b.audioInput="audioInput",b.audioOutput="audioOutput",b),rd=class{constructor(){this._volume=1,this._codec="opus",this._maxBitrate=32,this._deviceId="default",this._audioMode="voice",this._advanced=[{autoGainControl:{exact:!0}},{noiseSuppression:{exact:!0}},{highpassFilter:{exact:!0}},{audioMirroring:{exact:!0}}]}volume(e){if(!(0<=e&&e<=1))throw Error("volume can only be in range [0.0, 1.0]");return this._volume=e,this}codec(e){return this._codec=e,this}maxBitrate(e){if(e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate="music"===this._audioMode?320:e,this}deviceId(e){return this._deviceId=e,this}audioMode(e="voice"){return this._audioMode=e,"music"===this._audioMode?this._maxBitrate=320:this._maxBitrate=32,this}advanced(e){return this._advanced=e,this}build(){return new rc(this._volume,this._codec,this._maxBitrate,this._deviceId,this._advanced,this._audioMode)}},rc=class{constructor(e,t,i,s,r,n){this.volume=e,this.codec=t,this.maxBitrate=i,this.deviceId=s,this.advanced=r,this.audioMode=n,"music"===this.audioMode?this.maxBitrate=320:this.maxBitrate=32}toConstraints(){return{deviceId:this.deviceId,advanced:"music"===this.audioMode?[]:this.advanced}}toAnalyticsProperties(){return{audio_bitrate:this.maxBitrate,audio_codec:this.codec}}},ru=class{constructor(){this._width=320,this._height=180,this._codec="vp8",this._maxFramerate=30,this._maxBitrate=150,this._advanced=[]}setWidth(e){return this._width=e,this}setHeight(e){return this._height=e,this}codec(e){return this._codec=e,this}maxFramerate(e){if(e&&e<=0)throw Error("maxFramerate should be >= 1");return this._maxFramerate=e,this}maxBitrate(e,t=!0){if("number"==typeof e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,!this._maxBitrate&&t&&(this._maxBitrate=15e4),this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}facingMode(e){return this._facingMode=e,this}build(){return new rh(this._width,this._height,this._codec,this._maxFramerate,this._deviceId,this._advanced,this._maxBitrate,this._facingMode)}},rh=class{constructor(e,t,i,s,r,n,a,o){this.width=e,this.height=t,this.codec=i,this.maxFramerate=s,this.maxBitrate=a,this.deviceId=r,this.advanced=n,this.facingMode=o}toConstraints(e){let t="ideal";e&&(t="max");let i=this.improviseConstraintsAspect();return{width:{[t]:i.width},height:{[t]:i.height},frameRate:this.maxFramerate,deviceId:this.deviceId,facingMode:this.facingMode}}toAnalyticsProperties(){return{width:this.width,height:this.height,video_bitrate:this.maxBitrate,framerate:this.maxFramerate,video_codec:this.codec,facingMode:this.facingMode}}improviseConstraintsAspect(){return t4()&&this.height&&this.width&&this.height>this.width?{width:this.height,height:this.width}:{width:this.width,height:this.height}}},rp=class{constructor(){this._video=new ru().build(),this._audio=new rd().build(),this._screen=new ru().build(),this._simulcast=!1}video(e){return this._video=e,this}audio(e){return this._audio=e,this}screen(e){return this._screen=e,this}simulcast(e){return this._simulcast=e,this}build(){if(null===this._audio&&null===this._video)throw i3("TRACK");if(null===this._video&&this._simulcast)throw i5("TRACK","Cannot enable simulcast when no video settings are provided");return new rv(this._video,this._audio,this._simulcast,this._screen||void 0)}},rv=class{constructor(e,t,i,s=null){this.video=e,this.audio=t,this.simulcast=i,this.screen=s}toAnalyticsProperties(){let e={audio_enabled:null!==this.audio,video_enabled:null!==this.video};return this.audio&&(e=tb(tb({},this.audio.toAnalyticsProperties()),e)),this.video&&(e=tb(tb({},this.video.toAnalyticsProperties()),e)),e}};function rg(e,t){return function(i){return!_(q)(e[i],t[i])}}var rm=class e extends sV{constructor(e,t,i,s,r=new rd().build(),n){super(e,t,i),this.eventBus=s,this.room=n,this.TAG="[HMSLocalAudioTrack]",this.tracksCreated=new Set,this.isPublished=!1,this.handleVisibilityChange=()=>tP(this,null,function*(){if(!this.shouldReacquireTrack())return void tV.d(this.TAG,`visibiltiy: ${document.visibilityState}`,`${this}`);if("hidden"===document.visibilityState)this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!0,reason:"visibility-change"}));else{tV.d(this.TAG,"On visibile replacing track as it is not publishing");try{yield this.replaceTrackWith(this.settings)}catch(e){this.eventBus.error.publish(e)}this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!1,reason:"visibility-change"}))}}),this.trackPermissions=()=>{s0("microphone",e=>{this.eventBus.analytics.publish(sj.permissionChange(this.type,e)),"denied"===e&&this.eventBus.localAudioEnabled.publish({enabled:!1,track:this})})},this.handleTrackMute=()=>{tV.d(this.TAG,"muted natively");let e="hidden"===document.visibilityState?"visibility-change":"incoming-call";this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!0,reason:e})),this.eventBus.localAudioEnabled.publish({enabled:!1,track:this})},this.handleTrackUnmute=()=>tP(this,null,function*(){tV.d(this.TAG,"unmuted natively");let e="hidden"===document.visibilityState?"visibility-change":"incoming-call";this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!1,reason:e}));try{yield this.setEnabled(this.enabled,!0),this.eventBus.localAudioUnmutedNatively.publish()}catch(e){this.eventBus.error.publish(e)}}),this.replaceSenderTrack=()=>tP(this,null,function*(){if(!this.transceiver||"sendonly"!==this.transceiver.direction)return void tV.d(this.TAG,`transceiver for ${this.trackId} not available or not connected yet`);yield this.transceiver.sender.replaceTrack(this.processedTrack||this.nativeTrack)}),this.shouldReacquireTrack=()=>sZ(this.nativeTrack)||this.isTrackNotPublishing(),this.handleSettingsChange=e=>tP(this,null,function*(){let t=this.stream,i=rg(e,this.settings);(i("maxBitrate")||i("audioMode"))&&e.maxBitrate&&(yield t.setMaxBitrateAndFramerate(this,e)),(i("advanced")||i("audioMode"))&&(yield this.replaceTrackWith(e))}),this.handleDeviceChange=(e,t=!1)=>tP(this,null,function*(){if(rg(e,this.settings)("deviceId")){this.manuallySelectedDeviceId=t?this.manuallySelectedDeviceId:e.deviceId,tV.d(this.TAG,"device change","manual selection:",this.manuallySelectedDeviceId,"new device:",e.deviceId),yield this.replaceTrackWith(e);let i=this.nativeTrack.getSettings().groupId;!t&&e.deviceId&&(sq.updateSelection("audioInput",{deviceId:e.deviceId,groupId:i}),this.eventBus.deviceChange.publish({isUserSelection:!0,type:"audioInput",selection:{deviceId:e.deviceId,groupId:i}}))}}),e.tracks.push(this),this.addTrackEventListeners(t),this.trackPermissions(),this.settings=r,r.deviceId===t.getSettings().deviceId||sZ(t)||(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new sJ(this,s,n),this.setFirstTrackId(t.id),"regular"===i&&document.addEventListener("visibilitychange",this.handleVisibilityChange)}clone(t){let i=this.nativeTrack.clone();t.nativeStream.addTrack(i);let s=new e(t,i,this.source,this.eventBus,this.settings,this.room);return s.peerId=this.peerId,this.pluginsManager.pluginsMap.size>0&&this.pluginsManager.pluginsMap.forEach(e=>{s.addPlugin(e).catch(t=>tV.e(this.TAG,"Plugin add failed while migrating",e,t))}),s}getManuallySelectedDeviceId(){return this.manuallySelectedDeviceId}resetManuallySelectedDeviceId(){this.manuallySelectedDeviceId=void 0}updateTrack(e){return tP(this,null,function*(){e.enabled=this.enabled,yield this.stream.replaceStreamTrack(this.nativeTrack,e),this.nativeTrack=e,yield this.replaceSenderTrack(),this.audioLevelMonitor&&this.initAudioLevelMonitor()})}replaceTrackWith(e){return tP(this,null,function*(){let t=this.nativeTrack;null==t||t.stop(),this.removeTrackEventListeners(t),this.tracksCreated.forEach(e=>e.stop()),this.tracksCreated.clear();try{let i=yield sY(e);this.addTrackEventListeners(i),this.tracksCreated.add(i),tV.d(this.TAG,"replaceTrack, Previous track stopped",t,"newTrack",i),yield this.updateTrack(i)}catch(t){let e=yield sY(this.settings);throw this.addTrackEventListeners(e),this.tracksCreated.add(e),yield this.updateTrack(e),this.isPublished&&this.eventBus.analytics.publish(sj.publish({error:t})),t}try{yield this.pluginsManager.reprocessPlugins()}catch(e){this.eventBus.audioPluginFailed.publish(e)}})}setEnabled(t,i=!1){return tP(this,null,function*(){(t!==this.enabled||i)&&(t&&this.shouldReacquireTrack()&&(yield this.replaceTrackWith(this.settings)),yield tw(e.prototype,this,"setEnabled").call(this,t),t&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),this.eventBus.localAudioEnabled.publish({enabled:t,track:this}))})}isPublishedTrackId(e){return this.publishedTrackId===e}setSettings(e,t=!1){return tP(this,null,function*(){let i=this.buildNewSettings(e);if(sZ(this.nativeTrack)){this.settings=i;return}yield this.handleDeviceChange(i,t),yield this.handleSettingsChange(i),this.settings=i})}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e){return tP(this,null,function*(){return this.pluginsManager.addPlugin(e)})}removePlugin(e){return tP(this,null,function*(){return this.pluginsManager.removePlugin(e)})}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}setProcessedTrack(e){return tP(this,null,function*(){e?e!==this.processedTrack&&(this.processedTrack=e):this.processedTrack=void 0,yield this.replaceSenderTrack()})}initAudioLevelMonitor(){this.audioLevelMonitor&&this.destroyAudioLevelMonitor(),tV.d(this.TAG,"Monitor Audio Level for",this,this.getMediaTrackSettings().deviceId),this.audioLevelMonitor=new s7(this,this.eventBus.trackAudioLevelUpdate,this.eventBus.localAudioSilence),this.audioLevelMonitor.start(),this.audioLevelMonitor.detectSilence()}destroyAudioLevelMonitor(){var e;null==(e=this.audioLevelMonitor)||e.stop(),this.audioLevelMonitor=void 0}cleanup(){return tP(this,null,function*(){var t;tw(e.prototype,this,"cleanup").call(this),yield this.pluginsManager.cleanup(),yield this.pluginsManager.closeContext(),this.transceiver=void 0,null==(t=this.processedTrack)||t.stop(),this.tracksCreated.forEach(e=>e.stop()),this.tracksCreated.clear(),this.isPublished=!1,this.destroyAudioLevelMonitor(),document.removeEventListener("visibilitychange",this.handleVisibilityChange)})}getTrackIDBeingSent(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id}getTrackBeingSent(){return this.processedTrack||this.nativeTrack}addTrackEventListeners(e){e.addEventListener("mute",this.handleTrackMute),e.addEventListener("unmute",this.handleTrackUnmute)}removeTrackEventListeners(e){e.removeEventListener("mute",this.handleTrackMute),e.removeEventListener("unmute",this.handleTrackUnmute)}buildNewSettings(e){let{volume:t,codec:i,maxBitrate:s,deviceId:r,advanced:n,audioMode:a}=tb(tb({},this.settings),e);return new rc(t,i,s,r,n,a)}},rf=class e extends sV{setEnabled(t){return tP(this,null,function*(){t!==this.enabled&&(yield tw(e.prototype,this,"setEnabled").call(this,t),yield this.subscribeToAudio(t))})}},ry=class extends sG{constructor(e,t,i){if(super(e,t,i),this.type="video",this.sinkCount=0,this.handleTrackUnmute=()=>{this.getSinks().forEach(e=>this.reTriggerPlay({videoElement:e}))},this.reTriggerPlay=({videoElement:e})=>{setTimeout(()=>{e.play().catch(e=>{tV.w("[HMSVideoTrack]","failed to play",e.message)})},0)},"video"!==t.kind)throw Error("Expected 'track' kind = 'video'")}setVideoHandler(e){this.videoHandler=e}hasSinks(){return this.sinkCount>0}getSinks(){return this.videoHandler.getVideoElements()||[]}attach(e){this.videoHandler.addVideoElement(e)}detach(e){this.videoHandler.removeVideoElement(e)}addSink(e){this.addSinkInternal(e,this.nativeTrack)}removeSink(e){null!==e.srcObject&&(e.srcObject=null,this.reduceSinkCount())}cleanup(){super.cleanup(),this.videoHandler.cleanup()}addSinkInternal(e,t){let i=e.srcObject;if(null!==i&&i instanceof MediaStream){let e=i.getVideoTracks()[0];if((null==e?void 0:e.id)===t.id){if(!e.muted&&"live"===e.readyState)return;this.reduceSinkCount()}else this.reduceSinkCount()}this.addPropertiesToElement(e),e.srcObject=new MediaStream([t]),this.reTriggerPlay({videoElement:e}),this.sinkCount++}reduceSinkCount(){this.sinkCount>0&&this.sinkCount--}addPropertiesToElement(e){t6||(e.autoplay=!0),e.playsInline=!0,e.muted=!0,e.controls=!1}},rk={none:-1,low:0,medium:1,high:2},rb=(e,t)=>{let i="high",s=t.width>t.height?"width":"height",r=[...e].sort((e,t)=>rk[e.layer]-rk[t.layer]),n=t[s]*((null==window?void 0:window.devicePixelRatio)||1);for(let e=0;e<r.length;e++){let{resolution:t,layer:a}=r[e],o=t[s];if(n<=o){i=a;break}{let t=r[e+1];if((n-o)/((t?t.resolution[s]:1/0)-o)<.5){i=a;break}}}return i},rT=new class{constructor(){this.TAG="[HMSIntersectionObserverWrapper]",this.listeners=new WeakMap,this.observe=(e,t)=>{var i;this.createObserver(),this.unobserve(e),null==(i=this.intersectionObserver)||i.observe(e),this.listeners.set(e,t)},this.unobserve=e=>{var t;null==(t=this.intersectionObserver)||t.unobserve(e),this.listeners.delete(e)},this.createObserver=()=>{this.isSupported()&&!this.intersectionObserver&&(this.intersectionObserver=new IntersectionObserver(this.handleIntersection))},this.handleIntersection=e=>{var t;for(let i of e)null==(t=this.listeners.get(i.target))||t(i)},this.createObserver()}isSupported(){let e=t3&&void 0!==window.IntersectionObserver;return e||tV.w(this.TAG,"IntersectionObserver is not supported, fallback will be used instead"),e}},rS=new class{constructor(){this.TAG="[HMSResizeObserverWrapper]",this.listeners=new WeakMap,this.observe=(e,t,i={box:"border-box"})=>{var s;this.createObserver(),this.unobserve(e),null==(s=this.resizeObserver)||s.observe(e,i),this.listeners.set(e,t)},this.unobserve=e=>{var t;null==(t=this.resizeObserver)||t.unobserve(e),this.listeners.delete(e)},this.createObserver=()=>{this.isSupported()&&!this.resizeObserver&&(this.resizeObserver=new ResizeObserver(s8(this.handleResize,300)))},this.handleResize=e=>{var t;for(let i of e)null==(t=this.listeners.get(i.target))||t(i)},this.createObserver()}isSupported(){let e=t3&&void 0!==window.ResizeObserver;return e||tV.w(this.TAG,"Resize Observer is not supported"),e}},rw=class{constructor(e){this.track=e,this.TAG="[VideoElementManager]",this.videoElements=new Set,this.entries=new WeakMap,this.handleIntersection=e=>tP(this,null,function*(){let t="visible"===getComputedStyle(e.target).visibility;this.track.enabled&&(e.isIntersecting&&t||!document.contains(e.target))?(tV.d(this.TAG,"add sink intersection",`${this.track}`,this.id),this.entries.set(e.target,e.boundingClientRect),yield this.selectMaxLayer(),yield this.track.addSink(e.target)):(tV.d(this.TAG,"remove sink intersection",`${this.track}`,this.id),yield this.track.removeSink(e.target))}),this.handleResize=e=>tP(this,null,function*(){this.track.enabled&&this.track instanceof rG&&(this.entries.set(e.target,e.contentRect),yield this.selectMaxLayer())}),this.cleanup=()=>{this.videoElements.forEach(e=>{var t,i;e.srcObject=null,null==(t=this.resizeObserver)||t.unobserve(e),null==(i=this.intersectionObserver)||i.unobserve(e)}),this.videoElements.clear(),this.resizeObserver=void 0,this.intersectionObserver=void 0},this.init(),this.id=V()}updateSinks(e=!1){for(let t of this.videoElements)this.track.enabled?this.track.addSink(t,e):this.track.removeSink(t,e)}addVideoElement(e){return tP(this,null,function*(){var t;this.videoElements.has(e)||(this.init(),tV.d(this.TAG,`Adding video element for ${this.track}`,this.id),this.videoElements.add(e),this.videoElements.size>=10&&tV.w(this.TAG,`${this.track}`,`the track is added to ${this.videoElements.size} video elements, while this may be intentional, it's likely that there is a bug leading to unnecessary creation of video elements in the UI`),null!=(t=this.intersectionObserver)&&t.isSupported()?this.intersectionObserver.observe(e,this.handleIntersection):t3&&(this.isElementInViewport(e)?this.track.addSink(e):this.track.removeSink(e)),this.resizeObserver?this.resizeObserver.observe(e,this.handleResize):this.track instanceof rG&&(yield this.track.setPreferredLayer(this.track.getPreferredLayer())))})}removeVideoElement(e){var t,i;this.track.removeSink(e),this.videoElements.delete(e),this.entries.delete(e),null==(t=this.resizeObserver)||t.unobserve(e),null==(i=this.intersectionObserver)||i.unobserve(e),tV.d(this.TAG,`Removing video element for ${this.track}`)}getVideoElements(){return Array.from(this.videoElements)}init(){t3&&(this.resizeObserver=rS,this.intersectionObserver=rT)}isElementInViewport(e){let t=e.offsetTop,i=e.offsetLeft,s=e.offsetWidth,r=e.offsetHeight,{hidden:n}=e,{opacity:a,display:o}=getComputedStyle(e);for(;e.offsetParent;)t+=(e=e.offsetParent).offsetTop,i+=e.offsetLeft;return t<window.pageYOffset+window.innerHeight&&i<window.pageXOffset+window.innerWidth&&t+r>window.pageYOffset&&i+s>window.pageXOffset&&!n&&(""===a||parseFloat(a)>0)&&"none"!==o}selectMaxLayer(){return tP(this,null,function*(){let e;if(this.track instanceof rG&&0!==this.videoElements.size){for(let t of this.videoElements){let i=this.entries.get(t);if(!i)continue;let{width:s,height:r}=i;if(0===s||0===r)continue;let n=rb(this.track.getSimulcastDefinitions(),{width:s,height:r});e=e?rk[n]>rk[e]?n:e:n}e&&(tV.d(this.TAG,`selecting max layer ${e} for the track`,`${this.track}`),yield this.track.setPreferredLayer(e))}})}},rP,rC,rE=((T=rE||{}).TRANSFORM="TRANSFORM",T.ANALYZE="ANALYZE",T),rI=((S=rI||{})["2D"]="2d",S.WEBGL="webgl",S.WEBGL2="webgl2",S),rA=class{constructor(){this.total=0,this.count=0}add(e){this.count++,this.total+=e}getAvg(){return Math.floor(this.total/this.count)}reset(){this.total=0,this.count=0}},rR=class{constructor(e){this.eventBus=e,this.TAG="[VideoPluginsAnalytics]",this.initTime={},this.preProcessingAvgs=new rA,this.addedTimestamps={},this.processingAvgs={},this.pluginAdded={},this.pluginInputFrameRate={},this.pluginFrameRate={}}added(e,t,i){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.processingAvgs[e]=new rA,t&&(this.pluginInputFrameRate[e]=t,this.pluginFrameRate[e]=i||t),this.eventBus.analytics.publish(sz.added(e,this.addedTimestamps[e]))}removed(e){var t;if(this.pluginAdded[e]){let i={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],avgPreProcessingTime:this.preProcessingAvgs.getAvg(),avgProcessingTime:null==(t=this.processingAvgs[e])?void 0:t.getAvg(),inputFrameRate:this.pluginInputFrameRate[e],pluginFrameRate:this.pluginFrameRate[e]};this.eventBus.analytics.publish(sz.stats(i)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(sz.failure(e,t)),this.clean(e))}initWithTime(e,t){return tP(this,null,function*(){let i;if(this.initTime[e])return void tV.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);try{i=yield this.timeInMs(t),tV.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(i){let t=sw("VIDEO_PLUGINS",`failed during initialization of plugin${i.message||i}`);throw tV.e(this.TAG,t),this.failure(e,t),t}i&&(this.initTime[e]=i)})}preProcessWithTime(e){return tP(this,null,function*(){let t=yield this.timeInMs(e);this.preProcessingAvgs.add(t)})}processWithTime(e,t){return tP(this,null,function*(){var i;let s;try{s=yield this.timeInMs(t)}catch(i){let t=sP("VIDEO_PLUGINS",`Failed during processing of plugin${i.message||i}`);throw tV.e(this.TAG,t),this.failure(e,t),t}s&&(null==(i=this.processingAvgs[e])||i.add(s))})}timeInMs(e){return tP(this,null,function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)})}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.processingAvgs[e],delete this.pluginAdded[e],delete this.pluginInputFrameRate[e],delete this.pluginFrameRate[e]}},r_=class{constructor(e,t){this.TAG="[VideoPluginsManager]",this.pluginsLoopRunning=!1,this.pluginsLoopState="paused",this.pluginAddInProgress=!1,this.reusableWorker=function(){if("undefined"==typeof Worker)return{sleep:e=>s6(e)};let e=new Worker(URL.createObjectURL(new Blob([s4],{type:"application/javascript"})));return{sleep:t=>(e.postMessage(["start",t]),new Promise(t=>{e.onmessage=e=>{"tick"===e.data&&t()}}))}}(),this.hmsTrack=e,this.pluginsMap=new Map,this.pluginNumFramesToSkip={},this.pluginNumFramesSkipped={},this.analytics=new rR(t),this.canvases=[]}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e,t){return tP(this,null,function*(){var i;if(this.pluginAddInProgress){let t=null==(i=e.getName)?void 0:i.call(e);if(!t||""===t)return void tV.w("no name provided by the plugin");let s=sC("VIDEO_PLUGINS","Add Plugin is already in Progress");throw this.analytics.failure(t,s),tV.w("can't add another plugin when previous add is in progress"),s}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e,t)}finally{this.pluginAddInProgress=!1}})}addPluginInternal(e,t){return tP(this,null,function*(){var i,s;let r=null==(i=e.getName)?void 0:i.call(e);if(!r||""===r)return void tV.w("no name provided by the plugin");if(this.pluginsMap.has(r))return void tV.w(this.TAG,`plugin - ${e.getName()} already added.`);let n=this.hmsTrack.getMediaTrackSettings().frameRate||24,a=0;t&&t>0?(tV.i(this.TAG,`adding plugin ${e.getName()} with framerate ${t}`),t<n&&(a=Math.ceil(n/t)-1),this.analytics.added(r,n,t)):(tV.i(this.TAG,`adding plugin ${e.getName()}`),this.analytics.added(r,n)),tV.i(this.TAG,"numFrames to skip processing",a),this.pluginNumFramesToSkip[r]=a,this.pluginNumFramesSkipped[r]=a,this.validateAndThrow(r,e);try{if(yield this.analytics.initWithTime(r,()=>tP(this,null,function*(){return yield e.init()})),this.pluginsMap.set(r,e),this.pluginsMap.size+1>this.canvases.length)for(let e=this.canvases.length;e<=this.pluginsMap.size;e++)this.canvases[e]=document.createElement("canvas");yield this.startPluginsLoop(null==(s=e.getContextType)?void 0:s.call(e))}catch(t){throw tV.e(this.TAG,"failed to add plugin",t),yield this.removePlugin(e),t}})}validatePlugin(e){return e.checkSupport()}validateAndThrow(e,t){let i=this.validatePlugin(t);if(i.isSupported)tV.i(this.TAG,`plugin is supported,- ${t.getName()}`);else{let t;switch(i.errType){case"PLATFORM_NOT_SUPPORTED":throw t=sS("VIDEO_PLUGINS","platform not supported, see docs"),this.analytics.failure(e,t),t;case"DEVICE_NOT_SUPPORTED":throw t=sE("VIDEO_PLUGINS","video device not supported, see docs"),this.analytics.failure(e,t),t}}}removePlugin(e){return tP(this,null,function*(){let t=e.getName();if(!this.pluginsMap.get(t))return void tV.w(this.TAG,`plugin - ${t} not found to remove.`);tV.i(this.TAG,`removing plugin ${t}`),this.removePluginEntry(t),0===this.pluginsMap.size&&(tV.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.stopPluginsLoop()),e.stop(),this.analytics.removed(t)})}removePluginEntry(e){this.pluginsMap.delete(e),this.pluginNumFramesToSkip[e]&&delete this.pluginNumFramesToSkip[e],this.pluginNumFramesSkipped[e]&&delete this.pluginNumFramesSkipped[e]}waitForRestart(){return tP(this,null,function*(){if(!(!this.pluginsLoopRunning||"running"===this.pluginsLoopState))for(;"paused"===this.pluginsLoopState;)yield s9(100)})}cleanup(){return tP(this,null,function*(){var e;for(let e of this.pluginsMap.values())yield this.removePlugin(e);null==(e=this.outputTrack)||e.stop()})}initElementsAndStream(e){this.inputCanvas||(this.inputCanvas=document.createElement("canvas")),this.outputCanvas=document.createElement("canvas"),this.inputVideo||(this.inputVideo=document.createElement("video")),this.inputCanvas.getContext("2d"),this.outputCanvas.getContext(e||"2d");let t=this.outputCanvas.captureStream();this.outputTrack=t.getVideoTracks()[0]}startPluginsLoop(e){return tP(this,null,function*(){if(!this.pluginsLoopRunning){this.initElementsAndStream(e),this.pluginsLoopRunning=!0;try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw this.pluginsLoopRunning=!1,tV.e(this.TAG,"error in setting processed track",e),e}this.pluginsLoop().then(()=>{tV.d(this.TAG,"processLoop stopped")})}})}stopPluginsLoop(){return tP(this,null,function*(){var e;this.pluginsLoopRunning=!1,yield this.hmsTrack.setProcessedTrack(void 0),this.resetCanvases(),null==(e=this.outputTrack)||e.stop(),this.inputVideo&&(this.inputVideo.srcObject=null,this.inputVideo=void 0)})}pluginsLoop(){return tP(this,null,function*(){for(;this.pluginsLoopRunning;){let e=Math.floor(1e3/(this.hmsTrack.getMediaTrackSettings().frameRate||24));if(!this.hmsTrack.enabled||"ended"===this.hmsTrack.nativeTrack.readyState){"running"===this.pluginsLoopState&&this.resetCanvases(),this.pluginsLoopState="paused",yield this.reusableWorker.sleep(e);continue}let t=0;try{yield this.analytics.preProcessWithTime(()=>tP(this,null,function*(){return yield this.doPreProcessing()}));let i=Date.now();yield this.processFramesThroughPlugins(),(t=Math.floor(Date.now()-i))>e&&(t=e)}catch(e){tV.e(this.TAG,"error in plugins loop",e)}this.pluginsLoopState="running",yield this.reusableWorker.sleep(e-t)}})}doPreProcessing(){return tP(this,null,function*(){yield this.addTrackToVideo(),yield this.updateInputCanvas()})}processFramesThroughPlugins(){return tP(this,null,function*(){this.canvases[0]=this.inputCanvas;let e=0;for(let t of this.pluginsMap.values()){let i=t.getName();if(t){try{let s=this.checkIfSkipRequired(i);if("TRANSFORM"===t.getPluginType()){let r=(e,r)=>tP(this,null,function*(){try{yield t.processVideoFrame(e,r,s)}catch(e){tV.e(this.TAG,`error in processing plugin ${i}`,e)}});if(s)e===this.pluginsMap.size-1?yield r(this.canvases[e],this.outputCanvas):yield r(this.canvases[e],this.canvases[e+1]);else{let t=this.canvases[e],s=this.canvases[e+1];e===this.pluginsMap.size-1?yield this.analytics.processWithTime(i,()=>tP(this,null,function*(){return r(t,this.outputCanvas)})):yield this.analytics.processWithTime(i,()=>tP(this,null,function*(){return r(t,s)}))}}else"ANALYZE"!==t.getPluginType()||s||(yield this.analytics.processWithTime(i,()=>tP(this,null,function*(){return yield t.processVideoFrame(this.inputCanvas)})))}catch(e){tV.e(this.TAG,`error in processing plugin ${i}`,e),yield this.removePlugin(t)}e++}}})}addTrackToVideo(){return tP(this,null,function*(){var e;if(!this.inputVideo)return;let t=this.inputVideo.srcObject;null!==t&&t instanceof MediaStream&&(null==(e=t.getVideoTracks()[0])?void 0:e.id)===this.hmsTrack.nativeTrack.id||(this.inputVideo.pause(),this.inputVideo.srcObject=new MediaStream([this.hmsTrack.nativeTrack]),this.inputVideo.muted=!0,this.inputVideo.playsInline=!0,yield this.inputVideo.play())})}updateInputCanvas(){return tP(this,null,function*(){if(!this.inputCanvas||!this.inputVideo)return;let{width:e=320,height:t=240}=this.hmsTrack.getMediaTrackSettings();this.inputCanvas.height!==t&&(this.inputCanvas.height=t),this.inputCanvas.width!==e&&(this.inputCanvas.width=e),this.inputCanvas.getContext("2d").drawImage(this.inputVideo,0,0,e,t)})}resetCanvases(){if(!this.outputCanvas||!this.inputCanvas)return;let e=this.inputCanvas.getContext("2d");e&&(e.fillStyle="rgb(0, 0, 0)",e.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height)),this.canvases=[]}checkIfSkipRequired(e){let t=!1;return this.pluginNumFramesSkipped[e]<this.pluginNumFramesToSkip[e]?(this.pluginNumFramesSkipped[e]++,t=!0):(t=!1,this.pluginNumFramesSkipped[e]=0),t}},rL=class{constructor(e,t){this.TAG="[MediaStreamPluginsManager]",this.plugins=new Set,this.analytics=new rR(e),this.room=t}addPlugins(e){e.forEach(e=>{var t;if("HMSEffectsPlugin"===e.getName()&&!(null!=(t=this.room)&&t.isEffectsEnabled)){let e="Effects Virtual Background is not enabled for this room";if(0===this.plugins.size)throw Error(e);tV.w(this.TAG,e);return}this.plugins.add(e)})}removePlugins(e){e.forEach(e=>{e.stop(),this.analytics.removed(e.getName()),this.plugins.delete(e)})}applyPlugins(e){let t=e;for(let e of this.plugins){let i=e.getName();try{t=e.apply(t),this.analytics.added(i)}catch(e){this.analytics.failure(i,e),tV.e("Could not apply plugin",e,i)}}return t}getPlugins(){return Array.from(this.plugins).map(e=>e.getName())}cleanup(){return tP(this,null,function*(){this.removePlugins(Array.from(this.plugins))})}},rM=["init_response_time","ws_connect_time","on_policy_change_time","local_audio_track_time","local_video_track_time","peer_list_time","room_state_time","join_response_time"],rD=class{constructor(){this.eventPerformanceMeasures={}}start(e){performance.mark(e)}end(e){var t;try{this.eventPerformanceMeasures[e]=performance.measure(e,e),tV.d("[HMSPerformanceTiming]",e,null==(t=this.eventPerformanceMeasures[e])?void 0:t.duration)}catch(t){tV.w("[AnalyticsTimer]",`Error in measuring performance for event ${e}`,{error:t})}}getTimeTaken(e){var t;return null==(t=this.eventPerformanceMeasures[e])?void 0:t.duration}getTimes(...e){return[...rM,...e].reduce((e,t)=>tT(tb({},e),{[t]:this.getTimeTaken(t)}),{})}cleanup(){this.eventPerformanceMeasures={}}},rO={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default",audioMode:"voice"},rN=class e{constructor(e,t,i,s,r){this.store=e,this.observer=t,this.deviceManager=i,this.eventBus=s,this.analyticsTimer=r,this.TAG="[LocalTrackManager]",this.setScreenCaptureHandleConfig()}getTracksToPublish(){return tP(this,arguments,function*(e=rO){let t=this.getAVTrackSettings(e);if(!t)return[];let i=!!t.audio,s=!!t.video,r=[],{videoTrack:n,audioTrack:a}=yield this.updateCurrentLocalTrackSettings(t),o=(null==n?void 0:n.stream)||(null==a?void 0:a.stream),l=!!(n&&this.store.getTrackById(n.trackId)),d=!!(a&&this.store.getTrackById(a.trackId));if(l&&d)return[];let c={audio:i&&!a&&(!e.isAudioMuted||"empty"),video:s&&!n&&(!e.isVideoMuted||"empty")};c.audio&&this.analyticsTimer.start("local_audio_track_time"),c.video&&this.analyticsTimer.start("local_video_track_time");try{tV.d(this.TAG,"Init Local Tracks",{fetchTrackOptions:c}),r=yield this.getLocalTracks(c,t,o)}catch(e){r=yield this.retryGetLocalTracks(e,t,c,o)}return c.audio&&this.analyticsTimer.end("local_audio_track_time"),c.video&&this.analyticsTimer.end("local_video_track_time"),n&&s&&!l&&r.push(n),a&&i&&!d&&r.push(a),r})}getLocalTracks(){return tP(this,arguments,function*(e={audio:!0,video:!0},t,i){try{let s=yield this.getNativeLocalTracks(e,t);return this.createHMSLocalTracks(s,t,i)}catch(e){throw this.eventBus.analytics.publish(sj.publish({devices:this.deviceManager.getDevices(),error:e,settings:t})),e}})}getNativeLocalTracks(){return tP(this,arguments,function*(e={audio:!1,video:!1},t){let i=new rv(!0===e.video?t.video:null,!0===e.audio?t.audio:null,t.simulcast),s=[];return(i.audio||i.video)&&s.push(...yield this.getAVTracks(i)),s.push(...this.getEmptyTracks(e)),s})}optimizeScreenShareConstraint(e,t){return tP(this,null,function*(){var i,s,r;if("boolean"==typeof t.video||!(null!=(i=t.video)&&i.width)||!(null!=(s=t.video)&&s.height))return;let n=this.store.getPublishParams();if(!n||!(null!=(r=n.allowed)&&r.includes("screen")))return;let a=document.createElement("video");a.srcObject=e,a.addEventListener("loadedmetadata",()=>tP(this,null,function*(){let{videoWidth:i,videoHeight:s}=a,r=n.screen,o=r.width*r.height,l=i/s,d=r.width/r.height;if(l>d){let r=t.video,n=Math.sqrt(l/d);i*s>o?(r.width=i/n,r.height=s/n):(r.height=s*n,r.width=i*n),yield e.getVideoTracks()[0].applyConstraints(r)}}))})}getLocalScreen(e,t=!1){return tP(this,null,function*(){var i;let s,r=yield this.getOrDefaultScreenshareConfig(e),n=this.getScreenshareSettings(r.videoOnly),a={video:tT(tb({},null==n?void 0:n.video.toConstraints(!0)),{displaySurface:r.displaySurface}),preferCurrentTab:r.preferCurrentTab,selfBrowserSurface:r.selfBrowserSurface,surfaceSwitching:r.surfaceSwitching,systemAudio:r.systemAudio};if(null!=n&&n.audio){let e=null==(i=null==n?void 0:n.audio)?void 0:i.toConstraints();delete e.advanced,a.audio=tT(tb({},e),{autoGainControl:!1,noiseSuppression:!1,googAutoGainControl:!1,echoCancellation:!1})}else null!=e&&e.forceCurrentTab&&e.preferCurrentTab&&e.cropElement&&(a.audio={echoCancellation:!0,noiseSuppression:!0});try{tV.d("retrieving screenshare with ",{config:r},{constraints:a}),s=yield navigator.mediaDevices.getDisplayMedia(a),t&&(yield this.optimizeScreenShareConstraint(s,a))}catch(t){tV.w(this.TAG,"error in getting screenshare - ",t);let e=sQ(t,"screen");throw this.eventBus.analytics.publish(sj.publish({error:e,devices:this.deviceManager.getDevices(),settings:new rv(null==n?void 0:n.video,null==n?void 0:n.audio,!1)})),e}let o=[],l=new rq(s),d=new rU(l,s.getVideoTracks()[0],"screen",this.eventBus,null==n?void 0:n.video,this.store.getRoom());d.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"screen"));try{let e=this.validateCurrentTabCapture(d,r.forceCurrentTab);d.isCurrentTab=e,yield d.cropTo(r.cropTarget)}catch(e){throw s.getTracks().forEach(e=>e.stop()),e}o.push(d);let c=s.getAudioTracks()[0];if(c){let e=new rm(l,c,"screen",this.eventBus,null==n?void 0:n.audio,this.store.getRoom());o.push(e)}return tV.v(this.TAG,"getLocalScreen",o),o})}setScreenCaptureHandleConfig(e){var t;!(null!=(t=navigator.mediaDevices)&&t.setCaptureHandleConfig)||this.isInIframe()||(Object.assign(e=e||{},{handle:V(),exposeOrigin:!1,permittedOrigins:[window.location.origin]}),tV.d("setting capture handle - ",e.handle),navigator.mediaDevices.setCaptureHandleConfig(e),this.captureHandleIdentifier=e.handle)}validateCurrentTabCapture(e,t){let i=e.getCaptureHandle(),s=!!(this.captureHandleIdentifier&&(null==i?void 0:i.handle)===this.captureHandleIdentifier);if(t&&!s)throw tV.e(this.TAG,"current tab was not shared with forceCurrentTab as true"),i7();return s}requestPermissions(){return tP(this,null,function*(){try{(yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})).getTracks().forEach(e=>e.stop())}catch(e){tV.e(this.TAG,e)}})}static getEmptyVideoTrack(e){var t,i,s;let r=(null==(t=null==e?void 0:e.getSettings())?void 0:t.width)||320,n=(null==(i=null==e?void 0:e.getSettings())?void 0:i.height)||240;rP||((rP=document.createElement("canvas")).width=r,rP.height=n,null==(s=rP.getContext("2d"))||s.fillRect(0,0,r,n)),rC||(rC=setInterval(()=>{let e=null==rP?void 0:rP.getContext("2d");e&&e.fillRect(0,0,1,1)},1e3));let a=rP.captureStream(1).getVideoTracks()[0];return a.enabled=!1,a}static getEmptyAudioTrack(){let e=s1.getAudioContext(),t=e.createOscillator(),i=e.createMediaStreamDestination();t.connect(i),t.start();let s=i.stream.getAudioTracks()[0];return s.enabled=!1,s}static cleanup(){clearInterval(rC),rC=void 0,rP=void 0}getAVTracks(e){return tP(this,null,function*(){try{let t=yield navigator.mediaDevices.getUserMedia({audio:!!e.audio&&e.audio.toConstraints(),video:!!e.video&&e.video.toConstraints()});return t.getVideoTracks().concat(t.getAudioTracks())}catch(s){yield this.deviceManager.init();let t=!!(!this.deviceManager.hasWebcamPermission&&e.video),i=!!(!this.deviceManager.hasMicrophonePermission&&e.audio);throw sQ(s,this.getErrorType(t,i))}})}getAVTrackSettings(e){let t=this.getAudioSettings(e),i=this.getVideoSettings(e);return t||i?new rp().video(i).audio(t).build():null}isInIframe(){try{return window.self!==window.top}catch(e){return!0}}retryGetLocalTracks(e,t,i,s){return tP(this,null,function*(){if(!(e instanceof i$)||"TRACK"!==e.action)return tV.w(this.TAG,"Fetch AV Tracks failed - unknown exception",e),this.observer.onFailure(e),[];{this.observer.onFailure(e);let r=e.code===iv,n=e.message.includes("audio"),a=e.message.includes("video");if(r){let r=new rp().video(new rh).audio(new rc).build();tV.w(this.TAG,"Fetch AV Tracks failed with overconstrained error",{fetchTrackOptions:i},{error:e});try{return yield this.getLocalTracks(i,r,s)}catch(n){let e=n instanceof i$?n.nativeError:n,r=n;if((null==e?void 0:e.name)==="OverconstrainedError"){let t=iZ("TRACK","Overconstrained error after dropping all constraints");t.addNativeError(e),r=t}return yield this.retryGetLocalTracks(r,t,i,s)}}i.audio=n?"empty":i.audio,i.video=a?"empty":i.video,tV.w(this.TAG,"Fetch AV Tracks failed",{fetchTrackOptions:i},e);try{return yield this.getLocalTracks(i,t,s)}catch(e){return tV.w(this.TAG,"Fetch empty tacks failed",e),i.audio=i.audio&&"empty",i.video=i.video&&"empty",this.observer.onFailure(e),yield this.getLocalTracks(i,t,s)}}})}getErrorType(e,t){return e&&t?"audio, video":e?"video":t?"audio":"audio, video"}getEmptyTracks(t){let i=[];return"empty"===t.audio&&i.push(e.getEmptyAudioTrack()),"empty"===t.video&&i.push(e.getEmptyVideoTrack()),i}updateCurrentLocalTrackSettings(e){return tP(this,null,function*(){let t=this.store.getLocalPeerTracks(),i=t.find(e=>"video"===e.type&&"regular"===e.source),s=t.find(e=>"audio"===e.type&&"regular"===e.source),r=t.find(e=>"video"===e.type&&"screen"===e.source);null!=e&&e.video&&(yield null==i?void 0:i.setSettings(e.video)),null!=e&&e.audio&&(yield null==s?void 0:s.setSettings(e.audio));let n=this.getScreenshareSettings(!0);return null!=n&&n.video&&(yield null==r?void 0:r.setSettings(null==n?void 0:n.video)),{videoTrack:i,audioTrack:s}})}getAudioSettings(e){var t;let i=this.store.getPublishParams();if(!i||!(null!=(t=i.allowed)&&t.includes("audio")))return null;let s=this.store.getLocalPeer(),r=null==s?void 0:s.audioTrack,n=(null==r?void 0:r.settings.deviceId)||e.audioInputDeviceId;return new rd().codec(i.audio.codec).maxBitrate(i.audio.bitRate).deviceId(n||rO.audioInputDeviceId).build()}getVideoSettings(e){var t;let i=this.store.getPublishParams();if(!i||!(null!=(t=i.allowed)&&t.includes("video")))return null;let s=this.store.getLocalPeer(),r=null==s?void 0:s.videoTrack,n=(null==r?void 0:r.settings.deviceId)||e.videoDeviceId,a=i.video;return new ru().codec(a.codec).maxBitrate(a.bitRate).maxFramerate(a.frameRate).setWidth(a.width).setHeight(a.height).deviceId(n||rO.videoDeviceId).build()}getScreenshareSettings(e=!1){var t;let i=this.store.getPublishParams();if(!i||!(null!=(t=i.allowed)&&t.includes("screen")))return null;let s=i.screen;return{video:new ru().maxBitrate(s.bitRate,!1).codec(s.codec).maxFramerate(s.frameRate).setWidth(s.width).setHeight(s.height).build(),audio:e?void 0:new rd().build()}}getOrDefaultScreenshareConfig(e){return tP(this,null,function*(){var t;let i=Object.assign({videoOnly:!1,audioOnly:!1,forceCurrentTab:!1,preferCurrentTab:!1,selfBrowserSurface:"exclude",surfaceSwitching:"include",systemAudio:"exclude",displaySurface:"monitor"},e||{});return i.forceCurrentTab&&(i.videoOnly=!0,i.preferCurrentTab=!0,i.selfBrowserSurface="include",i.surfaceSwitching="exclude"),i.preferCurrentTab&&(i.selfBrowserSurface="include",i.displaySurface=void 0),i.cropElement&&null!=(t=window.CropTarget)&&t.fromElement&&(i.cropTarget=yield window.CropTarget.fromElement(i.cropElement)),i})}createHMSLocalTracks(e,t,i){let s=e.find(e=>"video"===e.kind),r=e.find(e=>"audio"===e.kind);i?e.forEach(e=>null==i?void 0:i.nativeStream.addTrack(e)):i=new rq(new MediaStream(e));let n=[];if(r&&null!=t&&t.audio){let e=new rm(i,r,"regular",this.eventBus,t.audio,this.store.getRoom());n.push(e)}if(s&&null!=t&&t.video){let e=new rU(i,s,"regular",this.eventBus,t.video,this.store.getRoom());e.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"regular")),n.push(e)}return n}};function rx(e,t){return function(i){return!_(q)(e[i],t[i])}}var rU=class e extends ry{constructor(e,t,i,s,r=new ru().build(),n){super(e,t,i),this.eventBus=s,this.room=n,this._layerDefinitions=[],this.TAG="[HMSLocalVideoTrack]",this.enabledStateBeforeBackground=!1,this.isCurrentTab=!1,this.isPublished=!1,this.replaceSenderTrack=e=>tP(this,null,function*(){if(!this.transceiver||"sendonly"!==this.transceiver.direction)return void tV.d(this.TAG,`transceiver for ${this.trackId} not available or not connected yet`);yield this.transceiver.sender.replaceTrack(e)}),this.buildNewSettings=e=>{let{width:t,height:i,codec:s,maxFramerate:r,maxBitrate:n,deviceId:a,advanced:o,facingMode:l}=tb(tb({},this.settings),e);return new rh(t,i,s,r,a,o,n,l)},this.handleSettingsChange=e=>tP(this,null,function*(){let t=this.stream,i=rx(e,this.settings);if(i("maxBitrate")&&e.maxBitrate&&(yield t.setMaxBitrateAndFramerate(this)),i("width")||i("height")||i("advanced"))if("video"===this.source){let t=yield this.replaceTrackWith(e);yield this.replaceSender(t,this.enabled),this.nativeTrack=t,yield this.processPlugins(),this.videoHandler.updateSinks()}else yield this.nativeTrack.applyConstraints(e.toConstraints())}),this.handleDeviceChange=(e,t=!1)=>tP(this,null,function*(){if(rx(e,this.settings)("deviceId")&&"regular"===this.source){if(this.enabled){delete e.facingMode;let t=yield this.replaceTrackWith(e);yield this.replaceSender(t,this.enabled),this.nativeTrack=t,yield this.processPlugins(),this.videoHandler.updateSinks()}let i=this.nativeTrack.getSettings().groupId;!t&&e.deviceId&&(sq.updateSelection("videoInput",{deviceId:e.deviceId,groupId:i}),this.eventBus.deviceChange.publish({isUserSelection:!0,type:"video",selection:{deviceId:e.deviceId,groupId:i}}))}}),this.trackPermissions=()=>{s0("camera",e=>{this.eventBus.analytics.publish(sj.permissionChange(this.type,e)),"denied"===e&&this.eventBus.localVideoEnabled.publish({enabled:!1,track:this})})},this.handleTrackMute=()=>{tV.d(this.TAG,"muted natively",document.visibilityState);let e="hidden"===document.visibilityState?"visibility-change":"incoming-call";this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!0,reason:e})),this.eventBus.localVideoEnabled.publish({enabled:!1,track:this})},this.handleTrackUnmuteNatively=()=>tP(this,null,function*(){tV.d(this.TAG,"unmuted natively");let e="hidden"===document.visibilityState?"visibility-change":"incoming-call";this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!1,reason:e})),this.handleTrackUnmute(),this.eventBus.localVideoEnabled.publish({enabled:this.enabled,track:this}),this.eventBus.localVideoUnmutedNatively.publish(),yield this.setEnabled(this.enabled)}),this.removeOrReplaceProcessedTrack=e=>tP(this,null,function*(){e?e!==this.processedTrack&&(this.processedTrack=e):this.processedTrack=void 0,yield this.replaceSenderTrack(this.processedTrack||this.nativeTrack)}),this.handleVisibilityChange=()=>tP(this,null,function*(){if("hidden"===document.visibilityState)this.enabledStateBeforeBackground=this.enabled,this.enabled&&(yield this.setEnabled(!1)),this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!0,reason:"visibility-change"}));else{if(tV.d(this.TAG,"visibility visible, restoring track state",this.enabledStateBeforeBackground),this.enabledStateBeforeBackground)try{yield this.setEnabled(!0)}catch(e){this.eventBus.error.publish(e)}this.eventBus.analytics.publish(this.sendInterruptionEvent({started:!1,reason:"visibility-change"}))}}),this.addTrackEventListeners(t),this.trackPermissions(),e.tracks.push(this),this.setVideoHandler(new rw(this)),this.settings=r,r.deviceId!==t.getSettings().deviceId&&t.enabled&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new r_(this,s),this.mediaStreamPluginsManager=new rL(s,n),this.setFirstTrackId(this.trackId),this.eventBus.localAudioUnmutedNatively.subscribe(this.handleTrackUnmute),t3&&"regular"===i&&t4()&&document.addEventListener("visibilitychange",this.handleVisibilityChange)}clone(t){let i=this.nativeTrack.clone();t.nativeStream.addTrack(i);let s=new e(t,i,this.source,this.eventBus,this.settings,this.room);return s.peerId=this.peerId,this.pluginsManager.pluginsMap.size>0&&this.pluginsManager.pluginsMap.forEach(e=>{s.addPlugin(e).catch(t=>tV.e(this.TAG,"Plugin add failed while migrating",e,t))}),this.mediaStreamPluginsManager.plugins.size>0&&s.addStreamPlugins(Array.from(this.mediaStreamPluginsManager.plugins)),s}setSimulcastDefinitons(e){this._layerDefinitions=e}getSimulcastDefinitions(){return this._layerDefinitions}setEnabled(t){return tP(this,null,function*(){var i;if(t!==this.enabled){if("regular"===this.source){let s;s=t?yield this.replaceTrackWith(this.settings):yield this.replaceTrackWithBlank(),yield this.replaceSender(s,t),null==(i=this.nativeTrack)||i.stop(),this.nativeTrack=s,yield tw(e.prototype,this,"setEnabled").call(this,t),t&&(yield this.pluginsManager.waitForRestart(),yield this.processPlugins(),this.settings=this.buildNewSettings({deviceId:s.getSettings().deviceId})),this.videoHandler.updateSinks()}this.eventBus.localVideoEnabled.publish({enabled:t,track:this})}})}processPlugins(){return tP(this,null,function*(){try{if(this.pluginsManager.getPlugins().length>0)return;if(this.mediaStreamPluginsManager.getPlugins().length>0){let e=this.mediaStreamPluginsManager.applyPlugins(new MediaStream([this.nativeTrack])).getVideoTracks()[0];yield this.setProcessedTrack(e)}else yield this.setProcessedTrack();this.videoHandler.updateSinks()}catch(e){console.error("error in processing plugin(s)",e)}})}addStreamPlugins(e){return tP(this,null,function*(){if(this.pluginsManager.getPlugins().length>0)throw Error("Plugins of type HMSMediaStreamPlugin and HMSVideoPlugin cannot be used together");this.mediaStreamPluginsManager.addPlugins(e),yield this.processPlugins()})}removeStreamPlugins(e){return tP(this,null,function*(){this.mediaStreamPluginsManager.removePlugins(e),yield this.processPlugins()})}isPublishedTrackId(e){return this.publishedTrackId===e}addSink(e){this.addSinkInternal(e,this.processedTrack||this.nativeTrack)}setSettings(e,t=!1){return tP(this,null,function*(){let i=this.buildNewSettings(e);if(yield this.handleDeviceChange(i,t),!this.enabled||sZ(this.nativeTrack)){this.settings=i;return}yield this.pluginsManager.waitForRestart(),yield this.handleSettingsChange(i),this.settings=i})}getPlugins(){return this.mediaStreamPluginsManager.getPlugins().length>0?this.mediaStreamPluginsManager.getPlugins():this.pluginsManager.getPlugins()}addPlugin(e,t){return tP(this,null,function*(){if(this.mediaStreamPluginsManager.getPlugins().length>0)throw Error("Plugins of type HMSVideoPlugin and HMSMediaStreamPlugin cannot be used together");return this.pluginsManager.addPlugin(e,t)})}removePlugin(e){return tP(this,null,function*(){return this.pluginsManager.removePlugin(e)})}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}cleanup(){return tP(this,null,function*(){var t;this.eventBus.localAudioUnmutedNatively.unsubscribe(this.handleTrackUnmute),this.removeTrackEventListeners(this.nativeTrack),yield this.mediaStreamPluginsManager.cleanup(),yield this.pluginsManager.cleanup(),tw(e.prototype,this,"cleanup").call(this),this.transceiver=void 0,null==(t=this.processedTrack)||t.stop(),this.isPublished=!1,t3&&t4()&&document.removeEventListener("visibilitychange",this.handleVisibilityChange)})}cropTo(e){return tP(this,null,function*(){if(e&&"screen"===this.source)try{this.nativeTrack.cropTo&&(yield this.nativeTrack.cropTo(e))}catch(e){throw tV.e(this.TAG,"failed to crop screenshare capture - ",e),iZ("TRACK","failed to crop screenshare capture")}})}getCaptureHandle(){if(this.nativeTrack.getCaptureHandle)return this.nativeTrack.getCaptureHandle()}setProcessedTrack(e){return tP(this,null,function*(){if(!this.nativeTrack.enabled){this.processedTrack=e;return}yield this.removeOrReplaceProcessedTrack(e),this.videoHandler.updateSinks()})}getTrackIDBeingSent(){return this.getTrackBeingSent().id}getTrackBeingSent(){return this.enabled&&this.processedTrack||this.nativeTrack}switchCamera(){return tP(this,null,function*(){var e;let t=this.getMediaTrackSettings().facingMode;if(!t||"regular"!==this.source)return void tV.d(this.TAG,"facingMode not supported");let i="environment"===t?"user":"environment";null==(e=this.nativeTrack)||e.stop();let s=yield this.replaceTrackWith(this.buildNewSettings({facingMode:i,deviceId:void 0}));yield this.replaceSender(s,this.enabled),this.nativeTrack=s,yield this.processPlugins(),this.videoHandler.updateSinks(),this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId,facingMode:i}),sq.updateSelection("videoInput",{deviceId:this.settings.deviceId,groupId:this.nativeTrack.getSettings().groupId})})}replaceTrackWith(e){return tP(this,null,function*(){let t=this.nativeTrack;this.removeTrackEventListeners(t),null==t||t.stop();try{let i=yield sX(e);return this.addTrackEventListeners(i),tV.d(this.TAG,"replaceTrack, Previous track stopped",t,"newTrack",i),"default"===this.settings.deviceId&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),i}catch(t){let e=yield sX(this.settings);throw this.addTrackEventListeners(e),yield this.replaceSender(e,this.enabled),this.nativeTrack=e,yield this.processPlugins(),this.videoHandler.updateSinks(),this.isPublished&&this.eventBus.analytics.publish(sj.publish({error:t})),t}})}replaceTrackWithBlank(){return tP(this,null,function*(){let e=this.nativeTrack,t=rN.getEmptyVideoTrack(e);return this.removeTrackEventListeners(e),this.addTrackEventListeners(t),null==e||e.stop(),tV.d(this.TAG,"replaceTrackWithBlank, Previous track stopped",e,"newTrack",t),t})}replaceSender(e,t){return tP(this,null,function*(){t?yield this.replaceSenderTrack(this.processedTrack||e):yield this.replaceSenderTrack(e),this.stream.replaceStreamTrack(this.nativeTrack,e)})}addTrackEventListeners(e){e.addEventListener("mute",this.handleTrackMute),e.addEventListener("unmute",this.handleTrackUnmuteNatively)}removeTrackEventListeners(e){e.removeEventListener("mute",this.handleTrackMute),e.removeEventListener("unmute",this.handleTrackUnmuteNatively)}},rB="renegotiation-callback-id",rF="ion-sfu",rj="SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID",r$="_handraise",rG=class e extends ry{constructor(e,t,i,s){super(e,t,i),this._degraded=!1,this._degradedAt=null,this._layerDefinitions=[],this.history=new rV,this.preferredLayer="high",this.disableNoneLayerRequest=!1,this.disableNoneLayerRequest=!!s,this.setVideoHandler(new rw(this))}setTrackId(e){this.bizTrackId=e}get trackId(){return this.bizTrackId||super.trackId}get degraded(){return this._degraded}get degradedAt(){return this._degradedAt}setEnabled(t){return tP(this,null,function*(){t!==this.enabled&&(tw(e.prototype,this,"setEnabled").call(this,t),this.videoHandler.updateSinks(!0))})}setPreferredLayer(e){return tP(this,null,function*(){if("none"===e)return void tV.w("layer none will be ignored");if(this.preferredLayer=e,this.shouldSendVideoLayer(e,"preferLayer")){if(!this.hasSinks())return void tV.d(`[Remote Track] ${this.logIdentifier}
        streamId=${this.stream.id} 
        trackId=${this.trackId}
        saving ${e}, source=${this.source}
        Track does not have any sink`);yield this.requestLayer(e,"preferLayer"),this.pushInHistory(`uiPreferLayer-${e}`)}})}getSimulcastLayer(){return this.stream.getSimulcastLayer()}getLayer(){return this.stream.getVideoLayer()}getPreferredLayer(){return this.preferredLayer}getPreferredLayerDefinition(){return this._layerDefinitions.find(e=>e.layer===this.preferredLayer)}replaceTrack(e){this.nativeTrack=e.nativeTrack,e.transceiver&&(this.transceiver=e.transceiver,this.stream.updateId(e.stream.id)),this.videoHandler.updateSinks()}addSink(t,i=!0){return tP(this,null,function*(){sZ(this.nativeTrack)?yield this.requestLayer(this.preferredLayer,"addSink"):(tw(e.prototype,this,"addSink").call(this,t),i&&(yield this.updateLayer("addSink"))),this.pushInHistory("uiSetLayer-high")})}removeSink(t,i=!0){return tP(this,null,function*(){tw(e.prototype,this,"removeSink").call(this,t),i&&(yield this.updateLayer("removeSink")),this._degraded=!1,this.pushInHistory("uiSetLayer-none")})}getSimulcastDefinitions(){return[...this._layerDefinitions]}setSimulcastDefinitons(e){this._layerDefinitions=e}setLayerFromServer(e){this._degraded=this.getDegradationValue(e),this._degradedAt=this._degraded?new Date:this._degradedAt;let t=e.current_layer;return tV.d(`[Remote Track] ${this.logIdentifier} 
      streamId=${this.stream.id} 
      trackId=${this.trackId}
      layer update from sfu
      currLayer=${e.current_layer}
      preferredLayer=${e.expected_layer}
      sub_degraded=${e.subscriber_degraded}
      pub_degraded=${e.publisher_degraded}
      isDegraded=${this._degraded}`),this.stream.setVideoLayerLocally(t,this.logIdentifier,"setLayerFromServer"),this.pushInHistory(`sfuLayerUpdate-${t}`),this._degraded}getDegradationValue(e){return this.enabled&&(e.publisher_degraded||e.subscriber_degraded)&&"none"===e.current_layer}updateLayer(e){return tP(this,null,function*(){let t=this.preferredLayer;this.enabled&&this.hasSinks()?t=this.preferredLayer:this.disableNoneLayerRequest||(t="none"),this.shouldSendVideoLayer(t,e)&&(yield this.requestLayer(t,e))})}pushInHistory(e){}requestLayer(e,t){return tP(this,null,function*(){try{let i=yield this.stream.setVideoLayer(e,this.trackId,this.logIdentifier,t);return tV.d(`[Remote Track] ${this.logIdentifier} 
      streamId=${this.stream.id}
      trackId=${this.trackId}
      Requested layer ${e}, source=${t}`),i}catch(i){throw tV.d(`[Remote Track] ${this.logIdentifier} 
      streamId=${this.stream.id}
      trackId=${this.trackId}
      Failed to set layer ${e}, source=${t}
      error=${i.message}`),i}})}shouldSendVideoLayer(e,t){let i=this.getLayer();return!!this.degraded&&"none"===e||i!==e||(tV.d(`[Remote Track] ${this.logIdentifier}`,`Not sending update, already on layer ${e}, source=${t}`),!1)}},rV=class{constructor(){this.history=[]}push(e){e.time=new Date().toISOString().split("T")[1],this.history.push(e)}},rq=class extends t1{constructor(){super(...arguments),this.TAG="[HMSLocalStream]",this.connection=null}setConnection(e){this.connection=e}addTransceiver(e,t){let i=this.connection.addTransceiver(e.getTrackBeingSent(),{streams:[this.nativeStream],direction:"sendonly",sendEncodings:this.getTrackEncodings(e,t)});return this.setPreferredCodec(i,e.nativeTrack.kind),e.transceiver=i,i}setMaxBitrateAndFramerate(e,t){return tP(this,null,function*(){var i;yield null==(i=this.connection)?void 0:i.setMaxBitrateAndFramerate(e,t)})}setPreferredCodec(e,t){}replaceStreamTrack(e,t){this.nativeStream.addTrack(t),this.nativeStream.removeTrack(e)}removeSender(e){var t,i;if(!this.connection||"closed"===this.connection.connectionState)return void tV.d(this.TAG,"publish connection is not initialised or closed");let s=null==(t=e.transceiver)?void 0:t.sender;if(!s)return void tV.w(this.TAG,`No sender found for trackId=${e.trackId}`);null==(i=this.connection)||i.removeTrack(s);let r=this.tracks.indexOf(e);-1!==r?this.tracks.splice(r,1):tV.w(this.TAG,`Cannot find ${e.trackId} in locally stored tracks`)}getTrackEncodings(e,t){let i=[];if(e instanceof rU)if(t.length>0)tV.d(this.TAG,"Simulcast enabled with layers",t),i.push(...t);else{let t={active:this.nativeStream.active};e.settings.maxBitrate&&!t5&&(t.maxBitrate=e.settings.maxBitrate),i.push(t)}return i}},rH=class extends t1{constructor(e,t){super(e),this.audio=!0,this.video="none",this.connection=t}setAudio(e,t,i){return tP(this,null,function*(){this.audio!==e&&(this.audio=e,tV.d(`[Remote stream] ${i||""} 
    streamId=${this.id}
    trackId=${t}
    subscribing audio - ${this.audio}`),yield this.connection.sendOverApiDataChannelWithResponse({params:{subscribed:this.audio,track_id:t},method:"prefer-audio-track-state"}))})}setVideoLayerLocally(e,t,i){this.video=e,tV.d(`[Remote stream] ${t}
    streamId=${this.id}
    source: ${i}
    Setting layer field to=${e}`)}setVideoLayer(e,t,i,s){return tV.d(`[Remote stream] ${i} 
      streamId=${this.id}
      trackId=${t} 
      source: ${s} request ${e} layer`),this.setVideoLayerLocally(e,i,s),this.connection.sendOverApiDataChannelWithResponse({params:{max_spatial_layer:this.video,track_id:t},method:"prefer-video-track-state"})}getSimulcastLayer(){return this.video}getVideoLayer(){return this.video}isAudioSubscribed(){return this.audio}},rW=(e,t,i,s)=>tP(void 0,null,function*(){var r;let n,a={};if(null!=(r=t.transceiver)&&r.sender.track){try{n=yield t.transceiver.sender.getStats();let e={},r={},o={};null==n||n.forEach(t=>{switch(t.type){case"outbound-rtp":r[t.id]=t;break;case"remote-inbound-rtp":o[t.ssrc]=t;break;case"codec":e[t.id]=t.mimeType}}),Object.keys(tb({},r)).forEach(n=>{var l,d;let c=null==(l=r[n])?void 0:l.codecId,u=c?e[c]:void 0,h;u&&(h=u.substring(u.indexOf("/")+1));let p=tT(tb({},r[n]),{rid:null==(d=r[n])?void 0:d.rid}),v=o[p.ssrc];a[n]=tT(tb({},p),{bitrate:rY("bytesSent",p,null==s?void 0:s[n]),packetsLost:null==v?void 0:v.packetsLost,jitter:null==v?void 0:v.jitter,roundTripTime:null==v?void 0:v.roundTripTime,totalRoundTripTime:null==v?void 0:v.totalRoundTripTime,peerName:i,peerID:t.peerId,enabled:t.enabled,codec:h})})}catch(i){e.analytics.publish(sj.rtcStatsFailed(sd("TRACK",`Error getting local track stats ${t.trackId} - ${i.message}`))),tV.w("[HMSWebrtcStats]","Error in getting local track stats",t,i,i.name)}return a}}),rz=(e,t,i,s)=>tP(void 0,null,function*(){var r;let n;try{n=yield null==(r=t.transceiver)?void 0:r.receiver.getStats()}catch(i){e.analytics.publish(sj.rtcStatsFailed(sd("TRACK",`Error getting remote track stats ${t.trackId} - ${i.message}`))),tV.w("[HMSWebrtcStats]","Error in getting remote track stats",t,i)}let a=rK(n),o=rY("bytesReceived",a,s),l=rX("packetsLost",a,s);return null!=a&&a.remote&&Object.assign(a.remote,{packetsLostRate:rX("packetsLost",a.remote,null==s?void 0:s.remote)}),a&&tT(tb({},a),{bitrate:o,packetsLostRate:l,peerID:t.peerId,enabled:t.enabled,peerName:i,codec:a.codec})}),rK=e=>{let t,i,s={};null==e||e.forEach(e=>{switch(e.type){case"inbound-rtp":case"outbound-rtp":t=e;break;case"remote-inbound-rtp":i=e;break;case"codec":s[e.id]=e.mimeType}});let r=null!=t&&t.codecId?s[t.codecId]:void 0,n;return r&&(n=r.substring(r.indexOf("/")+1)),t&&Object.assign(t,{remote:i,codec:n})},rJ=(e,t,i)=>{let s=rQ(t),r=rY("publish"===e?"bytesSent":"bytesReceived",s,i&&i[e]);return s&&Object.assign(s,{bitrate:r})},rQ=e=>{let t;return null==e||e.forEach(i=>{"transport"===i.type&&(t=null==e?void 0:e.get(i.selectedCandidatePairId))}),t||null==e||e.forEach(e=>{"candidate-pair"===e.type&&e.selected&&(t=e)}),t},rY=(e,t,i)=>8*rX(e,t,i),rX=(e,t,i)=>{let s=t&&t[e],r=i?i[e]:null;return[t,i,sM(s),sM(r)].every(e=>!!e)?1e3*rZ(s,r,null==t?void 0:t.timestamp,null==i?void 0:i.timestamp):0},rZ=(e,t,i,s)=>sM(e)&&sM(t)&&i&&s?(e-t)/(i-s):0,r0=class{constructor(e,t,i,s){var r;this.store=e,this.eventBus=t,this.publishConnection=i,this.subscribeConnection=s,this.TAG="[HMSWebrtcStats]",this.peerStats={},this.remoteTrackStats={},this.localTrackStats={},this.getLocalPeerStats=()=>this.peerStats[this.localPeerID],this.getRemoteTrackStats=e=>this.remoteTrackStats[e],this.getAllRemoteTracksStats=()=>this.remoteTrackStats,this.getLocalTrackStats=()=>this.localTrackStats,this.updateStats=()=>tP(this,null,function*(){yield this.updateLocalPeerStats(),yield this.updateLocalTrackStats(),yield this.updateRemoteTrackStats()}),this.updateLocalPeerStats=()=>tP(this,null,function*(){var e,t,i,s,r;let n,a=this.getLocalPeerStats(),o;try{o=yield null==(e=this.publishConnection)?void 0:e.getStats()}catch(e){this.eventBus.analytics.publish(sj.rtcStatsFailed(sd("PUBLISH",e.message))),tV.w(this.TAG,"Error in getting publish stats",e)}let l=o&&rJ("publish",o,a),d;try{d=yield null==(t=this.subscribeConnection)?void 0:t.getStats()}catch(e){this.eventBus.analytics.publish(sj.rtcStatsFailed(sd("SUBSCRIBE",e.message))),tV.w(this.TAG,"Error in getting subscribe stats",e)}let c=d&&rJ("subscribe",d,a),{packetsLost:u,jitter:h}=(n={packetsLost:0,jitter:0},null==(r=d)||r.forEach(e=>{e.packetsLost&&(n.packetsLost+=e.packetsLost),e.jitter>n.jitter&&(n.jitter=e.jitter)}),n),p=rZ(u,null==(i=null==a?void 0:a.subscribe)?void 0:i.packetsLost,null==c?void 0:c.timestamp,null==(s=null==a?void 0:a.subscribe)?void 0:s.timestamp),v=c&&Object.assign(c,{packetsLostRate:p,jitter:h,packetsLost:u});this.peerStats[this.localPeerID]={publish:l,subscribe:v}}),this.updateRemoteTrackStats=()=>tP(this,null,function*(){var e;let t=Array.from(this.store.getTracksMap().values()).filter(e=>e instanceof rG||e instanceof rf),i=t.map(e=>e.trackId);for(let s of(Object.keys(this.remoteTrackStats).forEach(e=>{i.includes(e)||delete this.remoteTrackStats[e]}),t)){let t=s.peerId&&(null==(e=this.store.getPeerById(s.peerId))?void 0:e.name),i=this.getRemoteTrackStats(s.trackId),r=yield rz(this.eventBus,s,t,i);r&&(this.remoteTrackStats[s.trackId]=r)}}),this.updateLocalTrackStats=()=>tP(this,null,function*(){var e;let t,i,s=this.store.getLocalPeerTracks().reduce((e,t)=>(e[t.getTrackIDBeingSent()]=t,e),{});for(let r of(t=Object.keys(this.localTrackStats),i=Object.keys(s),Array.from(new Set(t.concat(i))))){let t=s[r];if(t){let i=null==(e=this.store.getLocalPeer())?void 0:e.name,s=yield rW(this.eventBus,t,i,this.localTrackStats[r]);s&&(this.localTrackStats[r]=s)}else delete this.localTrackStats[r]}}),this.localPeerID=null==(r=this.store.getLocalPeer())?void 0:r.peerId}setPeerConnections({publish:e,subscribe:t}){this.publishConnection=e,this.subscribeConnection=t}getPublishPeerConnection(){return this.publishConnection}getSubscribePeerConnection(){return this.subscribeConnection}},r1=class{constructor(e,t){this.store=e,this.eventBus=t,this.TAG="[HMSWebrtcInternals]",this.interval=1e3,this.isMonitored=!1,this.handleStatsUpdate=()=>tP(this,null,function*(){var e;yield null==(e=this.hmsStats)?void 0:e.updateStats(),this.hmsStats&&this.eventBus.statsUpdate.publish(this.hmsStats)})}getCurrentStats(){return this.hmsStats}getPublishPeerConnection(){var e;return null==(e=this.hmsStats)?void 0:e.getPublishPeerConnection()}getSubscribePeerConnection(){var e;return null==(e=this.hmsStats)?void 0:e.getSubscribePeerConnection()}onStatsChange(e){return this.eventBus.statsUpdate.subscribe(e),()=>{this.eventBus.statsUpdate.unsubscribe(e)}}setPeerConnections({publish:e,subscribe:t}){this.hmsStats?this.hmsStats.setPeerConnections({publish:e,subscribe:t}):this.hmsStats=new r0(this.store,this.eventBus,e,t)}start(){return tP(this,null,function*(){if(this.isMonitored)return void tV.d(this.TAG,"Already started");this.stop(),this.isMonitored=!0,tV.d(this.TAG,"Starting Webrtc Stats Monitor"),this.startLoop().then(()=>tV.d(this.TAG,"Stopping Webrtc Stats Monitor")).catch(e=>{this.eventBus.analytics.publish(sj.rtcStatsFailed(sd("PUBLISH",e.message))),tV.e(this.TAG,e.message)})})}stop(){this.isMonitored=!1}startLoop(){return tP(this,null,function*(){for(;this.isMonitored;)yield this.handleStatsUpdate(),yield s6(this.interval)})}cleanup(){this.stop(),this.eventBus.statsUpdate.removeAllListeners()}},r2=class{constructor({peerId:e,name:t,isLocal:i,customerUserId:s,metadata:r,role:n,joinedAt:a,groups:o,realtime:l,type:d}){this.customerUserId="",this.metadata="",this.auxiliaryTracks=[],this.name=t,this.peerId=e,this.isLocal=i,this.customerUserId=s,this.metadata=r,this.joinedAt=a,this.groups=o,this.realtime=l,this.type=d,n&&(this.role=n)}get isHandRaised(){var e;return!!(null!=(e=this.groups)&&e.includes(r$))}updateRole(e){this.role=e}updateName(e){this.name=e}updateNetworkQuality(e){this.networkQuality=e}updateMetadata(e){this.metadata=e}updateGroups(e){this.groups=e}toString(){var e,t,i,s;return`{
      name: ${this.name};
      role: ${null==(e=this.role)?void 0:e.name};
      peerId: ${this.peerId};
      customerUserId: ${this.customerUserId};
      ${this.audioTrack?`audioTrack: ${null==(t=this.audioTrack)?void 0:t.trackId};`:""}
      ${this.videoTrack?`videoTrack: ${null==(i=this.videoTrack)?void 0:i.trackId};`:""}
      groups: ${null==(s=this.groups)?void 0:s.join()}
    }`}},r3=class{};r3.makePeerId=()=>V();var r5=class extends r2{constructor(e){super(tT(tb({},e),{peerId:r3.makePeerId(),isLocal:!0})),this.isLocal=!0,this.auxiliaryTracks=[],this.asRole=e.asRole}isInPreview(){return!!this.asRole}toString(){var e,t,i;return`{
      name: ${this.name};
      role: ${null==(e=this.role)?void 0:e.name};
      peerId: ${this.peerId};
      customerUserId: ${this.customerUserId};
      ${this.asRole?`asRole: ${this.asRole.name};`:""}
      ${this.audioTrack?`audioTrack: ${null==(t=this.audioTrack)?void 0:t.trackId};`:""}
      ${this.videoTrack?`videoTrack: ${null==(i=this.videoTrack)?void 0:i.trackId};`:""}
    }`}},r4=class extends r2{constructor(e){super(tT(tb({},e),{isLocal:!1})),this.isLocal=!1,this.auxiliaryTracks=[],this.fromRoomState=!1,this.fromRoomState=!!e.fromRoomState}},r6=(e,t)=>new r4({peerId:e.peer_id,name:e.info.name,role:t.getPolicyForRole(e.role),customerUserId:e.info.user_id,metadata:e.info.data,groups:e.groups,type:e.info.type}),r9=class{constructor(e,t,i){this.transport=e,this.store=t,this.options=i,this.isEnd=!1,this.iterator=null,this.total=0,this.defaultPaginationLimit=10}validateConnection(){if(!this.transport||!this.store)throw Error("Use usePaginatedParticipants or hmsActions.getPeerListIterator after preview or join has happened")}hasNext(){return!this.isEnd}getTotal(){return this.total}findPeers(){return tP(this,null,function*(){var e;this.validateConnection();let t=yield this.transport.signal.findPeers(tT(tb({},this.options||{}),{limit:(null==(e=this.options)?void 0:e.limit)||this.defaultPaginationLimit}));return this.updateState(t),this.processPeers(t.peers)})}next(){return tP(this,null,function*(){var e;let t;return this.validateConnection(),this.iterator||this.isEnd?this.iterator?(t=yield this.transport.signal.peerIterNext({iterator:this.iterator,limit:(null==(e=this.options)?void 0:e.limit)||this.defaultPaginationLimit}),this.updateState(t),this.processPeers(t.peers)):[]:yield this.findPeers()})}processPeers(e){let t=[];return e.forEach(e=>{let i=r6(e,this.store);t.push(i)}),t}updateState(e){this.isEnd=e.eof,this.total=e.total,e.iterator&&(this.iterator=e.iterator)}},r8=class{constructor(e){this.TAG="[AudioContextManager]",this.audioContext=new AudioContext,this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.audioContext.destination)}resumeContext(){return tP(this,null,function*(){"suspended"===this.audioContext.state&&(yield this.audioContext.resume(),tV.d(this.TAG,"AudioContext is resumed"))})}getAudioTrack(){return this.destinationNode&&this.source.disconnect(this.destinationNode),this.destinationNode=this.audioContext.createMediaStreamDestination(),this.source.connect(this.destinationNode),this.destinationNode.stream.getAudioTracks()[0]}cleanup(){"closed"!==this.audioContext.state&&this.audioContext.close().catch(e=>{tV.d(this.TAG,"AudioContext close error",e.message)})}},r7=class extends eK.EventEmitter2{on(e,t){return super.on(e,t)}off(e,t){return super.off(e,t)}emit(e,t){return super.emit(e,t)}listeners(e){return super.listeners(e)}},ne=class extends r7{constructor(){super(...arguments),this.audioElement=null,this.TAG="[PlaylistAudioManager]",this.seeked=!1}play(e){return tP(this,null,function*(){return this.audioElement=this.getAudioElement(),new Promise((t,i)=>{this.audioElement=this.getAudioElement(),this.audioElement.src=e,this.seeked=!1,this.audioElement.onerror=()=>{let t=`Error loading ${e}`;tV.e(this.TAG,t),this.stop(),i(t)},this.audioElement.oncanplaythrough=()=>tP(this,null,function*(){try{if(!this.audioElement)return;if(this.audioContextManager.resumeContext(),this.track)this.seeked?this.seeked=!1:(yield this.audioElement.play(),t([this.track]));else{yield this.audioElement.play();let e=this.audioContextManager.getAudioTrack();this.track=e,t([e])}}catch(t){tV.e(this.TAG,"Error playing audio",e,t.message),i(t)}}),this.audioElement.onseeked=()=>{this.seeked=!0}})})}getTracks(){return this.track?[this.track.id]:[]}getElement(){return this.audioElement||(this.audioElement=this.getAudioElement()),this.audioElement}stop(){var e,t,i;null==(e=this.audioElement)||e.pause(),null==(t=this.audioElement)||t.removeAttribute("src"),this.audioElement=null,null==(i=this.audioContextManager)||i.cleanup(),this.track=void 0}getAudioElement(){if(this.audioElement)return this.audioElement;let e=document.createElement("audio");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",e=>this.emit("progress",e)),e.addEventListener("ended",()=>{this.emit("ended",null)}),this.audioContextManager=new r8(e),e}},nt=class extends r7{constructor(){super(...arguments),this.TAG="[PlaylistVideoManager]",this.videoElement=null,this.canvasContext=null,this.tracks=[],this.DEFAUL_FPS=24,this.seeked=!1,this.drawImage=()=>{var e,t,i;!this.videoElement||this.videoElement.paused||this.videoElement.ended||(null==(i=this.canvasContext)||i.drawImage(this.videoElement,0,0,null==(e=this.canvas)?void 0:e.width,null==(t=this.canvas)?void 0:t.height),this.timer=setTimeout(()=>{this.drawImage()},1e3/this.DEFAUL_FPS))}}play(e){return this.videoElement=this.getVideoElement(),this.createCanvas(),new Promise((t,i)=>{this.videoElement=this.getVideoElement(),this.videoElement.src=e,this.seeked=!1,this.videoElement.onerror=()=>{let t=`Error loading ${e}`;tV.e(this.TAG,t),this.stop(),i(t)},this.videoElement.oncanplaythrough=()=>tP(this,null,function*(){var s,r,n;try{if(!this.videoElement)return;if(this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,0===this.tracks.length){this.clearCanvasAndTracks();let e=this.canvas.captureStream();if(!e)return void tV.e(this.TAG,"Browser does not support captureStream");this.videoElement.onplay=this.drawImage,yield this.audioContextManager.resumeContext(),yield this.videoElement.play();let i=this.audioContextManager.getAudioTrack();e.addTrack(i),e.getTracks().forEach(e=>{this.tracks.push(e)}),t(this.tracks)}else this.seeked?(this.seeked=!1,null==(n=this.canvasContext)||n.drawImage(this.videoElement,0,0,null==(s=this.canvas)?void 0:s.width,null==(r=this.canvas)?void 0:r.height)):(yield this.videoElement.play(),t(this.tracks))}catch(t){tV.e(this.TAG,"Error playing video",e,t.message),i(t)}}),this.videoElement.onseeked=()=>{this.seeked=!0}})}getTracks(){return this.tracks.map(e=>e.id)}getElement(){return this.videoElement||(this.videoElement=this.getVideoElement()),this.videoElement}stop(){var e,t,i;null==(e=this.videoElement)||e.pause(),null==(t=this.videoElement)||t.removeAttribute("src"),this.videoElement=null,null==(i=this.audioContextManager)||i.cleanup(),this.clearCanvasAndTracks()}clearCanvasAndTracks(){var e;this.tracks=[],null==(e=this.canvasContext)||e.clearRect(0,0,this.canvas.width,this.canvas.height),clearTimeout(this.timer)}getVideoElement(){if(this.videoElement)return this.videoElement;let e=document.createElement("video");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",e=>this.emit("progress",e)),e.addEventListener("ended",()=>{this.emit("ended",null)}),this.audioContextManager=new r8(e),e}createCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"))}},ni={list:[],currentIndex:-1,isAutoplayOn:!0},ns={list:[],currentIndex:-1,isAutoplayOn:!0},nr=class extends r7{constructor(e,t){super(),this.sdk=e,this.eventBus=t,this.state={audio:tb({},ni),video:tb({},ns)},this.TAG="[PlaylistManager]",this.handlePausePlaylist=e=>tP(this,[e],function*({enabled:e,track:t}){var i;let s;!e&&("audioplaylist"===t.source&&(s="audio"),"videoplaylist"===t.source&&(s="video"),s&&(null==(i=this.getElement(s))||i.pause()))}),this.addTrack=(e,t)=>tP(this,null,function*(){yield this.sdk.addTrack(e,t),tV.d(this.TAG,"Playlist track added",s$(e))}),this.removeTrack=e=>tP(this,null,function*(){yield this.sdk.removeTrack(e,!0),tV.d(this.TAG,"Playlist track removed",e)}),this.audioManager=new ne,this.videoManager=new nt,this.addListeners()}getList(e="audio"){return this.state[e].list}setList(e){if(!e||0===e.length)return void tV.w(this.TAG,"Please pass in a list of HMSPlaylistItem's");e.forEach(e=>{this.state[e.type].list.find(t=>t.id===e.id)||this.state[e.type].list.push(e)})}clearList(e){return tP(this,null,function*(){this.isPlaying(e)&&(yield this.stop(e)),this.state[e].list=[]})}removeItem(e,t){return tP(this,null,function*(){let{list:i,currentIndex:s}=this.state[t],r=i.findIndex(t=>e===t.id);return r>-1&&(s===r&&this.isPlaying(t)&&(yield this.stop(t)),i.splice(r,1),!0)})}seek(e,t="audio"){let{currentIndex:i}=this.state[t];if(-1===i)throw sI("PLAYLIST","No item is currently playing");let s=this.getElement(t);if(s){let t=Math.max(s.currentTime+e,0);s.currentTime=Math.min(t,s.duration)}}seekTo(e,t="audio"){let{currentIndex:i}=this.state[t];if(-1===i)throw sI("PLAYLIST","No item is currently playing");if(e<0)throw Error("value cannot be negative");let s=this.getElement(t);s&&(s.currentTime=Math.min(e,s.duration))}setVolume(e,t="audio"){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");let i=this.getElement(t);i&&(i.volume=.01*e)}getVolume(e="audio"){let t=this.getElement(e);return t?Math.floor(100*t.volume):0}getCurrentTime(e="audio"){let t=this.getElement(e);return(null==t?void 0:t.currentTime)||0}getCurrentIndex(e="audio"){return this.state[e].currentIndex}getCurrentProgress(e="audio"){var t;let{list:i,currentIndex:s}=this.state[e],r=null==(t=i[s])?void 0:t.url,n=this.getElement(e);return r&&n?Math.floor(100*(n.currentTime/n.duration)):0}getCurrentSelection(e="audio"){let{list:t,currentIndex:i}=this.state[e];if(-1!==i)return t[i]}isPlaying(e="audio"){let t=this.getElement(e);return!!t&&!t.paused}setIsAutoplayOn(e="audio",t){this.state[e].isAutoplayOn=t}getPlaybackRate(e="audio"){let t=this.getElement(e);return t?t.playbackRate:1}setPlaybackRate(e="audio",t){if(t<.25||t>2)throw Error("Please pass a value between 0.25 and 2.0");let i=this.getElement(e);i&&(i.playbackRate=t)}setEnabled(e,t){return tP(this,arguments,function*(e,{id:t,type:i="audio"}){let s=this.state[i].list.findIndex(e=>e.id===t);if(!t||-1===s)return void tV.w(this.TAG,"Pass a valid id");let r=this.state[i].list[s].url;e?yield this.play(r,i):yield this.pause(r,i),this.state[i].currentIndex=s,this.setDuration(i)})}playNext(){return tP(this,arguments,function*(e="audio"){let{list:t,currentIndex:i}=this.state[e];if(i>=t.length-1)throw sI("PLAYLIST","Reached end of playlist");yield this.play(t[i+1].url,e),this.state[e].currentIndex=i+1,this.setDuration(e)})}playPrevious(){return tP(this,arguments,function*(e="audio"){let{list:t,currentIndex:i}=this.state[e];if(i<=0)throw sI("PLAYLIST","Reached start of playlist");yield this.play(t[i-1].url,e),this.state[e].currentIndex=i-1,this.setDuration(e)})}stop(){return tP(this,arguments,function*(e="audio"){var t;let i="audio"===e?this.audioManager:this.videoManager;null==(t=i.getElement())||t.pause(),yield this.removeTracks(e),i.stop(),this.state[e].currentIndex=-1})}cleanup(){this.state={audio:tb({},ni),video:tb({},ns)},this.eventBus.localAudioEnabled.unsubscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.unsubscribe(this.handlePausePlaylist),this.audioManager.stop(),this.videoManager.stop()}onProgress(e){this.videoManager.on("progress",()=>{try{e({type:"video",progress:this.getCurrentProgress("video")})}catch(e){tV.e(this.TAG,"Error in onProgress callback")}}),this.audioManager.on("progress",()=>{try{e({type:"audio",progress:this.getCurrentProgress("audio")})}catch(e){tV.e(this.TAG,"Error in onProgress callback")}})}onNewTrackStart(e){this.on("newTrackStart",e)}onPlaylistEnded(e){this.on("playlistEnded",e)}onCurrentTrackEnded(e){this.on("currentTrackEnded",e)}getElement(e="audio"){return"audio"===e?this.audioManager.getElement():this.videoManager.getElement()}removeTracks(){return tP(this,arguments,function*(e="audio"){for(let t of("audio"===e?this.audioManager:this.videoManager).getTracks())yield this.removeTrack(t)})}play(e){return tP(this,arguments,function*(e,t="audio"){let i="audio"===t?this.audioManager:this.videoManager,s=i.getElement();if(this.isItemCurrentlyPlaying(e,t))return void tV.w(this.TAG,`The ${t} is currently playing`);if(null!=s&&s.src.includes(e))yield s.play();else for(let r of(null==s||s.pause(),yield i.play(e)))yield this.addTrack(r,"audio"===t?"audioplaylist":"videoplaylist")})}isItemCurrentlyPlaying(e,t){let i=this.getElement(t);return!!(i&&!i.paused&&i.src.includes(e))}setDuration(e="audio"){let t=this.getElement(e),{list:i,currentIndex:s}=this.state[e];i[s]&&(i[s].duration=(null==t?void 0:t.duration)||0),this.emit("newTrackStart",i[s])}pause(e){return tP(this,arguments,function*(e,t="audio"){let i=this.getElement(t);i&&!i.paused&&i.src.includes(e)?(i.pause(),tV.d(this.TAG,"paused url",e)):tV.w(this.TAG,"The passed in url is not currently playing")})}addListeners(){this.audioManager.on("ended",()=>this.handleEnded("audio")),this.videoManager.on("ended",()=>this.handleEnded("video")),this.eventBus.localAudioEnabled.subscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.subscribe(this.handlePausePlaylist)}handleEnded(){return tP(this,arguments,function*(e="audio"){let{list:t,currentIndex:i,isAutoplayOn:s}=this.state[e];i===t.length-1?(yield this.stop(e),this.emit("playlistEnded",e)):s?this.playNext(e):yield this.pause(t[i].url,e),this.emit("currentTrackEnded",t[i])})}},nn=e=>e.room,na=(x(e=>e.errors,e=>0===e.length?null:e.at(-1)),x(nn,e=>e.id),e=>e.peers),no=e=>e.messages.byID,nl=e=>e.messages.allIDs,nd=e=>e.tracks,nc=e=>e.settings,nu=x([nn],e=>e&&e.isConnected),nh=(x([nu,nn],(e,t)=>e?void 0!==t.peerCount?t.peerCount||1:t.peers.length:Math.max(void 0!==t.peerCount?t.peerCount:t.peers.length-1,0)),x([nn,na,e=>e.hideLocalPeer],(e,t,i)=>i?e.peers.filter(t=>e.localPeer!==t).map(e=>t[e]):e.peers.map(e=>t[e]))),np=x(nd,e=>Object.values(e)),nv=x(nn,na,(e,t)=>t[e.localPeer]),ng=x(nn,e=>e.localPeer),nm=(x(nv,e=>null==e?void 0:e.name),x(nv,e=>null==e?void 0:e.roleName),x(nv,e=>null==e?void 0:e.audioTrack)),nf=x(nv,e=>null==e?void 0:e.videoTrack),ny=x(nv,e=>null==e?void 0:e.auxiliaryTracks),nk=x([nm,nf,ny],(e,t,i)=>{let s=i?[...i]:[];return e&&s.unshift(e),t&&s.unshift(t),s}),nb=(x(nh,e=>e.filter(e=>!e.isLocal)),x(na,e=>e.speakers,(e,t)=>{let i=Object.entries(t).sort((e,t)=>{var i,s;let r=(null==(i=e[1])?void 0:i.audioLevel)||0;return((null==(s=t[1])?void 0:s.audioLevel)||0)>r?1:-1});if(i.length>0&&i[0][1].audioLevel&&i[0][1].audioLevel>0){let t=i[0][1].peerID;if(t in e)return e[t]}return null}),e=>{let t=nv(e);return tF(e,null==t?void 0:t.videoTrack)}),nT=e=>{var t;let i=nv(e);return!!(t=null==i?void 0:i.videoTrack)&&!!e.tracks[t]&&e.tracks[t].displayEnabled},nS=x(nv,nd,(e,t)=>{let{video:i,audio:s}=tD(t,e);return!!(i||s)}),nw=x(na,nd,(e,t)=>{let i;for(let s in e){let r=e[s],{video:n,audio:a}=tD(t,r);if(n)return r;a&&!i&&(i=r)}return i}),nP=(x(nw,e=>!!e),x(na,nd,(e,t)=>{for(let i in e){let s=e[i],{audio:r,video:n}=tD(t,s);if(!n&&r)return s}}),x(na,nd,(e,t)=>{let i=[],s=[];for(let r in e){let n=e[r],{video:a,audio:o}=tD(t,n);a?i.push(n):o&&s.push(n)}return i.concat(s)}),x(na,nd,(e,t)=>{for(let i in t){let s=t[i];if(tU(s)&&tN(s)&&s.peerId)return e[s.peerId]}}),x(na,nd,(e,t)=>{for(let i in t){let s=t[i];if(tx(s)&&s.peerId)return e[s.peerId]}}),x(np,e=>e.filter(tB)),x(nl,e=>e.length),x(no,e=>Object.values(e).filter(e=>!e.read).length),x(nl,no,(e,t)=>{let i=[];return e.forEach(e=>{i.push(t[e])}),i})),nC=x(nP,e=>e.filter(e=>{var t;return!e.recipientPeer&&!(e.recipientRoles&&(null==(t=e.recipientRoles)?void 0:t.length)>0)})),nE=(x(nC,e=>e.filter(e=>!e.read).length),x([nn],e=>e&&e.roomState)),nI=x(nE,e=>"Preview"===e),nA=(x(nn,e=>"Disconnected"!==e.roomState),x(nn,e=>!!e.transcriptions&&!(e.transcriptions.length<=0)&&e.transcriptions.some(e=>"caption"===e.mode&&"started"===e.state)),e=>e.roles),nR=(x([nA],e=>Object.keys(e)),x([nv,nA],(e,t)=>null!=e&&e.roleName?t[e.roleName]:null)),n_=x([e=>{var t;return null==(t=e.preview)?void 0:t.asRole},nA],(e,t)=>e?t[e]:null),nL=(x([nR],e=>{var t;return null!=(t=null==e?void 0:e.subscribeParams)&&!!t.subscribeToRoles&&e.subscribeParams.subscribeToRoles.length>0}),x(nR,e=>null==e?void 0:e.permissions));x(nn,e=>e.recording),x(nn,e=>e.rtmp),x(nn,e=>e.hls),x(nn,e=>e.transcriptions),x(nn,e=>e.sessionId),x(nn,e=>e.startedAt),x(nn,e=>!!e.isLargeRoom),x(nn,e=>!!e.isEffectsEnabled),x(nn,e=>!!e.isVBEnabled),x(nn,e=>e.effectsKey),x(nh,e=>e.filter(e=>e.isHandRaised)),x(e=>e.whiteboards,e=>Object.values(e)[0]);var nM=(e="audio")=>t=>t.playlist[e].list,nD=(e="audio")=>t=>t.playlist[e].selection,nO=(e="audio")=>t=>t.playlist[e].progress,nN=(e="audio")=>t=>t.playlist[e].currentTime,nx=(e="audio")=>t=>t.playlist[e].playbackRate,nU=(e="audio")=>t=>t.playlist[e].volume,nB=(e="audio")=>x(nM(e),e=>Object.values(e)),nF=(e="audio")=>x(nM(e),nD(e),(e,t)=>{if(t.id)return e[t.id]}),nj={selection:nD("audio"),progress:nO("audio"),currentTime:nN("audio"),playbackRate:nx("audio"),volume:nU("audio"),list:nB("audio"),selectedItem:nF("audio")},n$={selection:nD("video"),progress:nO("video"),currentTime:nN("video"),playbackRate:nx("video"),volume:nU("video"),list:nB("video"),selectedItem:nF("video")};function nG(e){return t=>i=>e(i,t)}var nV="HMS-Store:",nq=class{static v(e,...t){this.log(0,e,...t)}static d(...e){this.log(1,...e)}static i(...e){this.log(2,...e)}static w(...e){this.log(3,...e)}static e(...e){this.log(6,...e)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanup(){performance.clearMarks(),performance.clearMeasures()}static log(e,...t){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:console.log(nV,...t);break;case 1:console.debug(nV,...t);break;case 2:console.info(nV,...t);break;case 3:console.warn(nV,...t);break;case 6:console.error(nV,...t);break;case 4:performance.mark(t[1]);break;case 5:{let e=t[0],i=t[1];try{let t=performance.measure(i,i);this.log(1,e,i,null==t?void 0:t.duration),performance.clearMarks(i),performance.clearMeasures(i)}catch(t){this.log(1,e,i,t)}}}}};nq.level=0;var nH=(e,t)=>t,nW=(e,t)=>t,nz=(e,t)=>t,nK=x([na,nH],(e,t)=>t?e[t]:null),nJ=x([nd,nW],(e,t)=>t?e[t]:null),nQ=x([nd,nW],(e,t)=>{if(!t)return null;let i=e[t];return(null==i?void 0:i.type)==="video"?i:null}),nY=x([nd,nW],(e,t)=>{if(!t)return null;let i=e[t];return(null==i?void 0:i.type)==="audio"?i:null}),nX=x([nd,nW],(e,t)=>{if(!t)return null;let i=e[t];return(null==i?void 0:i.type)==="audio"&&(null==i?void 0:i.source)==="screen"?i:null}),nZ=x([nd,nW],(e,t)=>{if(!t)return null;let i=e[t];return(null==i?void 0:i.type)==="video"&&(null==i?void 0:i.source)==="screen"?i:null}),n0=x([e=>e.polls,(e,t)=>t],(e,t)=>t?e[t]:null),n1=nG(nK);nG(x([e=>e.appData,(e,t)=>t],(e,t)=>{if(e)return t?e[t]:e})),nG(x(nK,e=>null==e?void 0:e.name)),nG(x(nK,e=>null==e?void 0:e.type));var n2=nG(nJ),n3=nG(nQ),n5=(nG(nY),nG(nX),nG(nZ),nG((e,t)=>{let i=nK(e,t);if(i&&i.videoTrack&&""!==i.videoTrack)return e.tracks[i.videoTrack]}),nG((e,t)=>{let i=nK(e,t);if(i&&i.audioTrack&&""!==i.audioTrack)return e.tracks[i.audioTrack]})),n4=(nG((e,t)=>{let i=nK(e,t);return(null==i?void 0:i.auxiliaryTracks.map(t=>e.tracks[t]))||[]}),(e,t)=>t?e.speakers[t]:null),n6=(nG(x(n4,e=>(null==e?void 0:e.audioLevel)||0)),nG(x((e,t)=>{let i=n5(t)(e);return n4(e,null==i?void 0:i.id)},e=>(null==e?void 0:e.audioLevel)||0)),nG((e,t)=>{if(t)return e.connectionQualities[t]}),nG((e,t)=>{let i=nK(e,t);if(i){let t=null==i?void 0:i.auxiliaryTracks.find(t=>tO(e.tracks[t]));return t?e.tracks[t]:void 0}}),nG(x(nd,nK,(e,t)=>{let i=null==t?void 0:t.auxiliaryTracks.find(t=>{let i=e[t];return tU(i)&&tN(i)});return i?e[i]:void 0})),nG(x(nd,nK,(e,t)=>{let i=null==t?void 0:t.auxiliaryTracks.find(t=>{let i=e[t];return tU(i)&&tO(i)});return i?e[i]:void 0})),nG(x(nd,nK,(e,t)=>{let i=null==t?void 0:t.auxiliaryTracks.find(t=>{let i=e[t];return tx(i)&&tO(i)});return i?e[i]:void 0})),nG(x(nd,nK,(e,t)=>tD(e,t)))),n9=e=>x(n6(e),e=>e.audio),n8=(nG((e,t)=>{let i=nK(e,t);return tF(e,null==i?void 0:i.audioTrack)}),nG((e,t)=>{let i=nK(e,t);return tF(e,null==i?void 0:i.videoTrack)}),nG((e,t)=>{if(t&&e.tracks[t])return 0===e.tracks[t].volume})),n7=(nG((e,t)=>{let i=nK(e,t);return n8(null==i?void 0:i.audioTrack)(e)}),nG((e,t)=>{let i=n9(t)(e);return n8(null==i?void 0:i.id)(e)}),nG((e,t)=>{let i=nJ(e,t);if(i)return"audio"!==i.type?void nq.w("Please pass audio track here"):i.volume})),ae=(nG((e,t)=>{let i=nK(e,t);return n7(null==i?void 0:i.audioTrack)(e)}),nG((e,t)=>{let i=n9(t)(e);return n7(null==i?void 0:i.id)(e)}),nG((e,t)=>{let i=nJ(e,t);if(i)return"video"!==i.type?void nq.w("Please pass video track here"):i.layer}),x([nP,ng,nH],(e,t,i)=>{if(i)return e.filter(e=>{var s;return(!!e.recipientPeer||!!(null!=(s=e.recipientRoles)&&s.length))&&(!e.sender||!![t,i].includes(e.sender))&&[t,i].includes(e.recipientPeer)})})),at=x([nP,nz],(e,t)=>{if(t)return e.filter(e=>{var i,s;return null!=(i=e.recipientRoles)&&!!i.length&&(null==(s=e.recipientRoles)?void 0:s.includes(t))})}),ai=x(nP,e=>e.filter(e=>{var t;return!e.recipientPeer&&!(null!=(t=e.recipientRoles)&&t.length)})),as=x([at,nz],e=>e?e.filter(e=>!e.read).length:0),ar=x([ae,nH],e=>e?e.filter(e=>!e.read).length:0),an=(x(ai,e=>e.filter(e=>!e.read).length),nG(ae),nG(at),nG(as),nG(ar),nG(n0));x([na,nd],(e,t)=>Object.values(e).map(e=>{var i;return{peer:e,isAudioEnabled:!!e.audioTrack&&(null==(i=t[e.audioTrack])?void 0:i.enabled)}})),x([e=>e.roleChangeRequests[0]||null,na,nA],(e,t,i)=>e?{requestedBy:e.requestedBy?t[e.requestedBy]:void 0,role:i[e.roleName],token:e.token}:null),x([nR],e=>tj(e)),x([n_],e=>tj(e)),x([nf,nd],(e,t)=>{let i=null;return e&&(i=t[e]),(null==i?void 0:i.plugins)||[]}),x([nm,nd],(e,t)=>{let i=null;return e&&(i=t[e]),(null==i?void 0:i.plugins)||[]});var aa={0:"PEER_JOINED",1:"PEER_LEFT",8:"ROLE_UPDATED",10:"NAME_UPDATED",11:"METADATA_UPDATED",12:"HAND_RAISE_CHANGED"},ao={0:"TRACK_ADDED",1:"TRACK_REMOVED",2:"TRACK_MUTED",3:"TRACK_UNMUTED",5:"TRACK_DEGRADED",6:"TRACK_RESTORED",4:"TRACK_DESCRIPTION_CHANGED"},al={0:"POLL_CREATED",1:"POLL_STARTED",2:"POLL_STOPPED",4:"POLL_VOTES_UPDATED",3:"POLLS_LIST"},ad="hmsNotification",ac=class{constructor(e){this.id=0,this.onNotification=(e,t)=>{let i=i=>{if(!t||(Array.isArray(t)?t.includes(i.type):t===i.type))e(i)};return this.eventEmitter.addListener(ad,i),()=>{this.eventEmitter.removeListener(ad,i)}},this.store=e,this.eventEmitter=new(0,eK.EventEmitter2)({maxListeners:Object.keys(tL).length})}sendPlaylistTrackEnded(e){let t=this.createNotification("PLAYLIST_TRACK_ENDED",e,"info");this.emitEvent(t)}sendDeviceChange(e){var t;let i=this.createNotification("DEVICE_CHANGE_UPDATE",e,e.error?"error":"info",`Selected ${e.type} device - ${null==(t=e.selection)?void 0:t.label}`);this.emitEvent(i)}sendLeaveRoom(e){var t;let i=null==(t=e.requestedBy)?void 0:t.name,s=this.createNotification(e.roomEnded||!i?"ROOM_ENDED":"REMOVED_FROM_ROOM",e,"info",`${e.roomEnded?"Room ended":"Removed from room"} ${i?`by ${i}`:""}`);this.emitEvent(s)}sendPeerList(e){if(0===e.length)return;let t=this.createNotification("PEER_LIST",e,"info");this.emitEvent(t)}sendPeerUpdate(e,t){let i=this.store.getState(n1(null==t?void 0:t.id))||t,s=aa[e];if(s&&i){let e=this.createNotification(s,i,"info");this.emitEvent(e)}}sendTrackUpdate(e,t){let i=this.store.getState(n2(t)),s=ao[e];if(s){let e=this.createNotification(s,i,"info");this.emitEvent(e)}}sendMessageReceived(e){let t=this.createNotification("NEW_MESSAGE",e,"info");this.emitEvent(t)}sendError(e){let t=this.createNotification("ERROR",e,"error");this.emitEvent(t)}sendReconnecting(e){let t=this.createNotification("RECONNECTING",e,"error");this.emitEvent(t)}sendReconnected(){let e=this.createNotification("RECONNECTED",null,"info");this.emitEvent(e)}sendChangeTrackStateRequest(e){let t=this.createNotification("CHANGE_TRACK_STATE_REQUEST",e,"info");this.emitEvent(t)}sendChangeMultiTrackStateRequest(e){let t=this.createNotification("CHANGE_MULTI_TRACK_STATE_REQUEST",e,"info");this.emitEvent(t)}sendPollUpdate(e,t){let i=al[e],s=this.store.getState(an(t));if(i){let e=this.createNotification(i,s,"info");this.emitEvent(e)}}sendTranscriptionUpdate(e){let t=this.createNotification("TRANSCRIPTION_STATE_UPDATED",e,"info");this.emitEvent(t)}emitEvent(e){this.eventEmitter.emit(ad,e)}createNotification(e,t,i,s=""){return this.id++,{id:this.id,type:e,message:s,data:t,severity:i}}},au=class{constructor(e){this.queuedUpdates={},this.timers={},this.DEFAULT_INTERVAL_MS=50,this.store=e}setState(e,t,i=this.DEFAULT_INTERVAL_MS){this.queuedUpdates[t]=this.queuedUpdates[t]||[],this.queuedUpdates[t].push(e),this.timers[t]||(window?this.timers[t]=window.setTimeout(()=>this.setStateBatched(t),i):this.setStateBatched(t))}setStateBatched(e){var t;if((null==(t=this.queuedUpdates[e])?void 0:t.length)>0){let t=t=>{this.queuedUpdates[e].forEach(e=>{try{e(t)}catch(e){nq.w("failed to update store",e)}})};console.time(`timed-${e}`),this.store.namedSetState(t,e),console.timeEnd(`timed-${e}`)}delete this.queuedUpdates[e],window&&this.timers[e]&&(window.clearTimeout(this.timers[e]),delete this.timers[e])}},ah=(e,t)=>{for(let i of ay(Object.keys(e),Object.keys(t))){let s=e[i],r=t[i];av(s,r)?Object.assign(s,r):ag(s,r)?delete e[i]:am(s,r)&&(e[i]=r)}},ap=(e,t)=>{e.plugins&&af(e.plugins,t.plugins)&&(t.plugins=e.plugins),"video"===e.type&&e.layerDefinitions&&af(e.layerDefinitions,t.layerDefinitions)&&(t.layerDefinitions=e.layerDefinitions)},av=(e,t)=>e&&t,ag=(e,t)=>e&&!t,am=(e,t)=>!e&&t,af=(e,t)=>{if(e===t||0===e.length&&(null==t?void 0:t.length)===0)return!0;if(!e||!t||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0},ay=(e,t)=>{let i=new Set;for(let t of e)i.add(t);for(let e of t)i.add(e);return Array.from(i)},ak=class e{static convertPeer(e){var t,i,s;return{id:e.peerId,name:e.name,roleName:null==(t=e.role)?void 0:t.name,isLocal:e.isLocal,videoTrack:null==(i=e.videoTrack)?void 0:i.trackId,audioTrack:null==(s=e.audioTrack)?void 0:s.trackId,auxiliaryTracks:e.auxiliaryTracks.map(e=>e.trackId),customerUserId:e.customerUserId,metadata:e.metadata,joinedAt:e.joinedAt,groups:e.groups,isHandRaised:e.isHandRaised,type:e.type}}static convertTrack(e,t){let i={id:e.trackId,source:e.source,type:e.type,enabled:e.enabled,displayEnabled:e.enabled,peerId:e.peerId||t};return this.enrichTrack(i,e),i}static enrichTrack(t,i){let s=i.getMediaTrackSettings();i instanceof rf&&(t.volume=i.getVolume()||0),e.updateDeviceID(t,i),e.enrichLocalTrack(t,i),"video"===t.type&&("screen"===t.source?(t.displaySurface=s.displaySurface,e.enrichScreenTrack(t,i)):"regular"===t.source&&(t.facingMode=s.facingMode),t.height=s.height,t.width=s.width,e.enrichVideoTrack(t,i)),e.enrichPluginsDetails(t,i)}static enrichLocalTrack(e,t){(t instanceof rU||t instanceof rm)&&(e.isPublished=t.isPublished)}static updateDeviceID(e,t){var i;t instanceof rU||t instanceof rm?e.deviceID=t.settings.deviceId:e.deviceID=null==(i=t.getMediaTrackSettings())?void 0:i.deviceId}static enrichVideoTrack(e,t){t instanceof rG&&(e.layer=t.getLayer(),e.preferredLayer=t.getPreferredLayer(),e.degraded=t.degraded),(t instanceof rG||t instanceof rU)&&(af(t.getSimulcastDefinitions(),e.layerDefinitions)||(e.layerDefinitions=t.getSimulcastDefinitions()))}static enrichScreenTrack(e,t){var i,s;if(t instanceof rU){let r=null==(i=t.getCaptureHandle)?void 0:i.call(t);(null==r?void 0:r.handle)!==(null==(s=e.captureHandle)?void 0:s.handle)&&(e.captureHandle=r),t.isCurrentTab&&(e.displaySurface="selfBrowser")}}static enrichPluginsDetails(e,t){(t instanceof rU||t instanceof rm)&&(af(t.getPlugins(),e.plugins)||(e.plugins=t.getPlugins()))}static convertRoom(t,i){let{recording:s,rtmp:r,hls:n,transcriptions:a}=e.convertRecordingStreamingState(t.recording,t.rtmp,t.hls,t.transcriptions);return{id:t.id,name:t.name,localPeer:i,recording:s,rtmp:r,hls:n,transcriptions:a,sessionId:t.sessionId,startedAt:t.startedAt,joinedAt:t.joinedAt,peerCount:t.peerCount,isLargeRoom:t.large_room_optimization,isEffectsEnabled:t.isEffectsEnabled,disableNoneLayerRequest:t.disableNoneLayerRequest,isVBEnabled:t.isVBEnabled,effectsKey:t.effectsKey,isHipaaEnabled:t.isHipaaEnabled,isNoiseCancellationEnabled:t.isNoiseCancellationEnabled}}static convertMessage(e,t){var i,s,r,n;return{sender:null==(i=e.peer)?void 0:i.peer_id,senderName:null==(s=e.peer)?void 0:s.info.name,senderRole:null==(r=e.peer)?void 0:r.role,senderUserId:null==(n=e.peer)?void 0:n.info.user_id,recipientPeer:e.private?t:void 0,recipientRoles:e.roles,time:new Date(e.timestamp),type:e.info.type,message:e.info.message,id:e.message_id}}static convertRoles(e){let t={};return e&&e.forEach(e=>{t[e.name]=e}),t}static convertRoleChangeRequest(e){var t;return{requestedBy:null==(t=e.requestedBy)?void 0:t.peerId,roleName:e.role.name,token:e.token}}static convertException(e){let t="trackType"in e,i={code:e.code,action:e.action,name:e.name,message:e.message,description:e.description,isTerminal:e.isTerminal,nativeError:e.nativeError,timestamp:new Date};return t&&(i.trackType=null==e?void 0:e.trackType),i}static convertDeviceChangeUpdate(e){let t={devices:e.devices,selection:e.selection,type:e.type};return e.error&&(t.error=this.convertException(e.error)),t}static convertPlaylist(e){return{audio:this.getConvertedPlaylistType(e,"audio"),video:this.getConvertedPlaylistType(e,"video")}}static convertPlaylistItem(e,t){let i=t.type,s=e.getCurrentSelection(i),r=e.isPlaying(i),n=t.url===(null==s?void 0:s.url);return tT(tb({},t),{type:t.type,selected:n,playing:n&&r})}static getConvertedPlaylistType(t,i){let s={},r=t.getCurrentSelection(i),n=t.getCurrentProgress(i),a=t.getVolume(i),o=t.getList(i),l=t.getCurrentIndex(i);return t.getList(i).forEach(i=>{s[i.id]=e.convertPlaylistItem(t,i)}),{list:s,selection:{id:null==r?void 0:r.id,hasPrevious:l>0,hasNext:l<o.length-1},progress:n,volume:a,currentTime:t.getCurrentTime(i),playbackRate:t.getPlaybackRate(i)}}static convertRecordingStreamingState(e,t,i,s){var r;return{recording:{browser:tb({running:!1},null==e?void 0:e.browser),server:tb({running:!1},null==e?void 0:e.server),hls:tb({running:!1},null==e?void 0:e.hls)},rtmp:tb({running:!1},t),hls:{variants:(null==(r=null==i?void 0:i.variants)?void 0:r.map(e=>e))||[],running:!!(null!=i&&i.running),error:null==i?void 0:i.error},transcriptions:s||[]}}},ab=class{constructor(e,t,i,s){this.playlistManager=e,this.syncPlaylistState=i,this.store=s,this.type=t}play(e){return tP(this,null,function*(){if(!e)return void nq.w("Please pass id to play");yield this.playlistManager.setEnabled(!0,{id:e,type:this.type})})}pause(){return tP(this,null,function*(){let e="audio"===this.type?nj:n$,t=this.store.getState(e.selection);if(!t.id)return void nq.w("No item is currently playing to pause");yield this.playlistManager.setEnabled(!1,{id:t.id,type:this.type})})}playNext(){return tP(this,null,function*(){yield this.playlistManager.playNext(this.type)})}playPrevious(){return tP(this,null,function*(){yield this.playlistManager.playPrevious(this.type)})}seek(e){this.playlistManager.seek(e,this.type),this.syncPlaylistState(`seekOn${this.type}Playlist`)}seekTo(e){this.playlistManager.seekTo(e,this.type),this.syncPlaylistState(`seekToOn${this.type}Playlist`)}setVolume(e){this.playlistManager.setVolume(e,this.type),this.syncPlaylistState(`setVolumeOn${this.type}Playlist`)}setList(e){this.playlistManager.setList(e),this.syncPlaylistState(`setListOn${this.type}Playlist`)}stop(){return tP(this,null,function*(){yield this.playlistManager.stop(this.type),this.syncPlaylistState(`stop${this.type}Playlist`)})}setIsAutoplayOn(e){this.playlistManager.setIsAutoplayOn(this.type,e)}setPlaybackRate(e){this.playlistManager.setPlaybackRate(this.type,e),this.syncPlaylistState(`set${this.type}PlaybackRate`)}removeItem(e){return tP(this,null,function*(){let t=yield this.playlistManager.removeItem(e,this.type);return t&&this.syncPlaylistState(`remove${this.type}PlaylistItem`),t})}clearList(){return tP(this,null,function*(){yield this.playlistManager.clearList(this.type),this.syncPlaylistState(`clear${this.type}Playlist`)})}},aT=class{constructor(e,t){this.sdk=e,this.setLocally=t}get sdkSessionStore(){return this.sdk.getSessionStore()}set(e,t){return tP(this,null,function*(){let{value:i}=yield this.sdkSessionStore.set(String(e),t);this.setLocally({key:e,value:i})})}observe(e){return tP(this,null,function*(){let t=Array.isArray(e)?e.map(e=>String(e)):[String(e)];yield this.sdkSessionStore.observe(t)})}unobserve(e){return tP(this,null,function*(){let t=Array.isArray(e)?e.map(e=>String(e)):[String(e)];yield this.sdkSessionStore.unobserve(t)})}},aS=class{constructor(e,t){this.TAG="[BeamSpeakerLabelsLogger]",this.intervalMs=100,this.shouldMonitor=!1,this.hasStarted=!1,this.unsubs=[],this.analysers={},this.store=e,this.actions=t}start(){return tP(this,null,function*(){if(this.hasStarted)return;this.hasStarted=!0,nq.d("starting audio level monitor for remote peers",this.store);let e=this.store.getState(nu);nq.d("starting audio levels is connected to room",e),e&&(yield this.monitorAudioLevels());let t=this.store.subscribe(this.monitorAudioLevels.bind(this),nu);this.unsubs.push(t)})}stop(){return tP(this,null,function*(){this.hasStarted&&(this.hasStarted=!1,this.shouldMonitor=!1,this.unsubs.forEach(e=>e()),nq.d("stopped audio level monitor for remote peers"))})}monitorAudioLevels(){return tP(this,null,function*(){if(!this.store.getState(nu)){this.shouldMonitor&&(nq.i("room no longer connected, stopping audio level monitoring for remote"),this.shouldMonitor=!1);return}if(this.shouldMonitor)return;nq.i("monitoring audio levels"),this.shouldMonitor=!0;let e=()=>{this.shouldMonitor?(this.logAllPeersAudioLevels(),setTimeout(e,this.intervalMs)):nq.i("stopped monitoring audio levels")};setTimeout(e,1e3)})}logAllPeersAudioLevels(){return tP(this,null,function*(){var e;if(!window.__triggerBeamEvent__)return;let t=this.store.getState(nh),i=t.filter(e=>!!e.audioTrack);nq.d(this.TAG,"Peers Without audio track",t.filter(e=>!e.audioTrack).map(e=>e.id).join(","));let s=[];for(let t of i){let i=this.actions.getTrackById(t.audioTrack||""),r=null==(e=null==i?void 0:i.stream)?void 0:e.nativeStream;if(t.joinedAt&&r){let e=yield this.getAudioLevel(t,r);nq.d(this.TAG,t.id,e),e.level>0&&s.push(e)}}s.length>0&&(nq.d("logging audio levels",JSON.stringify(s)),window.__triggerBeamEvent__(JSON.stringify({event:"app-audio-level",data:s})))})}getAudioLevel(e,t){return tP(this,null,function*(){this.analysers[t.id]||(this.analysers[t.id]=this.createAnalyserNode(t));let i=this.analysers[t.id],s=this.calculateAudioLevel(i);return{peerId:e.id,peerName:e.name,level:s}})}createAnalyserNode(e){this.audioContext||(this.audioContext=new AudioContext);let t=this.audioContext.createAnalyser();return this.audioContext.createMediaStreamSource(e).connect(t),t}calculateAudioLevel(e){let t=new Uint8Array(e.fftSize);e.getByteTimeDomainData(t);let i=.009;for(let e of t)i=Math.max(i,(e-128)/128);return Math.ceil(Math.min(Math.max((Math.log(.009)-Math.log(i))/Math.log(.009)*100,0),100))}},aw={name:"diagnostics-role",priority:1,publishParams:{allowed:["audio","video"],audio:{bitRate:32,codec:"opus"},video:{bitRate:100,codec:"vp8",frameRate:30,height:720,width:1280},screen:{bitRate:100,codec:"vp8",frameRate:10,height:1080,width:1920}},subscribeParams:{subscribeToRoles:[],maxSubsBitRate:3200},permissions:{browserRecording:!1,changeRole:!1,endRoom:!1,hlsStreaming:!1,mute:!1,pollRead:!1,pollWrite:!1,removeOthers:!1,rtmpStreaming:!1,unmute:!1}},aP=class{constructor(){this.networkScores=[],this.lastPushedAt=0}pushScore(e){!e||e<0||(0===this.networkScores.length?(this.networkScores.push(e),this.lastPushedAt=Date.now()):this.addPendingCQSTillNow())}addPendingCQSTillNow(){if(this.networkScores.length>0){let e=(Date.now()-this.lastPushedAt)/1e3;for(;e>0;)this.networkScores.push(this.networkScores[this.networkScores.length-1]),e-=1;this.lastPushedAt=Date.now()}}getCQS(){return this.networkScores.reduce((e,t)=>e+t,0)/this.networkScores.length}},aC=e=>e[e.length-1],aE=(e,t)=>{let i=e.filter(e=>{let i;return!!(i=t(e))&&!isNaN(i)});return i.reduce((e,i)=>e+(t(i)||0),0)/i.length},aI=class{constructor(e){this.sdk=e,this.peerStatsList=[],this.localAudioTrackStatsList=[],this.localVideoTrackStatsList=[],this.remoteAudioTrackStatsList=[],this.remoteVideoTrackStatsList=[]}handleStatsUpdate(e){return tP(this,null,function*(){var t,i,s,r,n,a,o,l;let d=e.getLocalPeerStats();d&&this.peerStatsList.push(d);let c=null==(s=null==(i=null==(t=this.sdk.getLocalPeer())?void 0:t.audioTrack)?void 0:i.nativeTrack)?void 0:s.id,u=null==(a=null==(n=null==(r=this.sdk.getLocalPeer())?void 0:r.videoTrack)?void 0:n.nativeTrack)?void 0:a.id,h=e.getLocalTrackStats();h&&(c&&this.localAudioTrackStatsList.push(h[c]),u&&this.localVideoTrackStatsList.push(h[u]));let p=yield null==(l=null==(o=this.sdk.getWebrtcInternals())?void 0:o.getSubscribePeerConnection())?void 0:l.getStats();null==p||p.forEach(e=>{if("inbound-rtp"===e.type){let t="audio"===e.kind?this.remoteAudioTrackStatsList:this.remoteVideoTrackStatsList,i=rY("bytesReceived",e,aC(t));t.push(tT(tb({},e),{bitrate:i}))}})})}buildReport(){var e,t,i,s,r,n,a,o,l,d;let c=null==(e=aC(this.peerStatsList))?void 0:e.publish,u=null==(t=aC(this.peerStatsList))?void 0:t.subscribe,h=Number((((null!=c&&c.responsesReceived?((null==c?void 0:c.totalRoundTripTime)||0)/c.responsesReceived:0)+(null!=u&&u.responsesReceived?((null==u?void 0:u.totalRoundTripTime)||0)/u.responsesReceived:0))/2*1e3).toFixed(2)),p=(null==(i=aC(this.remoteAudioTrackStatsList))?void 0:i.packetsReceived)||0,v=(null==(s=aC(this.remoteVideoTrackStatsList))?void 0:s.packetsReceived)||0,g=this.localAudioTrackStatsList.map(e=>e?aE(Object.values(e),e=>e.bitrate):0),m=this.localVideoTrackStatsList.map(e=>e?aE(Object.values(e),e=>e.bitrate):0),f=(null==(r=aC(this.remoteAudioTrackStatsList))?void 0:r.jitter)||0,y=(null==(n=aC(this.remoteVideoTrackStatsList))?void 0:n.jitter)||0,k=Math.max(f,y),b=aC(this.localAudioTrackStatsList),T=aC(this.localVideoTrackStatsList);return{combined:{roundTripTime:h,packetsReceived:p+v,packetsLost:(null==u?void 0:u.packetsLost)||0,bytesSent:(null==c?void 0:c.bytesSent)||0,bytesReceived:(null==u?void 0:u.bytesReceived)||0,bitrateSent:aE(this.peerStatsList,e=>{var t;return null==(t=e.publish)?void 0:t.bitrate}),bitrateReceived:aE(this.peerStatsList,e=>{var t;return null==(t=e.subscribe)?void 0:t.bitrate}),jitter:k},audio:{roundTripTime:h,packetsReceived:p,packetsLost:(null==(a=aC(this.remoteAudioTrackStatsList))?void 0:a.packetsLost)||0,bytesReceived:(null==(o=aC(this.remoteAudioTrackStatsList))?void 0:o.bytesReceived)||0,bitrateSent:aE(g,e=>e),bitrateReceived:aE(this.remoteAudioTrackStatsList,e=>e.bitrate),bytesSent:b?Object.values(b).reduce((e,t)=>e+(t.bytesSent||0),0):0,jitter:f},video:{roundTripTime:h,packetsLost:(null==(l=aC(this.remoteVideoTrackStatsList))?void 0:l.packetsLost)||0,bytesReceived:(null==(d=aC(this.remoteVideoTrackStatsList))?void 0:d.bytesReceived)||0,packetsReceived:v,bitrateSent:aE(m,e=>e),bitrateReceived:aE(this.remoteVideoTrackStatsList,e=>e.bitrate),bytesSent:T?Object.values(T).reduce((e,t)=>e+(t.bytesSent||0),0):0,jitter:y}}}},aA,aR,a_=((w=a_||{})[w.STARTING=0]="STARTING",w[w.INIT_FETCHED=1]="INIT_FETCHED",w[w.SIGNAL_CONNECTED=2]="SIGNAL_CONNECTED",w[w.ICE_ESTABLISHED=3]="ICE_ESTABLISHED",w[w.MEDIA_CAPTURED=4]="MEDIA_CAPTURED",w[w.MEDIA_PUBLISHED=5]="MEDIA_PUBLISHED",w[w.COMPLETED=6]="COMPLETED",w),aL=class{constructor(e,t,i,s,r=2e4){this.sdk=e,this.sdkListener=t,this.progressCallback=i,this.completionCallback=s,this.connectivityDuration=r,this.wsConnected=!1,this.initConnected=!1,this.isPublishICEConnected=!1,this.isSubscribeICEConnected=!1,this.gatheredPublishICECandidates=[],this.gatheredSubscribeICECandidates=[],this.errors=[],this.isAudioTrackCaptured=!1,this.isVideoTrackCaptured=!1,this.isAudioTrackPublished=!1,this.isVideoTrackPublished=!1,this.cqsCalculator=new aP,this.timestamp=Date.now(),this.onRoomUpdate=this.sdkListener.onRoomUpdate.bind(this.sdkListener),this.onPeerUpdate=this.sdkListener.onPeerUpdate.bind(this.sdkListener),this.onMessageReceived=this.sdkListener.onMessageReceived.bind(this.sdkListener),this.onReconnected=this.sdkListener.onReconnected.bind(this.sdkListener),this.onRoleChangeRequest=this.sdkListener.onRoleChangeRequest.bind(this.sdkListener),this.onRoleUpdate=this.sdkListener.onRoleUpdate.bind(this.sdkListener),this.onChangeTrackStateRequest=this.sdkListener.onChangeTrackStateRequest.bind(this.sdkListener),this.onChangeMultiTrackStateRequest=this.sdkListener.onChangeMultiTrackStateRequest.bind(this.sdkListener),this.onRemovedFromRoom=this.sdkListener.onRemovedFromRoom.bind(this.sdkListener),this.onNetworkQuality=null==(aA=this.sdkListener.onNetworkQuality)?void 0:aA.bind(this.sdkListener),this.onPreview=this.sdkListener.onPreview.bind(this.sdkListener),this.onDeviceChange=null==(aR=this.sdkListener.onDeviceChange)?void 0:aR.bind(this.sdkListener),this.onSessionStoreUpdate=this.sdkListener.onSessionStoreUpdate.bind(this.sdkListener),this.onPollsUpdate=this.sdkListener.onPollsUpdate.bind(this.sdkListener),this.onWhiteboardUpdate=this.sdkListener.onWhiteboardUpdate.bind(this.sdkListener),this.handleConnectionQualityUpdate=e=>{let t=e.find(e=>{var t,i;return e.peerID===(null==(i=null==(t=this.sdk)?void 0:t.store.getLocalPeer())?void 0:i.peerId)});this.cqsCalculator.pushScore(null==t?void 0:t.downlinkQuality)},this.statsCollector=new aI(e),this.state=0}get state(){return this._state}set state(e){var t;void 0===e||void 0!==this._state&&e<this._state||(this._state=e,null==(t=this.progressCallback)||t.call(this,e))}onICESuccess(e){e?this.isPublishICEConnected=!0:this.isSubscribeICEConnected=!0,this.isPublishICEConnected&&this.isSubscribeICEConnected&&(this.state=3)}onSelectedICECandidatePairChange(e,t){t?this.selectedPublishICECandidate=e:this.selectedSubscribeICECandidate=e}onICECandidate(e,t){t?this.gatheredPublishICECandidates.push(e):this.gatheredSubscribeICECandidates.push(e)}onMediaPublished(e){switch(e.type){case"audio":this.isAudioTrackPublished=!0;break;case"video":this.isVideoTrackPublished=!0}this.isVideoTrackPublished&&this.isAudioTrackPublished&&(this.state=5)}onInitSuccess(e){this.websocketURL=e,this.initConnected=!0,this.state=1}onSignallingSuccess(){this.wsConnected=!0,this.state=2}onJoin(e){var t,i;this.sdkListener.onJoin(e),null==(t=this.sdk.getWebrtcInternals())||t.onStatsChange(e=>this.statsCollector.handleStatsUpdate(e)),null==(i=this.sdk.getWebrtcInternals())||i.start(),this.cleanupTimer=window.setTimeout(()=>{this.cleanupAndReport()},this.connectivityDuration)}onError(e){this.sdkListener.onError(e),this.errors.push(e),null!=e&&e.isTerminal&&this.cleanupAndReport()}onTrackUpdate(e,t,i){if(this.sdkListener.onTrackUpdate(e,t,i),i.isLocal&&0===e){switch(t.type){case"audio":this.isAudioTrackCaptured=!0;break;case"video":this.isVideoTrackCaptured=!0}this.isVideoTrackCaptured&&this.isAudioTrackCaptured&&(this.state=4)}}onReconnecting(e){this.sdkListener.onReconnecting(e),this.cqsCalculator.addPendingCQSTillNow()}cleanupAndReport(){var e;clearTimeout(this.cleanupTimer),this.cleanupTimer=void 0,5===this.state&&(this.state=6),null==(e=this.completionCallback)||e.call(this,this.buildReport()),this.sdk.leave()}buildReport(){this.cqsCalculator.addPendingCQSTillNow();let e=this.cqsCalculator.getCQS(),t=this.statsCollector.buildReport();return{testTimestamp:this.timestamp,connectivityState:this.state,errors:this.errors,signallingReport:{isConnected:this.wsConnected,isInitConnected:this.initConnected,websocketUrl:this.websocketURL},mediaServerReport:{stats:t,connectionQualityScore:e,isPublishICEConnected:this.isPublishICEConnected,isSubscribeICEConnected:this.isSubscribeICEConnected,publishICECandidatePairSelected:this.selectedPublishICECandidate,subscribeICECandidatePairSelected:this.selectedSubscribeICECandidate,publishIceCandidatesGathered:this.gatheredPublishICECandidates,subscribeIceCandidatesGathered:this.gatheredSubscribeICECandidates}}}},aM=class{constructor(e){this.recording={server:{running:!1},browser:{running:!1},hls:{running:!1}},this.rtmp={running:!1},this.hls={running:!1,variants:[]},this.transcriptions=[],this.id=e}},aD=(e,t,i)=>tP(void 0,null,function*(){let s=Error("something went wrong during fetch");for(let r=0;r<4;r++)try{let s=yield fetch(e,t),r=yield s.clone().json();if(i&&i.length&&!s.ok&&i.includes(r.code))throw iJ(r.code,"GET_TOKEN",r.message,!1);return s}catch(e){s=e}throw["Failed to fetch","NetworkError"].some(e=>s.message.includes(e))?iQ("GET_TOKEN",s.message):s}),aO=class{constructor(e,t){this.sdk=e,this.sdkListener=t,this.recordedAudio="https://100ms.live/test-audio.wav",this.sdk.setIsDiagnostics(!0),this.initSdkWithLocalPeer()}get localPeer(){var e;return null==(e=this.sdk)?void 0:e.store.getLocalPeer()}checkBrowserSupport(){sO(),sD()}requestPermission(e){return tP(this,null,function*(){try{let t=yield navigator.mediaDevices.getUserMedia(e);return t.getTracks().forEach(e=>e.stop()),yield this.sdk.deviceManager.init(!0),{audio:t.getAudioTracks().length>0,video:t.getVideoTracks().length>0}}catch(t){throw sQ(t,this.sdk.localTrackManager.getErrorType(!!e.video,!!e.audio))}})}startCameraCheck(e){return tP(this,null,function*(){var t,i,s,r;if(this.initSdkWithLocalPeer(),!this.localPeer)throw Error("Local peer not found");this.sdk.store.setSimulcastEnabled(!1),this.localPeer.role=tT(tb({},aw),{publishParams:tT(tb({},aw.publishParams),{allowed:["video"]})});let n=new rp().video(new ru().deviceId(e||"default").build()).build(),a=yield null==(t=this.sdk)?void 0:t.localTrackManager.getLocalTracks({audio:!1,video:!0},n),o=null==a?void 0:a.find(e=>"video"===e.type);if(!o)throw Error("No video track found");null==(i=this.sdk)||i.deviceManager.init(!0),this.localPeer.videoTrack=o,null==(r=null==(s=this.sdk)?void 0:s.listener)||r.onPeerUpdate(9,[this.localPeer])})}stopCameraCheck(){var e,t;null==(t=null==(e=this.localPeer)?void 0:e.videoTrack)||t.cleanup(),this.localPeer&&(this.localPeer.videoTrack=void 0)}startMicCheck(e){return tP(this,arguments,function*({inputDevice:e,onError:t,onStop:i,time:s=1e4}){var r,n,a,o;this.initSdkWithLocalPeer(e=>{this.stopMicCheck(),null==t||t(e)});let l=yield this.getLocalAudioTrack(e);if(null==(r=this.sdk)||r.deviceManager.init(!0),!this.localPeer)throw Error("Local peer not found");if(!l)throw Error("No audio track found");this.localPeer.audioTrack=l,null==(n=this.sdk)||n.initPreviewTrackAudioLevelMonitor(),null==(o=null==(a=this.sdk)?void 0:a.listener)||o.onPeerUpdate(9,[this.localPeer]),this.mediaRecorder=new MediaRecorder(l.stream.nativeStream);let d=[];this.mediaRecorder.ondataavailable=function(e){d.push(e.data)},this.mediaRecorder.onstop=()=>{var e,t;let i=new Blob(d,{type:null==(e=this.mediaRecorder)?void 0:e.mimeType});this.recordedAudio=URL.createObjectURL(i),null==(t=this.onStopMicCheck)||t.call(this)},this.mediaRecorder.start();let c=setTimeout(()=>{this.stopMicCheck()},s);this.onStopMicCheck=()=>{clearTimeout(c),null==i||i()}})}stopMicCheck(){var e,t,i;null==(e=this.mediaRecorder)||e.stop(),null==(i=null==(t=this.localPeer)?void 0:t.audioTrack)||i.cleanup(),this.localPeer&&(this.localPeer.audioTrack=void 0)}getRecordedAudio(){return this.recordedAudio}startConnectivityCheck(e,t,i,s){return tP(this,null,function*(){if(!this.sdk)throw Error("SDK not found");this.connectivityCheck=new aL(this.sdk,this.sdkListener,e,t,s);let r=yield this.getAuthToken(i);yield this.sdk.leave(),yield this.sdk.join({authToken:r,userName:"diagnostics-test"},this.connectivityCheck),this.sdk.addConnectionQualityListener({onConnectionQualityUpdate:e=>{var t;null==(t=this.connectivityCheck)||t.handleConnectionQualityUpdate(e)}})})}stopConnectivityCheck(){return tP(this,null,function*(){var e;return null==(e=this.connectivityCheck)?void 0:e.cleanupAndReport()})}initSdkWithLocalPeer(e){var t,i,s;this.sdkListener&&(null==(t=this.sdk)||t.initStoreAndManagers(tT(tb({},this.sdkListener),{onError:t=>{null==e||e(t),this.sdkListener.onError(t)}})));let r=new r5({name:"diagnostics-peer",role:aw,type:"regular"});null==(i=this.sdk)||i.store.addPeer(r);let n=new aM("diagnostics-room");this.sdk.store.setRoom(n),this.sdkListener.onRoomUpdate("ROOM_PEER_COUNT_UPDATED",n),null==(s=this.sdk)||s.deviceManager.init(!0)}getAuthToken(e){return tP(this,null,function*(){let t=new URL("https://api.100ms.live/v2/diagnostics/token");e&&t.searchParams.append("region",e);let i=yield aD(t.toString(),{method:"GET"},[429,500,501,502,503,504,505,506,507,508,509,510,511]),s=yield i.json();if(!i.ok)throw iJ(s.code,"GET_TOKEN",s.message,!1);let{token:r}=s;if(!r)throw Error(s.message);return r})}getLocalAudioTrack(e){return tP(this,null,function*(){var t;if(!this.localPeer)return;this.localPeer.role=tT(tb({},aw),{publishParams:tT(tb({},aw.publishParams),{allowed:["audio"]})});let i=new rp().audio(new rd().deviceId(e||"default").build()).build(),s=yield null==(t=this.sdk)?void 0:t.localTrackManager.getLocalTracks({audio:!0,video:!1},i);return null==s?void 0:s.find(e=>"audio"===e.type)})}},aN=class{constructor(e,t,i){this.isRoomJoinCalled=!1,this.ignoredMessageTypes=[],this.setProgress=({type:e,progress:t})=>{this.setState(i=>{i.playlist[e].progress=t,i.playlist[e].currentTime=this.sdk.getPlaylistManager().getCurrentTime(e)},"playlistProgress")},this.syncPlaylistState=e=>{this.setState(e=>{Object.assign(e.playlist,ak.convertPlaylist(this.sdk.getPlaylistManager()))},e)},this.sendPeerUpdateNotification=(e,t)=>{let i=this.store.getState(n1(t.peerId)),s=aa[e]||"peerUpdate";if(8===e)this.syncRoomState(s),this.updateMidCallPreviewRoomState(e,t);else if([0,1].includes(e))this.syncRoomState(s),i||(i=this.store.getState(n1(t.peerId)));else if([12,13,14].includes(e))this.syncRoomState(s),i||(i=this.store.getState(n1(t.peerId)));else{let e=ak.convertPeer(t);this.setState(t=>{let s=t.peers[e.id];av(s,e)&&(af(s.auxiliaryTracks,e.auxiliaryTracks)&&(s.auxiliaryTracks=e.auxiliaryTracks),Object.assign(s,e)),i=e},s)}this.hmsNotifications.sendPeerUpdate(e,i)},this.getSDKHMSPeer=e=>this.sdk.getPeerMap()[e],this.setState=(e,t)=>this.store.namedSetState(e,t),this.store=e,this.sdk=t,this.hmsNotifications=i,this.sessionStore=new aT(this.sdk,this.setSessionStoreValueLocally.bind(this)),this.actionBatcher=new au(e)}submitSessionFeedback(e,t){return this.sdk.submitSessionFeedback(e,t)}getLocalTrack(e){return this.sdk.store.getLocalPeerTracks().find(t=>t.trackId===e)}get interactivityCenter(){return this.sdk.getInteractivityCenter()}setPlaylistSettings(e){this.sdk.updatePlaylistSettings(e)}refreshDevices(){return tP(this,null,function*(){yield this.sdk.refreshDevices()})}unblockAudio(){return tP(this,null,function*(){yield this.sdk.getAudioOutput().unblockAutoplay()})}setVolume(e,t){return tP(this,null,function*(){t?yield this.setTrackVolume(e,t):(yield this.sdk.getAudioOutput().setVolume(e),this.syncRoomState("setOutputVolume"))})}setAudioOutputDevice(e){return tP(this,null,function*(){(yield this.sdk.getAudioOutput().setDevice(e))&&this.setState(t=>{t.settings.audioOutputDeviceId=e},"setAudioOutputDevice")})}setPreferredLayer(e,t){return tP(this,null,function*(){var i;let s=this.getTrackById(e);if(s)if(s instanceof rG){if("none"===t)return void nq.d("layer none will be ignored");if((null==(i=this.store.getState(n3(e)))?void 0:i.preferredLayer)===t)return void nq.d(`preferred layer is already ${t}`);this.setState(i=>{let s=i.tracks[e];s&&(s.preferredLayer=t)},"setPreferredLayer"),yield s.setPreferredLayer(t)}else nq.d(`track ${e} is not a remote video track`);else this.logPossibleInconsistency(`track ${e} not present, unable to set preffer layer`)})}getNativeTrackById(e){var t;return null==(t=this.sdk.store.getTrackById(e))?void 0:t.nativeTrack}getTrackById(e){return this.sdk.store.getTrackById(e)}getAuthTokenByRoomCode(e,t){return this.sdk.getAuthTokenByRoomCode(e,t)}preview(e){return tP(this,null,function*(){let t=this.store.getState(nE);if("Preview"===t||"Connecting"===t)return void this.logPossibleInconsistency("attempting to call preview while room is in preview/connecting");try{"Connected"!==t&&this.setState(e=>{e.room.roomState="Connecting"},"connecting"),yield this.sdkPreviewWithListeners(e)}catch(e){throw nq.e("Cannot show preview. Failed to connect to room - ",e),e}})}cancelMidCallPreview(){return tP(this,null,function*(){return this.sdk.cancelMidCallPreview()})}join(e){return tP(this,null,function*(){if(this.isRoomJoinCalled)return void this.logPossibleInconsistency("room join is called again");try{this.isRoomJoinCalled=!0,this.setState(e=>{e.room.roomState="Connecting"},"join"),yield this.sdkJoinWithListeners(e)}catch(e){throw this.isRoomJoinCalled=!1,nq.e("Failed to connect to room - ",e),e}})}leave(){return tP(this,null,function*(){let e=this.store.getState(nu),t=!0;e||(t=!1,this.logPossibleInconsistency("room leave is called when no room is connected"));let i=this.store.getState(nE);return this.setState(e=>{e.room.roomState="Disconnecting"},"leaving"),this.sdk.leave(t).then(()=>{this.resetState("leave"),this.beamSpeakerLabelsLogger&&this.beamSpeakerLabelsLogger.stop().catch(nq.e),nq.i("left room")}).catch(e=>{nq.e("error in leaving room - ",e),this.setState(e=>{e.room.roomState=i},"revertLeave")})})}setScreenShareEnabled(e,t){return tP(this,null,function*(){"boolean"==typeof t&&(t={audioOnly:t});try{e?yield this.startScreenShare(t):yield this.stopScreenShare()}catch(e){throw this.hmsNotifications.sendError(ak.convertException(e)),e}})}addTrack(e,t="regular"){return tP(this,null,function*(){yield this.sdk.addTrack(e,t),this.syncRoomState("addTrack")})}removeTrack(e){return tP(this,null,function*(){yield this.sdk.removeTrack(e),this.syncRoomState("removeTrack")})}setLocalAudioEnabled(e){return tP(this,null,function*(){let t=this.store.getState(nm);t&&(yield this.setEnabledTrack(t,e))})}setLocalVideoEnabled(e){return tP(this,null,function*(){let t=this.store.getState(nf);t&&(yield this.setEnabledTrack(t,e))})}setEnabledTrack(e,t){return tP(this,null,function*(){var i;if((null==(i=this.store.getState().tracks[e])?void 0:i.enabled)===t)return void this.logPossibleInconsistency(`local track[${e}] enabled state - ${t}`);this.setState(i=>{i.tracks[e]?i.tracks[e].displayEnabled=t:this.logPossibleInconsistency("track id not found for setEnabled")},"displayEnabled");try{yield this.setEnabledSDKTrack(e,t),this.syncRoomState("setEnabled")}catch(i){throw this.setState(i=>{i.tracks[e].displayEnabled=!t},"rollbackDisplayEnabled"),this.hmsNotifications.sendError(ak.convertException(i)),i}this.hmsNotifications.sendTrackUpdate(t?3:2,e)})}autoSelectAudioOutput(e){return tP(this,null,function*(){yield this.sdk.autoSelectAudioOutput(e)})}setAudioSettings(e){return tP(this,null,function*(){let t=this.store.getState(nm);t&&(yield this.setSDKLocalAudioTrackSettings(t,e),this.syncRoomState("setAudioSettings"))})}setVideoSettings(e){return tP(this,null,function*(){let t=this.store.getState(nf);t&&(yield this.setSDKLocalVideoTrackSettings(t,e),this.syncRoomState("setVideoSettings"))})}switchCamera(){return tP(this,null,function*(){let e=this.store.getState(nf);if(e){let t=this.sdk.store.getLocalPeerTracks().find(t=>t.trackId===e);t&&(yield t.switchCamera(),this.syncRoomState("switchCamera"))}})}sendMessage(e){this.sendBroadcastMessage(e)}sendBroadcastMessage(e,t){return tP(this,null,function*(){let{message_id:i,timestamp:s}=yield this.sdk.sendBroadcastMessage(e,t);this.updateMessageInStore({message:e,type:t,id:i,time:s})})}sendGroupMessage(e,t,i){return tP(this,null,function*(){let s=this.store.getState(nA),r=t.map(e=>s[e]),{message_id:n,timestamp:a}=yield this.sdk.sendGroupMessage(e,r,i);this.updateMessageInStore({message:e,recipientRoles:t,type:i,id:n,time:a})})}sendDirectMessage(e,t,i){return tP(this,null,function*(){let{message_id:s,timestamp:r}=yield this.sdk.sendDirectMessage(e,t,i);this.updateMessageInStore({message:e,recipientPeer:t,type:i,id:s,time:r})})}updateMessageInStore(e){var t;if(!e.message)throw nq.w("sendMessage","Failed to send message",e),Error(`sendMessage Failed - ${JSON.stringify(e)}`);if(e.type&&this.ignoredMessageTypes.includes(e.type))return;let i=this.sdk.getLocalPeer(),s={read:!0,id:e.id,time:new Date(e.time),message:e.message,type:e.type||"chat",recipientPeer:e.recipientPeer,recipientRoles:e.recipientRoles,senderName:null==i?void 0:i.name,sender:null==i?void 0:i.peerId,senderRole:null==(t=null==i?void 0:i.role)?void 0:t.name,ignored:!1};this.setState(e=>{e.messages.byID[s.id]=s,e.messages.allIDs.push(s.id)},"newMessage")}setMessageRead(e,t){this.setState(i=>{t?i.messages.byID[t]?i.messages.byID[t].read=e:this.logPossibleInconsistency("no message with id is found"):i.messages.allIDs.forEach(t=>{i.messages.byID[t].read=e})},"setMessageRead")}attachVideo(e,t){return tP(this,null,function*(){if(this.localAndVideoUnmuting(e))return new Promise(i=>{let s=this.store.subscribe(r=>tP(this,null,function*(){r&&(yield this.attachVideoInternal(e,t),s(),i())}),nb)});yield this.attachVideoInternal(e,t)})}detachVideo(e,t){return tP(this,null,function*(){let i=this.getTrackById(e);(null==i?void 0:i.type)==="video"?yield this.sdk.detachVideo(i,t):(t&&(t.srcObject=null),nq.d("possible inconsistency detected - no video track found to remove sink"))})}addPluginToVideoTrack(e,t){return tP(this,null,function*(){return this.addRemoveVideoPlugin(e,"add",t)})}addPluginsToVideoStream(e){return tP(this,null,function*(){return this.addRemoveMediaStreamVideoPlugins(e,"add")})}removePluginsFromVideoStream(e){return tP(this,null,function*(){return this.addRemoveMediaStreamVideoPlugins(e,"remove")})}addPluginToAudioTrack(e){return tP(this,null,function*(){return this.addRemoveAudioPlugin(e,"add")})}validateVideoPluginSupport(e){let t={};if(t.isSupported=!1,!e)return nq.w("no plugin passed in for checking support"),t.errMsg="no plugin passed in for checking support",t;let i=this.store.getState(nf);if(!i)return nq.w("video Track not added to local peer yet"),t.errMsg="call this function only after local peer has video track",t;let s=this.getTrackById(i);return s?t=s.validatePlugin(e):(nq.w(`track ${i} not present, unable to validate plugin`),t.errMsg=`track ${i} not present, unable to validate plugin`),t}validateAudioPluginSupport(e){let t={};if(t.isSupported=!1,!e)return nq.w('no plugin passed in for checking support"'),t.errMsg='no plugin passed in for checking support"',t;let i=this.store.getState(nm);if(!i)return nq.w("audio track not added to local peer yet"),t.errMsg="call this function only after local peer has audio track",t;let s=this.getTrackById(i);return s?t=s.validatePlugin(e):(nq.w(`track ${i} not present, unable to validate plugin`),t.errMsg=`track ${i} not present, unable to validate plugin`),t}removePluginFromVideoTrack(e){return tP(this,null,function*(){return this.addRemoveVideoPlugin(e,"remove")})}removePluginFromAudioTrack(e){return tP(this,null,function*(){return this.addRemoveAudioPlugin(e,"remove")})}changeRole(e,t,i=!1){return tP(this,null,function*(){yield this.sdk.changeRoleOfPeer(e,t,i)})}changeRoleOfPeer(e,t,i=!1){return tP(this,null,function*(){yield this.sdk.changeRoleOfPeer(e,t,i)})}changeRoleOfPeersWithRoles(e,t){return tP(this,null,function*(){let i=this.sdk.getRoles().filter(t=>e.includes(t.name));yield this.sdk.changeRoleOfPeersWithRoles(i,t)})}acceptChangeRole(e){return tP(this,null,function*(){let t=e.requestedBy?this.getSDKHMSPeer(e.requestedBy.id):void 0;t||nq.w(`peer for which role change is requested no longer available - ${e.requestedBy}`);let i={requestedBy:t,role:e.role,token:e.token};yield this.sdk.acceptChangeRole(i),this.removeRoleChangeRequest(e)})}raiseLocalPeerHand(){return tP(this,null,function*(){yield this.sdk.raiseLocalPeerHand()})}lowerLocalPeerHand(){return tP(this,null,function*(){yield this.sdk.lowerLocalPeerHand()})}raiseRemotePeerHand(e){return tP(this,null,function*(){yield this.sdk.raiseRemotePeerHand(e)})}lowerRemotePeerHand(e){return tP(this,null,function*(){yield this.sdk.lowerRemotePeerHand(e)})}getPeer(e){return tP(this,null,function*(){let t=yield this.sdk.getPeer(e);if(t)return ak.convertPeer(t)})}findPeerByName(e){return tP(this,null,function*(){let{offset:t,peers:i,eof:s}=yield this.sdk.findPeerByName(e);return{offset:t,eof:s,peers:i.map(e=>ak.convertPeer(e))}})}getPeerListIterator(e){let t=this.sdk.getPeerListIterator(e);return{hasNext:()=>t.hasNext(),next:()=>tP(this,null,function*(){return(yield t.next()).map(e=>ak.convertPeer(e))}),findPeers:()=>tP(this,null,function*(){return(yield t.findPeers()).map(e=>ak.convertPeer(e))}),getTotal:()=>t.getTotal()}}initAppData(e){this.setState(t=>{t.appData=e},"initAppData")}setAppData(e,t,i){let s=(null==t?void 0:t.constructor.name)==="Object";this.setState(r=>{r.appData?i&&s?Object.assign(r.appData[e],t):r.appData[e]=t:r.appData={[e]:t}},`setAppData-${e}`)}rejectChangeRole(e){this.removeRoleChangeRequest(e)}endRoom(e,t){return tP(this,null,function*(){let i=this.store.getState(nL);if(!(null!=i&&i.endRoom))return void nq.w("You are not allowed to perform this action - endRoom");let s=this.store.getState(nE);this.setState(e=>{e.room.roomState="Disconnecting"},"endingRoom");try{yield this.sdk.endRoom(e,t),this.resetState("endRoom")}catch(e){nq.e("error in ending room - ",e),this.setState(e=>{e.room.roomState=s},"revertEndRoom")}})}removePeer(e,t){return tP(this,null,function*(){var i;e!==(null==(i=this.sdk.getLocalPeer())?void 0:i.peerId)&&(yield this.sdk.removePeer(e,t))})}startRTMPOrRecording(e){return tP(this,null,function*(){yield this.sdk.startRTMPOrRecording(e)})}stopRTMPAndRecording(){return tP(this,null,function*(){yield this.sdk.stopRTMPAndRecording()})}startHLSStreaming(e){return tP(this,null,function*(){yield this.sdk.startHLSStreaming(e)})}stopHLSStreaming(e){return tP(this,null,function*(){yield this.sdk.stopHLSStreaming(e)})}startTranscription(e){return tP(this,null,function*(){yield this.sdk.startTranscription(e)})}stopTranscription(e){return tP(this,null,function*(){yield this.sdk.stopTranscription(e)})}sendHLSTimedMetadata(e){return tP(this,null,function*(){yield this.sdk.sendHLSTimedMetadata(e)})}changeName(e){return tP(this,null,function*(){yield this.sdk.changeName(e)})}changeMetadata(e){return tP(this,null,function*(){"string"!=typeof e&&(e=JSON.stringify(e)),yield this.sdk.changeMetadata(e)})}setSessionMetadata(e){return tP(this,null,function*(){yield this.sdk.setSessionMetadata(e),this.setState(t=>{t.sessionMetadata=e},"setSessionMetadata"),this.setSessionStoreValueLocally({key:"default",value:e},"setSessionMetadata")})}populateSessionMetadata(){return tP(this,null,function*(){let e=yield this.sdk.getSessionMetadata();this.setState(t=>{t.sessionMetadata=e},"populateSessionMetadata"),this.setSessionStoreValueLocally({key:"default",value:e},"populateSessionmetadata")})}setRemoteTrackEnabled(e,t){return tP(this,null,function*(){if("string"==typeof e){let i=this.getTrackById(e);i&&(i instanceof rf||i instanceof rG)?yield this.sdk.changeTrackState(i,t):this.logPossibleInconsistency(`No remote track with ID ${e} found for change track state`)}else Array.isArray(e)&&e.forEach(e=>this.setRemoteTrackEnabled(e,t))})}setRemoteTracksEnabled(e){return tP(this,null,function*(){let t={enabled:e.enabled,type:e.type,source:e.source};if(e.roles){let i=this.store.getState(nA);t.roles=e.roles.map(e=>i[e])}yield this.sdk.changeMultiTrackState(t)})}setLogLevel(e){nq.level=e,this.sdk.setLogLevel(e)}setFrameworkInfo(e){this.sdk.setFrameworkInfo(e)}ignoreMessageTypes(e,t=!1){if(t)this.ignoredMessageTypes=e;else for(let t of e)this.ignoredMessageTypes.includes(t)||this.ignoredMessageTypes.push(t)}enableBeamSpeakerLabelsLogging(){return tP(this,null,function*(){this.beamSpeakerLabelsLogger||(nq.i("enabling beam speaker labels logging"),this.beamSpeakerLabelsLogger=new aS(this.store,this),yield this.beamSpeakerLabelsLogger.start())})}initDiagnostics(){let e=new aO(this.sdk,{onJoin:this.onJoin.bind(this),onPreview:this.onPreview.bind(this),onRoomUpdate:this.onRoomUpdate.bind(this),onPeerUpdate:this.onPeerUpdate.bind(this),onTrackUpdate:this.onTrackUpdate.bind(this),onMessageReceived:this.onMessageReceived.bind(this),onError:this.onError.bind(this),onReconnected:this.onReconnected.bind(this),onReconnecting:this.onReconnecting.bind(this),onRoleChangeRequest:this.onRoleChangeRequest.bind(this),onRoleUpdate:this.onRoleUpdate.bind(this),onDeviceChange:this.onDeviceChange.bind(this),onChangeTrackStateRequest:this.onChangeTrackStateRequest.bind(this),onChangeMultiTrackStateRequest:this.onChangeMultiTrackStateRequest.bind(this),onRemovedFromRoom:this.onRemovedFromRoom.bind(this),onNetworkQuality:this.onNetworkQuality.bind(this),onSessionStoreUpdate:this.onSessionStoreUpdate.bind(this),onPollsUpdate:this.onPollsUpdate.bind(this),onWhiteboardUpdate:this.onWhiteboardUpdate.bind(this)});return this.sdk.addAudioListener({onAudioLevelUpdate:this.onAudioLevelUpdate.bind(this)}),this.sdk.addConnectionQualityListener({onConnectionQualityUpdate:this.onConnectionQualityUpdate.bind(this)}),e}resetState(e="resetState"){this.isRoomJoinCalled=!1,nq.cleanup(),this.setState(e=>{Object.assign(e,tI())},e)}getDebugInfo(){return this.sdk.getDebugInfo()}sdkJoinWithListeners(e){return tP(this,null,function*(){yield this.sdk.join(e,{onJoin:this.onJoin.bind(this),onPreview:this.onPreview.bind(this),onRoomUpdate:this.onRoomUpdate.bind(this),onPeerUpdate:this.onPeerUpdate.bind(this),onTrackUpdate:this.onTrackUpdate.bind(this),onMessageReceived:this.onMessageReceived.bind(this),onError:this.onError.bind(this),onReconnected:this.onReconnected.bind(this),onReconnecting:this.onReconnecting.bind(this),onRoleChangeRequest:this.onRoleChangeRequest.bind(this),onRoleUpdate:this.onRoleUpdate.bind(this),onDeviceChange:this.onDeviceChange.bind(this),onChangeTrackStateRequest:this.onChangeTrackStateRequest.bind(this),onChangeMultiTrackStateRequest:this.onChangeMultiTrackStateRequest.bind(this),onRemovedFromRoom:this.onRemovedFromRoom.bind(this),onNetworkQuality:this.onNetworkQuality.bind(this),onSessionStoreUpdate:this.onSessionStoreUpdate.bind(this),onPollsUpdate:this.onPollsUpdate.bind(this),onWhiteboardUpdate:this.onWhiteboardUpdate.bind(this),onSFUMigration:this.onSFUMigration.bind(this)}),this.sdk.addAudioListener({onAudioLevelUpdate:this.onAudioLevelUpdate.bind(this)}),this.sdk.addConnectionQualityListener({onConnectionQualityUpdate:this.onConnectionQualityUpdate.bind(this)})})}onSFUMigration(){this.syncRoomState("SFUMigration")}onRemovedFromRoom(e){var t;let i=this.store.getState(n1(null==(t=e.requestedBy)?void 0:t.peerId));this.hmsNotifications.sendLeaveRoom(tT(tb({},e),{requestedBy:i||void 0}));let s=e.roomEnded||!i?"roomEnded":"removedFromRoom";nq.i(`resetting state after peer removed ${s}`,e),this.resetState(s)}onDeviceChange(e){let t=e.devices;if(!t)return;let i=this.store.getState(nv);if(this.setState(e=>{af(e.devices.audioInput,t.audioInput)||(e.devices.audioInput=t.audioInput),af(e.devices.videoInput,t.videoInput)||(e.devices.videoInput=t.videoInput),af(e.devices.audioOutput,t.audioOutput)||(e.devices.audioOutput=t.audioOutput);let s=this.sdk.getLocalPeer();null!=i&&i.id&&s&&Object.assign(e.settings,this.getMediaSettings(s))},"deviceChange"),e.selection&&!e.internal){let t=ak.convertDeviceChangeUpdate(e);this.hmsNotifications.sendDeviceChange(t)}}sdkPreviewWithListeners(e){return tP(this,null,function*(){yield this.sdk.preview(e,{onPreview:this.onPreview.bind(this),onError:this.onError.bind(this),onReconnected:this.onReconnected.bind(this),onReconnecting:this.onReconnecting.bind(this),onDeviceChange:this.onDeviceChange.bind(this),onRoomUpdate:this.onRoomUpdate.bind(this),onPeerUpdate:this.onPeerUpdate.bind(this),onNetworkQuality:this.onNetworkQuality.bind(this),onTrackUpdate:this.onTrackUpdate.bind(this)}),this.sdk.addAudioListener({onAudioLevelUpdate:this.onAudioLevelUpdate.bind(this)})})}onNetworkQuality(e){this.setState(t=>{var i;let s=t.room.localPeer||(null==(i=this.sdk.getLocalPeer())?void 0:i.peerId);s&&(t.connectionQualities[s]={peerID:s,downlinkQuality:e})},"ConnectionQuality")}onSessionStoreUpdate(e){this.setSessionStoreValueLocally(e,"sessionStoreUpdate")}onPollsUpdate(e,t){let i=al[e];this.setState(e=>{let i=t.reduce((e,t)=>{var i;return e[t.id]=tT(tb({},t),{questions:null==(i=t.questions)?void 0:i.map(e=>{var t,i;return tT(tb({},e),{answer:e.answer?tb({},e.answer):void 0,options:null==(t=e.options)?void 0:t.map(e=>tb({},e)),responses:null==(i=e.responses)?void 0:i.map(e=>tb({},e))})})}),e},{});var s=e.polls;for(let e of ay(Object.keys(s),Object.keys(i))){let t=s[e],r=i[e];av(t,r)?(t.questions&&af(t.questions,r.questions)&&(r.questions=t.questions),Object.assign(t,r)):am(t,r)&&(s[e]=r)}},i),t.forEach(t=>this.hmsNotifications.sendPollUpdate(e,t.id))}onWhiteboardUpdate(e){this.setState(t=>{t.whiteboards[e.id]=e},"whiteboardUpdate")}startScreenShare(e){return tP(this,null,function*(){this.store.getState(nS)?this.logPossibleInconsistency("start screenshare is called while it's on"):(yield this.sdk.startScreenShare(()=>this.syncRoomState("screenshareStopped"),e),this.syncRoomState("startScreenShare"))})}stopScreenShare(){return tP(this,null,function*(){this.store.getState(nS)?(yield this.sdk.stopScreenShare(),this.syncRoomState("stopScreenShare")):this.logPossibleInconsistency("stop screenshare is called while it's not on")})}attachVideoInternal(e,t){return tP(this,null,function*(){let i=this.getTrackById(e);i||(i=this.getLocalTrack(e)),i&&"video"===i.type?yield this.sdk.attachVideo(i,t):this.logPossibleInconsistency("no video track found to add sink")})}syncRoomState(e){e=`${e}_fullSync`,nq.time(`store-sync-${e}`);let t={},i=[],s={},r={},n={},a;for(let e of this.sdk.getPeers()){let o=ak.convertPeer(e);for(let r of(t[o.id]=o,i.push(o.id),n[o.id]={peerID:o.id,downlinkQuality:e.networkQuality||-1},[e.audioTrack,e.videoTrack,...e.auxiliaryTracks])){if(!r)continue;let e=ak.convertTrack(r);s[e.id]=e}e.isLocal&&(a=this.getPreviewFields(e),Object.assign(r,this.getMediaSettings(e)))}let o=this.sdk.getRecordingState(),l=this.sdk.getRTMPState(),d=this.sdk.getHLSState(),c=this.sdk.getTranscriptionState();this.setState(e=>{var u;e.room.peers=i;let h=e.peers,p=e.tracks;((e,t)=>{for(let i of ay(Object.keys(e),Object.keys(t))){let s=e[i],r=t[i];av(s,r)?(af(s.auxiliaryTracks,r.auxiliaryTracks)&&(r.auxiliaryTracks=s.auxiliaryTracks),s.groups&&af(s.groups,r.groups)&&(r.groups=s.groups),Object.assign(s,r)):ag(s,r)?delete e[i]:am(s,r)&&(e[i]=r)}})(h,t),((e,t)=>{for(let i of ay(Object.keys(e),Object.keys(t))){let s=e[i],r=t[i];av(s,r)?(ap(s,r),Object.assign(s,r)):ag(s,r)?delete e[i]:am(s,r)&&(e[i]=r)}})(p,s),Object.assign(e.settings,r),e.room.isConnected&&Object.assign(e.connectionQualities,n),null!=(u=e.preview)&&u.localPeer&&null!=a&&a.localPeer?Object.assign(e.preview,a):e.preview=a,Object.assign(e.roles,ak.convertRoles(this.sdk.getRoles())),Object.assign(e.playlist,ak.convertPlaylist(this.sdk.getPlaylistManager())),Object.assign(e.room,ak.convertRecordingStreamingState(o,l,d,c)),Object.assign(e.templateAppData,this.sdk.getTemplateAppData())},e),nq.timeEnd(`store-sync-${e}`)}onPreview(e){this.setState(t=>{var i;Object.assign(t.room,ak.convertRoom(e,null==(i=this.sdk.getLocalPeer())?void 0:i.peerId)),t.room.roomState="Preview"},"previewStart"),this.syncRoomState("previewSync")}onJoin(e){let t=this.sdk.getPlaylistManager();this.audioPlaylist=new ab(t,"audio",this.syncPlaylistState.bind(this),this.store),this.videoPlaylist=new ab(t,"video",this.syncRoomState.bind(this),this.store),this.syncRoomState("joinSync"),this.setState(t=>{var i;Object.assign(t.room,ak.convertRoom(e,null==(i=this.sdk.getLocalPeer())?void 0:i.peerId)),t.room.isConnected=!0,t.room.roomState="Connected"},"joined"),t.onProgress(this.setProgress),t.onNewTrackStart(e=>{this.syncPlaylistState(`${e.type}PlaylistUpdate`)}),t.onPlaylistEnded(e=>{this.syncPlaylistState(`${e}PlaylistEnded`)}),t.onCurrentTrackEnded(e=>{this.hmsNotifications.sendPlaylistTrackEnded(ak.convertPlaylistItem(t,e)),this.syncPlaylistState(`${e.type}PlaylistItemEnded`)})}onRoomUpdate(e,t){this.setState(e=>{var i;Object.assign(e.room,ak.convertRoom(t,null==(i=this.sdk.getLocalPeer())?void 0:i.peerId))},e),"TRANSCRIPTION_STATE_UPDATED"===e&&this.hmsNotifications.sendTranscriptionUpdate(t.transcriptions)}onPeerUpdate(e,t){if(![4,5].includes(e)){if(Array.isArray(t)){let e=this.store.getState(na),i=t.filter(t=>!e[t.peerId]);if(this.syncRoomState("peersJoined"),this.store.getState(nu)){let e=[];for(let i of t){let t=this.store.getState(n1(i.peerId));t&&e.push(t)}this.hmsNotifications.sendPeerList(e)}else i.forEach(e=>{let t=this.store.getState(n1(e.peerId));t&&this.hmsNotifications.sendPeerUpdate(0,t)});return}this.sendPeerUpdateNotification(e,t)}}onTrackUpdate(e,t,i){if(1===e)this.hmsNotifications.sendTrackUpdate(e,t.trackId),this.handleTrackRemove(t,i);else if([0,1].includes(e)){let i=ao[e];this.syncRoomState(i),this.hmsNotifications.sendTrackUpdate(e,t.trackId)}else{let i=ao[e]||"trackUpdate",s=ak.convertTrack(t);this.setState(e=>{let t=e.tracks[s.id];av(t,s)&&(ap(t,s),Object.assign(t,s))},i),this.hmsNotifications.sendTrackUpdate(e,t.trackId)}}onMessageReceived(e){let t=ak.convertMessage(e,this.store.getState(ng));t.read=!1,t.ignored=this.ignoredMessageTypes.includes(t.type),"hms_transcript"===t.type&&(t.ignored=!0),this.putMessageInStore(t),this.hmsNotifications.sendMessageReceived(t)}putMessageInStore(e){e.ignored||this.actionBatcher.setState(t=>{t.messages.byID[e.id]=e,t.messages.allIDs.push(e.id)},"newMessage",150)}onAudioLevelUpdate(e){this.setState(t=>{let i={};for(let[s,r]of(e.forEach(e=>{if(!e.track||!e.peer)return;let s=e.track.trackId;i[s]=e.audioLevel,t.speakers[s]||(t.speakers[s]={audioLevel:e.audioLevel,peerID:e.peer.peerId,trackID:s})}),Object.entries(t.speakers)))r.audioLevel=i[s]||0,0===r.audioLevel&&delete t.speakers[s]},"audioLevel")}onConnectionQualityUpdate(e){this.setState(t=>{e.forEach(e=>{let i=e.peerID;i&&(t.connectionQualities[i]?Object.assign(t.connectionQualities[i],e):t.connectionQualities[i]=e)})},"connectionQuality")}onChangeTrackStateRequest(e){var t;let i=this.store.getState(n1(null==(t=e.requestedBy)?void 0:t.peerId)),s=this.getStoreLocalTrackIDfromSDKTrack(e.track),r=this.store.getState(n2(s));if(!r)return this.logPossibleInconsistency(`Not found track for which track state change was requested, ${e.track}`);e.enabled||this.syncRoomState("changeTrackStateRequest"),this.hmsNotifications.sendChangeTrackStateRequest({requestedBy:i||void 0,track:r,enabled:e.enabled})}onChangeMultiTrackStateRequest(e){var t;let i=this.store.getState(n1(null==(t=e.requestedBy)?void 0:t.peerId));e.enabled||this.syncRoomState("changeMultiTrackStateRequest");let s=[],r=this.store.getState(nd);for(let t of e.tracks){let e=this.getStoreLocalTrackIDfromSDKTrack(t);e&&r[e]&&s.push(r[e])}this.hmsNotifications.sendChangeMultiTrackStateRequest({requestedBy:i||void 0,tracks:s,enabled:e.enabled,type:e.type,source:e.source})}onReconnected(){this.syncRoomState("reconnectedSync"),this.hmsNotifications.sendReconnected(),this.setState(e=>{e.room.roomState=e.room.isConnected?"Connected":"Preview"},"reconnected")}onReconnecting(e){let t=ak.convertException(e);nq.e("Reconnection: received error from sdk",t),this.hmsNotifications.sendReconnecting(t),this.setState(e=>{e.room.roomState="Reconnecting",e.errors.push(t)},"reconnecting")}onError(e){let t=ak.convertException(e);t.isTerminal?(this.leave().then(()=>nq.e("error from SDK, left room.")),this.setState(e=>{e.room.roomState="Failed",e.errors.push(t)},"errorTerminal")):this.store.getState().errors.length<50&&this.setState(e=>{e.errors.push(t)},"error"),this.syncRoomState("errorSync"),this.hmsNotifications.sendError(t),nq.e("received error from sdk",t instanceof i$?`${t}`:t)}handleTrackRemove(e,t){this.setState(i=>{let s=i.peers[t.peerId],r=i.tracks,n=e.trackId;if(s)if(n===s.audioTrack)delete s.audioTrack;else if(n===s.videoTrack)delete s.videoTrack;else{let e=s.auxiliaryTracks.indexOf(n);e>-1&&s.auxiliaryTracks.splice(e,1)}delete r[n]},"trackRemoved")}setEnabledSDKTrack(e,t){return tP(this,null,function*(){let i=this.getLocalTrack(e);i?yield i.setEnabled(t):this.logPossibleInconsistency(`track ${e} not present, unable to enabled/disable`)})}setSDKLocalVideoTrackSettings(e,t){return tP(this,null,function*(){let i=this.getLocalTrack(e);i?yield i.setSettings(t):this.logPossibleInconsistency(`local track ${e} not present, unable to set settings`)})}setSDKLocalAudioTrackSettings(e,t){return tP(this,null,function*(){let i=this.getLocalTrack(e);i?yield i.setSettings(t):this.logPossibleInconsistency(`local track ${e} not present, unable to set settings`)})}getMediaSettings(e){var t;let i=this.store.getState(nc),s=e.audioTrack,r=e.videoTrack;return{audioInputDeviceId:(null==s?void 0:s.settings.deviceId)||i.audioInputDeviceId,videoInputDeviceId:(null==r?void 0:r.settings.deviceId)||i.videoInputDeviceId,audioOutputDeviceId:null==(t=this.sdk.getAudioOutput().getDevice())?void 0:t.deviceId,audioMode:(null==s?void 0:s.settings.audioMode)||"voice"}}getPreviewFields(e){var t,i;if(!e.isInPreview())return;let s=ak.convertPeer(e);return{localPeer:s.id,audioTrack:s.audioTrack,videoTrack:s.videoTrack,asRole:(null==(t=e.asRole)?void 0:t.name)||(null==(i=e.role)?void 0:i.name)}}setTrackVolume(e,t){return tP(this,null,function*(){let i=this.getTrackById(t);i?i instanceof sV?(yield i.setVolume(e),this.setState(i=>{let s=i.tracks[t];s&&"audio"===s.type&&(s.volume=e)},"trackVolume")):nq.w(`track ${t} is not an audio track`):this.logPossibleInconsistency(`track ${t} not present, unable to set volume`)})}localAndVideoUnmuting(e){let t=this.store.getState(nv);if((null==t?void 0:t.videoTrack)!==e)return!1;let i=this.store.getState(nT),s=this.store.getState(nb);return i&&!s}logPossibleInconsistency(e){nq.w("possible inconsistency detected - ",e)}addRemoveVideoPlugin(e,t,i){return tP(this,null,function*(){if(!e)return void nq.w("Invalid plugin received in store");let s=this.store.getState(nf);if(s){let r=this.getLocalTrack(s);r?("add"===t?yield r.addPlugin(e,i):"remove"===t&&(yield r.removePlugin(e)),this.syncRoomState(`${t}VideoPlugin`)):this.logPossibleInconsistency(`track ${s} not present, unable to ${t} plugin`)}})}addRemoveMediaStreamVideoPlugins(e,t){return tP(this,null,function*(){if(0===e.length)return void nq.w("Invalid plugin received in store");let i=this.store.getState(nf);if(i){let s=this.getLocalTrack(i);s?("add"===t?yield s.addStreamPlugins(e):"remove"===t&&(yield s.removeStreamPlugins(e)),this.syncRoomState(`${t}MediaStreamPlugin`)):this.logPossibleInconsistency(`track ${i} not present, unable to ${t} plugin`)}})}addRemoveAudioPlugin(e,t){return tP(this,null,function*(){try{if(!e)return void nq.w("Invalid plugin received in store");let i=this.store.getState(nm);if(i){let s=this.getLocalTrack(i);s?("add"===t?yield s.addPlugin(e):"remove"===t&&(yield s.removePlugin(e)),this.syncRoomState(`${t}AudioPlugin`)):this.logPossibleInconsistency(`track ${i} not present, unable to ${t} plugin`)}}catch(e){console.error(e)}})}onRoleChangeRequest(e){this.setState(t=>{0===t.roleChangeRequests.length&&t.roleChangeRequests.push(ak.convertRoleChangeRequest(e))},"roleChangeRequest")}removeRoleChangeRequest(e){this.setState(t=>{let i=t.roleChangeRequests.findIndex(t=>t.token===e.token);-1!==i&&t.roleChangeRequests.splice(i,1)},"removeRoleChangeRequest")}onRoleUpdate(){this.syncRoomState("roleUpdate")}getStoreLocalTrackIDfromSDKTrack(e){return this.store.getState(nk).find(t=>{var i;return(null==(i=this.getTrackById(t))?void 0:i.trackId)===e.trackId})}updateMidCallPreviewRoomState(e,t){t.isLocal&&8===e&&this.store.getState(nI)&&this.setState(e=>{e.room.roomState="Connected"},"midCallPreviewCompleted")}setSessionStoreValueLocally(e,t="setSessionStore"){let i=Array.isArray(e)?e:[e];this.setState(e=>{i.forEach(t=>{e.sessionStore[t.key]=t.value})},t)}hasActiveElements(e){let t=Object.keys(this.store.getState().whiteboards).length>0,i=Object.keys(this.store.getState().polls).length>0,s=Object.keys(this.store.getState().peers).length>0,r=e.getState().remoteTrackStats;return s&&(t||i||Object.values(r).some(e=>e&&"number"==typeof e.bitrate&&e.bitrate>0))}},ax=e=>t3?`${e} ${document.title}`:e,aU=class{constructor(e,t){this.eventBus=e,this.listener=t,this.TAG="[NetworkTestManager]",this.controller=new AbortController,this.start=e=>tP(this,null,function*(){var t;if(!e)return;let{url:i,timeout:s,scoreMap:r}=e,n=this.controller.signal,a=Date.now(),o=0,l=s6(s).then(()=>{this.controller.abort()});try{let e=null==(t=(yield fetch(`${i}?${Date.now()}`,{signal:n})).body)?void 0:t.getReader();if(!e)throw Error("unable to process request");let s=()=>tP(this,null,function*(){if(e)try{let t=!1;for(;!t;){let{value:i,done:s}=yield e.read();t=s,i&&(o+=i.byteLength,this.sendScore({scoreMap:r,downloadedSize:o,startTime:a}))}}catch(e){"AbortError"!==e.name&&tV.d(this.TAG,e)}});return Promise.race([s(),l]).then(()=>{this.sendScore({scoreMap:r,downloadedSize:o,startTime:a,finished:!0})}).catch(e=>{tV.d(this.TAG,e),this.updateScoreToListener(0),this.eventBus.analytics.publish(sj.previewNetworkQuality({error:e.message}))})}catch(e){"AbortError"!==e.name?(tV.d(this.TAG,e),this.updateScoreToListener(0),this.eventBus.analytics.publish(sj.previewNetworkQuality({error:e.message}))):tV.d(this.TAG,e)}}),this.stop=()=>{this.controller.signal.aborted||this.controller.abort()},this.sendScore=({scoreMap:e,downloadedSize:t,startTime:i,finished:s=!1})=>{let r=t/1024/((Date.now()-i)/1e3)*8,n=-1;for(let t in e){let i=e[t];r>=i.low&&(!i.high||r<=i.high)&&(n=Number(t))}this.updateScoreToListener(n),s&&this.eventBus.analytics.publish(sj.previewNetworkQuality({score:n,downLink:r.toFixed(2)}))}}updateScoreToListener(e){var t,i;e!==this.score&&(this.score=e,null==(i=null==(t=this.listener)?void 0:t.onNetworkQuality)||i.call(t,e))}},aB=class{constructor(e,t,i,s,r,n){this.store=e,this.transport=t,this.deviceManager=i,this.publish=s,this.removeAuxiliaryTrack=r,this.listener=n,this.handleLocalPeerRoleUpdate=e=>tP(this,[e],function*({oldRole:e,newRole:t}){var i;let s=this.store.getLocalPeer();s&&(yield this.diffRolesAndPublishTracks({oldRole:e,newRole:t}),null==(i=this.listener)||i.onPeerUpdate(8,s))}),this.diffRolesAndPublishTracks=e=>tP(this,[e],function*({oldRole:e,newRole:t}){var i,s,r,n,a,o;let l=new Set(e.publishParams.allowed),d=new Set(t.publishParams.allowed),c=this.removeTrack(l,d,"video"),u=this.removeTrack(l,d,"audio"),h=this.removeTrack(l,d,"screen"),p=this.hasSimulcastDifference(null==(i=e.publishParams.simulcast)?void 0:i.video,null==(s=t.publishParams.simulcast)?void 0:s.video),v=this.hasSimulcastDifference(null==(r=e.publishParams.simulcast)?void 0:r.screen,null==(n=t.publishParams.simulcast)?void 0:n.screen),g=null==(o=null==(a=this.store.getLocalPeer())?void 0:a.videoTrack)?void 0:o.enabled;yield this.removeAudioTrack(u),yield this.removeVideoTracks(c||p),yield this.removeScreenTracks(h||v);let m=this.getSettings();p&&(m.isVideoMuted=!g),yield this.publish(m),yield this.syncDevices(m,t)})}syncDevices(e,t){return tP(this,null,function*(){e.isAudioMuted&&e.isVideoMuted||!(t.publishParams.allowed.length>0)||(yield this.deviceManager.init(!0))})}removeVideoTracks(e){return tP(this,null,function*(){var t;if(!e)return;let i=this.store.getLocalPeer();null!=i&&i.videoTrack&&(i.videoTrack.isPublished?yield this.transport.unpublish([i.videoTrack]):yield i.videoTrack.cleanup(),null==(t=this.listener)||t.onTrackUpdate(1,i.videoTrack,i),i.videoTrack=void 0),yield this.removeAuxTracks(e=>"screen"!==e.source&&"video"===e.type)})}removeAudioTrack(e){return tP(this,null,function*(){var t;if(!e)return;let i=this.store.getLocalPeer();null!=i&&i.audioTrack&&(i.audioTrack.isPublished?yield this.transport.unpublish([i.audioTrack]):yield i.audioTrack.cleanup(),null==(t=this.listener)||t.onTrackUpdate(1,i.audioTrack,i),i.audioTrack=void 0),yield this.removeAuxTracks(e=>"screen"!==e.source&&"audio"===e.type)})}removeScreenTracks(e){return tP(this,null,function*(){e&&(yield this.removeAuxTracks(e=>"screen"===e.source))})}removeAuxTracks(e){return tP(this,null,function*(){let t=this.store.getLocalPeer();if(null!=t&&t.auxiliaryTracks)for(let i of[...t.auxiliaryTracks])e(i)&&(yield this.removeAuxiliaryTrack(i.trackId))})}removeTrack(e,t,i){return e.has(i)&&!t.has(i)}hasSimulcastDifference(e,t){var i,s,r;return(!!e||!!t)&&((null==(i=null==e?void 0:e.layers)?void 0:i.length)!==(null==(s=null==t?void 0:t.layers)?void 0:s.length)||!!(null!=(r=null==e?void 0:e.layers)&&r.some(e=>{var i;let s=null==(i=null==t?void 0:t.layers)?void 0:i.find(t=>t.rid===e.rid);return(null==s?void 0:s.maxBitrate)!==e.maxBitrate||(null==s?void 0:s.maxFramerate)!==e.maxFramerate})))}getSettings(){let{isAudioMuted:e,isVideoMuted:t}=this.getMutedStatus(),{audioInputDeviceId:i,audioOutputDeviceId:s}=this.getAudioDeviceSettings();return{isAudioMuted:e,isVideoMuted:t,audioInputDeviceId:i,audioOutputDeviceId:s,videoDeviceId:this.getVideoInputDeviceId()}}getMutedStatus(){var e,t,i;let s=null==(e=this.store.getConfig())?void 0:e.settings;return{isAudioMuted:null==(t=null==s?void 0:s.isAudioMuted)||t,isVideoMuted:null==(i=null==s?void 0:s.isVideoMuted)||i}}getAudioDeviceSettings(){var e,t,i;let s=null==(e=this.store.getConfig())?void 0:e.settings;return{audioInputDeviceId:(null==(t=this.deviceManager.currentSelection.audioInput)?void 0:t.deviceId)||(null==s?void 0:s.audioInputDeviceId)||"default",audioOutputDeviceId:(null==(i=this.deviceManager.currentSelection.audioOutput)?void 0:i.deviceId)||(null==s?void 0:s.audioOutputDeviceId)||"default"}}getVideoInputDeviceId(){var e,t;let i=null==(e=this.store.getConfig())?void 0:e.settings;return(null==(t=this.deviceManager.currentSelection.videoInput)?void 0:t.deviceId)||(null==i?void 0:i.videoDeviceId)||"default"}},aF=new class{constructor(){this.TAG="[HTTPAnalyticsTransport]",this.failedEvents=new sR("client-events"),this.isConnected=!0,this.env=null,this.websocketURL=""}setEnv(e){this.env=e,this.flushFailedEvents()}setWebsocketEndpoint(e){this.websocketURL=e}sendEvent(e){if(!this.env)return void this.addEventToStorage(e);let t={event:e.name,payload:e.properties,event_id:String(e.timestamp),peer:e.metadata.peer,timestamp:e.timestamp,device_id:e.device_id,cluster:{websocket_url:this.websocketURL}};fetch("prod"===this.env?"https://event.100ms.live/v2/client/report":"https://event-nonprod.100ms.live/v2/client/report",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.metadata.token}`,user_agent_v2:e.metadata.userAgent},body:JSON.stringify(t)}).then(t=>{if(401===t.status)return void this.removeFromStorage(e);if(200!==t.status)throw Error(t.statusText);this.removeFromStorage(e)}).catch(t=>{tV.v(this.TAG,"Failed to send event",t,e),this.addEventToStorage(e)})}flushFailedEvents(){let e=this.failedEvents.get();null==e||e.forEach(e=>this.sendEvent(e))}addEventToStorage(e){let t=this.failedEvents.get()||[];t.find(t=>t.timestamp===e.timestamp)||(100===t.length&&t.shift(),t.push(e),this.failedEvents.set(t))}removeFromStorage(e){let t=this.failedEvents.get()||[],i=t.findIndex(t=>t.timestamp===e.timestamp);i>-1&&(t.splice(i,1),this.failedEvents.set(t))}},aj=class{constructor(e){this.type=e.type,this.source=e.source||"regular",this.description="",e instanceof sG?(this.mute=!e.enabled,this.track_id=e.publishedTrackId,this.stream_id=e.stream.id):(this.mute=e.mute,this.track_id=e.track_id,this.stream_id=e.stream_id)}},a$=class{constructor(){this.TAG="[Store]:",this.knownRoles={},this.peers={},this.tracks=new Map,this.peerTrackStates={},this.speakers=[],this.roleDetailsArrived=!1,this.env="prod",this.simulcastEnabled=!1,this.userAgent=sx(this.env),this.polls=new Map,this.whiteboards=new Map,this.addPermissionToRole=(e,t,i,s)=>{var r;if(!this.knownRoles[e])return void tV.d(this.TAG,`role ${e} is not present in given roles`,this.knownRoles);let n=this.knownRoles[e].permissions;"transcriptions"===t&&s?n[t]=tT(tb({},n[t]),{[s]:[i]}):"whiteboard"===t&&(n[t]||(n[t]=[]),null==(r=n[t])||r.push(i))},this.addWhiteboardPluginToRole=e=>{var t,i,s;let r=null==e?void 0:e.permissions;null==(t=null==r?void 0:r.admin)||t.forEach(e=>this.addPermissionToRole(e,"whiteboard","admin")),null==(i=null==r?void 0:r.reader)||i.forEach(e=>this.addPermissionToRole(e,"whiteboard","read")),null==(s=null==r?void 0:r.writer)||s.forEach(e=>this.addPermissionToRole(e,"whiteboard","write"))},this.addTranscriptionsPluginToRole=(e=[])=>{var t,i;for(let s of e)null==(i=null==(t=s.permissions)?void 0:t.admin)||i.forEach(e=>this.addPermissionToRole(e,"transcriptions","admin",s.mode))},this.handleNoiseCancellationPlugin=e=>{this.room&&(this.room.isNoiseCancellationEnabled=!!(null!=e&&e.enabled)&&!!this.room.isNoiseCancellationEnabled)}}getConfig(){return this.config}setSimulcastEnabled(e){this.simulcastEnabled=e}removeRemoteTracks(){this.tracks.forEach(e=>{(e instanceof rf||e instanceof rG)&&(this.removeTrack(e),delete this.peerTrackStates[e.trackId])})}getEnv(){return this.env}getPublishParams(){let e=this.getLocalPeer(),t=(null==e?void 0:e.asRole)||(null==e?void 0:e.role);return null==t?void 0:t.publishParams}getRoom(){return this.room}getPolicyForRole(e){return this.knownRoles[e]}getKnownRoles(){return this.knownRoles}getTemplateAppData(){return this.templateAppData}getLocalPeer(){if(this.localPeerId&&this.peers[this.localPeerId])return this.peers[this.localPeerId]}getRemotePeers(){return Object.values(this.peers).filter(e=>!e.isLocal)}getPeers(){return Object.values(this.peers)}getPeerMap(){return this.peers}getPeerById(e){if(this.peers[e])return this.peers[e]}getTracksMap(){return this.tracks}getTracks(){return Array.from(this.tracks.values())}getVideoTracks(){return this.getTracks().filter(e=>"video"===e.type)}getRemoteVideoTracks(){return this.getTracks().filter(e=>e instanceof rG)}getAudioTracks(){return this.getTracks().filter(e=>"audio"===e.type)}getPeerTracks(e){let t=e?this.peers[e]:void 0,i=[];return null!=t&&t.videoTrack&&i.push(t.videoTrack),null!=t&&t.audioTrack&&i.push(t.audioTrack),i.concat((null==t?void 0:t.auxiliaryTracks)||[])}getLocalPeerTracks(){return this.getPeerTracks(this.localPeerId)}hasTrack(e){return this.tracks.has(e)}getTrackById(e){var t,i;let s=Array.from(this.tracks.values()).find(t=>t.trackId===e);if(s)return s;let r=this.getLocalPeer();if(r){if(null!=(t=r.audioTrack)&&t.isPublishedTrackId(e))return r.audioTrack;if(null!=(i=r.videoTrack)&&i.isPublishedTrackId(e))return r.videoTrack}}getPeerByTrackId(e){let t=Array.from(this.tracks.values()).find(t=>t.trackId===e);return null!=t&&t.peerId?this.peers[t.peerId]:void 0}getSpeakers(){return this.speakers}getSpeakerPeers(){return this.speakers.map(e=>e.peer)}getUserAgent(){return this.userAgent}createAndSetUserAgent(e){this.userAgent=sx(this.env,e)}setRoom(e){this.room=e}setKnownRoles(e){var t,i;if(this.knownRoles=e.known_roles,this.addPluginsToRoles(e.plugins),this.roleDetailsArrived=!0,this.templateAppData=e.app_data,!this.simulcastEnabled)return;let s=null==(t=this.knownRoles[e.name])?void 0:t.publishParams;this.videoLayers=this.convertSimulcastLayers(null==(i=s.simulcast)?void 0:i.video),this.updatePeersPolicy()}hasRoleDetailsArrived(){return this.roleDetailsArrived}setConfig(e){var t,i,s;if(sq.rememberDevices(!!e.rememberDeviceSelection),e.rememberDeviceSelection){let r=sq.getSelection();r&&(e.settings||(e.settings={}),null!=(t=r.audioInput)&&t.deviceId&&(e.settings.audioInputDeviceId=e.settings.audioInputDeviceId||r.audioInput.deviceId),null!=(i=r.audioOutput)&&i.deviceId&&(e.settings.audioOutputDeviceId=e.settings.audioOutputDeviceId||r.audioOutput.deviceId),null!=(s=r.videoInput)&&s.deviceId&&(e.settings.videoDeviceId=e.settings.videoDeviceId||r.videoInput.deviceId))}e.autoManageVideo=!1!==e.autoManageVideo,e.autoManageWakeLock=!1!==e.autoManageWakeLock,this.config=e,this.setEnv()}addPeer(e){this.peers[e.peerId]=e,e.isLocal&&(this.localPeerId=e.peerId)}addTrack(e){this.tracks.set(e,e)}getTrackState(e){return this.peerTrackStates[e]}setTrackState(e){this.peerTrackStates[e.trackInfo.track_id]=e}removeTrackState(e){delete this.peerTrackStates[e]}removePeer(e){this.localPeerId===e&&(this.localPeerId=void 0),delete this.peers[e]}removeTrack(e){this.tracks.delete(e)}updateSpeakers(e){this.speakers=e}updateAudioOutputVolume(e){return tP(this,null,function*(){for(let t of this.getAudioTracks())yield t.setVolume(e)})}updateAudioOutputDevice(e){return tP(this,null,function*(){let t=[];this.getAudioTracks().forEach(i=>{i instanceof rf&&t.push(i.setOutputDevice(e))}),yield Promise.all(t)})}getSimulcastLayers(e){var t;return this.simulcastEnabled&&["screen","regular"].includes(e)?"screen"===e?[]:(null==(t=this.videoLayers)?void 0:t.layers)||[]:[]}convertSimulcastLayers(e){if(e)return tT(tb({},e),{layers:(e.layers||[]).map(e=>tT(tb({},e),{maxBitrate:1e3*e.maxBitrate}))})}getSimulcastDefinitionsForPeer(e,t){var i,s,r;if([!e||!e.role,"screen"===t,!this.simulcastEnabled].some(e=>!!e))return[];let n=this.getPolicyForRole(e.role.name).publishParams,a,o,l;return"regular"===t?(a=null==(i=n.simulcast)?void 0:i.video,o=n.video.width,l=n.video.height):"screen"===t&&(a=null==(s=n.simulcast)?void 0:s.screen,o=n.screen.width,l=n.screen.height),(null==(r=null==a?void 0:a.layers)?void 0:r.map(e=>({layer:ra[e.rid],resolution:{width:Math.floor(o/e.scaleResolutionDownBy),height:Math.floor(l/e.scaleResolutionDownBy)}})))||[]}setPoll(e){this.polls.set(e.id,e)}getPoll(e){return this.polls.get(e)}setWhiteboard(e){this.whiteboards.set(e.id,e)}getWhiteboards(){return this.whiteboards}getWhiteboard(e){return e?this.whiteboards.get(e):this.whiteboards.values().next().value}getErrorListener(){return this.errorListener}cleanup(){for(let e of this.getTracks())e.cleanup();this.room=void 0,this.config=void 0,this.localPeerId=void 0,this.roleDetailsArrived=!1}setErrorListener(e){this.errorListener=e}updatePeersPolicy(){this.getPeers().forEach(e=>{var t;if(!e.role){null==(t=this.errorListener)||t.onError(sf("VALIDATION",""));return}e.role=this.getPolicyForRole(e.role.name)})}addPluginsToRoles(e){e&&Object.keys(e).forEach(t=>{switch(t){case"whiteboard":this.addWhiteboardPluginToRole(e[t]);break;case"transcriptions":this.addTranscriptionsPluginToRole(e[t]);break;case"noiseCancellation":this.handleNoiseCancellationPlugin(e[t])}})}setEnv(){var e;let t=(null==(e=this.config)?void 0:e.initEndpoint).split("https://")[1],i="prod";t.startsWith("prod")?i="prod":t.startsWith("qa")?i="qa":t.startsWith("dev")&&(i="dev"),this.env=i,aF.setEnv(i)}},aG=class{constructor(){this.TAG="[WakeLockManager]",this.wakeLock=null,this.acquireLock=()=>tP(this,null,function*(){yield this.requestWakeLock(),null==document||document.addEventListener("visibilitychange",this.visibilityHandler)}),this.cleanup=()=>tP(this,null,function*(){if(this.wakeLock&&!this.wakeLock.released)try{yield this.wakeLock.release(),tV.d(this.TAG,"Wake lock released")}catch(e){tV.w(this.TAG,"Error while releasing wake lock",`name=${e.name}, message=${e.message}`)}null==document||document.removeEventListener("visibilitychange",this.visibilityHandler),this.wakeLock=null}),this.visibilityHandler=()=>tP(this,null,function*(){(null==document?void 0:document.visibilityState)==="visible"&&(!this.wakeLock||this.wakeLock.released)&&(tV.d(this.TAG,"Re-acquiring wake lock due to visibility change"),yield this.requestWakeLock())}),this.requestWakeLock=()=>tP(this,null,function*(){try{if(!("wakeLock"in navigator))return void tV.d(this.TAG,"Wake lock feature not supported");this.wakeLock=yield navigator.wakeLock.request("screen"),tV.d(this.TAG,"Wake lock acquired")}catch(e){tV.w(this.TAG,"Error acquiring wake lock",`name=${e.name}, message=${e.message}`)}})}},aV=class{constructor(e){this.store=e,this.bufferSize=100,this.TAG="[AnalyticsEventsService]",this.transport=null,this.pendingEvents=[],this.level=1}setTransport(e){this.transport=e}reset(){this.transport=null,this.pendingEvents=[]}queue(e){if(e.level>=this.level&&(this.pendingEvents.push(e),this.pendingEvents.length>this.bufferSize)){let e=this.pendingEvents.shift();tV.d(this.TAG,"Max buffer size reached","Removed event to accommodate new events",e)}return this}flushFailedClientEvents(){aF.flushFailedEvents()}flush(){var e;try{for(;this.pendingEvents.length>0;){let t=this.pendingEvents.shift();t&&(t.metadata.peer.peer_id=null==(e=this.store.getLocalPeer())?void 0:e.peerId,t.metadata.userAgent=this.store.getUserAgent(),this.transport&&this.transport.transportProvider.isConnected?this.transport.sendEvent(t):this.sendClientEventOnHTTP(t))}}catch(e){tV.w(this.TAG,"Flush Failed",e)}}sendClientEventOnHTTP(e){var t,i,s,r;let n=this.store.getRoom(),a=this.store.getLocalPeer();e.metadata.token=null==(t=this.store.getConfig())?void 0:t.authToken,e.metadata.peer={session_id:null==n?void 0:n.sessionId,room_id:null==n?void 0:n.id,room_name:null==n?void 0:n.name,template_id:null==n?void 0:n.templateId,joined_at:null==(i=null==n?void 0:n.joinedAt)?void 0:i.getTime(),session_started_at:null==(s=null==n?void 0:n.startedAt)?void 0:s.getTime(),role:null==(r=null==a?void 0:a.role)?void 0:r.name,user_name:null==a?void 0:a.name,user_data:null==a?void 0:a.metadata,peer_id:null==a?void 0:a.peerId},aF.sendEvent(e)}},aq={autoplayFailed:void 0,initialized:!1,autoplayCheckPromise:void 0},aH=class{constructor(e,t,i){this.store=e,this.deviceManager=t,this.eventBus=i,this.autoPausedTracks=new Set,this.TAG="[AudioSinkManager]:",this.volume=100,this.state=tb({},aq),this.handleAudioPaused=e=>tP(this,null,function*(){tV.d(this.TAG,"Audio Paused",e.target.id);let t=this.store.getTrackById(e.target.id);t&&this.autoPausedTracks.add(t)}),this.handleTrackUpdate=({track:e})=>{tV.d(this.TAG,"Track updated",`${e}`)},this.handleTrackAdd=e=>tP(this,[e],function*({track:e,peer:t,callListener:i=!0}){var s,r;let n=document.createElement("audio");n.style.display="none",n.id=e.trackId,n.addEventListener("pause",this.handleAudioPaused),n.onerror=()=>tP(this,null,function*(){var i,s;tV.e(this.TAG,"error on audio element",n.error);let r=se(`Audio playback error for track - ${e.trackId} code - ${null==(i=null==n?void 0:n.error)?void 0:i.code}`);this.eventBus.analytics.publish(sj.audioPlaybackError(r)),(null==(s=null==n?void 0:n.error)?void 0:s.code)===MediaError.MEDIA_ERR_DECODE&&(this.removeAudioElement(n,e),yield s6(500),yield this.handleTrackAdd({track:e,peer:t,callListener:!1}),this.state.autoplayFailed||this.eventBus.analytics.publish(sj.audioRecovered("Audio recovered after media decode error")))}),e.setAudioElement(n),yield e.setVolume(this.volume),tV.d(this.TAG,"Audio track added",`${e}`),this.init(),null==(s=this.audioSink)||s.append(n),this.outputDevice&&(yield e.setOutputDevice(this.outputDevice)),n.srcObject=new MediaStream([e.nativeTrack]),i&&(null==(r=this.listener)||r.onTrackUpdate(0,e,t)),yield this.handleAutoplayError(e)}),this.handleAutoplayError=e=>tP(this,null,function*(){if(void 0===this.state.autoplayFailed&&(this.state.autoplayCheckPromise||(this.state.autoplayCheckPromise=new Promise(t=>{this.playAudioFor(e).then(t)})),yield this.state.autoplayCheckPromise),this.state.autoplayFailed)return void this.autoPausedTracks.add(e);yield this.playAudioFor(e)}),this.handleAudioDeviceChange=e=>tP(this,null,function*(){e.isUserSelection||e.error||!e.selection||"video"===e.type||(yield this.unpauseAudioTracks())}),this.handleTrackRemove=e=>{this.autoPausedTracks.delete(e);let t=document.getElementById(e.trackId);t&&this.removeAudioElement(t,e),this.audioSink&&0===this.audioSink.childElementCount&&(this.state.autoplayCheckPromise=void 0,this.state.autoplayFailed=void 0),tV.d(this.TAG,"Audio track removed",`${e}`)},this.unpauseAudioTracks=()=>tP(this,null,function*(){let e=[];this.autoPausedTracks.forEach(t=>{e.push(this.playAudioFor(t))}),yield Promise.all(e)}),this.removeAudioElement=(e,t)=>{e&&(tV.d(this.TAG,"removing audio element",`${t}`),e.removeEventListener("pause",this.handleAudioPaused),e.srcObject=null,e.remove(),t.setAudioElement(null))},this.eventBus.audioTrackAdded.subscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.subscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.subscribe(this.handleTrackUpdate),this.eventBus.deviceChange.subscribe(this.handleAudioDeviceChange),this.eventBus.localVideoUnmutedNatively.subscribe(this.unpauseAudioTracks),this.eventBus.localAudioUnmutedNatively.subscribe(this.unpauseAudioTracks)}setListener(e){this.listener=e}get outputDevice(){return this.deviceManager.outputDevice}getVolume(){return this.volume}setVolume(e){return tP(this,null,function*(){yield this.store.updateAudioOutputVolume(e),this.volume=e})}unblockAutoplay(){return tP(this,null,function*(){this.autoPausedTracks.size>0&&(yield this.unpauseAudioTracks()),yield s1.resumeContext()})}init(e){if(this.state.initialized||this.audioSink)return;this.state.initialized=!0;let t=document.createElement("div");t.id=`HMS-SDK-audio-sink-${V()}`,(e&&document.getElementById(e)||document.body).append(t),this.audioSink=t,tV.d(this.TAG,"audio sink created",this.audioSink)}cleanup(){var e;null==(e=this.audioSink)||e.remove(),this.audioSink=void 0,this.eventBus.audioTrackAdded.unsubscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.unsubscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.unsubscribe(this.handleTrackUpdate),this.eventBus.deviceChange.unsubscribe(this.handleAudioDeviceChange),this.eventBus.localVideoUnmutedNatively.unsubscribe(this.unpauseAudioTracks),this.eventBus.localAudioUnmutedNatively.unsubscribe(this.unpauseAudioTracks),this.autoPausedTracks=new Set,this.state=tb({},aq)}playAudioFor(e){return tP(this,null,function*(){let t=e.getAudioElement();if(!t)return void tV.w(this.TAG,"No audio element found on track",e.trackId);try{yield t.play(),this.state.autoplayFailed=!1,this.autoPausedTracks.delete(e),tV.d(this.TAG,"Played track",`${e}`)}catch(t){if(this.autoPausedTracks.add(e),tV.w(this.TAG,"Failed to play track",`${e}`,t),!this.state.autoplayFailed&&"NotAllowedError"===t.name){this.state.autoplayFailed=!0;let e=i4("AUTOPLAY","");e.addNativeError(t),this.eventBus.analytics.publish(sj.autoplayError()),this.eventBus.autoplayError.publish(e)}}})}},aW=class{constructor(e){this.eventBus=e,this.pluginUsage=new Map,this.pluginLastAddedAt=new Map,this.getPluginUsage=e=>{if(this.pluginUsage.has(e)||this.pluginUsage.set(e,0),this.pluginLastAddedAt.has(e)){let t=this.pluginLastAddedAt.get(e)||0,i=t?Date.now()-t:0;this.pluginUsage.set(e,(this.pluginUsage.get(e)||0)+i),this.pluginLastAddedAt.delete(e)}return this.pluginUsage.get(e)},this.updatePluginUsageData=e=>{var t;let i=(null==(t=e.properties)?void 0:t.plugin_name)||"";switch(e.name){case"mediaPlugin.toggled.on":case"mediaPlugin.added":{let t=e.properties.added_at||Date.now();this.pluginLastAddedAt.set(i,t);break}case"mediaPlugin.toggled.off":case"mediaPlugin.stats":if(this.pluginLastAddedAt.has(i)){let t=e.properties.duration||(Date.now()-(this.pluginLastAddedAt.get(i)||0))/1e3;this.pluginUsage.set(i,(this.pluginUsage.get(i)||0)+1e3*Math.max(t,0)),this.pluginLastAddedAt.delete(i)}}},this.cleanup=()=>{this.pluginLastAddedAt.clear(),this.pluginUsage.clear()},this.eventBus.analytics.subscribe(e=>this.updatePluginUsageData(e))}},az=class{constructor(e,t){this.store=e,this.eventBus=t,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.hasWebcamPermission=!1,this.hasMicrophonePermission=!1,this.currentSelection={audioInput:void 0,videoInput:void 0,audioOutput:void 0},this.TAG="[Device Manager]:",this.initialized=!1,this.videoInputChanged=!1,this.audioInputChanged=!1,this.earpieceSelected=!1,this.timer=null,this.updateOutputDevice=(e,t)=>tP(this,null,function*(){let i=this.audioOutput.find(t=>t.deviceId===e);return i&&(this.outputDevice=i,yield this.store.updateAudioOutputDevice(i),this.eventBus.analytics.publish(sj.deviceChange({isUserSelection:t,selection:{audioOutput:i},devices:this.getDevices(),type:"audioOutput"})),sq.updateSelection("audioOutput",{deviceId:i.deviceId,groupId:i.groupId})),i}),this.getCurrentSelection=()=>{var e,t;let i=this.store.getLocalPeer(),s=this.createIdentifier(null==(e=null==i?void 0:i.audioTrack)?void 0:e.getMediaTrackSettings()),r=this.createIdentifier(null==(t=null==i?void 0:i.videoTrack)?void 0:t.getMediaTrackSettings());return{audioInput:this.audioInput.find(e=>this.createIdentifier(e)===s),videoInput:this.videoInput.find(e=>this.createIdentifier(e)===r),audioOutput:this.outputDevice}},this.computeChange=(e,t)=>e.length!==t.length||t.some(t=>!e.includes(this.createIdentifier(t))),this.enumerateDevices=()=>tP(this,null,function*(){try{let e=yield navigator.mediaDevices.enumerateDevices(),t=this.videoInput.map(this.createIdentifier),i=this.audioInput.map(this.createIdentifier);this.audioInput=[],this.audioOutput=[],this.videoInput=[],e.forEach(e=>{"audioinput"===e.kind&&e.label?(this.hasMicrophonePermission=!0,this.audioInput.push(e)):"audiooutput"===e.kind?this.audioOutput.push(e):"videoinput"===e.kind&&e.label&&(this.hasWebcamPermission=!0,this.videoInput.push(e))}),this.videoInputChanged=this.computeChange(t,this.videoInput),this.audioInputChanged=this.computeChange(i,this.audioInput),sq.setDevices({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput]}),this.logDevices("Enumerate Devices")}catch(e){tV.e(this.TAG,"Failed enumerating devices",e)}}),this.updateToActualDefaultDevice=()=>tP(this,null,function*(){var e,t,i,s,r;let n=this.store.getLocalPeer();if((null==(t=null==(e=this.store.getConfig())?void 0:e.settings)?void 0:t.videoDeviceId)||null==n||!n.videoTrack||(yield n.videoTrack.setSettings({deviceId:null==(i=this.videoInput[0])?void 0:i.deviceId},!0)),!(null==(r=null==(s=this.store.getConfig())?void 0:s.settings)?void 0:r.audioInputDeviceId)&&null!=n&&n.audioTrack){let e=()=>{var e,t;let i=this.audioInput.find(e=>!e.label.toLowerCase().includes("iphone"));return(null==(t=t2.getOS().name)?void 0:t.toLowerCase())==="ios"&&i?null==i?void 0:i.deviceId:null==(e=this.getNewAudioInputDevice())?void 0:e.deviceId};e()&&(yield n.audioTrack.setSettings({deviceId:e()},!0))}}),this.handleDeviceChange=s8(()=>tP(this,null,function*(){yield this.enumerateDevices(),this.logDevices("After Device Change");let e=this.store.getLocalPeer();yield this.setOutputDevice(!0),yield this.handleAudioInputDeviceChange(null==e?void 0:e.audioTrack),yield this.handleVideoInputDeviceChange(null==e?void 0:e.videoTrack),this.eventBus.analytics.publish(sj.deviceChange({selection:this.getCurrentSelection(),type:"change",devices:this.getDevices()}))}),500).bind(this),this.handleAudioInputDeviceChange=e=>tP(this,null,function*(){if(!e)return void tV.d(this.TAG,"No Audio track on local peer");if(!this.audioInputChanged)return void tV.d(this.TAG,"No Change in AudioInput Device");let t=this.getNewAudioInputDevice();if(!t||!t.deviceId){this.eventBus.analytics.publish(sj.deviceChange({selection:{audioInput:t},error:st("audio"),devices:this.getDevices(),type:"audioInput"})),tV.e(this.TAG,"Audio device not found");return}let{settings:i}=e,s=new rd().codec(i.codec).maxBitrate(i.maxBitrate).deviceId(t.deviceId).audioMode(i.audioMode).build();try{yield e.setSettings(s,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"audioInput"}),this.logDevices("Audio Device Change Success")}catch(e){tV.e(this.TAG,"[Audio Device Change]",e),this.eventBus.analytics.publish(sj.deviceChange({selection:{audioInput:t},devices:this.getDevices(),type:"audioInput",error:e})),this.eventBus.deviceChange.publish({error:e,selection:t,type:"audioInput",devices:this.getDevices()})}}),this.handleVideoInputDeviceChange=e=>tP(this,null,function*(){if(!e)return void tV.d(this.TAG,"No video track on local peer");if(!this.videoInputChanged)return void tV.d(this.TAG,"No Change in VideoInput Device");let t=this.videoInput[0];if(!t||!t.deviceId){this.eventBus.analytics.publish(sj.deviceChange({selection:{videoInput:t},error:st("video"),devices:this.getDevices(),type:"video"})),tV.e(this.TAG,"Video device not found");return}let{settings:i}=e,s=new ru().codec(i.codec).maxBitrate(i.maxBitrate).maxFramerate(i.maxFramerate).setWidth(i.width).setHeight(i.height).deviceId(t.deviceId).build();try{yield e.setSettings(s,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"video"}),this.logDevices("Video Device Change Success")}catch(e){tV.e(this.TAG,"[Video Device Change]",e),this.eventBus.analytics.publish(sj.deviceChange({selection:{videoInput:t},devices:this.getDevices(),type:"video",error:e})),this.eventBus.deviceChange.publish({error:e,type:"video",selection:t,devices:this.getDevices()})}}),this.startPollingForDevices=()=>tP(this,null,function*(){let{earpiece:e}=this.categorizeAudioInputDevices();e&&(this.timer=setTimeout(()=>{tP(this,null,function*(){yield this.enumerateDevices(),yield this.autoSelectAudioOutput(),this.startPollingForDevices()})},5e3))}),this.autoSelectAudioOutput=e=>tP(this,null,function*(){var t,i;let{bluetoothDevice:s,earpiece:r,speakerPhone:n,wired:a}=this.categorizeAudioInputDevices(),o=null==(t=this.store.getLocalPeer())?void 0:t.audioTrack;if(!o||!r)return;let l=this.getManuallySelectedAudioDevice(),d=(null==l?void 0:l.deviceId)||(null==s?void 0:s.deviceId)||(null==a?void 0:a.deviceId)||(null==n?void 0:n.deviceId);if(!(!e&&o.settings.deviceId===d&&this.earpieceSelected))try{(!this.earpieceSelected||e)&&((null==s?void 0:s.deviceId)===d||(tV.d(this.TAG,"selecting earpiece"),yield o.setSettings({deviceId:null==r?void 0:r.deviceId},!0),e&&(yield s6(e))),this.earpieceSelected=!0),yield o.setSettings({deviceId:d},!0);let t=null==(i=this.audioInput.find(e=>e.deviceId===d))?void 0:i.groupId;this.eventBus.deviceChange.publish({isUserSelection:!1,type:"audioInput",selection:{deviceId:d,groupId:t},devices:this.getDevices(),internal:!0})}catch(e){this.eventBus.error.publish(e)}});let i=({enabled:e,track:t})=>e&&"regular"===t.source;this.eventBus.localVideoEnabled.waitFor(i).then(()=>{0===this.videoInput.length&&this.init(!0)}),this.eventBus.localAudioEnabled.waitFor(i).then(()=>{0===this.audioInput.length&&this.init(!0)}),this.eventBus.deviceChange.subscribe(({type:e,isUserSelection:t,selection:i})=>{if(t){let s="video"===e?"videoInput":e,r=this[s].find(e=>this.createIdentifier(e)===this.createIdentifier(i));this.eventBus.analytics.publish(sj.deviceChange({selection:{[s]:r},devices:this.getDevices(),type:e,isUserSelection:t}))}})}init(e=!1,t=!0){return tP(this,null,function*(){this.initialized&&!e||(this.initialized||navigator.mediaDevices.addEventListener("devicechange",this.handleDeviceChange),this.initialized=!0,yield this.enumerateDevices(),e||(yield this.updateToActualDefaultDevice(),this.startPollingForDevices()),yield this.autoSelectAudioOutput(),this.logDevices("Init"),yield this.setOutputDevice(),this.eventBus.deviceChange.publish({devices:this.getDevices()}),t&&this.eventBus.analytics.publish(sj.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})))})}getDevices(){return{audioInput:this.audioInput,audioOutput:this.audioOutput,videoInput:this.videoInput}}cleanup(){this.timer&&(clearTimeout(this.timer),this.timer=null),this.initialized=!1,this.earpieceSelected=!1,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.outputDevice=void 0,navigator.mediaDevices.removeEventListener("devicechange",this.handleDeviceChange)}createIdentifier(e){return e?`${e.deviceId}${e.groupId}`:""}getNewAudioInputDevice(){var e,t;let i=this.getManuallySelectedAudioDevice();if(i)return i;null==(t=null==(e=this.store.getLocalPeer())?void 0:e.audioTrack)||t.resetManuallySelectedDeviceId();let s=this.audioInput.find(e=>"default"===e.deviceId);return s?this.audioInput.find(e=>"default"!==e.deviceId&&s.label.includes(e.label)):this.audioInput[0]}setOutputDevice(e=!1){return tP(this,null,function*(){let t=this.getNewAudioInputDevice(),i=this.createIdentifier(this.outputDevice);this.outputDevice=this.getAudioOutputDeviceMatchingInput(t),this.outputDevice||(this.outputDevice=this.audioOutput.find(e=>this.createIdentifier(e)===i),this.outputDevice||(this.outputDevice=this.audioOutput.find(e=>"default"===e.deviceId)||this.audioOutput[0])),yield this.store.updateAudioOutputDevice(this.outputDevice),e&&i!==this.createIdentifier(this.outputDevice)&&(this.eventBus.analytics.publish(sj.deviceChange({selection:{audioOutput:this.outputDevice},devices:this.getDevices(),type:"audioOutput"})),this.eventBus.deviceChange.publish({selection:this.outputDevice,type:"audioOutput",devices:this.getDevices()}))})}getManuallySelectedAudioDevice(){let e=this.store.getLocalPeer(),t=null==e?void 0:e.audioTrack;return this.audioInput.find(e=>e.deviceId===(null==t?void 0:t.getManuallySelectedDeviceId()))}categorizeAudioInputDevices(){let e=null,t=null,i=null,s=null;for(let r of this.audioInput){let n=s3(r.label);"SPEAKERPHONE"===n?t=r:"WIRED"===n?i=r:"BLUETOOTH"===n?e=r:"EARPIECE"===n&&(s=r)}return{bluetoothDevice:e,speakerPhone:t,wired:i,earpiece:s}}getAudioOutputDeviceMatchingInput(e){var t,i;let s=(null==(i=null==(t=this.store.getConfig())?void 0:t.settings)?void 0:i.speakerAutoSelectionBlacklist)||[];if("all"===s||!e)return;let r=e.label.toLowerCase()||"";if(s.some(e=>r.includes(e.toLowerCase())))return;let n=this.audioOutput.find(t=>"default"!==e.deviceId&&t.label===e.label);if(n)return n;let a=this.audioOutput.find(t=>t.groupId===e.groupId);if(a&&"default"===this.audioOutput[0].deviceId&&a.groupId===this.audioOutput[0].groupId)return a}logDevices(e=""){tV.d(this.TAG,e,JSON.stringify({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput],selected:this.getCurrentSelection()},null,4))}},aK=class{constructor(e,t){this.deviceManager=e,this.audioSinkManager=t}getVolume(){return this.audioSinkManager.getVolume()}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.audioSinkManager.setVolume(e)}getDevice(){return this.deviceManager.outputDevice}setDevice(e){return this.deviceManager.updateOutputDevice(e,!0)}unblockAutoplay(){return tP(this,null,function*(){yield this.audioSinkManager.unblockAutoplay(),yield s1.resumeContext()})}},aJ=class{static handleError(e){if(404===e.status)throw iQ("FEEDBACK",e.statusText);if(e.status>=400)throw iJ(e.status,"FEEDBACK",null==e?void 0:e.statusText)}static sendFeedback(e){return tP(this,arguments,function*({token:e,eventEndpoint:t="https://event.100ms.live",info:i,feedback:s}){tV.d(this.TAG,`sendFeedback: feedbackEndpoint=${t} peerId=${i.peer.peer_id} session=${i.peer.session_id} `);let r=new URL("v2/client/feedback",t),n=tT(tb({},i),{payload:s});try{let t=yield fetch(r,{headers:{Authorization:`Bearer ${e}`},body:JSON.stringify(n),method:"POST"});try{this.handleError(t);return}catch(e){throw tV.e(this.TAG,"error",e.message,t.status),e instanceof i$?e:iJ(t.status,"FEEDBACK",e.message)}}catch(e){throw["Failed to fetch","NetworkError","ECONNRESET"].some(t=>e.message.includes(t))?iQ("FEEDBACK",e.message):e}})}};aJ.TAG="[FeedbackService]";var aQ=class{constructor(e,t){this.eventName=e,this.eventEmitter=t,this.publish=e=>{this.eventEmitter.emit(this.eventName,e)},this.subscribe=e=>{this.eventEmitter.on(this.eventName,e)},this.subscribeOnce=e=>{this.eventEmitter.once(this.eventName,e)},this.unsubscribe=e=>{this.eventEmitter.off(this.eventName,e)},this.waitFor=e=>this.eventEmitter.waitFor(this.eventName,{filter:e}),this.removeAllListeners=()=>{this.eventEmitter.removeAllListeners(this.eventName)}}},aY=class{constructor(){this.eventEmitter=new(0,eK.EventEmitter2),this.analytics=new aQ("analytics",this.eventEmitter),this.deviceChange=new aQ("device-change",this.eventEmitter),this.localAudioEnabled=new aQ("local-audio-enabled",this.eventEmitter),this.localVideoEnabled=new aQ("local-video-enabled",this.eventEmitter),this.localVideoUnmutedNatively=new aQ("local-video-unmuted-natively",this.eventEmitter),this.localAudioUnmutedNatively=new aQ("local-audio-unmuted-natively",this.eventEmitter),this.statsUpdate=new aQ("stats-update",this.eventEmitter),this.trackDegraded=new aQ("track-degraded",this.eventEmitter),this.trackRestored=new aQ("track-restored",this.eventEmitter),this.trackAudioLevelUpdate=new aQ("track-audio-level-update",this.eventEmitter),this.audioPluginFailed=new aQ("audio-plugin-failed",this.eventEmitter),this.localAudioSilence=new aQ("local-audio-silence",this.eventEmitter),this.policyChange=new aQ("policy-change",this.eventEmitter),this.localRoleUpdate=new aQ("local-role-update",this.eventEmitter),this.audioTrackUpdate=new aQ("audio-track-update",this.eventEmitter),this.audioTrackAdded=new aQ("audio-track-added",this.eventEmitter),this.audioTrackRemoved=new aQ("audio-track-removed",this.eventEmitter),this.autoplayError=new aQ("autoplay-error",this.eventEmitter),this.leave=new aQ("leave",this.eventEmitter),this.error=new aQ("error",this.eventEmitter)}},aX=class{constructor(e,t,i){this.store=e,this.listener=t,this.audioListener=i}handleActiveSpeakers(e){var t,i,s;let r=e["speaker-list"],n=r.map(e=>({audioLevel:e.level,peer:this.store.getPeerById(e.peer_id),track:this.store.getTrackById(e.track_id)}));null==(t=this.audioListener)||t.onAudioLevelUpdate(n),this.store.updateSpeakers(n);let a=r[0];if(a){let e=this.store.getPeerById(a.peer_id);null==(i=this.listener)||i.onPeerUpdate(4,e)}else null==(s=this.listener)||s.onPeerUpdate(5,null)}},aZ=class{constructor(e){this.listener=e,this.TAG="[BroadcastManager]"}handleNotification(e,t){"on-broadcast"===e&&this.handleBroadcast(t)}handleBroadcast(e){var t,i;tV.d(this.TAG,`Received Message from sender=${null==(t=null==e?void 0:e.peer)?void 0:t.peer_id}: ${e}`),null==(i=this.listener)||i.onMessageReceived(e)}},a0=class{constructor(e,t){this.store=e,this.listener=t}handleQualityUpdate(e){var t;let i=e.peers.map(e=>{let t=this.store.getPeerById(e.peer_id);return t&&t.updateNetworkQuality(e.downlink_score),{peerID:e.peer_id,downlinkQuality:e.downlink_score}});null==(t=this.listener)||t.onConnectionQualityUpdate(i)}},a1=class{constructor(e,t,i){this.store=e,this.eventBus=t,this.listener=i,this.TAG="[TrackManager]",this.tracksToProcess=new Map,this.handleTrackAdd=e=>{tV.d(this.TAG,"ONTRACKADD",`${e}`),this.tracksToProcess.set(e.trackId,e),this.processPendingTracks()},this.handleTrackRemovedPermanently=e=>{tV.d(this.TAG,"ONTRACKREMOVE permanently",e),Object.keys(e.tracks).forEach(e=>{var t;let i=this.store.getTrackState(e);if(!i)return;let s=this.store.getTrackById(e);if(!s)return void tV.d(this.TAG,"Track not found in store");"audio"===s.type&&this.eventBus.audioTrackRemoved.publish(s),this.store.removeTrack(s);let r=this.store.getPeerById(i.peerId);r&&(this.removePeerTracks(r,s),null==(t=this.listener)||t.onTrackUpdate(1,s,r))})},this.handleTrackLayerUpdate=e=>{for(let t in e.tracks){let i=e.tracks[t],s=this.store.getTrackById(t);!s||!this.store.getPeerByTrackId(t)||s instanceof rG&&this.setLayer(s,i)}},this.handleTrackUpdate=(e,t=!0)=>{var i,s;let r=this.store.getPeerById(e.peer.peer_id),n=e.peer;if(!r&&!n)return void tV.d(this.TAG,"Track Update ignored - Peer not added to store");for(let a in r||(r=r6(n,this.store),this.store.addPeer(r)),e.tracks){let n=Object.assign({},null==(i=this.store.getTrackState(a))?void 0:i.trackInfo),o=e.tracks[a],l=this.store.getTrackById(a);if(this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:tb(tb({},n),o)}),!l||this.tracksToProcess.has(a))this.processTrackInfo(o,e.peer.peer_id,t),this.processPendingTracks();else{l.setEnabled(!o.mute);let e=this.processTrackUpdate(l,n,o);e&&(null==(s=this.listener)||s.onTrackUpdate(e,l,r))}}},this.processTrackInfo=(e,t,i)=>{},this.processPendingTracks=()=>{new Map(this.tracksToProcess).forEach(e=>{var t;let i=this.store.getTrackState(e.trackId);if(!i)return void tV.d(this.TAG,"TrackState not added to store",`peerId - ${e.peerId}`,`trackId -${e.trackId}`);let s=this.store.getPeerById(i.peerId);if(!s)return void tV.d(this.TAG,"Peer not added to store, peerId",i.peerId);e.source=i.trackInfo.source,e.peerId=s.peerId,e.logIdentifier=s.name,e.setEnabled(!i.trackInfo.mute),this.addAudioTrack(s,e),this.addVideoTrack(s,e),"audio"===e.type?this.eventBus.audioTrackAdded.publish({track:e,peer:s}):null==(t=this.listener)||t.onTrackUpdate(0,e,s),this.tracksToProcess.delete(e.trackId)})}}handleTrackMetadataAdd(e){for(let t in tV.d(this.TAG,"TRACK_METADATA_ADD",JSON.stringify(e,null,2)),e.tracks){let i=e.tracks[t];this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:i})}this.processPendingTracks()}handleTrackRemove(e,t=!0){var i;tV.d(this.TAG,"ONTRACKREMOVE",`${e}`);let s=this.store.getTrackState(e.trackId);if(s){if(!this.store.hasTrack(e))return void tV.d(this.TAG,"Track not found in store");if(t){this.store.removeTrack(e);let t=this.store.getPeerById(s.peerId);if(!t)return;this.removePeerTracks(t,e),null==(i=this.listener)||i.onTrackUpdate(1,e,t),"audio"===e.type&&this.eventBus.audioTrackRemoved.publish(e)}}}setLayer(e,t){var i,s;let r=this.store.getPeerByTrackId(e.trackId);r&&(e.setLayerFromServer(t)?null==(i=this.listener)||i.onTrackUpdate(5,e,r):null==(s=this.listener)||s.onTrackUpdate(6,e,r))}removePeerTracks(e,t){let i=e.auxiliaryTracks.indexOf(t);i>-1?(e.auxiliaryTracks.splice(i,1),tV.d(this.TAG,"auxiliary track removed",`${t}`)):"audio"===t.type&&e.audioTrack===t?(e.audioTrack=void 0,tV.d(this.TAG,"audio track removed",`${t}`)):"video"===t.type&&e.videoTrack===t&&(e.videoTrack=void 0,tV.d(this.TAG,"video track removed",`${t}`))}addAudioTrack(e,t){var i;"audio"===t.type&&("regular"!==t.source||e.audioTrack&&(null==(i=e.audioTrack)?void 0:i.trackId)!==t.trackId?e.auxiliaryTracks.push(t):e.audioTrack=t,this.store.addTrack(t),tV.d(this.TAG,"audio track added",`${t}`))}addVideoTrack(e,t){if("video"!==t.type)return;let i=this.store.getSimulcastDefinitionsForPeer(e,t.source);if(t.setSimulcastDefinitons(i),this.addAsPrimaryVideoTrack(e,t))e.videoTrack?e.videoTrack.replaceTrack(t):e.videoTrack=t,this.store.addTrack(e.videoTrack);else{let i=e.auxiliaryTracks.findIndex(e=>e.trackId===t.trackId);-1===i?(e.auxiliaryTracks.push(t),this.store.addTrack(t)):(e.auxiliaryTracks[i].replaceTrack(t),this.store.addTrack(e.auxiliaryTracks[i]))}tV.d(this.TAG,"video track added",`${t}`)}addAsPrimaryVideoTrack(e,t){var i;return"regular"===t.source&&(!e.videoTrack||(null==(i=e.videoTrack)?void 0:i.trackId)===t.trackId)}processTrackUpdate(e,t,i){let s;return t.mute!==i.mute?(s=i.mute?2:3,"audio"===e.type&&this.eventBus.audioTrackUpdate.publish({track:e,enabled:!i.mute})):t.description!==i.description&&(s=4),s}},a2=class extends a1{constructor(e,t,i,s){super(e,t,s),this.transport=i,this.TAG="[OnDemandTrackManager]",this.processTrackInfo=(e,t,i=!0)=>{var s,r;if("video"!==e.type)return;let n=this.store.getPeerById(t);if(!n||!this.isPeerRoleSubscribed(t))return void tV.d(this.TAG,`no peer in store for peerId: ${t}`);let a=new rH(new MediaStream,this.transport.getSubscribeConnection()),o=rN.getEmptyVideoTrack();o.enabled=!e.mute;let l=new rG(a,o,e.source,null==(s=this.store.getRoom())?void 0:s.disableNoneLayerRequest);l.setTrackId(e.track_id),l.peerId=n.peerId,l.logIdentifier=n.name,this.addVideoTrack(n,l),i&&(null==(r=this.listener)||r.onTrackUpdate(0,n.videoTrack,n))}}handleTrackMetadataAdd(e){for(let t in super.handleTrackMetadataAdd(e),e.tracks)"video"===e.tracks[t].type&&this.processTrackInfo(e.tracks[t],e.peer.peer_id)}handleTrackRemove(e){let t="video"===e.type&&"regular"===e.source;super.handleTrackRemove(e,!t),t&&this.processTrackInfo({track_id:e.trackId,mute:!e.enabled,type:e.type,source:e.source,stream_id:e.stream.id},e.peerId,!1)}addAsPrimaryVideoTrack(e,t){return"regular"===t.source&&(!e.videoTrack||e.videoTrack.trackId===t.trackId||e.videoTrack.enabled&&sZ(e.videoTrack.nativeTrack))}isPeerRoleSubscribed(e){var t,i,s,r;if(!e)return!0;let n=this.store.getLocalPeer(),a=this.store.getPeerById(e);return a&&(null==(r=null==(i=null==(t=null==n?void 0:n.role)?void 0:t.subscribeParams)?void 0:i.subscribeToRoles)?void 0:r.includes(null==(s=a.role)?void 0:s.name))}},a3=class{constructor(e,t,i,s){this.store=e,this.peerManager=t,this.trackManager=i,this.listener=s,this.TAG="[PeerListManager]",this.handleInitialPeerList=e=>{let t=Object.values(e.peers);this.peerManager.handlePeerList(t)},this.handleReconnectPeerList=e=>{this.handleRepeatedPeerList(e.peers)},this.handlePreviewRoomState=e=>{if(!this.store.hasRoleDetailsArrived())return;let t=e.peers;if(null==t){0===e.peer_count&&this.handleRepeatedPeerList({});return}Object.keys(t).forEach(e=>{t[e].tracks={},t[e].is_from_room_state=!0}),this.handleRepeatedPeerList(t)},this.handleRepeatedPeerList=e=>{let t=this.store.getRemotePeers(),i=Object.values(e),s=t.filter(t=>!e[t.peerId]);s.length>0&&tV.d(this.TAG,`${s}`),s.forEach(e=>{var t;let i={peer_id:e.peerId,role:(null==(t=e.role)?void 0:t.name)||"",info:{name:e.name,data:e.metadata||"",user_id:e.customerUserId||"",type:e.type},tracks:{},groups:[],realtime:e.realtime};this.peerManager.handlePeerLeave(i)});let r=[];i.forEach(e=>{let t=this.store.getPeerById(e.peer_id),i=Object.values(e.tracks);t&&(this.store.getPeerTracks(t.peerId).forEach(i=>{var s;e.tracks[i.trackId]||(this.removePeerTrack(t,i.trackId),null==(s=this.listener)||s.onTrackUpdate(1,i,t))}),i.forEach(e=>{this.store.getTrackById(e.track_id)||this.store.setTrackState({peerId:t.peerId,trackInfo:e})}),this.trackManager.handleTrackUpdate({peer:e,tracks:e.tracks},!1),this.peerManager.handlePeerUpdate(e)),r.push(e)}),r.length>0&&this.peerManager.handlePeerList(r)}}handleNotification(e,t,i){"peer-list"===e?i?(tV.d(this.TAG,"RECONNECT_PEER_LIST event",JSON.stringify(t,null,2)),this.handleReconnectPeerList(t)):(tV.d(this.TAG,"PEER_LIST event",JSON.stringify(t,null,2)),this.handleInitialPeerList(t)):"room-state"===e&&this.handlePreviewRoomState(t)}removePeerTrack(e,t){var i,s;if(tV.d(this.TAG,`removing track - ${t} from ${e}`),(null==(i=e.audioTrack)?void 0:i.trackId)===t)e.audioTrack=void 0;else if((null==(s=e.videoTrack)?void 0:s.trackId)===t)e.videoTrack=void 0;else{let i=e.auxiliaryTracks.findIndex(e=>e.trackId===t);i>=0&&e.auxiliaryTracks.splice(i,1)}}},a5=e=>e?new Date(e):void 0,a4=class{constructor(e,t,i){this.store=e,this.trackManager=t,this.listener=i,this.TAG="[PeerManager]",this.handlePeerList=e=>{var t,i;if(0===e.length){null==(t=this.listener)||t.onPeerUpdate(9,[]);return}let s=[],r=new Set(e.map(e=>e.peer_id));for(let t of(this.store.getRemotePeers().forEach(({peerId:e,fromRoomState:t})=>{!r.has(e)&&t&&this.store.removePeer(e)}),e))s.push(this.makePeer(t));null==(i=this.listener)||i.onPeerUpdate(9,s),this.trackManager.processPendingTracks()},this.handlePeerJoin=e=>{var t;let i=this.makePeer(e);null==(t=this.listener)||t.onPeerUpdate(0,i),this.trackManager.processPendingTracks()},this.handlePeerLeave=e=>{var t,i,s,r;let n=this.store.getPeerById(e.peer_id);this.store.removePeer(e.peer_id),tV.d(this.TAG,"PEER_LEAVE",e.peer_id,`remainingPeers=${this.store.getPeers().length}`),n&&(n.audioTrack&&(null==(t=this.listener)||t.onTrackUpdate(1,n.audioTrack,n)),n.videoTrack&&(null==(i=this.listener)||i.onTrackUpdate(1,n.videoTrack,n)),null==(s=n.auxiliaryTracks)||s.forEach(e=>{var t;null==(t=this.listener)||t.onTrackUpdate(1,e,n)}),null==(r=this.listener)||r.onPeerUpdate(1,n))}}handleNotification(e,t){switch(e){case"on-peer-join":this.handlePeerJoin(t);break;case"on-peer-leave":this.handlePeerLeave(t);break;case"on-peer-update":this.handlePeerUpdate(t)}}handlePeerUpdate(e){var t,i,s,r,n;let a=this.store.getPeerById(e.peer_id);if(!a&&e.realtime){a=this.makePeer(e),null==(t=this.listener)||t.onPeerUpdate(a.isHandRaised?12:14,a);return}if(a&&!a.isLocal&&!e.realtime){this.store.removePeer(a.peerId),null==(i=this.listener)||i.onPeerUpdate(13,a);return}if(!a)return void tV.d(this.TAG,`peer ${e.peer_id} not found`);if(a.role&&a.role.name!==e.role){let t=this.store.getPolicyForRole(e.role);a.updateRole(t),this.updateSimulcastLayersForPeer(a),null==(s=this.listener)||s.onPeerUpdate(8,a)}let o=a.isHandRaised;a.updateGroups(e.groups),o!==(null==(r=e.groups)?void 0:r.includes(r$))&&(null==(n=this.listener)||n.onPeerUpdate(12,a)),this.handlePeerInfoUpdate(tb({peer:a},e.info))}handlePeerInfoUpdate({peer:e,name:t,data:i}){var s,r;e&&(t&&e.name!==t&&(e.updateName(t),null==(s=this.listener)||s.onPeerUpdate(10,e)),i&&e.metadata!==i&&(e.updateMetadata(i),null==(r=this.listener)||r.onPeerUpdate(11,e)))}makePeer(e){let t=this.store.getPeerById(e.peer_id);for(let i in t||((t=r6(e,this.store)).realtime=e.realtime,t.joinedAt=a5(e.joined_at),t.fromRoomState=!!e.is_from_room_state,this.store.addPeer(t),tV.d(this.TAG,"adding to the peerList",`${t}`)),e.tracks){let t=e.tracks[i];this.store.setTrackState({peerId:e.peer_id,trackInfo:t}),"video"===t.type&&this.trackManager.processTrackInfo(t,e.peer_id,!1)}return t}updateSimulcastLayersForPeer(e){this.store.getPeerTracks(e.peerId).forEach(t=>{if("video"===t.type&&["regular","screen"].includes(t.source)){let i=this.store.getSimulcastDefinitionsForPeer(e,t.source);t.setSimulcastDefinitons(i)}})}},a6=class{constructor(e,t){this.store=e,this.eventBus=t}handlePolicyChange(e){let t=this.store.getLocalPeer();if(t&&!t.role){let i=e.known_roles[e.name];t.updateRole(i)}this.store.setKnownRoles(e);let i=this.store.getRoom();i?i.templateId=e.template_id:tV.w("[PolicyChangeManager]","on policy change - room not present"),this.updateLocalPeerRole(e),this.eventBus.policyChange.publish(e)}updateLocalPeerRole(e){var t;let i=this.store.getLocalPeer();if(null!=i&&i.role&&i.role.name!==e.name){let s=this.store.getPolicyForRole(e.name),r=i.role;i.updateRole(s),s.name===(null==(t=i.asRole)?void 0:t.name)&&delete i.asRole,this.eventBus.localRoleUpdate.publish({oldRole:r,newRole:s})}}},a9=((P=a9||{}).FLAG_SERVER_SUB_DEGRADATION="subscribeDegradation",P.FLAG_SERVER_SIMULCAST="simulcast",P.FLAG_NON_WEBRTC_DISABLE_OFFER="nonWebRTCDisableOffer",P.FLAG_PUBLISH_STATS="publishStats",P.FLAG_SUBSCRIBE_STATS="subscribeStats",P.FLAG_ON_DEMAND_TRACKS="onDemandTracks",P.FLAG_DISABLE_VIDEO_TRACK_AUTO_UNSUBSCRIBE="disableVideoTrackAutoUnsubscribe",P.FLAG_WHITEBOARD_ENABLED="whiteboardEnabled",P.FLAG_EFFECTS_SDK_ENABLED="effectsSDKEnabled",P.FLAG_VB_ENABLED="vb",P.FLAG_HIPAA_ENABLED="hipaa",P.FLAG_NOISE_CANCELLATION="noiseCancellation",P.FLAG_SCALE_SCREENSHARE_BASED_ON_PIXELS="scaleScreenshareBasedOnPixels",P.FLAG_DISABLE_NONE_LAYER_REQUEST="disableNoneLayerRequest",P),a8=(e,t,i)=>{let s=new URL("qa"===i?"https://whiteboard-qa.100ms.live":"https://whiteboard.100ms.live");return s.searchParams.set("endpoint",`https://${t}`),s.searchParams.set("token",e),s.toString()},a7=class{constructor(e,t,i){this.transport=e,this.store=t,this.listener=i,this.TAG="[HMSWhiteboardInteractivityCenter]"}get isEnabled(){return this.transport.isFlagEnabled("whiteboardEnabled")}open(e){return tP(this,null,function*(){var t;if(!this.isEnabled)return tV.w(this.TAG,"Whiteboard is not enabled for customer");let i=this.store.getWhiteboard(null==e?void 0:e.id),s=null==i?void 0:i.id;if(i||(s=(yield this.transport.signal.createWhiteboard(this.getCreateOptionsWithDefaults(e))).id),!s)throw Error(`Whiteboard ID: ${s} not found`);let r=yield this.transport.signal.getWhiteboard({id:s}),n=tT(tb({},i),{title:null==e?void 0:e.title,attributes:null==e?void 0:e.attributes,id:r.id,url:a8(r.token,r.addr,this.store.getEnv()),token:r.token,addr:r.addr,owner:r.owner,permissions:r.permissions||[],open:!0});this.store.setWhiteboard(n),null==(t=this.listener)||t.onWhiteboardUpdate(n)})}close(e){return tP(this,null,function*(){var t;if(!this.isEnabled)return tV.w(this.TAG,"Whiteboard is not enabled for customer");let i=this.store.getWhiteboard(e);if(!i)throw Error(`Whiteboard ID: ${e} not found`);let s={id:i.id,title:i.title,open:!1};this.store.setWhiteboard(s),null==(t=this.listener)||t.onWhiteboardUpdate(s)})}setListener(e){this.listener=e}handleLocalRoleUpdate(){return tP(this,null,function*(){var e,t,i;for(let s of this.store.getWhiteboards().values())if(s.url){let r=yield this.transport.signal.getWhiteboard({id:s.id}),n=this.store.getLocalPeer(),a=(null==n?void 0:n.customerUserId)===r.owner?null==(t=null==(e=n.role)?void 0:e.permissions.whiteboard)?void 0:t.includes("admin"):r.permissions.length>0,o=tT(tb({},s),{id:r.id,url:a8(r.token,r.addr,this.store.getEnv()),token:r.token,addr:r.addr,owner:r.owner,permissions:r.permissions,open:a});this.store.setWhiteboard(o),null==(i=this.listener)||i.onWhiteboardUpdate(o)}})}getCreateOptionsWithDefaults(e){var t;let i=Object.values(this.store.getKnownRoles()),s=[],r=[],n=[];return i.forEach(e=>{var t,i,a;null!=(t=e.permissions.whiteboard)&&t.includes("read")&&s.push(e.name),null!=(i=e.permissions.whiteboard)&&i.includes("write")&&r.push(e.name),null!=(a=e.permissions.whiteboard)&&a.includes("admin")&&n.push(e.name)}),{title:(null==e?void 0:e.title)||`${null==(t=this.store.getRoom())?void 0:t.id} Whiteboard`,reader:(null==e?void 0:e.reader)||s,writer:(null==e?void 0:e.writer)||r,admin:(null==e?void 0:e.admin)||n}}},oe=class{constructor(e,t,i){this.transport=e,this.store=t,this.listener=i,this.whiteboard=new a7(e,t,i)}setListener(e){this.listener=e,this.whiteboard.setListener(e)}createPoll(e){return tP(this,null,function*(){var t,i;let{poll_id:s}=yield this.transport.signal.setPollInfo(tT(tb({},e),{mode:e.mode?({customerID:"userid",peerID:"peerid",userName:"username"})[e.mode]:void 0,poll_id:e.id,vote:e.rolesThatCanVote,responses:e.rolesThatCanViewResponses}));e.id||(e.id=s),Array.isArray(e.questions)&&(yield this.addQuestionsToPoll(e.id,e.questions));let r=yield this.transport.signal.getPollQuestions({poll_id:e.id,index:0,count:50}),n=ot(tT(tb({},e),{poll_id:e.id,state:"created",created_by:null==(t=this.store.getLocalPeer())?void 0:t.peerId}));n.questions=r.questions.map(({question:e,options:t,answer:i})=>tT(tb({},e),{options:t,answer:i})),null==(i=this.listener)||i.onPollsUpdate(0,[n])})}startPoll(e){return tP(this,null,function*(){"string"==typeof e?yield this.transport.signal.startPoll({poll_id:e}):(yield this.createPoll(e),yield this.transport.signal.startPoll({poll_id:e.id}))})}addQuestionsToPoll(e,t){return tP(this,null,function*(){t.length>0&&(yield this.transport.signal.setPollQuestions({poll_id:e,questions:t.map((e,t)=>this.createQuestionSetParams(e,t))}))})}stopPoll(e){return tP(this,null,function*(){yield this.transport.signal.stopPoll({poll_id:e})})}addResponsesToPoll(e,t){return tP(this,null,function*(){let i=this.store.getPoll(e);if(!i)throw Error("Invalid poll ID - Poll not found");let s=t.map(e=>{var t,s;let r=this.getQuestionInPoll(i,e.questionIndex);return"single-choice"===r.type?(e.option=e.option||(null==(t=e.options)?void 0:t[0])||-1,delete e.text,delete e.options):"multiple-choice"===r.type?(null==(s=e.options)||s.sort(),delete e.text,delete e.option):(delete e.option,delete e.options),e.skipped&&(delete e.option,delete e.options,delete e.text),tb({duration:0,type:r.type,question:e.questionIndex},e)});yield this.transport.signal.setPollResponses({poll_id:e,responses:s})})}fetchLeaderboard(e,t,i){return tP(this,null,function*(){var s,r;let n=this.store.getPoll(e);if(!n)throw Error("Invalid poll ID - Poll not found");let a=null==(r=null==(s=this.store.getLocalPeer())?void 0:s.role)?void 0:r.permissions,o=!!(null!=a&&a.pollRead||null!=a&&a.pollWrite);if(n.anonymous||"stopped"!==n.state||!o)return{entries:[],hasNext:!1};let l=yield this.transport.signal.fetchPollLeaderboard({poll_id:n.id,count:i,offset:t}),d={avgScore:l.avg_score,avgTime:l.avg_time,votedUsers:l.voted_users,totalUsers:l.total_users,correctUsers:l.correct_users};return{entries:l.questions.map(e=>({position:e.position,totalResponses:e.total_responses,correctResponses:e.correct_responses,duration:e.duration,peer:e.peer,score:e.score})),hasNext:!l.last,summary:d}})}getPollResponses(e,t){return tP(this,null,function*(){var i,s;let r=yield this.transport.signal.getPollResponses({poll_id:e.id,index:0,count:50,self:t}),n=JSON.parse(JSON.stringify(e));null==(i=r.responses)||i.forEach(({response:i,peer:s,final:r})=>{var a,o;let l=null==(a=null==e?void 0:e.questions)?void 0:a.find(e=>e.index===i.question);if(l){let e={id:i.response_id,questionIndex:i.question,option:i.option,options:i.options,text:i.text,responseFinal:r,peer:{peerid:s.peerid,userHash:s.hash,userid:s.userid,username:s.username},skipped:i.skipped,type:i.type,update:i.update},a=l.responses&&!t?[...l.responses]:[];null!=(o=n.questions)&&o[i.question-1]&&(n.questions[i.question-1].responses=[...a,e])}}),this.store.setPoll(n),null==(s=this.listener)||s.onPollsUpdate(4,[n])})}getPolls(){return tP(this,null,function*(){var e,t,i;let s=yield this.transport.signal.getPollsList({count:50,state:"started"}),r=[],n=null==(t=null==(e=this.store.getLocalPeer())?void 0:e.role)?void 0:t.permissions.pollWrite,a=[...s.polls];if(n){let e=yield this.transport.signal.getPollsList({count:50,state:"created"}),t=yield this.transport.signal.getPollsList({count:50,state:"stopped"});a=[...e.polls,...a,...t.polls]}for(let e of a){let t=yield this.transport.signal.getPollQuestions({poll_id:e.poll_id,index:0,count:50}),i=ot(e),s=this.store.getPoll(e.poll_id);i.questions=t.questions.map(({question:e,options:t,answer:i},r)=>{var n,a;return tT(tb({},e),{options:t,answer:i,responses:null==(a=null==(n=null==s?void 0:s.questions)?void 0:n[r])?void 0:a.responses})}),r.push(i),this.store.setPoll(i)}return null==(i=this.listener)||i.onPollsUpdate(3,r),r})}createQuestionSetParams(e,t){var i,s;if(e.index){let s=null==(i=e.options)?void 0:i.map((e,t)=>tT(tb({},e),{index:t+1}));return{question:tT(tb({},e),{index:t+1}),options:s,answer:e.answer}}let r=tT(tb({},e),{index:t+1}),n,a=e.answer||{hidden:!1};return Array.isArray(e.options)&&["single-choice","multiple-choice"].includes(e.type)?(n=null==(s=e.options)?void 0:s.map((e,t)=>({index:t+1,text:e.text,weight:e.weight})),"single-choice"===e.type?a.option=e.options.findIndex(e=>e.isCorrectAnswer)+1||void 0:a.options=e.options.map((e,t)=>e.isCorrectAnswer?t+1:void 0).filter(e=>!!e)):(null==a||delete a.options,null==a||delete a.option),{question:r,options:n,answer:a}}getQuestionInPoll(e,t){var i;let s=null==(i=null==e?void 0:e.questions)?void 0:i.find(e=>e.index===t);if(!s)throw Error("Invalid question index - Question not found in poll");return s}},ot=e=>({id:e.poll_id,title:e.title,startedBy:e.started_by,createdBy:e.created_by,anonymous:e.anonymous,type:e.type,duration:e.duration,locked:e.locked,mode:e.mode?({userid:"customerID",peerid:"peerID",username:"userName"})[e.mode]:void 0,visibility:e.visibility,rolesThatCanVote:e.vote||[],rolesThatCanViewResponses:e.responses||[],state:e.state,stoppedBy:e.stopped_by,startedAt:a5(e.started_at),stoppedAt:a5(e.stopped_at),createdAt:a5(e.created_at)}),oi=class{constructor(e,t,i){this.store=e,this.transport=t,this.listener=i}handleNotification(e,t){switch(e){case"on-poll-start":this.handlePollStart(t);break;case"on-poll-stop":this.handlePollStop(t);break;case"on-poll-stats":this.handlePollStats(t)}}handlePollStart(e){return tP(this,null,function*(){var t,i;let s=[];for(let i of e.polls){let e=this.store.getPoll(i.poll_id);if(e&&"started"===e.state){null==(t=this.listener)||t.onPollsUpdate(1,[e]);return}let r=yield this.transport.signal.getPollQuestions({poll_id:i.poll_id,index:0,count:50}),n=ot(i);n.questions=r.questions.map(({question:e,options:t,answer:i})=>tT(tb({},e),{options:t,answer:i})),yield this.updatePollResponses(n,!0),s.push(n),this.store.setPoll(n)}null==(i=this.listener)||i.onPollsUpdate(1,s)})}handlePollStop(e){return tP(this,null,function*(){var t;let i=[];for(let t of e.polls){let e=this.store.getPoll(t.poll_id);if(e){e.state="stopped",e.stoppedAt=a5(t.stopped_at),e.stoppedBy=t.stopped_by;let s=yield this.transport.signal.getPollResult({poll_id:t.poll_id});this.updatePollResult(e,s),i.push(e)}}i.length>0&&(null==(t=this.listener)||t.onPollsUpdate(2,i))})}handlePollStats(e){return tP(this,null,function*(){var t;let i=[];for(let t of e.polls){let e=this.store.getPoll(t.poll_id);if(!e)return;this.updatePollResult(e,t),i.push(e)}i.length>0&&(null==(t=this.listener)||t.onPollsUpdate(4,i))})}updatePollResult(e,t){var i;e.result=tb({},e.result),e.result.totalUsers=t.user_count,e.result.maxUsers=t.max_user,e.result.totalResponses=t.total_response,null==(i=t.questions)||i.forEach(t=>{var i,s;let r=null==(i=e.questions)?void 0:i.find(e=>e.index===t.question);r&&(r.result=tb({},r.result),r.result.correctResponses=t.correct,r.result.skippedCount=t.skipped,r.result.totalResponses=t.total,null==(s=t.options)||s.forEach((e,t)=>{var i;let s=null==(i=r.options)?void 0:i[t];s&&s.voteCount!==e&&(s.voteCount=e)}))})}updatePollResponses(e,t){return tP(this,null,function*(){var i;null==(i=(yield this.transport.signal.getPollResponses({poll_id:e.id,index:0,count:50,self:t})).responses)||i.forEach(({response:t,peer:i,final:s})=>{var r;let n=null==(r=null==e?void 0:e.questions)?void 0:r.find(e=>e.index===t.question);if(!n)return;let a={id:t.response_id,questionIndex:t.question,option:t.option,options:t.options,text:t.text,responseFinal:s,peer:{peerid:i.peerid,userHash:i.hash,userid:i.userid,username:i.username},skipped:t.skipped,type:t.type,update:t.update};Array.isArray(n.responses)&&n.responses.length>0?n.responses.find(({id:e})=>e===a.id)||n.responses.push(a):n.responses=[a]})})}},os=class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){switch(e){case"on-role-change-request":this.handleRoleChangeRequest(t);break;case"on-track-update-request":this.handleTrackUpdateRequest(t);break;case"on-change-track-mute-state-request":this.handleChangeTrackStateRequest(t);break;default:return}}handleRoleChangeRequest(e){var t;let i={requestedBy:e.requested_by?this.store.getPeerById(e.requested_by):void 0,role:this.store.getPolicyForRole(e.role),token:e.token};null==(t=this.listener)||t.onRoleChangeRequest(i)}handleTrackUpdateRequest(e){let{requested_by:t,track_id:i,mute:s}=e,r=t?this.store.getPeerById(t):void 0,n=this.store.getLocalPeerTracks().find(e=>e.publishedTrackId===i);if(!n)return;let a=()=>{var e;null==(e=this.listener)||e.onChangeTrackStateRequest({requestedBy:r,track:n,enabled:!s})};if(s){if(!s===n.enabled)return;n.setEnabled(!s).then(a)}else a()}handleChangeTrackStateRequest(e){var t;let{type:i,source:s,value:r,requested_by:n}=e,a=n?this.store.getPeerById(n):void 0,o=!r,l=this.getTracksToBeUpdated({type:i,source:s,enabled:o});if(0!==l.length)if(o)null==(t=this.listener)||t.onChangeMultiTrackStateRequest({requestedBy:a,tracks:l,type:i,source:s,enabled:!0});else{let e=[];for(let t of l)e.push(t.setEnabled(!1));Promise.all(e).then(()=>{var e;null==(e=this.listener)||e.onChangeMultiTrackStateRequest({requestedBy:a,tracks:l,enabled:!1})})}}getTracksToBeUpdated({type:e,source:t,enabled:i}){let s=this.store.getLocalPeerTracks();return e&&(s=s.filter(t=>t.type===e)),t&&(s=s.filter(e=>e.source===t)),s.filter(e=>e.enabled!==i)}},or=class{constructor(e,t){this.store=e,this.listener=t,this.TAG="[RoomUpdateManager]"}handleNotification(e,t){switch(e){case"peer-list":this.onRoomState(t.room);break;case"on-rtmp-update":this.updateRTMPStatus(t);break;case"on-record-update":this.updateRecordingStatus(t);break;case"room-state":this.handlePreviewRoomState(t);break;case"room-info":this.handleRoomInfo(t);break;case"session-info":this.handleSessionInfo(t);break;case"on-hls-update":this.updateHLSStatus(t);break;case"on-transcription-update":this.handleTranscriptionStatus([t])}}handleRoomInfo(e){let t=this.store.getRoom();if(!t)return void tV.w(this.TAG,"on session info - room not present");t.description=e.description,t.large_room_optimization=e.large_room_optimization,t.max_size=e.max_size,t.name=e.name}handleSessionInfo(e){var t;let i=this.store.getRoom();if(!i)return void tV.w(this.TAG,"on session info - room not present");i.sessionId=e.session_id,i.peerCount!==e.peer_count&&(i.peerCount=e.peer_count,null==(t=this.listener)||t.onRoomUpdate("ROOM_PEER_COUNT_UPDATED",i))}handlePreviewRoomState(e){let{room:t}=e;this.onRoomState(t)}onRoomState(e){var t,i,s,r;let{recording:n,streaming:a,transcriptions:o,session_id:l,started_at:d,name:c}=e,u=this.store.getRoom();if(!u)return void tV.w(this.TAG,"on room state - room not present");u.name=c,u.rtmp.running=this.isStreamingRunning(null==(t=null==a?void 0:a.rtmp)?void 0:t.state),u.rtmp.startedAt=a5(null==(i=null==a?void 0:a.rtmp)?void 0:i.started_at),u.rtmp.state=null==(s=null==a?void 0:a.rtmp)?void 0:s.state,u.recording.server=this.getPeerListSFURecording(n),u.recording.browser=this.getPeerListBrowserRecording(n),u.recording.hls=this.getPeerListHLSRecording(n),u.hls=this.convertHls(null==a?void 0:a.hls),u.transcriptions=this.addTranscriptionDetail(o),u.sessionId=l,u.startedAt=a5(d),null==(r=this.listener)||r.onRoomUpdate("RECORDING_STATE_UPDATED",u)}addTranscriptionDetail(e){return e?e.map(e=>({state:e.state,mode:e.mode,initialised_at:a5(e.initialised_at),started_at:a5(e.started_at),stopped_at:a5(e.stopped_at),updated_at:a5(e.updated_at),error:this.toSdkError(null==e?void 0:e.error)})):[]}isRecordingRunning(e){return!!e&&!["none","paused","stopped","failed"].includes(e)}isStreamingRunning(e){return!!e&&!["none","stopped","failed"].includes(e)}initHLS(e){let t=this.store.getRoom(),i={running:!0,variants:[]};return t?null!=e&&e.variants&&e.variants.forEach((t,s)=>{var r,n,a;"initialised"!==t.state?i.variants.push({meetingURL:null==t?void 0:t.meetingURL,url:null==t?void 0:t.url,metadata:null==t?void 0:t.metadata,playlist_type:null==t?void 0:t.playlist_type,startedAt:a5(null==(r=null==e?void 0:e.variants)?void 0:r[s].started_at),initialisedAt:a5(null==(n=null==e?void 0:e.variants)?void 0:n[s].initialised_at),state:t.state,stream_type:null==t?void 0:t.stream_type}):i.variants.push({initialisedAt:a5(null==(a=null==e?void 0:e.variants)?void 0:a[s].initialised_at),url:""})}):tV.w(this.TAG,"on hls - room not present"),i}updateHLSStatus(e){var t;let i=this.store.getRoom(),s=!!e.variants&&e.variants.length>0&&e.variants.some(e=>this.isStreamingRunning(e.state));if(!i)return void tV.w(this.TAG,"on hls - room not present");e.enabled=s,i.hls=this.convertHls(e),null==(t=this.listener)||t.onRoomUpdate("HLS_STREAMING_STATE_UPDATED",i)}handleTranscriptionStatus(e){var t;let i=this.store.getRoom();if(!i)return void tV.w(this.TAG,"on transcription - room not present");i.transcriptions=this.addTranscriptionDetail(e)||[],null==(t=this.listener)||t.onRoomUpdate("TRANSCRIPTION_STATE_UPDATED",i)}convertHls(e){var t;if(null!=e&&e.variants&&e.variants.length>0&&e.variants.some(e=>"initialised"===e.state))return this.initHLS(e);let i={running:!!(null!=e&&e.enabled),variants:[],error:this.toSdkError(null==e?void 0:e.error)};return null==(t=null==e?void 0:e.variants)||t.forEach(e=>{i.variants.push({meetingURL:null==e?void 0:e.meeting_url,url:null==e?void 0:e.url,metadata:null==e?void 0:e.metadata,playlist_type:null==e?void 0:e.playlist_type,startedAt:a5(null==e?void 0:e.started_at),initialisedAt:a5(null==e?void 0:e.initialised_at),state:e.state,stream_type:null==e?void 0:e.stream_type})}),i}getHLSRecording(e){var t,i;let s={running:!1},r=this.isRecordingRunning(null==e?void 0:e.state);return(r||(null==e?void 0:e.state)==="paused")&&(s={running:r,singleFilePerLayer:!!(null!=(t=null==e?void 0:e.hls_recording)&&t.single_file_per_layer),hlsVod:!!(null!=(i=null==e?void 0:e.hls_recording)&&i.hls_vod),startedAt:a5(null==e?void 0:e.started_at),initialisedAt:a5(null==e?void 0:e.initialised_at),state:null==e?void 0:e.state,error:this.toSdkError(null==e?void 0:e.error)}),s}getPeerListHLSRecording(e){var t,i;let s=null==e?void 0:e.hls;return{running:this.isRecordingRunning(null==s?void 0:s.state),startedAt:a5(null==s?void 0:s.started_at),initialisedAt:a5(null==s?void 0:s.initialised_at),state:null==s?void 0:s.state,singleFilePerLayer:null==(t=null==s?void 0:s.config)?void 0:t.single_file_per_layer,hlsVod:null==(i=null==s?void 0:s.config)?void 0:i.hls_vod}}getPeerListBrowserRecording(e){let t=null==e?void 0:e.browser;return{running:this.isRecordingRunning(null==t?void 0:t.state),startedAt:a5(null==t?void 0:t.started_at),state:null==t?void 0:t.state}}getPeerListSFURecording(e){let t=null==e?void 0:e.sfu;return{running:this.isRecordingRunning(null==t?void 0:t.state),startedAt:a5(null==t?void 0:t.started_at),state:null==t?void 0:t.state}}updateRecordingStatus(e){var t;let i,s=this.store.getRoom(),r=this.isRecordingRunning(e.state);if(!s)return void tV.w(this.TAG,`set recording status running=${r} - room not present`);"sfu"===e.type?(s.recording.server={running:r,startedAt:r?a5(e.started_at):void 0,error:this.toSdkError(e.error),state:e.state},i="SERVER_RECORDING_STATE_UPDATED"):"HLS"===e.type?(s.recording.hls=this.getHLSRecording(e),i="RECORDING_STATE_UPDATED"):(s.recording.browser={running:r,startedAt:r?a5(e.started_at):void 0,error:this.toSdkError(e.error),state:null==e?void 0:e.state},i="BROWSER_RECORDING_STATE_UPDATED"),null==(t=this.listener)||t.onRoomUpdate(i,s)}updateRTMPStatus(e){var t,i;let s=this.store.getRoom(),r=this.isStreamingRunning(e.state);if(!s)return void tV.w(this.TAG,"on policy change - room not present");if(!r){s.rtmp={running:r,state:e.state,error:this.toSdkError(e.error)},null==(t=this.listener)||t.onRoomUpdate("RTMP_STREAMING_STATE_UPDATED",s);return}s.rtmp={running:r,startedAt:r?a5(e.started_at):void 0,state:e.state,error:this.toSdkError(e.error)},null==(i=this.listener)||i.onRoomUpdate("RTMP_STREAMING_STATE_UPDATED",s)}toSdkError(e){if(!(null!=e&&e.code))return;let t=e.message||"error in streaming/recording",i=new i$(e.code,"ServerErrors","NONE",t,t);return tV.e(this.TAG,"error in streaming/recording",i),i}},on=class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){"on-metadata-change"===e&&this.handleMetadataChange(t)}handleMetadataChange(e){var t;let i=e.values.map(e=>({key:e.key,value:e.data,updatedAt:a5(e.updated_at),updatedBy:e.updated_by?this.store.getPeerById(e.updated_by):void 0}));null==(t=this.listener)||t.onSessionStoreUpdate(i)}},oa=class{constructor(e,t,i){this.store=e,this.transport=t,this.listener=i}handleNotification(e,t){"on-whiteboard-update"===e&&this.handleWhiteboardUpdate(t)}handleWhiteboardUpdate(e){return tP(this,null,function*(){var t;let i=this.store.getLocalPeer(),s=this.store.getWhiteboard(e.id),r=e.owner===(null==i?void 0:i.peerId)||e.owner===(null==i?void 0:i.customerUserId),n="open"===e.state,a={id:e.id,title:e.title,attributes:e.attributes};if(a.open=r?null==s?void 0:s.open:n,a.owner=a.open?e.owner:void 0,a.open)if(r)a.url=null==s?void 0:s.url,a.token=null==s?void 0:s.token,a.addr=null==s?void 0:s.addr,a.permissions=null==s?void 0:s.permissions;else{let t=yield this.transport.signal.getWhiteboard({id:e.id});a.url=a8(t.token,t.addr,this.store.getEnv()),a.token=t.token,a.addr=t.addr,a.permissions=t.permissions,a.open=t.permissions.length>0}this.store.setWhiteboard(a),null==(t=this.listener)||t.onWhiteboardUpdate(a)})}},oo=class{constructor(e,t,i,s,r,n){this.store=e,this.transport=i,this.listener=s,this.audioListener=r,this.connectionQualityListener=n,this.TAG="[HMSNotificationManager]",this.hasConsistentRoomStateArrived=!1,this.ignoreNotification=e=>{if("peer-list"===e)this.hasConsistentRoomStateArrived=!0;else if("room-state"===e)return this.hasConsistentRoomStateArrived;return!1},this.handleTrackAdd=e=>{this.trackManager.handleTrackAdd(e)},this.handleTrackRemove=e=>{this.trackManager.handleTrackRemove(e)},this.updateLocalPeer=({name:e,metadata:t})=>{let i=this.store.getLocalPeer();this.peerManager.handlePeerInfoUpdate({peer:i,name:e,data:t})};let a=this.transport.isFlagEnabled("onDemandTracks");this.trackManager=a?new a2(this.store,t,this.transport,this.listener):new a1(this.store,t,this.listener),this.peerManager=new a4(this.store,this.trackManager,this.listener),this.peerListManager=new a3(this.store,this.peerManager,this.trackManager,this.listener),this.broadcastManager=new aZ(this.listener),this.policyChangeManager=new a6(this.store,t),this.requestManager=new os(this.store,this.listener),this.activeSpeakerManager=new aX(this.store,this.listener,this.audioListener),this.connectionQualityManager=new a0(this.store,this.connectionQualityListener),this.roomUpdateManager=new or(this.store,this.listener),this.sessionMetadataManager=new on(this.store,this.listener),this.pollsManager=new oi(this.store,this.transport,this.listener),this.whiteboardManager=new oa(this.store,this.transport,this.listener)}setListener(e){this.listener=e,this.trackManager.listener=e,this.peerManager.listener=e,this.peerListManager.listener=e,this.broadcastManager.listener=e,this.requestManager.listener=e,this.activeSpeakerManager.listener=e,this.roomUpdateManager.listener=e,this.sessionMetadataManager.listener=e,this.pollsManager.listener=e,this.whiteboardManager.listener=e}setAudioListener(e){this.audioListener=e,this.activeSpeakerManager.audioListener=e}setConnectionQualityListener(e){this.connectionQualityListener=e,this.connectionQualityManager.listener=e}handleNotification(e,t=!1){var i,s;let r=e.method,n=e.params;["active-speakers","sfu-stats","on-connection-quality-update",void 0].includes(r)||tV.d(this.TAG,`Received notification - ${r}`,{notification:n}),"sfu-stats"===r&&null!=(i=window.HMS)&&i.ON_SFU_STATS&&"function"==typeof(null==(s=window.HMS)?void 0:s.ON_SFU_STATS)&&window.HMS.ON_SFU_STATS(e.params),this.ignoreNotification(r)||(this.roomUpdateManager.handleNotification(r,n),this.peerManager.handleNotification(r,n),this.requestManager.handleNotification(r,n),this.peerListManager.handleNotification(r,n,t),this.broadcastManager.handleNotification(r,n),this.sessionMetadataManager.handleNotification(r,n),this.pollsManager.handleNotification(r,n),this.whiteboardManager.handleNotification(r,n),this.handleIsolatedMethods(r,n))}handleIsolatedMethods(e,t){switch(e){case"on-track-add":this.trackManager.handleTrackMetadataAdd(t);break;case"on-track-update":this.trackManager.handleTrackUpdate(t);break;case"on-track-remove":if(!t.peer)return void tV.d(this.TAG,`Ignoring sfu notification - ${e}`,{notification:t});this.trackManager.handleTrackRemovedPermanently(t);break;case"on-track-layer-update":this.trackManager.handleTrackLayerUpdate(t);break;case"active-speakers":this.activeSpeakerManager.handleActiveSpeakers(t);break;case"on-connection-quality-update":this.connectionQualityManager.handleQualityUpdate(t);break;case"on-policy-change":this.policyChangeManager.handlePolicyChange(t);break;case"node-info":this.transport.setSFUNodeId(t.sfu_node_id)}}},ol=class{constructor(e){this.transport=e,this.observedKeys=new Set}get(e){return tP(this,null,function*(){let{data:t,updated_at:i}=yield this.transport.signal.getSessionMetadata(e);return{value:t,updatedAt:a5(i)}})}set(e,t){return tP(this,null,function*(){let{data:i,updated_at:s}=yield this.transport.signal.setSessionMetadata({key:e,data:t});return{value:i,updatedAt:a5(s)}})}observe(e){return tP(this,null,function*(){let t=new Set(this.observedKeys);if(e.forEach(e=>this.observedKeys.add(e)),this.observedKeys.size!==t.size)try{yield this.transport.signal.listenMetadataChange(Array.from(this.observedKeys))}catch(e){throw this.observedKeys=t,e}})}unobserve(e){return tP(this,null,function*(){let t=new Set(this.observedKeys);if(this.observedKeys=new Set([...this.observedKeys].filter(t=>!e.includes(t))),this.observedKeys.size!==t.size)try{yield this.transport.signal.listenMetadataChange(Array.from(this.observedKeys))}catch(e){throw this.observedKeys=t,e}})}},od=class{constructor(e,t,i="",s="",r="https://prod-init.100ms.live/init",n=!1,a){this.authToken=e,this.peerId=t,this.peerName=i,this.data=s,this.endpoint=r,this.autoSubscribeVideo=n,this.iceServers=a}},oc=((C=oc||{})[C.ConnectFailed=0]="ConnectFailed",C[C.SignalDisconnect=1]="SignalDisconnect",C[C.JoinWSMessageFailed=2]="JoinWSMessageFailed",C[C.PublishIceConnectionFailed=3]="PublishIceConnectionFailed",C[C.SubscribeIceConnectionFailed=4]="SubscribeIceConnectionFailed",C),ou={0:[],1:[],2:[1],3:[1],4:[1]},oh=((E=oh||{}).Disconnected="Disconnected",E.Connecting="Connecting",E.Joined="Joined",E.Preview="Preview",E.Failed="Failed",E.Reconnecting="Reconnecting",E.Leaving="Leaving",E),op=class{constructor(e){this.promise=new Promise((t,i)=>{this.resolve=t,this.reject=i,e(t,i)})}},ov=class{constructor(e,t){this.onStateChange=e,this.sendEvent=t,this.TAG="[RetryScheduler]",this.inProgress=new Map,this.retryTaskIds=[]}schedule(e){return tP(this,arguments,function*({category:e,error:t,task:i,originalState:s,maxRetryTime:r=6e4,changeState:n=!0}){yield this.scheduleTask({category:e,error:t,changeState:n,task:i,originalState:s,maxRetryTime:r,failedAt:Date.now()})})}reset(){this.retryTaskIds.forEach(e=>clearTimeout(e)),this.retryTaskIds=[],this.inProgress.clear()}isTaskInProgress(e){return!!this.inProgress.get(e)}scheduleTask(e){return tP(this,arguments,function*({category:e,error:t,changeState:i,task:s,originalState:r,failedAt:n,maxRetryTime:a=6e4,failedRetryCount:o=0}){let l;if(tV.d(this.TAG,"schedule: ",{category:oc[e],error:t}),0===o){let i=this.inProgress.get(e);if(i){tV.d(this.TAG,`schedule: Already a task for ${oc[e]} scheduled, waiting for its completion`),yield i.promise;return}let s=new op((e,t)=>{});this.inProgress.set(e,s),this.sendEvent(t,e)}let d=!1,c=ou[e];for(let t in c){let i=c[parseInt(t)];try{let t=this.inProgress.get(i);t&&(tV.d(this.TAG,`schedule: Suspending retry task of ${oc[e]}, waiting for ${oc[i]} to recover`),yield t.promise,tV.d(this.TAG,`schedule: Resuming retry task ${oc[e]} as it's dependency ${oc[i]} is recovered`))}catch(t){tV.d(this.TAG,`schedule: Stopping retry task of ${oc[e]} as it's dependency ${oc[i]} failed to recover`),d=!0;break}}let u=t=>{if(this.inProgress.delete(e),this.sendEvent(t,e),this.reset(),i)this.onStateChange("Failed",t);else throw t},h=Date.now()-n;if(h>=a||d)return t.description+=`. [${oc[e]}] Could not recover after ${h} milliseconds`,d&&(t.description+=` Could not recover all of it's required dependencies - [${c.map(e=>oc[e]).toString()}]`),t.isTerminal=!0,u(t);i&&this.onStateChange("Reconnecting",t);let p=this.getDelayForRetryCount(e);tV.d(this.TAG,`schedule: [${oc[e]}] [failedRetryCount=${o}] Scheduling retry task in ${p}ms`);try{l=yield this.setTimeoutPromise(s,p)}catch(t){if(l=!1,t.isTerminal)return tV.e(this.TAG,`[${oc[e]}] Un-caught terminal exception ${t.name} in retry-task`,t),u(t);tV.w(this.TAG,`[${oc[e]}] Un-caught exception ${t.name} in retry-task, initiating retry`,t)}if(l){let t=this.inProgress.get(e);this.inProgress.delete(e),null==t||t.resolve(o),i&&0===this.inProgress.size&&this.onStateChange(r),tV.d(this.TAG,`schedule: [${oc[e]}] [failedRetryCount=${o}] Recovered \u267B\uFE0F after ${h}ms`)}else yield this.scheduleTask({category:e,error:t,changeState:i,task:s,originalState:r,maxRetryTime:a,failedAt:n,failedRetryCount:o+1})})}getDelayForRetryCount(e){let t=2===e?2*Math.random():Math.random(),i=0;return 2===e?i=2+t:1===e&&(i=1),1e3*i}setTimeoutPromise(e,t){return tP(this,null,function*(){return new Promise((i,s)=>{let r=window.setTimeout(()=>tP(this,null,function*(){try{let t=yield e();t&&this.retryTaskIds.splice(this.retryTaskIds.indexOf(r),1),i(t)}catch(e){s(e)}}),t);this.retryTaskIds.push(r)})})}},og=class extends s5{constructor(){super(100),this.localStorage=new sR("hms-analytics"),this.localStorage.clear(),this.initLocalStorageQueue()}enqueue(e){super.enqueue(e),this.localStorage.set(this.storage)}dequeue(){let e=super.dequeue();return this.localStorage.set(this.storage),e}initLocalStorageQueue(){var e;null==(e=this.localStorage.get())||e.forEach(e=>{let t=new sF(e);super.enqueue(t)})}},om=class{constructor(){this.TAG="[AnalyticsTransport]",this.eventCount=0,this.lastResetTime=Date.now(),this.MAX_EVENTS_PER_MINUTE=200,this.RESET_INTERVAL_MS=6e4}checkRateLimit(){let e=Date.now();if(e-this.lastResetTime>=this.RESET_INTERVAL_MS&&(this.eventCount=0,this.lastResetTime=e),this.eventCount>=this.MAX_EVENTS_PER_MINUTE)throw Error("Too many events being sent, please check the implementation.");this.eventCount++}sendEvent(e){try{this.checkRateLimit()}catch(e){throw tV.w(this.TAG,"Rate limit exceeded",e),e}try{this.sendSingleEvent(e),this.flushFailedEvents()}catch(e){tV.w(this.TAG,"sendEvent failed",e)}}flushFailedEvents(e){var t;try{for(tV.d(this.TAG,"Flushing failed events",this.failedEvents);this.failedEvents.size()>0;){let i=this.failedEvents.dequeue();i&&((null==(t=i.metadata)?void 0:t.peer.peer_id)!==e&&i.metadata.peer.peer_id?aF.sendEvent(i):this.sendSingleEvent(i))}}catch(e){tV.w(this.TAG,"flushFailedEvents failed",e)}}sendSingleEvent(e){try{this.transportProvider.sendEvent(e),tV.d(this.TAG,"Sent event",e.name,e)}catch(t){throw tV.w(this.TAG,`${this.transportProvider.TAG}.sendEvent failed, adding to local storage events`,{event:e,error:t}),this.failedEvents.enqueue(e),t}}},of=class extends om{constructor(e){super(),this.transportProvider=e,this.failedEvents=new og}},oy=class{constructor(e,t,i,s){this.store=e,this.eventBus=t,this.sampleWindowSize=i,this.pushInterval=s,this.shouldSendEvent=!1,this.sequenceNum=1,this.stop=()=>{this.shouldSendEvent&&this.sendEvent(),this.eventBus.statsUpdate.unsubscribe(this.handleStatsUpdate.bind(this)),this.shouldSendEvent=!1},this.start()}start(){this.shouldSendEvent||(this.stop(),this.shouldSendEvent=!0,this.eventBus.statsUpdate.subscribe(this.handleStatsUpdate.bind(this)),this.startLoop().catch(e=>tV.e("[StatsAnalytics]",e.message)))}startLoop(){return tP(this,null,function*(){for(;this.shouldSendEvent;)yield s6(1e3*this.pushInterval),this.sendEvent()})}sendEvent(){this.trackAnalytics.forEach(e=>{e.clearSamples()})}cleanTrackAnalyticsAndCreateSample(e){this.trackAnalytics.forEach(e=>{this.store.hasTrack(e.track)||e.samples.length>0||this.trackAnalytics.delete(e.track_id)}),e&&this.trackAnalytics.forEach(e=>{e.createSample()})}},ok=class{constructor({track:e,ssrc:t,rid:i,kind:s,sampleWindowSize:r}){this.samples=[],this.tempStats=[],this.track=e,this.ssrc=t,this.rid=i,this.kind=s,this.track_id=this.track.trackId,this.source=this.track.source,this.sampleWindowSize=r}pushTempStat(e){this.tempStats.push(e)}createSample(){0!==this.tempStats.length&&(this.samples.push(this.collateSample()),this.prevLatestStat=this.getLatestStat(),this.tempStats.length=0)}clearSamples(){this.samples.length=0}getLatestStat(){return this.tempStats[this.tempStats.length-1]}getFirstStat(){return this.tempStats[0]}calculateSum(e){if("number"==typeof this.getLatestStat()[e])return this.tempStats.reduce((t,i)=>t+(i[e]||0),0)}calculateAverage(e,t=!0){let i=this.calculateSum(e),s=void 0!==i?i/this.tempStats.length:void 0;return s?t?Math.round(s):s:void 0}calculateDifferenceForSample(e){var t;let i=Number(null==(t=this.prevLatestStat)?void 0:t[e])||0;return(Number(this.getLatestStat()[e])||0)-i}calculateDifferenceAverage(e,t=!0){let i=this.calculateDifferenceForSample(e)/this.tempStats.length;return t?Math.round(i):i}calculateInstancesOfHigh(e,t){if("number"==typeof this.getLatestStat()[e])return this.tempStats.reduce((i,s)=>i+ +((s[e]||0)>t),0)}},ob=(e,t)=>e&&t&&(e.frameWidth!==t.frameWidth||e.frameHeight!==t.frameHeight),oT=(e,t)=>e&&t&&e.enabled!==t.enabled,oS=e=>Object.entries(e).filter(([,e])=>void 0!==e).reduce((e,[t,i])=>(e[t]=i,e),{}),ow=class extends oy{constructor(){super(...arguments),this.trackAnalytics=new Map}toAnalytics(){var e,t;let i=[],s=[];return this.trackAnalytics.forEach(e=>{"audio"===e.track.type?i.push(e.toAnalytics()):"video"===e.track.type&&s.push(e.toAnalytics())}),{audio:i,video:s,joined_at:null==(t=null==(e=this.store.getRoom())?void 0:e.joinedAt)?void 0:t.getTime(),sequence_num:this.sequenceNum++,max_window_sec:30}}sendEvent(){this.eventBus.analytics.publish(sj.publishStats(this.toAnalytics())),super.sendEvent()}handleStatsUpdate(e){let t=!1,i=e.getLocalTrackStats();Object.keys(i).forEach(s=>{let r=i[s],n=this.store.getLocalPeerTracks().find(e=>e.getTrackIDBeingSent()===s);Object.keys(r).forEach(i=>{var s,a,o;let l=r[i];if(!n)return;let d=this.getTrackIdentifier(n.trackId,l),c=tT(tb({},l),{availableOutgoingBitrate:null==(a=null==(s=e.getLocalPeerStats())?void 0:s.publish)?void 0:a.availableOutgoingBitrate});if(d&&this.trackAnalytics.has(d))null==(o=this.trackAnalytics.get(d))||o.pushTempStat(c);else if(n){let e=new oP({track:n,sampleWindowSize:this.sampleWindowSize,rid:l.rid,ssrc:l.ssrc.toString(),kind:l.kind});e.pushTempStat(c),this.trackAnalytics.set(this.getTrackIdentifier(n.trackId,l),e)}let u=this.trackAnalytics.get(d);null!=u&&u.shouldCreateSample()&&(t=!0)})}),this.cleanTrackAnalyticsAndCreateSample(t)}getTrackIdentifier(e,t){return t.rid?`${e}:${t.rid}`:e}},oP=class extends ok{constructor(){super(...arguments),this.samples=[],this.collateSample=()=>{let e=this.getLatestStat(),t=e.qualityLimitationDurations,i=t&&{bandwidth_sec:t.bandwidth,cpu_sec:t.cpu,other_sec:t.other},s=e.frameHeight?{height_px:this.getLatestStat().frameHeight,width_px:this.getLatestStat().frameWidth}:void 0,r=this.calculateAverage("jitter",!1),n=r?Math.round(1e3*r):void 0,a=this.calculateAverage("roundTripTime",!1),o=a?Math.round(1e3*a):void 0;return oS({timestamp:Date.now(),avg_available_outgoing_bitrate_bps:this.calculateAverage("availableOutgoingBitrate"),avg_bitrate_bps:this.calculateAverage("bitrate"),avg_fps:this.calculateAverage("framesPerSecond"),total_packets_lost:this.getLatestStat().packetsLost,total_packets_sent:this.getLatestStat().packetsSent,total_packet_sent_delay_sec:parseFloat(this.calculateDifferenceForSample("totalPacketSendDelay").toFixed(4)),total_fir_count:this.calculateDifferenceForSample("firCount"),total_pli_count:this.calculateDifferenceForSample("pliCount"),total_nack_count:this.calculateDifferenceForSample("nackCount"),avg_jitter_ms:n,avg_round_trip_time_ms:o,total_quality_limitation:i,resolution:s})},this.shouldCreateSample=()=>{let e=this.tempStats.length,t=this.tempStats[e-1],i=this.tempStats[e-2];return 30===e||oT(t,i)||"video"===t.kind&&ob(t,i)},this.toAnalytics=()=>({track_id:this.track_id,ssrc:this.ssrc,source:this.source,rid:this.rid,samples:this.samples})}},oC=class extends oy{constructor(){super(...arguments),this.trackAnalytics=new Map}toAnalytics(){var e,t;let i=[],s=[];return this.trackAnalytics.forEach(e=>{"audio"===e.track.type?i.push(e.toAnalytics()):"video"===e.track.type&&s.push(e.toAnalytics())}),{audio:i,video:s,joined_at:null==(t=null==(e=this.store.getRoom())?void 0:e.joinedAt)?void 0:t.getTime(),sequence_num:this.sequenceNum++,max_window_sec:10}}sendEvent(){this.eventBus.analytics.publish(sj.subscribeStats(this.toAnalytics())),super.sendEvent()}handleStatsUpdate(e){let t=e.getAllRemoteTracksStats(),i=!1;Object.keys(t).forEach(s=>{var r,n;let a,o,l,d,c=this.store.getTrackById(s),u=t[s],h=null==(r=this.trackAnalytics.get(s))?void 0:r.getLatestStat(),p=(a=(null==h?void 0:h.jitterBufferDelay)||0,o=(null==h?void 0:h.jitterBufferEmittedCount)||0,l=((null==u?void 0:u.jitterBufferDelay)||0)-a,(d=((null==u?void 0:u.jitterBufferEmittedCount)||0)-o)>0?1e3*l/d:(null==h?void 0:h.calculatedJitterBufferDelay)||0),v=this.calculateAvSyncForStat(u,e),g=tT(tb({},u),{calculatedJitterBufferDelay:p,avSync:v});if("video"===u.kind){let e=c.getPreferredLayerDefinition();g.expectedFrameHeight=null==e?void 0:e.resolution.height,g.expectedFrameWidth=null==e?void 0:e.resolution.width}if(this.trackAnalytics.has(s))null==(n=this.trackAnalytics.get(s))||n.pushTempStat(g);else if(c){let e=new oE({track:c,sampleWindowSize:this.sampleWindowSize,ssrc:u.ssrc.toString(),kind:u.kind});e.pushTempStat(g),this.trackAnalytics.set(s,e)}let m=this.trackAnalytics.get(s);null!=m&&m.shouldCreateSample()&&(i=!0)}),this.cleanTrackAnalyticsAndCreateSample(i)}calculateAvSyncForStat(e,t){if(!e.peerID||!e.estimatedPlayoutTimestamp||"video"!==e.kind)return;let i=this.store.getPeerById(e.peerID),s=null==i?void 0:i.audioTrack,r=null==i?void 0:i.videoTrack;if(!(s&&r&&s.enabled&&r.enabled))return 0x7fffffff;let n=t.getRemoteTrackStats(s.trackId);return n?n.estimatedPlayoutTimestamp?n.estimatedPlayoutTimestamp-e.estimatedPlayoutTimestamp:void 0:0x7fffffff}},oE=class extends ok{constructor(){super(...arguments),this.samples=[],this.collateSample=()=>{let e=this.getLatestStat(),t=this.getFirstStat(),i={timestamp:Date.now(),total_pli_count:this.calculateDifferenceForSample("pliCount"),total_nack_count:this.calculateDifferenceForSample("nackCount"),avg_jitter_buffer_delay:this.calculateAverage("calculatedJitterBufferDelay",!1)};if("video"===e.kind)return oS(tT(tb({},i),{avg_av_sync_ms:this.calculateAvgAvSyncForSample(),avg_frames_received_per_sec:this.calculateDifferenceAverage("framesReceived"),avg_frames_dropped_per_sec:this.calculateDifferenceAverage("framesDropped"),avg_frames_decoded_per_sec:this.calculateDifferenceAverage("framesDecoded"),frame_width:this.calculateAverage("frameWidth"),frame_height:this.calculateAverage("frameHeight"),expected_frame_width:this.calculateAverage("expectedFrameWidth"),expected_frame_height:this.calculateAverage("expectedFrameHeight"),pause_count:this.calculateDifferenceForSample("pauseCount"),pause_duration_seconds:this.calculateDifferenceForSample("totalPausesDuration"),freeze_count:this.calculateDifferenceForSample("freezeCount"),freeze_duration_seconds:this.calculateDifferenceForSample("totalFreezesDuration")}));{let s=(e.concealedSamples||0)-(e.silentConcealedSamples||0)-((t.concealedSamples||0)-(t.silentConcealedSamples||0));return oS(tT(tb({},i),{audio_level:this.calculateInstancesOfHigh("audioLevel",.05),audio_concealed_samples:s,audio_total_samples_received:this.calculateDifferenceForSample("totalSamplesReceived"),audio_concealment_events:this.calculateDifferenceForSample("concealmentEvents"),fec_packets_discarded:this.calculateDifferenceForSample("fecPacketsDiscarded"),fec_packets_received:this.calculateDifferenceForSample("fecPacketsReceived"),total_samples_duration:this.calculateDifferenceForSample("totalSamplesDuration"),total_packets_received:this.calculateDifferenceForSample("packetsReceived"),total_packets_lost:this.calculateDifferenceForSample("packetsLost")}))}},this.shouldCreateSample=()=>{let e=this.tempStats.length,t=this.tempStats[e-1],i=this.tempStats[e-2];return 10===e||oT(t,i)||"video"===t.kind&&ob(t,i)},this.toAnalytics=()=>({track_id:this.track_id,ssrc:this.ssrc,source:this.source,rid:this.rid,samples:this.samples})}calculateAvgAvSyncForSample(){let e=this.tempStats.map(e=>e.avSync).filter(e=>void 0!==e&&0x7fffffff!==e);return 0===e.length?0x7fffffff:e.reduce((e,t)=>e+t,0)/e.length}},oI=((I=oI||{})[I.Publish=0]="Publish",I[I.Subscribe=1]="Subscribe",I),oA="[HMSConnection]",oR=class{constructor(e,t){this.candidates=[],this.role=e,this.signal=t}get iceConnectionState(){return this.nativeConnection.iceConnectionState}get connectionState(){return this.nativeConnection.connectionState}get action(){return 0===this.role?"PUBLISH":"SUBSCRIBE"}setSfuNodeId(e){this.sfuNodeId=e}addTransceiver(e,t){return this.nativeConnection.addTransceiver(e,t)}createOffer(e,t){return tP(this,null,function*(){try{var i;let s=yield this.nativeConnection.createOffer(t);return tV.d(oA,`[role=${this.role}] createOffer offer=${JSON.stringify(s,null,1)}`),(i=function(e,t){var i;let s=tJ(e.sdp);if(!(null!=(i=s.origin)&&i.username.startsWith("mozilla")))return e;let r=t?Array.from(t.values()):[];return s.media.forEach(e=>{var t,i,s;let n=null==(t=e.msid)?void 0:t.split(" ")[0],a=null==(i=r.find(t=>t.type===e.type&&t.stream_id===n))?void 0:i.track_id;a&&(e.msid=null==(s=e.msid)?void 0:s.replace(/\s(.+)/,` ${a}`))}),{type:e.type,sdp:tK(s)}}(s,e)).sdp.includes("usedtx=1")?i:{type:i.type,sdp:i.sdp.replace("useinbandfec=1","useinbandfec=1;usedtx=1")}}catch(e){throw ss(this.action,e.message)}})}createAnswer(e){return tP(this,null,function*(){try{let t=yield this.nativeConnection.createAnswer(e);return tV.d(oA,`[role=${this.role}] createAnswer answer=${JSON.stringify(t,null,1)}`),t}catch(e){throw sr(this.action,e.message)}})}setLocalDescription(e){return tP(this,null,function*(){try{tV.d(oA,`[role=${this.role}] setLocalDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setLocalDescription(e)}catch(e){throw sn(this.action,e.message)}})}setRemoteDescription(e){return tP(this,null,function*(){try{tV.d(oA,`[role=${this.role}] setRemoteDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setRemoteDescription(e)}catch(e){throw sa(this.action,e.message)}})}addIceCandidate(e){return tP(this,null,function*(){if("closed"===this.nativeConnection.signalingState)return void tV.d(oA,`[role=${this.role}] addIceCandidate signalling state closed`);tV.d(oA,`[role=${this.role}] addIceCandidate candidate=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.addIceCandidate(e)})}get remoteDescription(){return this.nativeConnection.remoteDescription}getSenders(){return this.nativeConnection.getSenders()}handleSelectedIceCandidatePairs(){try{(0===this.role?this.getSenders():this.getReceivers()).forEach(e=>{var t;let i=null==(t=e.track)?void 0:t.kind;if(e.transport){let t=e.transport.iceTransport,s=()=>{"function"==typeof t.getSelectedCandidatePair&&(this.selectedCandidatePair=t.getSelectedCandidatePair(),this.selectedCandidatePair&&(this.observer.onSelectedCandidatePairChange(this.selectedCandidatePair),tV.d(oA,`${oI[this.role]} connection`,`selected ${i||"unknown"} candidate pair`,JSON.stringify(this.selectedCandidatePair,null,2))))};"function"==typeof t.onselectedcandidatepairchange&&(t.onselectedcandidatepairchange=s),s()}})}catch(e){tV.w(oA,`Error in logging selected ice candidate pair for ${oI[this.role]} connection`,e)}}removeTrack(e){"closed"!==this.nativeConnection.signalingState&&this.nativeConnection.removeTrack(e)}setMaxBitrateAndFramerate(e,t){return tP(this,null,function*(){let i=(null==t?void 0:t.maxBitrate)||e.settings.maxBitrate,s=e instanceof rU&&e.settings.maxFramerate,r=this.getSenders().find(t=>{var i;return(null==(i=null==t?void 0:t.track)?void 0:i.id)===e.getTrackIDBeingSent()});if(r){let e=r.getParameters();1===e.encodings.length&&(i&&(e.encodings[0].maxBitrate=1e3*i),s&&(e.encodings[0].maxFramerate=s)),yield r.setParameters(e)}else tV.w(oA,`no sender found to setMaxBitrate for track - ${e.trackId}, sentTrackId - ${e.getTrackIDBeingSent()}`)})}getStats(){return tP(this,null,function*(){return yield this.nativeConnection.getStats()})}close(){this.nativeConnection.close()}getReceivers(){return this.nativeConnection.getReceivers()}},o_=class extends oR{constructor(e,t,i){super(0,e),this.TAG="[HMSPublishConnection]",this.observer=i,this.nativeConnection=new RTCPeerConnection(t),this.channel=this.nativeConnection.createDataChannel(rF,{protocol:"SCTP"}),this.channel.onerror=e=>tV.e(this.TAG,`publish data channel onerror ${e}`,e),this.nativeConnection.onicecandidate=({candidate:t})=>{t&&(this.observer.onIceCandidate(t),e.trickle(this.role,t))},this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState),this.nativeConnection.sctp&&(this.nativeConnection.sctp.transport.onstatechange=()=>{var e;this.observer.onDTLSTransportStateChange(null==(e=this.nativeConnection.sctp)?void 0:e.transport.state)},this.nativeConnection.sctp.transport.onerror=e=>{var t;this.observer.onDTLSTransportError(Error(null==(t=null==e?void 0:e.error)?void 0:t.errorDetail))})}}close(){super.close(),this.channel.close()}initAfterJoin(){this.nativeConnection.onnegotiationneeded=()=>tP(this,null,function*(){tV.d(this.TAG,"onnegotiationneeded"),yield this.observer.onRenegotiationNeeded()})}},oL=class{constructor(e,t,i=""){this.TAG="[HMSDataChannel]",this.nativeChannel=e,this.observer=t,this.metadata=i,e.onmessage=e=>{this.observer.onMessage(e.data)}}get id(){return this.nativeChannel.id}get label(){return this.nativeChannel.label}get readyState(){return this.nativeChannel.readyState}send(e){tV.d(this.TAG,`[${this.metadata}] Sending [size=${e.length}] message=${e}`),this.nativeChannel.send(e)}close(){this.nativeChannel.close()}},oM=class extends oR{constructor(e,t,i,s){super(1,e),this.isFlagEnabled=i,this.TAG="[HMSSubscribeConnection]",this.remoteStreams=new Map,this.MAX_RETRIES=3,this.pendingMessageQueue=[],this.eventEmitter=new(_(eK))({maxListeners:60}),this.handlePendingApiMessages=()=>{this.eventEmitter.emit("open",!0),this.pendingMessageQueue.length>0&&(tV.d(this.TAG,"Found pending message queue, sending messages"),this.pendingMessageQueue.forEach(e=>this.sendOverApiDataChannel(e)),this.pendingMessageQueue.length=0)},this.sendMessage=(e,t)=>tP(this,null,function*(){var i;let s;(null==(i=this.apiChannel)?void 0:i.readyState)!=="open"&&(yield this.eventEmitter.waitFor("open"));for(let i=0;i<this.MAX_RETRIES;i++){this.apiChannel.send(e);let r=(s=yield this.waitForResponse(t)).error;if(r){if(404===r.code){tV.d(this.TAG,`Track not found ${t}`,{request:e,try:i+1,error:r});break}if(tV.d(this.TAG,`Failed sending ${t}`,{request:e,try:i+1,error:r}),r.code/100!=5&&429!==r.code)throw Error(`code=${r.code}, message=${r.message}`);let s=(2+2*Math.random())*1e3;yield s9(s)}else break}return s}),this.waitForResponse=e=>tP(this,null,function*(){let t=JSON.parse((yield this.eventEmitter.waitFor("message",function(t){return t.includes(e)}))[0]);return tV.d(this.TAG,`response for ${e} -`,JSON.stringify(t,null,2)),t}),this.observer=s,this.nativeConnection=new RTCPeerConnection(t),this.initNativeConnectionCallbacks()}initNativeConnectionCallbacks(){this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)},this.nativeConnection.ondatachannel=e=>{e.channel.label===rF&&(this.apiChannel=new oL(e.channel,{onMessage:e=>{this.eventEmitter.emit("message",e),this.observer.onApiChannelMessage(e)}},`role=${this.role}`),e.channel.onopen=this.handlePendingApiMessages)},this.nativeConnection.onicecandidate=e=>{null!==e.candidate&&(this.observer.onIceCandidate(e.candidate),this.signal.trickle(this.role,e.candidate))},this.nativeConnection.ontrack=e=>{var t;let i=e.streams[0],s=i.id;if(!this.remoteStreams.has(s)){let e=new rH(i,this);this.remoteStreams.set(s,e)}i.addEventListener("removetrack",t=>{if(t.track.id!==e.track.id)return;let i=r.tracks.findIndex(i=>{var s;return i.nativeTrack.id===t.track.id&&e.transceiver.mid===(null==(s=i.transceiver)?void 0:s.mid)});if(i>=0){let e=r.tracks[i];this.observer.onTrackRemove(e),r.tracks.splice(i,1),0===r.tracks.length&&this.remoteStreams.delete(s)}});let r=this.remoteStreams.get(s),n="audio"===e.track.kind,a=n?rf:rG,o=n?new a(r,e.track):new a(r,e.track,void 0,this.isFlagEnabled("disableNoneLayerRequest"));"video"===e.track.kind&&r.setVideoLayerLocally("none","addTrack","subscribeConnection"),o.transceiver=e.transceiver;let l=function(e,t){var i;if(!(null!=e&&e.sdp)||!t)return;let s=tJ(e.sdp).media.find(e=>sM(e.mid)&&parseInt(e.mid)===parseInt(t));return null==(i=null==s?void 0:s.msid)?void 0:i.split(" ")[1]}(this.remoteDescription,null==(t=e.transceiver)?void 0:t.mid);l&&o.setSdpTrackId(l),r.tracks.push(o),this.observer.onTrackAdd(o)}}sendOverApiDataChannel(e){this.apiChannel&&"open"===this.apiChannel.readyState?this.apiChannel.send(e):(tV.w(this.TAG,`API Data channel not ${this.apiChannel?"open":"present"}, queueing`,e),this.pendingMessageQueue.push(e))}sendOverApiDataChannelWithResponse(e,t){return tP(this,null,function*(){let i=V();if("prefer-video-track-state"===e.method&&this.isFlagEnabled("disableVideoTrackAutoUnsubscribe")&&"none"===e.params.max_spatial_layer)return tV.d(this.TAG,"video auto unsubscribe is disabled, request is ignored"),{id:i};let s=JSON.stringify(tb({id:t||i,jsonrpc:"2.0"},e));return this.sendMessage(s,i)})}close(){var e;super.close(),null==(e=this.apiChannel)||e.close()}},oD="[InitService]",oO=class{static handleError(e,t){switch(e.status){case 404:throw iQ("INIT",t.message||e.statusText);case 200:break;default:throw iJ(t.code||e.status,"INIT",t.message||(null==e?void 0:e.statusText))}}static fetchInitConfig(e){return tP(this,arguments,function*({token:e,peerId:t,userAgent:i,initEndpoint:s="https://prod-init.100ms.live",region:r="",iceServers:n}){tV.d(oD,`fetchInitConfig: initEndpoint=${s} token=${e} peerId=${t} region=${r} `);let a=function(e,t,i,s){try{let r=new URL("/init",e);return s&&s.trim().length>0&&r.searchParams.set("region",s.trim()),r.searchParams.set("peer_id",t),r.searchParams.set("user_agent_v2",i),r.toString()}catch(e){throw tV.e(oD,e.name,e.message),e}}(s,t,i,r);try{let t=yield fetch(a,{headers:{Authorization:`Bearer ${e}`}});try{let e=yield t.clone().json();return this.handleError(t,e),tV.d(oD,`config is ${JSON.stringify(e,null,2)}`),function(e,t){var i;let s;return tT(tb({},e),{rtcConfiguration:tT(tb({},e.rtcConfiguration),{iceServers:(s=null==(i=e.rtcConfiguration)?void 0:i.ice_servers,t&&0!==t.length?t.map(e=>({urls:e.urls,credentialType:"password",credential:e.password,username:e.userName})):s)})})}(e,n)}catch(i){let e=yield t.text();throw tV.e(oD,"json error",i.message,e),i instanceof i$?i:iJ(t.status,"INIT",i.message)}}catch(e){throw["Failed to fetch","NetworkError","ECONNRESET"].some(t=>e.message.includes(t))?iQ("INIT",e.message):e}})}},oN=class{constructor(e){this.TAG="[SIGNAL]: ",this.pongResponseTimes=new s5(5),this.isJoinCompleted=!1,this.pendingTrickle=[],this.socket=null,this.callbacks=new Map,this._isConnected=!1,this.id=0,this.onCloseHandler=()=>{},this.resolvePingOnAnyResponse=()=>{this.callbacks.forEach((e,t)=>{var i;(null==(i=e.metadata)?void 0:i.method)==="ping"&&(e.resolve({timestamp:Date.now()}),this.callbacks.delete(t))})},this.offlineListener=()=>{tV.d(this.TAG,"Window network offline"),this.setIsConnected(!1,"Window network offline")},this.onlineListener=()=>{tV.d(this.TAG,"Window network online"),this.observer.onNetworkOnline()},this.observer=e,window.addEventListener("offline",this.offlineListener),window.addEventListener("online",this.onlineListener),this.onMessageHandler=this.onMessageHandler.bind(this)}get isConnected(){return this._isConnected}setSfuNodeId(e){this.sfuNodeId=e}setIsConnected(e,t=""){tV.d(this.TAG,`isConnected set id: ${this.id}, oldValue: ${this._isConnected}, newValue: ${e}`),this._isConnected!==e&&(this._isConnected&&!e?(this._isConnected=e,this.rejectPendingCalls(t),this.observer.onOffline(t)):!this._isConnected&&e&&(this._isConnected=e,this.observer.onOnline()))}getPongResponseTimes(){return this.pongResponseTimes.toList()}internalCall(e,t){return tP(this,null,function*(){var i;let s=V();null==(i=this.socket)||i.send(JSON.stringify({method:e,params:t,id:s,jsonrpc:"2.0"}));try{return yield new Promise((t,i)=>{this.callbacks.set(s,{resolve:t,reject:i,metadata:{method:e}})})}catch(t){if(t instanceof i$)throw t;throw sc(Number(t.code),iq(e),t.message)}})}notify(e,t){var i,s;(null==(i=this.socket)?void 0:i.readyState)===WebSocket.OPEN&&(null==(s=this.socket)||s.send(JSON.stringify({method:e,params:t})))}open(e){return new Promise((t,i)=>{let s=!1;this.socket&&(this.socket.close(),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)),this.socket=new WebSocket(e);let r=()=>{tV.e(this.TAG,"Error from websocket"),s=!0,i(iW("JOIN","Error opening websocket connection"))};this.onCloseHandler=e=>{tV.w(`Websocket closed code=${e.code}`),s?this.setIsConnected(!1,`code: ${e.code}${1e3!==e.code?", unexpected websocket close":""}`):(s=!0,i(iK("JOIN",`Error opening websocket connection - websocket closed unexpectedly with code=${e.code}`)))},this.socket.addEventListener("error",r);let n=()=>{var e,i;s=!0,t(),this.setIsConnected(!0),this.id++,null==(e=this.socket)||e.removeEventListener("open",n),null==(i=this.socket)||i.removeEventListener("error",r),this.pingPongLoop(this.id)};this.socket.addEventListener("open",n),this.socket.addEventListener("close",this.onCloseHandler),this.socket.addEventListener("message",this.onMessageHandler)})}close(){return tP(this,null,function*(){window.removeEventListener("offline",this.offlineListener),window.removeEventListener("online",this.onlineListener),this.socket?(this.socket.close(1e3,"Normal Close"),this.setIsConnected(!1,"code: 1000, normal websocket close"),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)):this.setIsConnected(!1,"websocket not connected yet")})}join(e,t,i,s,r,n,a){return tP(this,null,function*(){if(!this.isConnected)throw iz("JOIN","Failed to send join over WS connection");let o=yield this.internalCall("join",{name:e,disableVidAutoSub:i,data:t,offer:a,server_sub_degrade:s,simulcast:r,onDemandTracks:n});return this.isJoinCompleted=!0,this.pendingTrickle.forEach(({target:e,candidate:t})=>this.trickle(e,t)),this.pendingTrickle.length=0,tV.d(this.TAG,`join: response=${JSON.stringify(o,null,1)}`),o})}trickle(e,t){this.isJoinCompleted?this.notify("trickle",{target:e,candidate:t,sfu_node_id:this.sfuNodeId}):this.pendingTrickle.push({target:e,candidate:t})}offer(e,t){return tP(this,null,function*(){return yield this.call("offer",{desc:e,tracks:Object.fromEntries(t),sfu_node_id:this.sfuNodeId})})}answer(e){this.notify("answer",{desc:e,sfu_node_id:this.sfuNodeId})}trackUpdate(e){this.notify("track-update",{tracks:Object.fromEntries(e)})}broadcast(e){return tP(this,null,function*(){return yield this.call("broadcast",e)})}leave(e){this.notify("leave",{client_reason:e})}endRoom(e,t){return tP(this,null,function*(){yield this.call("end-room",{lock:e,reason:t})})}sendEvent(e){if(!this.isConnected)throw Error(`${this.TAG} not connected. Could not send event ${e}`);this.notify("analytics",e.toSignalParams())}ping(e){let t=Date.now();return Promise.race([new Promise(i=>{setTimeout(()=>{i(Date.now()-t)},e+1)}),this.internalCall("ping",{timestamp:t}).then(()=>Date.now()-t).catch(()=>Date.now()-t)])}requestRoleChange(e){return tP(this,null,function*(){yield this.call("role-change-request",e)})}requestBulkRoleChange(e){return tP(this,null,function*(){yield this.call("role-change-request",e)})}acceptRoleChangeRequest(e){return tP(this,null,function*(){yield this.call("role-change",e)})}requestTrackStateChange(e){return tP(this,null,function*(){yield this.call("track-update-request",e)})}requestMultiTrackStateChange(e){return tP(this,null,function*(){yield this.call("change-track-mute-state-request",e)})}removePeer(e){return tP(this,null,function*(){yield this.call("peer-leave-request",e)})}startRTMPOrRecording(e){return tP(this,null,function*(){yield this.call("rtmp-start",tb({},e))})}stopRTMPAndRecording(){return tP(this,null,function*(){yield this.call("rtmp-stop",{})})}startHLSStreaming(e){return tP(this,null,function*(){yield this.call("hls-start",tb({},e))})}stopHLSStreaming(e){return tP(this,null,function*(){yield this.call("hls-stop",tb({},e))})}startTranscription(e){return tP(this,null,function*(){yield this.call("transcription-start",tb({},e))})}stopTranscription(e){return tP(this,null,function*(){yield this.call("transcription-stop",tb({},e))})}sendHLSTimedMetadata(e){return tP(this,null,function*(){yield this.call("hls-timed-metadata",tb({},e))})}updatePeer(e){return tP(this,null,function*(){yield this.call("peer-update",tb({},e))})}getPeer(e){return tP(this,null,function*(){return yield this.call("get-peer",tb({},e))})}joinGroup(e){return tP(this,null,function*(){return yield this.call("group-join",{name:e})})}leaveGroup(e){return tP(this,null,function*(){return yield this.call("group-leave",{name:e})})}addToGroup(e,t){return tP(this,null,function*(){yield this.call("group-add",{name:t,peer_id:e})})}removeFromGroup(e,t){return tP(this,null,function*(){yield this.call("group-remove",{name:t,peer_id:e})})}peerIterNext(e){return tP(this,null,function*(){return yield this.call("peer-iter-next",e)})}findPeers(e){return tP(this,null,function*(){return yield this.call("find-peer",e)})}findPeerByName(e){return tP(this,null,function*(){return yield this.call("peer-name-search",e)})}setSessionMetadata(e){if(!this.isConnected)throw iz("RECONNECT_SIGNAL","Failed to set session store value due to network disconnection");return this.call("set-metadata",tb({},e))}listenMetadataChange(e){if(!this.isConnected)throw iz("RECONNECT_SIGNAL","Failed to observe session store key due to network disconnection");return this.call("listen-metadata-change",{keys:e})}getSessionMetadata(e){if(!this.isConnected)throw iz("RECONNECT_SIGNAL","Failed to set session store value due to network disconnection");return this.call("get-metadata",{key:e})}setPollInfo(e){return this.call("poll-info-set",tb({},e))}getPollInfo(e){return this.call("poll-info-get",tb({},e))}setPollQuestions(e){return this.call("poll-questions-set",tb({},e))}startPoll(e){return this.call("poll-start",tb({},e))}stopPoll(e){return this.call("poll-stop",tb({},e))}getPollQuestions(e){return this.call("poll-questions-get",tb({},e))}setPollResponses(e){return this.call("poll-response",tb({},e))}getPollResponses(e){return this.call("poll-responses",tb({},e))}getPollsList(e){return this.call("poll-list",tb({},e))}getPollResult(e){return this.call("poll-result",tb({},e))}createWhiteboard(e){return this.validateConnection(),this.call("whiteboard-create",tb({},e))}getWhiteboard(e){return this.validateConnection(),this.call("whiteboard-get",tb({},e))}fetchPollLeaderboard(e){return this.call("poll-leaderboard",tb({},e))}validateConnection(){if(!this.isConnected)throw iz("RECONNECT_SIGNAL","Failed to send message due to network disconnection")}onMessageHandler(e){let t=JSON.parse(e.data);if(this.resolvePingOnAnyResponse(),t.id)this.handleResponseWithId(t);else if(t.method)this.handleResponseWithMethod(t);else throw Error(`WebSocket message has no 'method' or 'id' field, message=${t}`)}handleResponseWithId(e){let t=e.id;if(this.callbacks.has(t)){let i=this.callbacks.get(t);this.callbacks.delete(t),e.result?i.resolve(e.result):i.reject(e.error)}else this.observer.onNotification(e)}handleResponseWithMethod(e){switch(e.method){case"offer":this.observer.onOffer(e.params);break;case"trickle":this.observer.onTrickle(e.params);break;case"on-error":this.observer.onServerError(sc(Number(e.params.code),"on-error",e.params.message));break;case"on-warning":tV.w(this.TAG,e.params);break;default:this.observer.onNotification(e)}}rejectPendingCalls(e=""){this.callbacks.forEach((t,i)=>{var s,r,n,a;(null==(s=t.metadata)?void 0:s.method)!=="ping"&&(tV.e(this.TAG,`rejecting pending callback ${null==(r=t.metadata)?void 0:r.method}, id=${i}`),t.reject(iz(null!=(n=t.metadata)&&n.method?iq(null==(a=t.metadata)?void 0:a.method):"RECONNECT_SIGNAL",e)),this.callbacks.delete(i))})}pingPongLoop(e){return tP(this,null,function*(){var t,i;let s=(null==(t=window.HMS)?void 0:t.PING_TIMEOUT)||12e3;if(this.isConnected){let t=yield this.ping(s);this.pongResponseTimes.enqueue(t),t>s?(tV.d(this.TAG,`Pong timeout ${e}, pageHidden=${"undefined"!=typeof document&&document.hidden}`),this.id===e&&this.setIsConnected(!1,"ping pong failure")):setTimeout(()=>this.pingPongLoop(e),(null==(i=window.HMS)?void 0:i.PING_INTERVAL)||3e3)}})}call(e,t){return tP(this,null,function*(){let i=sc(500,e,`Default ${e} error`),s;for(s=1;s<=3;s++)try{return this.validateConnection(),tV.d(this.TAG,`Try number ${s} sending ${e}`,t),yield this.internalCall(e,t)}catch(n){if(i=n,tV.e(this.TAG,`Failed sending ${e} try: ${s}`,{method:e,params:t,error:i}),5!==parseInt(`${i.code/100}`)&&429!==i.code&&1003!==i.code)break;let r=(2+2*Math.random())*1e3;yield s9(r)}throw tV.e(`Sending ${e} over WS failed after ${Math.min(s,3)} retries`,{method:e,params:t,error:i}),i})}},ox="[HMSTransport]:",oU=class{constructor(e,t,i,s,r,n,a){this.observer=e,this.deviceManager=t,this.store=i,this.eventBus=s,this.analyticsEventsService=r,this.analyticsTimer=n,this.pluginUsageTracker=a,this.state="Disconnected",this.trackStates=new Map,this.publishConnection=null,this.subscribeConnection=null,this.maxSubscribeBitrate=0,this.joinRetryCount=0,this.publishDisconnectTimer=0,this.onScreenshareStop=()=>{},this.screenStream=new Set,this.callbacks=new Map,this.setListener=e=>{this.listener=e},this.setOnScreenshareStop=e=>{this.onScreenshareStop=e},this.signalObserver={onOffer:e=>tP(this,null,function*(){try{if(!this.subscribeConnection)return;if(e.sfu_node_id&&this.subscribeConnection.sfuNodeId&&this.subscribeConnection.sfuNodeId!==e.sfu_node_id)return void tV.d(ox,"ignoring old offer");for(let t of(yield this.subscribeConnection.setRemoteDescription(e),tV.d(ox,`[SUBSCRIBE] Adding ${this.subscribeConnection.candidates.length} ice-candidates`,this.subscribeConnection.candidates),this.subscribeConnection.candidates))yield this.subscribeConnection.addIceCandidate(t);this.subscribeConnection.candidates.length=0;let t=yield this.subscribeConnection.createAnswer();yield this.subscribeConnection.setLocalDescription(t),this.signal.answer(t),tV.d(ox,"[role=SUBSCRIBE] onOffer renegotiation DONE ✅")}catch(t){let e;tV.d(ox,"[role=SUBSCRIBE] onOffer renegotiation FAILED ❌",t),this.state="Failed",e=t instanceof i$?t:sv("SUBSCRIBE",t.message),this.observer.onFailure(e),this.eventBus.analytics.publish(sj.subscribeFail(e))}}),onTrickle:e=>tP(this,null,function*(){let t=0===e.target?this.publishConnection:this.subscribeConnection;null!=t&&t.remoteDescription?yield t.addIceCandidate(e.candidate):null==t||t.candidates.push(e.candidate)}),onNotification:e=>this.observer.onNotification(e),onServerError:e=>tP(this,null,function*(){yield this.observer.onStateChange("Failed",e)}),onFailure:e=>{this.joinParameters&&this.retryScheduler.schedule({category:1,error:e,task:this.retrySignalDisconnectTask,originalState:this.state})},onOffline:e=>tP(this,null,function*(){tV.d(ox,"socket offline",oh[this.state]);try{"Leaving"!==this.state&&this.joinParameters&&this.retryScheduler.schedule({category:1,error:iz("RECONNECT_SIGNAL",e),task:this.retrySignalDisconnectTask,originalState:this.state})}catch(e){console.error(e)}}),onOnline:()=>{var e;tV.d(ox,"socket online",oh[this.state]),this.analyticsSignalTransport.flushFailedEvents(null==(e=this.store.getLocalPeer())?void 0:e.peerId)},onNetworkOnline:()=>{this.analyticsEventsService.flushFailedClientEvents()}},this.signal=new oN(this.signalObserver),this.analyticsSignalTransport=new of(this.signal),this.publishDtlsStateTimer=0,this.lastPublishDtlsState="new",this.handleLocalRoleUpdate=e=>tP(this,[e],function*({oldRole:e,newRole:t}){!this.doesRoleNeedWebRTC(e)&&this.doesRoleNeedWebRTC(t)&&(tV.d(ox,"Local peer role updated to webrtc role, creating PeerConnections and performing inital publish negotiation ⏳"),this.createPeerConnections(),yield this.negotiateOnFirstPublish())}),this.retryPublishIceFailedTask=()=>tP(this,null,function*(){if(this.publishConnection){let e=new Promise((e,t)=>{this.callbacks.set(rB,{promise:{resolve:e,reject:t},action:"RESTART_ICE",extra:{}})});yield this.performPublishRenegotiation({iceRestart:"connected"!==this.publishConnection.connectionState}),yield e}return!0}),this.retrySubscribeIceFailedTask=()=>tP(this,null,function*(){return!this.subscribeConnection||"connected"===this.subscribeConnection.connectionState||Promise.race([new Promise((e,t)=>{this.callbacks.set(rj,{promise:{resolve:e,reject:t},action:"RESTART_ICE",extra:{}})}),new Promise(e=>{setTimeout(e,6e4,!1)})])}),this.retrySignalDisconnectTask=()=>tP(this,null,function*(){var e;tV.d(ox,"retrySignalDisconnectTask",{signalConnected:this.signal.isConnected}),this.signal.isConnected||(yield this.internalConnect(this.joinParameters.authToken,this.joinParameters.endpoint,this.joinParameters.peerId,this.joinParameters.iceServers));let t=null!=(e=this.store.getRoom())&&e.joinedAt?this.signal.isConnected&&(yield this.retryPublishIceFailedTask()):this.signal.isConnected;return this.signal.trackUpdate(this.trackStates),t}),this.webrtcInternals=new r1(this.store,this.eventBus);let o=(e,t)=>tP(this,null,function*(){e!==this.state&&(this.state=e,yield this.observer.onStateChange(this.state,t))});this.retryScheduler=new ov(o,this.sendErrorAnalyticsEvent.bind(this)),this.eventBus.statsUpdate.subscribe(e=>{var t,i;let s=(null==(i=null==(t=e.getLocalPeerStats())?void 0:t.subscribe)?void 0:i.bitrate)||0;this.maxSubscribeBitrate=Math.max(this.maxSubscribeBitrate,s)}),this.eventBus.localAudioEnabled.subscribe(({track:e,enabled:t})=>this.trackUpdate(e,t)),this.eventBus.localVideoEnabled.subscribe(({track:e,enabled:t})=>this.trackUpdate(e,t))}getWebsocketEndpoint(){if(this.initConfig)return this.initConfig.endpoint}getWebrtcInternals(){return this.webrtcInternals}isFlagEnabled(e){var t;let i=null==(t=this.initConfig)?void 0:t.config;return((null==i?void 0:i.enabledFlags)||[]).includes(e)}setConnectivityListener(e){this.connectivityListener=e}preview(e,t,i,s,r=!1,n){return tP(this,null,function*(){let a=yield this.connect(e,t,i,s,r,n);return this.state="Preview",this.observer.onStateChange(this.state),a})}join(e,t,i,s,r=!1,n){return tP(this,null,function*(){tV.d(ox,"join: started ⏰");try{this.signal.isConnected&&this.initConfig||(yield this.connect(e,s,t,i,r,n)),this.validateNotDisconnected("connect"),this.initConfig&&(yield this.waitForLocalRoleAvailability(),yield this.createConnectionsAndNegotiateJoin(i,r),this.initStatsAnalytics(),tV.d(ox,"✅ join: Negotiated over PUBLISH connection"))}catch(t){throw tV.e(ox,`join: failed \u274C [token=${e}]`,t),this.state="Failed",t.isTerminal=t.isTerminal||500===t.code,yield this.observer.onStateChange(this.state,t),t}tV.d(ox,"✅ join: successful"),this.state="Joined",this.observer.onStateChange(this.state)})}connect(e,t,i,s,r=!1,n){return tP(this,null,function*(){this.setTransportStateForConnect(),this.joinParameters=new od(e,i,s.name,s.metaData,t,r,n);try{return yield this.internalConnect(e,t,i,n)}catch(s){if(s instanceof i$&&([it,ie,ii,ir].includes(s.code)||s.code.toString().startsWith("5")||s.code.toString().startsWith("429"))){let r=()=>tP(this,null,function*(){return yield this.internalConnect(e,t,i,n),!!(this.initConfig&&this.initConfig.endpoint)});yield this.retryScheduler.schedule({category:0,error:s,task:r,originalState:this.state,changeState:!1})}else throw s}})}leave(e){return tP(this,arguments,function*(e,t="user request"){var i,s,r;this.retryScheduler.reset(),this.joinParameters=void 0,tV.d(ox,"leaving in transport");try{let n=this.pluginUsageTracker.getPluginUsage("HMSKrispPlugin");if(n&&this.eventBus.analytics.publish(sj.getKrispUsage(n)),this.state="Leaving",null==(i=this.publishStatsAnalytics)||i.stop(),null==(s=this.subscribeStatsAnalytics)||s.stop(),null==(r=this.webrtcInternals)||r.cleanup(),this.clearPeerConnections(),e)try{this.signal.leave(t),tV.d(ox,"signal leave done")}catch(e){tV.w(ox,"failed to send leave on websocket to server",e)}this.analyticsEventsService.flushFailedClientEvents(),this.analyticsEventsService.reset(),yield this.signal.close()}catch(e){this.eventBus.analytics.publish(sj.disconnect(e)),tV.e(ox,"leave: FAILED ❌",e)}finally{this.state="Disconnected",this.observer.onStateChange(this.state)}})}publish(e){return tP(this,null,function*(){var t;for(let i of e)try{yield this.publishTrack(i),null==(t=this.connectivityListener)||t.onMediaPublished(i)}catch(e){this.eventBus.analytics.publish(sj.publish({devices:this.deviceManager.getDevices(),error:e}))}})}unpublish(e){return tP(this,null,function*(){for(let t of e)yield this.unpublishTrack(t)})}setSFUNodeId(e){var t,i;this.signal.setSfuNodeId(e),this.sfuNodeId?e&&this.sfuNodeId!==e&&(this.sfuNodeId=e,this.handleSFUMigration()):(this.sfuNodeId=e,null==(t=this.publishConnection)||t.setSfuNodeId(e),null==(i=this.subscribeConnection)||i.setSfuNodeId(e))}handleSFUMigration(){return tP(this,null,function*(){var e,t;tV.time("sfu migration"),this.clearPeerConnections();let i=this.store.getPeerMap();for(let e in this.store.removeRemoteTracks(),i){let t=i[e];t.isLocal||(t.audioTrack=void 0,t.videoTrack=void 0,t.auxiliaryTracks=[])}let s=this.store.getLocalPeer();if(!s)return;this.createPeerConnections(),this.trackStates.clear(),yield this.negotiateOnFirstPublish();let r=new Map;if(s.audioTrack){let e=s.audioTrack.stream;r.get(e.id)||r.set(e.id,new rq(new MediaStream));let t=s.audioTrack.clone(r.get(e.id));this.store.removeTrack(s.audioTrack),s.audioTrack.cleanup(),yield this.publishTrack(t),s.audioTrack=t}if(s.videoTrack){let e=s.videoTrack.stream;r.get(e.id)||r.set(e.id,new rq(new MediaStream)),this.store.removeTrack(s.videoTrack);let t=s.videoTrack.clone(r.get(e.id));s.videoTrack.cleanup(),yield this.publishTrack(t),s.videoTrack=t}let n=[];for(;s.auxiliaryTracks.length>0;){let e=s.auxiliaryTracks.shift();if(e){let t=e.stream;r.get(t.id)||r.set(t.id,new rq("screen"===e.source?t.nativeStream.clone():new MediaStream)),this.store.removeTrack(e);let i=e.clone(r.get(t.id));"video"===i.type&&"screen"===i.source&&(this.screenStream.add(t.nativeStream),this.screenStream.add(i.stream.nativeStream),i.nativeTrack.addEventListener("ended",this.onScreenshareStop)),e.cleanup(),yield this.publishTrack(i),n.push(i)}}s.auxiliaryTracks=n,r.clear(),null==(t=null==(e=this.listener)?void 0:e.onSFUMigration)||t.call(e),tV.timeEnd("sfu migration")})}trackUpdate(e,t){var i;let s=Array.from(this.trackStates.values()).find(t=>e.type===t.type&&e.source===t.source);if(s){let r=new aj(tT(tb({},s),{mute:!t}));this.trackStates.set(s.track_id,r),tV.d(ox,"Track Update",this.trackStates,e),this.signal.trackUpdate(new Map([[s.track_id,r]]));let n=this.store.getLocalPeer();n&&t===e.enabled&&(null==(i=this.listener)||i.onTrackUpdate(t?3:2,e,n))}}publishTrack(e){return tP(this,null,function*(){e.publishedTrackId=e.getTrackIDBeingSent(),tV.d(ox,`\u23F3 publishTrack: trackId=${e.trackId}, toPublishTrackId=${e.publishedTrackId}`,`${e}`),this.trackStates.set(e.publishedTrackId,new aj(e));let t=new Promise((e,t)=>{this.callbacks.set(rB,{promise:{resolve:e,reject:t},action:"PUBLISH",extra:{}})}),i=e.stream;i.setConnection(this.publishConnection);let s=this.store.getSimulcastLayers(e.source);i.addTransceiver(e,s),tV.time(`publish-${e.trackId}-${e.type}`),yield t,tV.timeEnd(`publish-${e.trackId}-${e.type}`),this.store.addTrack(e),yield i.setMaxBitrateAndFramerate(e).then(()=>{tV.d(ox,`Setting maxBitrate=${e.settings.maxBitrate} kpbs${e instanceof rU?` and maxFramerate=${e.settings.maxFramerate}`:""} for ${e.source} ${e.type} ${e.trackId}`)}).catch(e=>tV.w(ox,"Failed setting maxBitrate and maxFramerate",e)),e.isPublished=!0,tV.d(ox,`\u2705 publishTrack: trackId=${e.trackId}`,`${e}`,this.callbacks)})}unpublishTrack(e){return tP(this,null,function*(){if(tV.d(ox,`\u23F3 unpublishTrack: trackId=${e.trackId}`,`${e}`),e.publishedTrackId&&this.trackStates.has(e.publishedTrackId))this.trackStates.delete(e.publishedTrackId);else{let t=Array.from(this.trackStates.values()).find(t=>e.type===t.type&&e.source===t.source);t&&this.trackStates.delete(t.track_id)}let t=new Promise((e,t)=>{this.callbacks.set(rB,{promise:{resolve:e,reject:t},action:"UNPUBLISH",extra:{}})});e.stream.removeSender(e),yield t,yield e.cleanup(),"screen"===e.source&&this.screenStream&&this.screenStream.forEach(e=>{e.getTracks().forEach(e=>{e.stop()}),this.screenStream.delete(e)}),this.store.removeTrack(e),tV.d(ox,`\u2705 unpublishTrack: trackId=${e.trackId}`,this.callbacks)})}clearPeerConnections(){return tP(this,null,function*(){var e,t;clearTimeout(this.publishDtlsStateTimer),this.publishDtlsStateTimer=0,clearTimeout(this.publishDisconnectTimer),this.publishDisconnectTimer=0,this.lastPublishDtlsState="new",null==(e=this.publishConnection)||e.close(),null==(t=this.subscribeConnection)||t.close(),this.publishConnection=null,this.subscribeConnection=null})}waitForLocalRoleAvailability(){if(!this.store.hasRoleDetailsArrived())return new Promise(e=>{this.eventBus.policyChange.subscribeOnce(()=>e())})}createConnectionsAndNegotiateJoin(e,t=!1){return tP(this,null,function*(){let i=this.doesLocalPeerNeedWebRTC();i&&this.createPeerConnections(),this.analyticsTimer.start("join_response_time"),yield this.negotiateJoinWithRetry({name:e.name,data:e.metaData,autoSubscribeVideo:t,isWebRTC:i}),this.analyticsTimer.end("join_response_time")})}createPeerConnections(){var e,t,i;let s=(e,t,i=!1)=>{(["disconnected","failed"].includes(t)?tV.w.bind(tV):tV.d.bind(tV))(ox,`${oI[e]} ${i?"ice":""} connection state change: ${t}`)};this.initConfig&&(this.publishConnection||(this.publishConnection=new o_(this.signal,this.initConfig.rtcConfiguration,{onRenegotiationNeeded:()=>tP(this,null,function*(){yield this.performPublishRenegotiation()}),onDTLSTransportStateChange:e=>{var t,i,s;if(("failed"===e?tV.w.bind(tV):tV.d.bind(tV))(ox,`Publisher on dtls transport state change: ${e}`),!e||this.lastPublishDtlsState===e||(this.lastPublishDtlsState=e,0!==this.publishDtlsStateTimer&&(clearTimeout(this.publishDtlsStateTimer),this.publishDtlsStateTimer=0),"connecting"!==e&&"failed"!==e))return;let r=null==(s=null==(i=null==(t=this.initConfig)?void 0:t.config)?void 0:i.dtlsStateTimeouts)?void 0:s[e];!r||r<=0||(this.publishDtlsStateTimer=window.setTimeout(()=>{var t;let i=null==(t=this.publishConnection)?void 0:t.nativeConnection.connectionState;if(i&&e&&i===e){let t=so("PUBLISH",`DTLS transport state ${e} timeout:${r}ms`,!0);this.eventBus.analytics.publish(sj.disconnect(t)),this.observer.onFailure(t)}},r))},onDTLSTransportError:e=>{tV.e(ox,`onDTLSTransportError ${e.name} ${e.message}`,e),this.eventBus.analytics.publish(sj.disconnect(e))},onIceConnectionChange:e=>tP(this,null,function*(){s(0,e,!0)}),onConnectionStateChange:e=>tP(this,null,function*(){var t,i,r,n,a,o,l,d;s(0,e,!1),"new"!==e&&("connected"===e?(null==(t=this.connectivityListener)||t.onICESuccess(!0),null==(i=this.publishConnection)||i.handleSelectedIceCandidatePairs()):"failed"===e?yield this.handleIceConnectionFailure(0,so("PUBLISH",`local candidate - ${null==(a=null==(n=null==(r=this.publishConnection)?void 0:r.selectedCandidatePair)?void 0:n.local)?void 0:a.candidate}; remote candidate - ${null==(d=null==(l=null==(o=this.publishConnection)?void 0:o.selectedCandidatePair)?void 0:l.remote)?void 0:d.candidate}`)):this.publishDisconnectTimer=window.setTimeout(()=>{var e,t,i,s,r,n,a;(null==(e=this.publishConnection)?void 0:e.connectionState)!=="connected"&&this.handleIceConnectionFailure(0,sl("PUBLISH",`local candidate - ${null==(s=null==(i=null==(t=this.publishConnection)?void 0:t.selectedCandidatePair)?void 0:i.local)?void 0:s.candidate}; remote candidate - ${null==(a=null==(n=null==(r=this.publishConnection)?void 0:r.selectedCandidatePair)?void 0:n.remote)?void 0:a.candidate}`))},5e3))}),onIceCandidate:e=>{var t;null==(t=this.connectivityListener)||t.onICECandidate(e,!0)},onSelectedCandidatePairChange:e=>{var t;null==(t=this.connectivityListener)||t.onSelectedICECandidatePairChange(e,!0)}})),this.subscribeConnection||(this.subscribeConnection=new oM(this.signal,this.initConfig.rtcConfiguration,this.isFlagEnabled.bind(this),{onApiChannelMessage:e=>{this.observer.onNotification(JSON.parse(e))},onTrackAdd:e=>{tV.d(ox,"[Subscribe] onTrackAdd",`${e}`),this.observer.onTrackAdd(e)},onTrackRemove:e=>{tV.d(ox,"[Subscribe] onTrackRemove",`${e}`),this.observer.onTrackRemove(e)},onIceConnectionChange:e=>tP(this,null,function*(){var t;if(s(1,e,!0),"connected"===e){let e=this.callbacks.get(rj);this.callbacks.delete(rj),null==(t=this.connectivityListener)||t.onICESuccess(!1),e&&e.promise.resolve(!0)}}),onConnectionStateChange:e=>tP(this,null,function*(){var t,i,r,n,a,o,l;if(s(1,e,!1),"failed"===e)yield this.handleIceConnectionFailure(1,so("SUBSCRIBE",`local candidate - ${null==(r=null==(i=null==(t=this.subscribeConnection)?void 0:t.selectedCandidatePair)?void 0:i.local)?void 0:r.candidate}; remote candidate - ${null==(o=null==(a=null==(n=this.subscribeConnection)?void 0:n.selectedCandidatePair)?void 0:a.remote)?void 0:o.candidate}`));else if("disconnected"===e)setTimeout(()=>{var e,t,i,s,r,n,a;(null==(e=this.subscribeConnection)?void 0:e.connectionState)==="disconnected"&&this.handleIceConnectionFailure(1,sl("SUBSCRIBE",`local candidate - ${null==(s=null==(i=null==(t=this.subscribeConnection)?void 0:t.selectedCandidatePair)?void 0:i.local)?void 0:s.candidate}; remote candidate - ${null==(a=null==(n=null==(r=this.subscribeConnection)?void 0:r.selectedCandidatePair)?void 0:n.remote)?void 0:a.candidate}`))},5e3);else if("connected"===e){null==(l=this.subscribeConnection)||l.handleSelectedIceCandidatePairs();let e=this.callbacks.get(rj);this.callbacks.delete(rj),e&&e.promise.resolve(!0)}}),onIceCandidate:e=>{var t;null==(t=this.connectivityListener)||t.onICECandidate(e,!1)},onSelectedCandidatePairChange:e=>{var t;null==(t=this.connectivityListener)||t.onSelectedICECandidatePairChange(e,!1)}}))),null==(i=this.webrtcInternals)||i.setPeerConnections({publish:null==(e=this.publishConnection)?void 0:e.nativeConnection,subscribe:null==(t=this.subscribeConnection)?void 0:t.nativeConnection})}negotiateJoinWithRetry(e){return tP(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:s=!0}){try{yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:s})}catch(a){tV.e(ox,"Join negotiation failed ❌",a);let r=a instanceof i$?a:sc(500,"JOIN",`Websocket join error - ${a.message}`),n=5===parseInt(`${r.code/100}`)||[it,429].includes(r.code);if(410===r.code&&(r.isTerminal=!0),n){this.joinRetryCount=0,r.isTerminal=!1;let n=()=>tP(this,null,function*(){return this.joinRetryCount++,yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:s})});yield this.retryScheduler.schedule({category:2,error:r,task:n,originalState:"Joined",changeState:!1})}else throw a}})}negotiateJoin(e){return tP(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:s=!0}){return s?yield this.negotiateJoinWebRTC({name:e,data:t,autoSubscribeVideo:i}):yield this.negotiateJoinNonWebRTC({name:e,data:t,autoSubscribeVideo:i})})}negotiateJoinWebRTC(e){return tP(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i}){if(tV.d(ox,"⏳ join: Negotiating over PUBLISH connection"),!this.publishConnection)return tV.e(ox,"Publish peer connection not found, cannot negotiate"),!1;let s=yield this.publishConnection.createOffer();yield this.publishConnection.setLocalDescription(s);let r=this.isFlagEnabled("subscribeDegradation"),n=this.isFlagEnabled("simulcast"),a=this.isFlagEnabled("onDemandTracks"),o=yield this.signal.join(e,t,!i,r,n,a,s);for(let e of(this.setSFUNodeId(null==o?void 0:o.sfu_node_id),yield this.publishConnection.setRemoteDescription(o),this.publishConnection.candidates))yield this.publishConnection.addIceCandidate(e);return this.publishConnection.initAfterJoin(),!!o})}negotiateJoinNonWebRTC(e){return tP(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i}){tV.d(ox,"⏳ join: Negotiating Non-WebRTC");let s=this.isFlagEnabled("subscribeDegradation"),r=this.isFlagEnabled("simulcast"),n=this.isFlagEnabled("onDemandTracks"),a=yield this.signal.join(e,t,!i,s,r,n);return this.setSFUNodeId(null==a?void 0:a.sfu_node_id),!!a})}negotiateOnFirstPublish(){return tP(this,null,function*(){if(tV.d(ox,"⏳ Negotiating offer over PUBLISH connection"),!this.publishConnection)return tV.e(ox,"Publish peer connection not found, cannot negotiate"),!1;try{let e=yield this.publishConnection.createOffer(this.trackStates);yield this.publishConnection.setLocalDescription(e);let t=yield this.signal.offer(e,this.trackStates);for(let e of(yield this.publishConnection.setRemoteDescription(t),this.publishConnection.candidates))yield this.publishConnection.addIceCandidate(e);return this.publishConnection.initAfterJoin(),!!t}catch(e){if(e instanceof i$&&421===e.code)return!0;throw e}})}performPublishRenegotiation(e){return tP(this,null,function*(){tV.d(ox,"⏳ [role=PUBLISH] onRenegotiationNeeded START",this.trackStates);let t=this.callbacks.get(rB);if(!t)return void tV.w(ox,"no callback found for renegotiation");if(!this.publishConnection)return void tV.e(ox,"Publish peer connection not found, cannot renegotiate");try{let i=yield this.publishConnection.createOffer(this.trackStates,e);yield this.publishConnection.setLocalDescription(i),tV.time("renegotiation-offer-exchange");let s=yield this.signal.offer(i,this.trackStates);this.callbacks.delete(rB),tV.timeEnd("renegotiation-offer-exchange"),yield this.publishConnection.setRemoteDescription(s),t.promise.resolve(!0),tV.d(ox,"[role=PUBLISH] onRenegotiationNeeded DONE ✅")}catch(i){let e;421===(e=i instanceof i$?i:sv("PUBLISH",i.message)).code?t.promise.resolve(!0):t.promise.reject(e),tV.d(ox,"[role=PUBLISH] onRenegotiationNeeded FAILED ❌")}})}handleIceConnectionFailure(e,t){return tP(this,null,function*(){this.retryScheduler.isTaskInProgress(4)||(0===e?this.retryScheduler.schedule({category:3,error:t,task:this.retryPublishIceFailedTask,originalState:"Joined"}):this.retryScheduler.schedule({category:4,error:t,task:this.retrySubscribeIceFailedTask,originalState:"Joined"}))})}internalConnect(e,t,i,s){return tP(this,null,function*(){var r,n,a;tV.d(ox,"connect: started ⏰");let o=new Date;try{this.analyticsTimer.start("init_response_time"),this.initConfig=yield oO.fetchInitConfig({token:e,peerId:i,userAgent:this.store.getUserAgent(),initEndpoint:t,iceServers:s}),null==(r=this.connectivityListener)||r.onInitSuccess(this.initConfig.endpoint);let o=this.store.getRoom();return o&&(o.effectsKey=null==(n=this.initConfig.config.vb)?void 0:n.effectsKey,o.isEffectsEnabled=this.isFlagEnabled("effectsSDKEnabled"),o.disableNoneLayerRequest=this.isFlagEnabled("disableNoneLayerRequest"),o.isVBEnabled=this.isFlagEnabled("vb"),o.isHipaaEnabled=this.isFlagEnabled("hipaa"),o.isNoiseCancellationEnabled=this.isFlagEnabled("noiseCancellation")),this.analyticsTimer.end("init_response_time"),aF.setWebsocketEndpoint(this.initConfig.endpoint),this.validateNotDisconnected("post init"),yield this.openSignal(e,i),this.observer.onConnected(),null==(a=this.connectivityListener)||a.onSignallingSuccess(),this.store.setSimulcastEnabled(this.isFlagEnabled("simulcast")),tV.d(ox,"Adding Analytics Transport: JsonRpcSignal"),this.analyticsEventsService.setTransport(this.analyticsSignalTransport),this.analyticsEventsService.flush(),this.initConfig}catch(e){throw"Reconnecting"!==this.state&&this.eventBus.analytics.publish(sj.connect(e,this.getAdditionalAnalyticsProperties(),o,new Date,t)),tV.e(ox,"❌ internal connect: failed",e),e}})}validateNotDisconnected(e){if("Disconnected"===this.state)throw tV.w(ox,"aborting join as transport state is disconnected"),sm(`leave called before join could complete - stage=${e}`)}openSignal(e,t){return tP(this,null,function*(){if(!this.initConfig)throw iX("INIT","Init Config not found");tV.d(ox,"⏳ internal connect: connecting to ws endpoint",this.initConfig.endpoint);let i=new URL(this.initConfig.endpoint);i.searchParams.set("peer",t),i.searchParams.set("token",e),i.searchParams.set("user_agent_v2",this.store.getUserAgent()),i.searchParams.set("protocol_version","2.5"),i.searchParams.set("protocol_spec","20250115"),this.endpoint=i.toString(),this.analyticsTimer.start("ws_connect_time"),yield this.signal.open(this.endpoint),this.analyticsTimer.end("ws_connect_time"),this.analyticsTimer.start("on_policy_change_time"),this.analyticsTimer.start("room_state_time"),tV.d(ox,"✅ internal connect: connected to ws endpoint")})}initStatsAnalytics(){var e,t;this.isFlagEnabled("publishStats")&&(this.publishStatsAnalytics=new ow(this.store,this.eventBus,this.getValueFromInitConfig("publishStats","maxSampleWindowSize",30),this.getValueFromInitConfig("publishStats","maxSamplePushInterval",300)),null==(e=this.getWebrtcInternals())||e.start()),this.isFlagEnabled("subscribeStats")&&(this.subscribeStatsAnalytics=new oC(this.store,this.eventBus,this.getValueFromInitConfig("subscribeStats","maxSampleWindowSize",10),this.getValueFromInitConfig("subscribeStats","maxSamplePushInterval",60)),null==(t=this.getWebrtcInternals())||t.start())}getValueFromInitConfig(e,t,i){var s,r;return(null==(r=null==(s=this.initConfig)?void 0:s.config[e])?void 0:r[t])||i}doesRoleNeedWebRTC(e){var t,i;if(!this.isFlagEnabled("nonWebRTCDisableOffer"))return!0;let s=!!(e.publishParams.allowed&&(null==(t=e.publishParams.allowed)?void 0:t.length)>0),r=!!(e.subscribeParams.subscribeToRoles&&(null==(i=e.subscribeParams.subscribeToRoles)?void 0:i.length)>0);return s||r}doesLocalPeerNeedWebRTC(){var e;let t=null==(e=this.store.getLocalPeer())?void 0:e.role;return!t||this.doesRoleNeedWebRTC(t)}setTransportStateForConnect(){if("Failed"===this.state&&(this.state="Disconnected"),"Disconnected"!==this.state&&"Reconnecting"!==this.state)throw su("JOIN",`Cannot join a meeting in ${this.state} state`);"Disconnected"===this.state&&(this.state="Connecting",this.observer.onStateChange(this.state))}sendErrorAnalyticsEvent(e,t){let i=this.getAdditionalAnalyticsProperties(),s;switch(t){case 0:s=sj.connect(e,i);break;case 1:s=sj.disconnect(e,i);break;case 2:s=sj.join({error:e,time:this.analyticsTimer.getTimeTaken("join_time"),init_response_time:this.analyticsTimer.getTimeTaken("init_response_time"),ws_connect_time:this.analyticsTimer.getTimeTaken("ws_connect_time"),on_policy_change_time:this.analyticsTimer.getTimeTaken("on_policy_change_time"),local_audio_track_time:this.analyticsTimer.getTimeTaken("local_audio_track_time"),local_video_track_time:this.analyticsTimer.getTimeTaken("local_video_track_time"),retries_join:this.joinRetryCount});break;case 3:s=sj.publish({error:e});break;case 4:s=sj.subscribeFail(e)}this.eventBus.analytics.publish(s)}getSubscribeConnection(){return this.subscribeConnection}getAdditionalAnalyticsProperties(){var e,t,i,s,r,n,a,o;return{network_info:(()=>{if(!t3||void 0===navigator.connection)return;let e=navigator.connection;return{downlink:e.downlink,downlinkMax:e.downlinkMax,effectiveType:e.effectiveType,rtt:e.rtt,saveData:e.saveData,type:e.type}})(),document_hidden:"undefined"!=typeof document&&document.hidden,num_degraded_tracks:this.store.getRemoteVideoTracks().filter(e=>e.degraded).length,bitrate:{publish:null==(s=null==(i=null==(t=null==(e=this.getWebrtcInternals())?void 0:e.getCurrentStats())?void 0:t.getLocalPeerStats())?void 0:i.publish)?void 0:s.bitrate,subscribe:null==(o=null==(a=null==(n=null==(r=this.getWebrtcInternals())?void 0:r.getCurrentStats())?void 0:n.getLocalPeerStats())?void 0:a.subscribe)?void 0:o.bitrate},max_sub_bitrate:this.maxSubscribeBitrate,recent_pong_response_times:this.signal.getPongResponseTimes(),transport_state:this.state}}};function oB(e){if(!e||0===e.length)throw iY("INIT","Token cannot be an empty string or undefined or null");let t=e.split(".");if(3!==t.length)throw iY("INIT","Expected 3 '.' separate fields - header, payload and signature respectively");let i=atob(t[1]);try{let e=JSON.parse(i);return{roomId:e.room_id,userId:e.user_id,role:e.role}}catch(e){throw iY("INIT",`couldn't parse to json - ${e.message}`)}}var oF={published:!1,isInitialised:!1,isReconnecting:!1,isPreviewInProgress:!1,isPreviewCalled:!1,isJoinInProgress:!1,deviceManagersInitialised:!1},oj=class{constructor(){this.TAG="[HMSSdk]:",this.transportState="Disconnected",this.analyticsTimer=new rD,this.sdkState=tb({},oF),this.isDiagnostics=!1,this.playlistSettings={video:{bitrate:1e3},audio:{bitrate:64}},this.handleAutoplayError=e=>{var t,i;null==(i=null==(t=this.errorListener)?void 0:t.onError)||i.call(t,e)},this.observer={onNotification:e=>{var t;if("on-peer-leave-request"===e.method)return void this.handlePeerLeaveRequest(e.params);switch(e.method){case"on-policy-change":this.analyticsTimer.end("on_policy_change_time");break;case"peer-list":this.analyticsTimer.end("peer_list_time"),this.sendJoinAnalyticsEvent(this.sdkState.isPreviewCalled);break;case"room-state":this.analyticsTimer.end("room_state_time")}null==(t=this.notificationManager)||t.handleNotification(e,this.sdkState.isReconnecting)},onConnected:()=>{this.initNotificationManager()},onTrackAdd:e=>{var t;null==(t=this.notificationManager)||t.handleTrackAdd(e)},onTrackRemove:e=>{var t;null==(t=this.notificationManager)||t.handleTrackRemove(e)},onFailure:e=>{var t;null==(t=this.errorListener)||t.onError(e)},onStateChange:(e,t)=>tP(this,null,function*(){var i,s;let r=e=>tP(this,null,function*(){var t,i;yield this.internalLeave(!0,e),this.sdkState.isPreviewInProgress||this.sdkState.isJoinInProgress||null==(i=null==(t=this.errorListener)?void 0:t.onError)||i.call(t,e),this.sdkState.isReconnecting=!1});switch(e){case"Preview":case"Joined":this.initNotificationManager(),"Reconnecting"===this.transportState&&(null==(i=this.listener)||i.onReconnected());break;case"Failed":yield r(t);break;case"Reconnecting":this.sdkState.isReconnecting=!0,null==(s=this.listener)||s.onReconnecting(t)}this.transportState=e,tV.d(this.TAG,"Transport State Change",this.transportState)})},this.handlePeerLeaveRequest=e=>{var t;let i=e.requested_by?this.store.getPeerById(e.requested_by):void 0,s={roomEnded:e.room_end,reason:e.reason,requestedBy:i};null==(t=this.listener)||t.onRemovedFromRoom(s),this.internalLeave(!1)},this.handlePreviewError=e=>{var t;this.analyticsTimer.end("preview_time"),e&&(null==(t=this.errorListener)||t.onError(e)),this.sendPreviewAnalyticsEvent(e),this.sdkState.isPreviewInProgress=!1},this.handleDeviceChange=e=>{var t,i;e.isUserSelection||(tV.d(this.TAG,"Device Change event",e),null==(i=null==(t=this.deviceChangeListener)?void 0:t.onDeviceChange)||i.call(t,e),(()=>{var t,i,s,r;if(e.error&&e.type){let n=e.type.includes("audio")?null==(t=this.localPeer)?void 0:t.audioTrack:null==(i=this.localPeer)?void 0:i.videoTrack;null==(s=this.errorListener)||s.onError(e.error),[il,ic,id].includes(e.error.code)&&n&&(n.setEnabled(!1),null==(r=this.listener)||r.onTrackUpdate(2,n,this.localPeer))}})())},this.handleAudioPluginError=e=>{var t;tV.e(this.TAG,"Audio Plugin Error event",e),null==(t=this.errorListener)||t.onError(e)},this.handleError=e=>{var t;tV.e(this.TAG,e),null==(t=this.errorListener)||t.onError(e)},this.handleLocalRoleUpdate=e=>tP(this,[e],function*({oldRole:e,newRole:t}){var i;this.deviceManager.currentSelection=this.deviceManager.getCurrentSelection(),yield this.transport.handleLocalRoleUpdate({oldRole:e,newRole:t}),yield null==(i=this.roleChangeManager)?void 0:i.handleLocalPeerRoleUpdate({oldRole:e,newRole:t}),yield this.interactivityCenter.whiteboard.handleLocalRoleUpdate()}),this.unpauseRemoteVideoTracks=()=>{this.store.getRemoteVideoTracks().forEach(e=>e.handleTrackUnmute())},this.sendAudioPresenceFailed=()=>{var e;let t=i9("PREVIEW");tV.w(this.TAG,"Audio Presence Failure",this.transportState,t),this.isDiagnostics&&(null==(e=this.listener)||e.onError(t))},this.sendJoinAnalyticsEvent=(e=!1,t)=>{this.eventBus.analytics.publish(sj.join(tT(tb({error:t},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken("join_time"),is_preview_called:e,retries_join:this.transport.joinRetryCount})))},this.sendPreviewAnalyticsEvent=e=>{this.eventBus.analytics.publish(sj.preview(tT(tb({error:e},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken("preview_time")})))},this.sendAnalyticsEvent=e=>{this.isDiagnostics||this.analyticsEventsService.queue(e).flush()}}setSessionPeerInfo(e,t){var i,s,r,n;let a=this.store.getRoom();if(!t||!a)return void tV.e(this.TAG,"setSessionPeerInfo> Local peer or room is undefined");this.sessionPeerInfo={peer:{peer_id:t.peerId,role:null==(i=t.role)?void 0:i.name,joined_at:(null==(s=t.joinedAt)?void 0:s.valueOf())||0,room_name:a.name,session_started_at:(null==(r=a.startedAt)?void 0:r.valueOf())||0,user_data:t.customerUserId,user_name:t.name,template_id:a.templateId,session_id:a.sessionId,token:null==(n=this.store.getConfig())?void 0:n.authToken},agent:this.store.getUserAgent(),device_id:s_(),cluster:{websocket_url:e},timestamp:Date.now()}}initNotificationManager(){this.notificationManager||(this.notificationManager=new oo(this.store,this.eventBus,this.transport,this.listener,this.audioListener))}initStoreAndManagers(e){var t,i;if(this.listener=e,this.errorListener=e,this.deviceChangeListener=e,null==(t=this.store)||t.setErrorListener(this.errorListener),this.sdkState.isInitialised){null==(i=this.notificationManager)||i.setListener(this.listener),this.audioSinkManager.setListener(this.listener),this.interactivityCenter.setListener(this.listener),this.transport.setListener(this.listener);return}this.sdkState.isInitialised=!0,this.store=new a$,this.store.setErrorListener(this.errorListener),this.eventBus=new aY,this.pluginUsageTracker=new aW(this.eventBus),this.wakeLockManager=new aG,this.networkTestManager=new aU(this.eventBus,this.listener),this.playlistManager=new nr(this,this.eventBus),this.deviceManager=new az(this.store,this.eventBus),this.audioSinkManager=new aH(this.store,this.deviceManager,this.eventBus),this.audioOutput=new aK(this.deviceManager,this.audioSinkManager),this.audioSinkManager.setListener(this.listener),this.eventBus.autoplayError.subscribe(this.handleAutoplayError),this.localTrackManager=new rN(this.store,this.observer,this.deviceManager,this.eventBus,this.analyticsTimer),this.analyticsEventsService=new aV(this.store),this.transport=new oU(this.observer,this.deviceManager,this.store,this.eventBus,this.analyticsEventsService,this.analyticsTimer,this.pluginUsageTracker),"onInitSuccess"in e&&this.transport.setConnectivityListener(e),this.sessionStore=new ol(this.transport),this.interactivityCenter=new oe(this.transport,this.store,this.listener),this.eventBus.analytics.subscribe(this.sendAnalyticsEvent),this.eventBus.deviceChange.subscribe(this.handleDeviceChange),this.eventBus.localVideoUnmutedNatively.subscribe(this.unpauseRemoteVideoTracks),this.eventBus.localAudioUnmutedNatively.subscribe(this.unpauseRemoteVideoTracks),this.eventBus.audioPluginFailed.subscribe(this.handleAudioPluginError),this.eventBus.error.subscribe(this.handleError)}validateJoined(e){if(!this.localPeer)throw sh("VALIDATION",`Not connected - ${e}`)}sendHLSAnalytics(e){this.sendAnalyticsEvent(sj.hlsPlayerError(e))}refreshDevices(){return tP(this,null,function*(){this.validateJoined("refreshDevices"),yield this.deviceManager.init(!0)})}getWebrtcInternals(){var e;return null==(e=this.transport)?void 0:e.getWebrtcInternals()}getDebugInfo(){var e;if(!this.transport)throw tV.e(this.TAG,"Transport is not defined"),Error("getDebugInfo can only be called after join");return{websocketURL:this.transport.getWebsocketEndpoint(),enabledFlags:Object.values(a9).filter(e=>this.transport.isFlagEnabled(e)),initEndpoint:null==(e=this.store.getConfig())?void 0:e.initEndpoint}}getSessionStore(){return this.sessionStore}getPlaylistManager(){return this.playlistManager}getRecordingState(){var e;return null==(e=this.store.getRoom())?void 0:e.recording}getRTMPState(){var e;return null==(e=this.store.getRoom())?void 0:e.rtmp}getHLSState(){var e;return null==(e=this.store.getRoom())?void 0:e.hls}getTranscriptionState(){var e;return null==(e=this.store.getRoom())?void 0:e.transcriptions}getTemplateAppData(){return this.store.getTemplateAppData()}getInteractivityCenter(){return this.interactivityCenter}getPeerListIterator(e){return new r9(this.transport,this.store,e)}updatePlaylistSettings(e){e.video&&Object.assign(this.playlistSettings.video,e.video),e.audio&&Object.assign(this.playlistSettings.audio,e.audio)}get localPeer(){var e;return null==(e=this.store)?void 0:e.getLocalPeer()}preview(e,t){return tP(this,null,function*(){if(sO(),sD(),this.sdkState.isPreviewInProgress)return Promise.reject(sy("PREVIEW","Preview already called"));if(["Joined","Reconnecting"].includes(this.transportState))return this.midCallPreview(e.asRole,e.settings);this.analyticsTimer.start("preview_time"),this.setUpPreview(e,t);let i=!1,s=!1,r=setTimeout(()=>{var e,t;i&&s||null==(t=null==(e=this.listener)?void 0:e.onNetworkQuality)||t.call(e,-1)},3e3);return new Promise((n,a)=>{let o=()=>tP(this,null,function*(){var i;if(this.localPeer){let t=e.asRole&&this.store.getPolicyForRole(e.asRole);this.localPeer.asRole=t||this.localPeer.role}let s=yield this.localTrackManager.getTracksToPublish(e.settings);s.forEach(e=>{var t;if(this.setLocalPeerTrack(e),e.isTrackNotPublishing()){let i=si(`${e.type} track has no data. muted: ${e.nativeTrack.muted}, readyState: ${e.nativeTrack.readyState}`);tV.e(this.TAG,i),this.sendAnalyticsEvent(sj.publish({devices:this.deviceManager.getDevices(),error:i})),null==(t=this.listener)||t.onError(i)}}),null!=(i=this.localPeer)&&i.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),this.sdkState.isPreviewInProgress=!1,this.analyticsTimer.end("preview_time");let r=this.store.getRoom();r&&t.onPreview(r,s),this.sendPreviewAnalyticsEvent(),n()});this.eventBus.policyChange.subscribeOnce(o),this.eventBus.leave.subscribeOnce(this.handlePreviewError),this.eventBus.leave.subscribeOnce(e=>a(e)),this.transport.preview(e.authToken,e.initEndpoint,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.autoVideoSubscribe,e.iceServers).then(t=>{var n;i=!0,clearTimeout(r),t&&e.captureNetworkQualityInPreview&&this.networkTestManager.start(null==(n=t.config)?void 0:n.networkHealth).then(()=>{s=!0})}).catch(e=>{this.handlePreviewError(e),a(e)})})})}midCallPreview(e,t){return tP(this,null,function*(){var i,s;if(!this.localPeer||"Joined"!==this.transportState)throw sh("VALIDATION","Not connected - midCallPreview");let r=e&&this.store.getPolicyForRole(e);if(!r)throw sf("PREVIEW",`role ${e} does not exist in policy`);this.localPeer.asRole=r;let n=yield this.localTrackManager.getTracksToPublish(t);n.forEach(e=>this.setLocalPeerTrack(e)),null!=(i=this.localPeer)&&i.audioTrack&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),null==(s=this.listener)||s.onPreview(this.store.getRoom(),n)})}cancelMidCallPreview(){return tP(this,null,function*(){var e,t,i;if(this.localPeer&&this.localPeer.isInPreview()||tV.w(this.TAG,"Cannot cancel mid call preview as preview is not in progress"),null!=(e=this.localPeer)&&e.asRole&&this.localPeer.role){let e=this.localPeer.asRole,s=this.localPeer.role;delete this.localPeer.asRole,yield null==(t=this.roleChangeManager)?void 0:t.diffRolesAndPublishTracks({oldRole:e,newRole:s}),null==(i=this.listener)||i.onPeerUpdate(8,this.localPeer)}})}join(e,t){return tP(this,null,function*(){var i,s,r,n,a,o,l,d;if(sO(),sD(),this.sdkState.isPreviewInProgress)throw sg("JOIN","Preview is in progress, can't join");null==(s=null==(i=this.eventBus)?void 0:i.leave)||s.unsubscribe(this.handlePreviewError),this.analyticsTimer.start("join_time"),this.sdkState.isJoinInProgress=!0;let{roomId:c,userId:u,role:h}=oB(e.authToken),p=(null==(n=null==(r=this.localPeer)?void 0:r.asRole)?void 0:n.name)||(null==(o=null==(a=this.localPeer)?void 0:a.role)?void 0:o.name);null==(l=this.networkTestManager)||l.stop(),this.commonSetup(e,c,t),this.removeDevicesFromConfig(e),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),s1.resumeContext();let v=this.store.getConfig();null!=v&&v.autoManageWakeLock&&this.wakeLockManager.acquireLock(),this.localPeer?(this.localPeer.name=e.userName,this.localPeer.role=this.store.getPolicyForRole(h),this.localPeer.customerUserId=u,this.localPeer.metadata=e.metaData,delete this.localPeer.asRole):this.createAndAddLocalPeerToStore(e,h,u),this.roleChangeManager=new aB(this.store,this.transport,this.deviceManager,this.getAndPublishTracks.bind(this),this.removeTrack.bind(this),this.listener),this.eventBus.localRoleUpdate.subscribe(this.handleLocalRoleUpdate),tV.d(this.TAG,`\u23F3 Joining room ${c}`),tV.time(`join-room-${c}`);try{yield this.transport.join(e.authToken,this.localPeer.peerId,{name:e.userName,metaData:e.metaData},e.initEndpoint,e.autoVideoSubscribe,e.iceServers),tV.d(this.TAG,`\u2705 Joined room ${c}`),this.analyticsTimer.start("peer_list_time"),yield this.notifyJoin(),this.sdkState.isJoinInProgress=!1,yield this.publish(e.settings,p)}catch(e){throw this.analyticsTimer.end("join_time"),this.sdkState.isJoinInProgress=!1,null==(d=this.listener)||d.onError(e),this.sendJoinAnalyticsEvent(this.sdkState.isPreviewCalled,e),tV.e(this.TAG,"Unable to join room",e),e}tV.timeEnd(`join-room-${c}`)})}stringifyMetadata(e){e.metaData&&"string"!=typeof e.metaData?e.metaData=JSON.stringify(e.metaData):e.metaData||(e.metaData="")}cleanup(){var e,t,i;this.cleanDeviceManagers(),this.eventBus.analytics.unsubscribe(this.sendAnalyticsEvent),this.eventBus.localVideoUnmutedNatively.unsubscribe(this.unpauseRemoteVideoTracks),this.eventBus.localAudioUnmutedNatively.unsubscribe(this.unpauseRemoteVideoTracks),this.eventBus.error.unsubscribe(this.handleError),this.analyticsTimer.cleanup(),sq.cleanup(),this.playlistManager.cleanup(),null==(e=this.wakeLockManager)||e.cleanup(),rN.cleanup(),this.notificationManager=void 0,tV.cleanup(),this.sdkState=tb({},oF),this.localPeer&&(null==(t=this.localPeer.audioTrack)||t.cleanup(),this.localPeer.audioTrack=void 0,null==(i=this.localPeer.videoTrack)||i.cleanup(),this.localPeer.videoTrack=void 0),this.store.cleanup(),this.listener=void 0,this.roleChangeManager&&this.eventBus.localRoleUpdate.unsubscribe(this.handleLocalRoleUpdate)}leave(e){return this.internalLeave(e)}internalLeave(e=!0,t){return tP(this,null,function*(){var i,s,r,n;let a=null==(i=this.store)?void 0:i.getRoom();if(a){for(;(this.sdkState.isPreviewInProgress||this.sdkState.isJoinInProgress)&&!(null!=t&&t.isTerminal);)yield s9(100);let i=a.id;this.setSessionPeerInfo(this.transport.getWebsocketEndpoint()||"",this.localPeer),null==(s=this.networkTestManager)||s.stop(),this.eventBus.leave.publish(t);let o=null==(r=this.localPeer)?void 0:r.peerId;tV.d(this.TAG,`\u23F3 Leaving room ${i}, peerId=${o}`),yield null==(n=this.transport)?void 0:n.leave(e,t?"sdk request":"user request"),this.cleanup(),tV.d(this.TAG,`\u2705 Left room ${i}, peerId=${o}`)}})}getAuthTokenByRoomCode(e,t){return tP(this,null,function*(){let i=(t||{}).endpoint||"https://auth.100ms.live/v2/token";this.analyticsTimer.start("GET_TOKEN");let s=yield aD(i,{method:"POST",body:JSON.stringify({code:e.roomCode,user_id:e.userId})},[429,500,501,502,503,504,505,506,507,508,509,510,511]),r=yield s.json();if(this.analyticsTimer.end("GET_TOKEN"),!s.ok)throw iJ(r.code,"GET_TOKEN",r.message,!1);let{token:n}=r;if(!n)throw Error(r.message);return n})}getLocalPeer(){return this.store.getLocalPeer()}getPeers(){return this.store.getPeers()}getPeerMap(){return this.store.getPeerMap()}getAudioOutput(){return this.audioOutput}sendMessage(e,t){this.sendMessageInternal({message:t,type:e})}sendBroadcastMessage(e,t){return tP(this,null,function*(){return yield this.sendMessageInternal({message:e,type:t})})}sendGroupMessage(e,t,i){return tP(this,null,function*(){let s=this.store.getKnownRoles();if(0===(t.filter(e=>s[e.name])||[]).length)throw sm("No valid role is present",t);return yield this.sendMessageInternal({message:e,recipientRoles:t,type:i})})}sendDirectMessage(e,t,i){return tP(this,null,function*(){var s,r;if((null==(s=this.localPeer)?void 0:s.peerId)===t)throw sm("Cannot send message to self");let n=!!(null!=(r=this.store.getRoom())&&r.large_room_optimization),a=this.store.getPeerById(t);if(!a)if(n){let e=yield this.transport.signal.getPeer({peer_id:t});if(!e)throw sm("Invalid peer - peer not present in the room",t);a=r6(e,this.store)}else throw sm("Invalid peer - peer not present in the room",t);return yield this.sendMessageInternal({message:e,recipientPeer:a,type:i})})}submitSessionFeedback(e,t){return tP(this,null,function*(){if(!this.sessionPeerInfo)throw tV.e(this.TAG,"submitSessionFeedback> session is undefined"),Error("session is undefined");let i=this.sessionPeerInfo.peer.token;if(!i)throw tV.e(this.TAG,"submitSessionFeedback> token is undefined"),Error("Internal error, token is not present");try{yield aJ.sendFeedback({token:i,info:this.sessionPeerInfo,feedback:e,eventEndpoint:t}),tV.i(this.TAG,"submitSessionFeedback> submitted feedback"),this.sessionPeerInfo=void 0}catch(e){throw tV.e(this.TAG,"submitSessionFeedback> error occured ",e),Error("Unable to submit feedback")}})}getPeer(e){return tP(this,null,function*(){let t=yield this.transport.signal.getPeer({peer_id:e});if(t)return r6(t,this.store)})}findPeerByName(e){return tP(this,arguments,function*({query:e,limit:t=10,offset:i}){let{peers:s,offset:r,eof:n}=yield this.transport.signal.findPeerByName({query:null==e?void 0:e.toLowerCase(),limit:t,offset:i});return s.length>0?{offset:r,eof:n,peers:s.map(e=>r6({peer_id:e.peer_id,role:e.role,groups:[],info:{name:e.name,data:"",user_id:"",type:e.type}},this.store))}:{offset:r,peers:[]}})}sendMessageInternal(e){return tP(this,arguments,function*({recipientRoles:e,recipientPeer:t,type:i="chat",message:s}){if(""===s.replace(/\u200b/g," ").trim())throw tV.w(this.TAG,"sendMessage","Ignoring empty message send"),sm("Empty message not allowed");let r={info:{message:s,type:i}};return null!=e&&e.length&&(r.roles=e.map(e=>e.name)),null!=t&&t.peerId&&(r.peer_id=t.peerId),tV.d(this.TAG,"Sending Message: ",r),yield this.transport.signal.broadcast(r)})}startScreenShare(e,t){return tP(this,null,function*(){var i,s,r;let n=this.store.getPublishParams();if(!n)return;let{allowed:a}=n;if(!(a&&a.includes("screen")))return void tV.e(this.TAG,`Role ${null==(i=this.localPeer)?void 0:i.role} cannot share screen`);if(null!=(r=null==(s=this.localPeer)?void 0:s.auxiliaryTracks)&&r.find(e=>"screen"===e.source))throw Error("Cannot share multiple screens");let o=yield this.getScreenshareTracks(e,t);if(!this.localPeer){tV.d(this.TAG,"Screenshared when not connected"),o.forEach(e=>{e.cleanup()});return}this.transport.setOnScreenshareStop(()=>{this.stopEndedScreenshare(e)}),yield this.transport.publish(o),o.forEach(e=>{var t,i,s;e.peerId=null==(t=this.localPeer)?void 0:t.peerId,null==(i=this.localPeer)||i.auxiliaryTracks.push(e),null==(s=this.listener)||s.onTrackUpdate(0,e,this.localPeer)})})}stopEndedScreenshare(e){return tP(this,null,function*(){tV.d(this.TAG,"✅ Screenshare ended natively"),yield this.stopScreenShare(),e()})}stopScreenShare(){return tP(this,null,function*(){var e;tV.d(this.TAG,"✅ Screenshare ended from app");let t=null==(e=this.localPeer)?void 0:e.auxiliaryTracks.filter(e=>"screen"===e.source);if(t)for(let e of t)yield this.removeTrack(e.trackId)})}addTrack(e,t="regular"){return tP(this,null,function*(){var i,s,r,n;if(!e)return void tV.w(this.TAG,"Please pass a valid MediaStreamTrack");if(!this.localPeer)throw sh("VALIDATION","No local peer present, cannot addTrack");if(this.localPeer.auxiliaryTracks.find(t=>t.trackId===e.id))return;let a=new("audio"===e.kind?rm:rU)(new rq(new MediaStream([e])),e,t,this.eventBus);yield this.applySettings(a),yield this.setPlaylistSettings({track:e,hmsTrack:a,source:t}),yield null==(i=this.transport)?void 0:i.publish([a]),a.peerId=null==(s=this.localPeer)?void 0:s.peerId,null==(r=this.localPeer)||r.auxiliaryTracks.push(a),null==(n=this.listener)||n.onTrackUpdate(0,a,this.localPeer)})}removeTrack(e,t=!1){return tP(this,null,function*(){var i;if(!this.localPeer)throw sh("VALIDATION","No local peer present, cannot removeTrack");let s=this.localPeer.auxiliaryTracks.findIndex(t=>t.trackId===e);if(s>-1){let e=this.localPeer.auxiliaryTracks[s];e.isPublished?yield this.transport.unpublish([e]):yield e.cleanup(),t||this.stopPlaylist(e),this.localPeer.auxiliaryTracks.splice(s,1),null==(i=this.listener)||i.onTrackUpdate(1,e,this.localPeer)}else tV.w(this.TAG,`No track found for ${e}`)})}setAnalyticsLevel(e){this.analyticsEventsService.level=e}setLogLevel(e){tV.level=e}autoSelectAudioOutput(e){var t;null==(t=this.deviceManager)||t.autoSelectAudioOutput(e)}addAudioListener(e){var t;this.audioListener=e,null==(t=this.notificationManager)||t.setAudioListener(e)}addConnectionQualityListener(e){var t;null==(t=this.notificationManager)||t.setConnectionQualityListener(e)}setIsDiagnostics(e){this.isDiagnostics=e}changeRole(e,t,i=!1){return tP(this,null,function*(){var s;yield null==(s=this.transport)?void 0:s.signal.requestRoleChange({requested_for:e,role:t,force:i})})}changeRoleOfPeer(e,t,i=!1){return tP(this,null,function*(){var s;yield null==(s=this.transport)?void 0:s.signal.requestRoleChange({requested_for:e,role:t,force:i})})}changeRoleOfPeersWithRoles(e,t){return tP(this,null,function*(){var i;e.length<=0||!t||(yield null==(i=this.transport)?void 0:i.signal.requestBulkRoleChange({roles:e.map(e=>e.name),role:t,force:!0}))})}acceptChangeRole(e){return tP(this,null,function*(){var t,i;yield null==(i=this.transport)?void 0:i.signal.acceptRoleChangeRequest({requested_by:null==(t=e.requestedBy)?void 0:t.peerId,role:e.role.name,token:e.token})})}endRoom(e,t){return tP(this,null,function*(){var i;if(!this.localPeer)throw sh("VALIDATION","No local peer present, cannot end room");yield null==(i=this.transport)?void 0:i.signal.endRoom(e,t),yield this.leave()})}removePeer(e,t){return tP(this,null,function*(){var i;if(!this.localPeer)throw sh("VALIDATION","No local peer present, cannot remove peer");yield null==(i=this.transport)?void 0:i.signal.removePeer({requested_for:e,reason:t})})}startRTMPOrRecording(e){return tP(this,null,function*(){var t,i;if(!this.localPeer)throw sh("VALIDATION","No local peer present, cannot start streaming or recording");let s={meeting_url:e.meetingURL,record:e.record};null!=(t=e.rtmpURLs)&&t.length&&(s.rtmp_urls=e.rtmpURLs),e.resolution&&(s.resolution=e.resolution),yield null==(i=this.transport)?void 0:i.signal.startRTMPOrRecording(s)})}stopRTMPAndRecording(){return tP(this,null,function*(){var e;if(!this.localPeer)throw sh("VALIDATION","No local peer present, cannot stop streaming or recording");yield null==(e=this.transport)?void 0:e.signal.stopRTMPAndRecording()})}startHLSStreaming(e){return tP(this,null,function*(){var t;if(!this.localPeer)throw sh("VALIDATION","No local peer present, cannot start HLS streaming");let i={};e&&e.variants&&e.variants.length>0&&(i.variants=e.variants.map(e=>{let t={meeting_url:e.meetingURL};return e.metadata&&(t.metadata=e.metadata),t})),null!=e&&e.recording&&(i.hls_recording={single_file_per_layer:e.recording.singleFilePerLayer,hls_vod:e.recording.hlsVod}),yield null==(t=this.transport)?void 0:t.signal.startHLSStreaming(i)})}stopHLSStreaming(e){return tP(this,null,function*(){var t,i,s;if(!this.localPeer)throw sh("VALIDATION","No local peer present, cannot stop HLS streaming");if(e){let s={variants:null==(t=null==e?void 0:e.variants)?void 0:t.map(e=>{let t={meeting_url:e.meetingURL};return e.metadata&&(t.metadata=e.metadata),t}),stop_reason:e.stop_reason};yield null==(i=this.transport)?void 0:i.signal.stopHLSStreaming(s)}else yield null==(s=this.transport)?void 0:s.signal.stopHLSStreaming()})}startTranscription(e){return tP(this,null,function*(){var t;if(!this.localPeer)throw sh("VALIDATION","No local peer present, cannot start transcriptions");let i={mode:e.mode};yield null==(t=this.transport)?void 0:t.signal.startTranscription(i)})}stopTranscription(e){return tP(this,null,function*(){var t;if(!this.localPeer)throw sh("VALIDATION","No local peer present, cannot stop transcriptions");if(!e)throw sp("VALIDATION","No mode is passed to stop the transcription");let i={mode:e.mode};yield null==(t=this.transport)?void 0:t.signal.stopTranscription(i)})}sendHLSTimedMetadata(e){return tP(this,null,function*(){var t;this.validateJoined("sendHLSTimedMetadata"),e.length>0&&(yield null==(t=this.transport)?void 0:t.signal.sendHLSTimedMetadata({metadata_objs:e}))})}changeName(e){return tP(this,null,function*(){var t,i;this.validateJoined("changeName");let s=this.store.getLocalPeer();s&&s.name!==e&&(yield null==(t=this.transport)?void 0:t.signal.updatePeer({name:e}),null==(i=this.notificationManager)||i.updateLocalPeer({name:e}))})}changeMetadata(e){return tP(this,null,function*(){var t,i;this.validateJoined("changeMetadata"),yield null==(t=this.transport)?void 0:t.signal.updatePeer({data:e}),null==(i=this.notificationManager)||i.updateLocalPeer({metadata:e})})}setSessionMetadata(e){return tP(this,null,function*(){var t;yield null==(t=this.transport)?void 0:t.signal.setSessionMetadata({key:"default",data:e})})}getSessionMetadata(){return tP(this,null,function*(){var e;return(yield null==(e=this.transport)?void 0:e.signal.getSessionMetadata("default")).data})}getRoles(){return Object.values(this.store.getKnownRoles())}changeTrackState(e,t){return tP(this,null,function*(){var i;if("video"===e.type&&"regular"!==e.source)return void tV.w(this.TAG,"Muting non-regular video tracks is currently not supported");if(e.enabled===t)return void tV.w(this.TAG,`Aborting change track state, track already has enabled - ${t}`,e);if(!this.store.getTrackById(e.trackId))throw sm("No track found for change track state",e);let s=this.store.getPeerByTrackId(e.trackId);if(!s)throw sm("No peer found for change track state",e);yield null==(i=this.transport)?void 0:i.signal.requestTrackStateChange({requested_for:s.peerId,track_id:e.trackId,stream_id:e.stream.id,mute:!t})})}changeMultiTrackState(e){return tP(this,null,function*(){var t;if("boolean"!=typeof e.enabled)throw sm("Pass a boolean for enabled");let{enabled:i,roles:s,type:r,source:n}=e;yield null==(t=this.transport)?void 0:t.signal.requestMultiTrackStateChange({value:!i,type:r,source:n,roles:null==s?void 0:s.map(e=>null==e?void 0:e.name)})})}raiseLocalPeerHand(){return tP(this,null,function*(){var e;this.validateJoined("raiseLocalPeerHand"),yield null==(e=this.transport)?void 0:e.signal.joinGroup(r$)})}lowerLocalPeerHand(){return tP(this,null,function*(){var e;this.validateJoined("lowerLocalPeerHand"),yield null==(e=this.transport)?void 0:e.signal.leaveGroup(r$)})}raiseRemotePeerHand(e){return tP(this,null,function*(){var t;yield null==(t=this.transport)?void 0:t.signal.addToGroup(e,r$)})}lowerRemotePeerHand(e){return tP(this,null,function*(){var t;yield null==(t=this.transport)?void 0:t.signal.removeFromGroup(e,r$)})}setFrameworkInfo(e){this.frameworkInfo=tb(tb({},this.frameworkInfo),e)}attachVideo(e,t){return tP(this,null,function*(){let i=this.store.getConfig();null!=i&&i.autoManageVideo?e.attach(t):yield e.addSink(t)})}detachVideo(e,t){return tP(this,null,function*(){let i=this.store.getConfig();null!=i&&i.autoManageVideo?e.detach(t):yield e.removeSink(t)})}publish(e,t){return tP(this,null,function*(){var i,s,r;if([this.store.getPublishParams(),!this.sdkState.published,!t5].every(e=>!!e)){let n=t&&t!==(null==(s=null==(i=this.localPeer)?void 0:i.role)?void 0:s.name)?()=>{var e;return null==(e=this.roleChangeManager)?void 0:e.diffRolesAndPublishTracks({oldRole:this.store.getPolicyForRole(t),newRole:this.localPeer.role})}:()=>this.getAndPublishTracks(e);yield null==(r=null==n?void 0:n())?void 0:r.catch(e=>{var t;tV.e(this.TAG,"Error in publish",e),null==(t=this.listener)||t.onError(e)})}})}getAndPublishTracks(e){return tP(this,null,function*(){var t,i;let s=yield this.localTrackManager.getTracksToPublish(e);yield this.initDeviceManagers(),yield this.setAndPublishTracks(s),null==(i=null==(t=this.localPeer)?void 0:t.audioTrack)||i.initAudioLevelMonitor(),this.sdkState.published=!0})}setAndPublishTracks(e){return tP(this,null,function*(){var t,i;for(let s of e){if(yield this.transport.publish([s]),s.isTrackNotPublishing()){let e=si(`${s.type} track has no data. muted: ${s.nativeTrack.muted}, readyState: ${s.nativeTrack.readyState}`);tV.e(this.TAG,e),this.sendAnalyticsEvent(sj.publish({devices:this.deviceManager.getDevices(),error:e})),null==(t=this.listener)||t.onError(e)}yield this.setLocalPeerTrack(s),null==(i=this.listener)||i.onTrackUpdate(0,s,this.localPeer)}})}setLocalPeerTrack(e){return tP(this,null,function*(){var t;switch(e.peerId=null==(t=this.localPeer)?void 0:t.peerId,e.type){case"audio":this.localPeer.audioTrack=e,yield this.deviceManager.autoSelectAudioOutput();break;case"video":this.localPeer.videoTrack=e}})}initDeviceManagers(){return tP(this,null,function*(){var e,t,i,s,r;this.sdkState.deviceManagersInitialised||(this.sdkState.deviceManagersInitialised=!0,yield this.deviceManager.init(),(yield this.deviceManager.updateOutputDevice(null==(t=null==(e=this.store.getConfig())?void 0:e.settings)?void 0:t.audioOutputDeviceId))||(yield this.deviceManager.updateOutputDevice(null==(s=null==(i=sq.getSelection())?void 0:i.audioOutput)?void 0:s.deviceId)),this.audioSinkManager.init(null==(r=this.store.getConfig())?void 0:r.audioSinkElementId))})}cleanDeviceManagers(){this.eventBus.deviceChange.unsubscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.unsubscribe(this.handleAudioPluginError),this.eventBus.autoplayError.unsubscribe(this.handleAutoplayError),this.deviceManager.cleanup(),this.audioSinkManager.cleanup()}initPreviewTrackAudioLevelMonitor(){var e;let t=null==(e=this.localPeer)?void 0:e.audioTrack;null==t||t.initAudioLevelMonitor(),this.eventBus.trackAudioLevelUpdate.subscribe(e=>{var i;let s=e&&e.track.trackId===(null==t?void 0:t.trackId)?[{audioLevel:e.audioLevel,peer:this.localPeer,track:t}]:[];this.store.updateSpeakers(s),null==(i=this.audioListener)||i.onAudioLevelUpdate(s)}),this.eventBus.localAudioSilence.subscribe(this.sendAudioPresenceFailed)}notifyJoin(){var e;let t=this.store.getLocalPeer(),i=this.store.getRoom();if(!i)return void tV.w(this.TAG,"notify join - room not present");if(i.joinedAt=new Date,t&&(t.joinedAt=i.joinedAt),null!=t&&t.role){this.analyticsTimer.end("join_time"),null==(e=this.listener)||e.onJoin(i);return}return new Promise((e,t)=>{this.eventBus.policyChange.subscribeOnce(()=>{var t;this.analyticsTimer.end("join_time"),null==(t=this.listener)||t.onJoin(i),e()}),this.eventBus.leave.subscribeOnce(e=>{t(e)})})}setUpPreview(e,t){this.sdkState.isPreviewCalled=!0,this.sdkState.isPreviewInProgress=!0;let{roomId:i,userId:s,role:r}=oB(e.authToken);this.commonSetup(e,i,t),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),this.createAndAddLocalPeerToStore(e,r,s,e.asRole)}setPlaylistSettings(e){return tP(this,arguments,function*({track:e,hmsTrack:t,source:i}){var s,r;if("videoplaylist"===i){let i={};if("audio"===e.kind)i.maxBitrate=(null==(s=this.playlistSettings.audio)?void 0:s.bitrate)||64;else{i.maxBitrate=(null==(r=this.playlistSettings.video)?void 0:r.bitrate)||1e3;let{width:t,height:s}=e.getSettings();i.width=t,i.height=s}yield t.setSettings(i)}else"audioplaylist"===i&&(yield t.setSettings({maxBitrate:64}))})}createAndAddLocalPeerToStore(e,t,i,s){let r=this.store.getPolicyForRole(t),n=s?this.store.getPolicyForRole(s):void 0,a=new r5({name:e.userName||"",customerUserId:i,metadata:e.metaData||"",role:r,asRole:n||r,type:"regular"});this.store.addPeer(a)}commonSetup(e,t,i){this.stringifyMetadata(e),e.initEndpoint||(e.initEndpoint="https://prod-init.100ms.live"),this.initStoreAndManagers(i),this.store.getRoom()||this.store.setRoom(new aM(t))}removeDevicesFromConfig(e){this.store.getConfig()&&e.settings&&(delete e.settings.audioOutputDeviceId,delete e.settings.videoDeviceId,delete e.settings.audioInputDeviceId)}getScreenshareTracks(e,t){return tP(this,null,function*(){let i=this.transport.isFlagEnabled("scaleScreenshareBasedOnPixels"),[s,r]=yield this.localTrackManager.getLocalScreen(t,i),n=()=>{this.stopEndedScreenshare(e)},a=[];if(null!=t&&t.audioOnly){if(s.nativeTrack.stop(),!r)throw i3("TRACK","Select share audio when sharing screen","No audio found");a.push(r),r.nativeTrack.addEventListener("ended",n)}else a.push(s),s.nativeTrack.addEventListener("ended",n),r&&a.push(r);return a})}stopPlaylist(e){"audioplaylist"===e.source?this.playlistManager.stop("audio"):"videoplaylist"===e.source&&this.playlistManager.stop("video")}applySettings(e){return tP(this,null,function*(){if(!this.store.getPublishParams())throw sh("VALIDATION","call addTrack after preview or join is successful");let t=this.store.getPublishParams();if(t){if(e instanceof rU){let i="regular"===e.source?"video":"screen"===e.source?"screen":"";if(!i||!t.allowed.includes(i))return;let s=t[i];if(!s)return;let r=new ru().codec(s.codec).maxBitrate(s.bitRate).maxFramerate(s.frameRate).setWidth(s.width).setHeight(s.height).build();yield e.setSettings(r)}else if(e instanceof rm){if(!t.allowed.includes("audio"))return;let i=new rd().codec(t.audio.codec).maxBitrate(t.audio.bitRate).build();yield e.setSettings(i)}}})}},o$=class e{constructor(t,i,s){this.getStats=()=>(this.stats||(this.stats=new oH(this.store,this.sdk)),this.stats),this.getDiagnosticsSDK=()=>(this.diagnostics||(this.diagnostics=this.actions.initDiagnostics()),this.diagnostics),t?this.store=t:this.store=e.createNewHMSStore(ax("HMSStore"),tI),s?this.notifications=s:this.notifications=new ac(this.store),i?this.actions=i:(this.sdk=new oj,this.actions=new aN(this.store,this.sdk,this.notifications)),this.actions.setFrameworkInfo({type:"js",sdkVersion:tC().version}),this.initialTriggerOnSubscribe=!1,t3&&(window.__hms=this)}triggerOnSubscribe(){this.initialTriggerOnSubscribe||(e.makeStoreTriggerOnSubscribe(this.store),this.initialTriggerOnSubscribe=!0)}getStore(){return this.store}getHMSActions(){return this.actions}getActions(){return this.actions}getNotifications(){return{onNotification:this.notifications.onNotification}}static createNewHMSStore(t,i){let s=_(e7)(()=>i()),r=s.setState;s.setState=e=>{r("function"==typeof e?(0,e9.produce)(e):e)};let n=s.getState;s.getState=e=>e?e(n()):n(),e.compareWithShallowCheckInSubscribe(s);let a=e.setUpDevtools(s,t);return tT(tb({},s),{namedSetState:a})}static makeStoreTriggerOnSubscribe(e){let t=e.subscribe;e.subscribe=(i,s,r)=>(i(e.getState(s),void 0),t(i,s,r))}static compareWithShallowCheckInSubscribe(e){let t=e.subscribe;e.subscribe=(e,i,s)=>(i||(i=e=>e),t(e,i,s=s||_(e8)))}static setUpDevtools(t,i){let s;try{s=window.__REDUX_DEVTOOLS_EXTENSION__||window.top.__REDUX_DEVTOOLS_EXTENSION__}catch(e){}if(!s)return e=>{t.setState(e)};let r=s.connect(e.devtoolsOptions(i));r.prefix=i?`${i} > `:"";let n=t.setState;return t.setState=e=>{n(e),r.send(`${r.prefix}setState`,t.getState())},r.subscribe(e.devtoolsSubscribe(r,t,n)),r.send("setUpStore",t.getState()),(e,i)=>{n(e);let s=i||`${r.prefix}action`;r.send(s,t.getState())}}static devtoolsOptions(e){return{name:e,actionsBlacklist:["audioLevel","playlistProgress","connectionQuality"]}}static devtoolsSubscribe(e,t,i){return s=>{var r,n,a,o;if("DISPATCH"===s.type&&s.state)["JUMP_TO_ACTION","JUMP_TO_STATE"].includes(s.payload.type)?i(JSON.parse(s.state)):t.setState(JSON.parse(s.state));else if("DISPATCH"===s.type&&(null==(r=s.payload)?void 0:r.type)==="COMMIT")e.init(t.getState());else if("DISPATCH"===s.type&&(null==(n=s.payload)?void 0:n.type)==="IMPORT_STATE"){let r=null==(a=s.payload.nextLiftedState)?void 0:a.actionsById;((null==(o=s.payload.nextLiftedState)?void 0:o.computedStates)||[]).forEach(({state:s},n)=>{let a=r[n]||`${e.prefix}setState`;0===n?e.init(s):(i(s),e.send(a,t.getState()))})}}}},oG=(e,t,i)=>{var s,r;let n=oV(i,t);null==(s=e.getWebrtcInternals())||s.start();let a=null==(r=e.getWebrtcInternals())?void 0:r.onStatsChange(s=>oq(t,s,i,e));return()=>{n(),a&&a()}},oV=(e,t)=>{let i,s,r;return e.getState(ng)?t.namedSetState(t=>{t.localPeer.id=e.getState(ng)},"localpeer-id"):i=e.subscribe(e=>{e&&t.namedSetState(t=>{t.localPeer.id=e},"localpeer-id")},ng),e.getState(nf)?t.namedSetState(t=>{t.localPeer.videoTrack=e.getState(nf)},"localpeer-videotrack-id"):s=e.subscribe(e=>{e&&t.namedSetState(t=>{t.localPeer.videoTrack=e},"localpeer-videotrack-id")},nf),e.getState(nm)?t.namedSetState(t=>{t.localPeer.audioTrack=e.getState(nm)},"localpeer-audiotrack-id"):r=e.subscribe(e=>{e&&t.namedSetState(t=>{t.localPeer.audioTrack=e},"localpeer-audiotrack-id")},nm),()=>{null==i||i(),null==s||s(),null==r||r()}},oq=(e,t,i,s)=>{let r=i.getState(nd);e.namedSetState(e=>{let n=i.getState(ng),a={};for(let e of Object.keys(r).filter(e=>r[e].peerId!==n)){let i=t.getRemoteTrackStats(e);i&&(a[e]=i)}ah(e.remoteTrackStats,a);let o={[n]:t.getLocalPeerStats()};ah(e.peerStats,o),((e,t,i)=>{let s=i.reduce((e,i)=>(e[i.firstTrackId]=Object.values(t[i.getTrackIDBeingSent()]||{}).sort((e,t)=>e.rid&&t.rid?e.rid<t.rid?-1:1:0),e),{});for(let t of ay(Object.keys(e),Object.keys(s))){if(!s[t]){delete e[t];continue}e[t]=s[t]}})(e.localTrackStats,t.getLocalTrackStats(),s.store.getLocalPeerTracks())},"webrtc-stats")},oH=class{constructor(e,t){var i,s,r;let n;this.hmsStore=e,this.sdk=t,this.store=o$.createNewHMSStore(ax("HMSStatsStore"),tA),this.getState=this.store.getState,this.subscribe=this.store.subscribe,this.getPublishPeerConnection=()=>new Promise(e=>{var t,i;"Connected"===this.hmsStore.getState(nE)?e(null==(i=null==(t=this.sdk)?void 0:t.getWebrtcInternals())?void 0:i.getPublishPeerConnection()):this.hmsStore.subscribe(t=>{var i,s;"Connected"===t&&e(null==(s=null==(i=this.sdk)?void 0:i.getWebrtcInternals())?void 0:s.getPublishPeerConnection())},nE)}),this.getSubscribePeerConnection=()=>new Promise(e=>{var t,i;"Connected"===this.hmsStore.getState(nE)?e(null==(i=null==(t=this.sdk)?void 0:t.getWebrtcInternals())?void 0:i.getSubscribePeerConnection()):this.hmsStore.subscribe(t=>{var i,s;"Connected"===t&&e(null==(s=null==(i=this.sdk)?void 0:i.getWebrtcInternals())?void 0:s.getSubscribePeerConnection())},nE)}),this.sdk&&(i=this.sdk,s=this.store,"Connected"===(r=this.hmsStore).getState(nE)&&(n=oG(i,s,r)),r.subscribe(e=>{["Connected","Reconnecting"].includes(e)?n||(n=oG(i,s,r)):["Disconnected","Failed"].includes(e)&&n&&(((e,t="resetState")=>{e.namedSetState(e=>{Object.assign(e,tA())},t)})(s,e),n(),n=void 0)},nE))}},oW=(e,t)=>t,oz=e=>e.peerStats,oK=e=>e.localTrackStats,oJ=x([oz,e=>e.localPeer.id],(e,t)=>e[t]),oQ=(x(oJ,e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.packetsLost}),x(oJ,e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.jitter}),x(oJ,e=>{var t;return null==(t=null==e?void 0:e.publish)?void 0:t.bitrate}),x(oJ,e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.bitrate}),x(oJ,e=>{var t;return null==(t=null==e?void 0:e.publish)?void 0:t.availableOutgoingBitrate}),x(oJ,e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.availableIncomingBitrate}),x(oJ,e=>{var t;return null==(t=null==e?void 0:e.publish)?void 0:t.bytesSent}),x(oJ,e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.bytesReceived}),x([oz,(e,t)=>t],(e,t)=>t?e[t]:void 0)),oY=x([e=>e.remoteTrackStats,oW],(e,t)=>t?e[t]:void 0),oX=x([oK,oW],(e,t)=>t?e[t]:void 0);nG(oQ),nG(oY),x([oK,e=>e.localPeer.audioTrack],(e,t)=>{var i;return t?null==(i=e[t])?void 0:i[0]:void 0}),nG(x(oX,e=>null==e?void 0:e[0])),x([oK,e=>e.localPeer.videoTrack],(e,t)=>{var i;return t?null==(i=e[t])?void 0:i[0]:void 0}),nG(x(oX,e=>e));const oZ=new URLSearchParams(window.location.search),o0=oZ.get("room_id"),o1="host"===oZ.get("mode")?"host":"guest";async function o2(){let e=await fetch("/api/create-token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:o0,role:o1})}),{token:t}=await e.json();return t}function o3(){let e=store.getState().peers;console.log("\uD83D\uDD0D peersRaw:",e,e?.constructor?.name);let t=[];if(Array.isArray(e))t=e;else if(e instanceof Map)t=Array.from(e.values());else if(e instanceof Set)t=Array.from(e);else if(e&&"function"==typeof e[Symbol.iterator])t=Array.from(e);else{if(!e||"object"!=typeof e)return void console.warn("⚠️ Unable to normalize peersRaw:",e);t=Object.values(e)}console.log("✅ normalized peers array:",t);let i=document.getElementById("video-section");if(!i)return void console.error("❌ Missing #video-section container!");if(i.innerHTML="",0===t.length){i.textContent="⏳ Waiting for video streams…";return}t.forEach(e=>{let t=document.createElement("video");t.autoplay=!0,t.playsInline=!0,t.muted=e.isLocal;let s=!1;if(e.videoTrack?.track)try{actions.attachVideo(e.videoTrack,t),s=!0}catch(e){console.warn("attachVideo failed:",e)}!s&&e.videoTrack?.track&&(t.srcObject=new MediaStream([e.videoTrack.track])),t.play().catch(e=>console.warn("play() failed:",e)),i.appendChild(t)})}(async function(){let e=new o$,t=e.getActions();e.getStore().subscribe(o3),e.triggerOnSubscribe();let i=await o2();await t.join({userName:o1,authToken:i}),await t.setAudioSettings({enabled:!0}),await t.setVideoSettings({enabled:!0}),console.log("✅ Joined and published as",o1)})().catch(e=>{console.error("❌ initVideoSession failed:",e);let t=document.getElementById("video-section");t&&(t.textContent="⚠️ Video init failed. See console.")});
//# sourceMappingURL=roleplayscenarioteam.4559cb23.js.map
